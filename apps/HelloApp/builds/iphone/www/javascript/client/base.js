dojo.provide("client.base");
if(!dojo._hasResource["toura.xhr"]){dojo._hasResource["toura.xhr"]=!0;dojo.provide("toura.xhr");var _d=dojo,cfg=_d.config,setValue=function(a,b,c){if(null!==c){var d=a[b];"string"==typeof d?a[b]=[d,c]:_d.isArray(d)?d.push(c):a[b]=c}};dojo.fieldToObject=function(a){var b=null;if(a=_d.byId(a)){var c=a.name,d=(a.type||"").toLowerCase();c&&d&&!a.disabled&&("radio"==d||"checkbox"==d?a.checked&&(b=a.value):a.multiple?(b=[],_d.query("option",a).forEach(function(a){a.selected&&b.push(a.value)})):b=a.value)}return b};
dojo.formToObject=function(a){var b={};"file|submit|image|reset|button|".forEach(dojo.byId(a).elements,function(a){var d=a.name,e=(a.type||"").toLowerCase();d&&e&&-1=="file|submit|image|reset|button|".indexOf(e)&&!a.disabled&&(setValue(b,d,"file|submit|image|reset|button|".fieldToObject(a)),"image"==e&&(b[d+".x"]=b[d+".y"]=b[d].x=b[d].y=0))});return b};dojo.objectToQuery=function(a){var b=encodeURIComponent,c=[],d={},e;for(e in a){var f=a[e];if(f!=d[e]){var g=b(e)+"=";if(_d.isArray(f))for(var i=0;i<
f.length;i++)c.push(g+b(f[i]));else c.push(g+b(f))}}return c.join("&")};dojo.formToQuery=function(a){return _d.objectToQuery(_d.formToObject(a))};dojo.formToJson=function(a,b){return _d.toJson(_d.formToObject(a),b)};dojo.queryToObject=function(a){var b={},a=a.split("&"),c=decodeURIComponent;_d.forEach(a,function(a){if(a.length){var e=a.split("="),a=c(e.shift()),e=c(e.join("="));"string"==typeof b[a]&&(b[a]=[b[a]]);_d.isArray(b[a])?b[a].push(e):b[a]=e}});return b};dojo._blockAsync=!1;var handlers=
_d._contentHandlers=dojo.contentHandlers={text:function(a){return a.responseText},json:function(a){return _d.fromJson(a.responseText||null)},"json-comment-filtered":function(a){dojo.config.useCommentedJson||console.warn("Consider using the standard mimetype:application/json. json-commenting can introduce security issues. To decrease the chances of hijacking, use the standard the 'json' handler and prefix your json with: {}&&\nUse djConfig.useCommentedJson=true to turn off this message.");var a=a.responseText,
b=a.indexOf("/*"),c=a.lastIndexOf("*/");if(-1==b||-1==c)throw Error("JSON was not comment filtered");return _d.fromJson(a.substring(b+2,c))},javascript:function(a){return _d.eval(a.responseText)},xml:function(a){return a.responseXML},"json-comment-optional":function(a){return a.responseText&&/^[^{\[]*\/\*/.test(a.responseText)?handlers["json-comment-filtered"](a):handlers.json(a)}};dojo._ioSetArgs=function(a,b,c,d){var e={args:a,url:a.url},f=null;if(a.form){var f=_d.byId(a.form),g=f.getAttributeNode("action");
e.url=e.url||(g?g.value:null);f=_d.formToObject(f)}g=[{}];f&&g.push(f);a.content&&g.push(a.content);a.preventCache&&g.push({"dojo.preventCache":(new Date).valueOf()});e.query=_d.objectToQuery(_d.mixin.apply(null,g));e.handleAs=a.handleAs||"text";var i=new _d.Deferred(b);i.addCallbacks(c,function(a){return d(a,i)});var h=a.load;h&&_d.isFunction(h)&&i.addCallback(function(b){return h.call(a,b,e)});var k=a.error;k&&_d.isFunction(k)&&i.addErrback(function(b){return k.call(a,b,e)});var j=a.handle;j&&_d.isFunction(j)&&
i.addBoth(function(b){return j.call(a,b,e)});cfg.ioPublish&&_d.publish&&!1!==e.args.ioPublish&&(i.addCallbacks(function(a){_d.publish("/dojo/io/load",[i,a]);return a},function(a){_d.publish("/dojo/io/error",[i,a]);return a}),i.addBoth(function(a){_d.publish("/dojo/io/done",[i,a]);return a}));i.ioArgs=e;return i};var _deferredCancel=function(a){a.canceled=!0;var b=a.ioArgs.xhr,c=typeof b.abort;("function"==c||"object"==c||"unknown"==c)&&b.abort();a=a.ioArgs.error;a||(a=Error("xhr cancelled"),a.dojoType=
"cancel");return a},_deferredOk=function(a){a=handlers[a.ioArgs.handleAs](a.ioArgs.xhr);return void 0===a?null:a},_deferError=function(a,b){b.ioArgs.args.failOk||console.error(a);return a},_inFlightIntvl=null,_inFlight=[],_pubCount=0,_checkPubCount=function(a){0>=_pubCount&&(_pubCount=0,cfg.ioPublish&&_d.publish&&(!a||a&&!1!==a.ioArgs.args.ioPublish)&&_d.publish("/dojo/io/stop"))},_watchInFlight=function(){var a=(new Date).getTime();if(!_d._blockAsync)for(var b=0,c;b<_inFlight.length&&(c=_inFlight[b]);b++){var d=
c.dfd,e=function(){if(!d||d.canceled||!c.validCheck(d))_inFlight.splice(b--,1),_pubCount-=1;else if(c.ioCheck(d))_inFlight.splice(b--,1),c.resHandle(d),_pubCount-=1;else if(d.startTime&&d.startTime+(d.ioArgs.args.timeout||0)<a){_inFlight.splice(b--,1);var e=Error("timeout exceeded");e.dojoType="timeout";d.errback(e);d.cancel();_pubCount-=1}};if(dojo.config.debugAtAllCosts)e.call(this);else try{e.call(this)}catch(f){d.errback(f)}}_checkPubCount(d);_inFlight.length||(clearInterval(_inFlightIntvl),_inFlightIntvl=
null)};dojo._ioCancelAll=function(){try{_d.forEach(_inFlight,function(a){try{a.dfd.cancel()}catch(c){}})}catch(a){}};_d._ioNotifyStart=function(a){cfg.ioPublish&&_d.publish&&!1!==a.ioArgs.args.ioPublish&&(_pubCount||_d.publish("/dojo/io/start"),_pubCount+=1,_d.publish("/dojo/io/send",[a]))};_d._ioWatch=function(a,b,c,d){var e=a.ioArgs.args;e.timeout&&(a.startTime=(new Date).getTime());_inFlight.push({dfd:a,validCheck:b,ioCheck:c,resHandle:d});_inFlightIntvl||(_inFlightIntvl=setInterval(_watchInFlight,
50));e.sync&&_watchInFlight()};var _defaultContentType="application/x-www-form-urlencoded",_validCheck=function(a){return a.ioArgs.xhr.readyState},_ioCheck=function(a){return 4==a.ioArgs.xhr.readyState},_resHandle=function(a){var b=a.ioArgs.xhr;if(_d._isDocumentOk(b))a.callback(a);else{var c=Error("Unable to load "+a.ioArgs.url+" status:"+b.status);c.status=b.status;c.responseText=b.responseText;a.errback(c)}};dojo._ioAddQueryToUrl=function(a){a.query.length&&(a.url+=(-1==a.url.indexOf("?")?"?":"&")+
a.query,a.query=null)};dojo.xhr=function(a,b,c){var d=_d._ioSetArgs(b,_deferredCancel,_deferredOk,_deferError),e=d.ioArgs,f=e.xhr=_d._xhrObj(e.args);if(!f)return d.cancel(),d;"postData"in b?e.query=b.postData:"putData"in b?e.query=b.putData:"rawBody"in b?e.query=b.rawBody:(2<arguments.length&&!c||-1=="POST|PUT".indexOf(a.toUpperCase()))&&_d._ioAddQueryToUrl(e);f.open(a,e.url,!0!==b.sync,b.user||void 0,b.password||void 0);if(b.headers)for(var g in b.headers)"content-type"===g.toLowerCase()&&!b.contentType?
b.contentType=b.headers[g]:b.headers[g]&&f.setRequestHeader(g,b.headers[g]);!1!==b.contentType&&f.setRequestHeader("Content-Type",b.contentType||_defaultContentType);(!b.headers||!("X-Requested-With"in b.headers))&&f.setRequestHeader("X-Requested-With","XMLHttpRequest");_d._ioNotifyStart(d);if(dojo.config.debugAtAllCosts)f.send(e.query);else try{f.send(e.query)}catch(i){e.error=i,d.cancel()}_d._ioWatch(d,_validCheck,_ioCheck,_resHandle);return d};dojo.xhrGet=function(a){return _d.xhr("GET",a)};dojo.rawXhrPost=
dojo.xhrPost=function(a){return _d.xhr("POST",a,!0)};dojo.rawXhrPut=dojo.xhrPut=function(a){return _d.xhr("PUT",a,!0)};dojo.xhrDelete=function(a){return _d.xhr("DELETE",a)}}dojo._hasResource["mulberry.app.Config"]||(dojo._hasResource["mulberry.app.Config"]=!0,dojo.provide("mulberry.app.Config"),function(){var a={};mulberry.app.Config={get:function(b){return a[b]},set:function(b,c){a=a||{};a[b]=c},registerConfig:function(b){a=b||{}}};mulberry._Config&&mulberry.app.Config.registerConfig(mulberry._Config)}(dojo));
dojo._hasResource["mulberry.Device"]||(dojo._hasResource["mulberry.Device"]=!0,dojo.provide("mulberry.Device"),mulberry._loadDeviceConfig=function(){var a=mulberry,b;if(!(b=mulberry.app.Config.get("device")))b=dojo.body(),b={type:640<Math.min(b.offsetWidth,b.offsetHeight)?"tablet":"phone",os:"browser"};a.Device=b},mulberry._loadDeviceConfig());
dojo._hasResource["mulberry._Nls"]||(dojo._hasResource["mulberry._Nls"]=!0,dojo.provide("mulberry._Nls"),dojo.declare("mulberry._Nls",null,{data:{__initialized:!1},constructor:function(){this.data.__initialized||(this.data.nlsStrings=dojo.i18n.getLocalization("mulberry","mulberry",mulberry.app.Config.get("locale")),this.data.__initialized=!0)},getString:function(a,b){var c=this.data.nlsStrings[a];return b?dojo.string.substitute(c,b):c},postMixInProperties:function(){this.inherited("postMixInProperties",
arguments);this.initializeStrings()},initializeStrings:function(){}}));
dojo._hasResource["vendor.iscroll"]||(dojo._hasResource["vendor.iscroll"]=!0,dojo.provide("vendor.iscroll"),function(){function a(a,u){var o=this,k=document,j;o.wrapper="object"==typeof a?a:k.getElementById(a);o.wrapper.style.overflow="hidden";o.scroller=o.wrapper.children[0];o.options={HWTransition:!0,HWCompositing:!0,hScroll:!0,vScroll:!0,hScrollbar:!0,vScrollbar:!0,fixedScrollbar:g,fadeScrollbar:f&&b||!c,hideScrollbar:f||!c,scrollbarClass:"",bounce:b,bounceLock:!1,momentum:b,lockDirection:!0,zoom:!1,
zoomMin:1,zoomMax:4,snap:!1,pullToRefresh:!1,pullDownLabel:["Pull down to refresh...","Release to refresh...","Loading..."],pullUpLabel:["Pull up to refresh...","Release to refresh...","Loading..."],onPullDown:function(){},onPullUp:function(){},onScrollStart:null,onScrollEnd:null,onZoomStart:null,onZoomEnd:null,checkDOMChange:!1};for(j in u)o.options[j]=u[j];o.options.HWCompositing=o.options.HWCompositing&&e;o.options.HWTransition=o.options.HWTransition&&e;o.scroller.style.cssText=o.options.HWCompositing?
o.scroller.style.cssText+("-webkit-transition-property:-webkit-transform;-webkit-transform-origin:0 0;-webkit-transform:"+q+"0,0"+s):o.scroller.style.cssText+"-webkit-transition-property:top,left;-webkit-transform-origin:0 0;top:0;left:0";o.options.HWTransition&&(o.scroller.style.cssText+="-webkit-transition-timing-function:cubic-bezier(0.33,0.66,0.66,1);-webkit-transition-duration:0;");o.options.hScrollbar=o.options.hScroll&&o.options.hScrollbar;o.options.vScrollbar=o.options.vScroll&&o.options.vScrollbar;
o.pullDownToRefresh="down"==o.options.pullToRefresh||"both"==o.options.pullToRefresh;o.pullUpToRefresh="up"==o.options.pullToRefresh||"both"==o.options.pullToRefresh;o.pullDownToRefresh&&(j=k.createElement("div"),j.className="iScrollPullDown",j.innerHTML='<span class="iScrollPullDownIcon"></span><span class="iScrollPullDownLabel">'+o.options.pullDownLabel[0]+"</span>\n",o.scroller.insertBefore(j,o.scroller.children[0]),o.options.bounce=!0,o.pullDownEl=j,o.pullDownLabel=j.getElementsByTagName("span")[1]);
o.pullUpToRefresh&&(j=k.createElement("div"),j.className="iScrollPullUp",j.innerHTML='<span class="iScrollPullUpIcon"></span><span class="iScrollPullUpLabel">'+o.options.pullUpLabel[0]+"</span>\n",o.scroller.appendChild(j),o.options.bounce=!0,o.pullUpEl=j,o.pullUpLabel=j.getElementsByTagName("span")[1]);o.refresh();o._bind(i,window);o._bind(h);d&&o.options.zoom&&(o._bind("gesturestart"),o.scroller.style.webkitTransform+=" scale(1)");c||o._bind("mousewheel");o.options.checkDOMChange&&(o.DOMChangeInterval=
setInterval(function(){o._checkSize()},250))}a.prototype={x:0,y:0,currPageX:0,currPageY:0,pagesX:[],pagesY:[],offsetBottom:0,offsetTop:0,scale:1,lastScale:1,contentReady:!0,handleEvent:function(a){switch(a.type){case h:this._start(a);break;case k:this._move(a);break;case j:case p:this._end(a);break;case "webkitTransitionEnd":this._transitionEnd(a);break;case i:this._resize();break;case "gesturestart":this._gestStart(a);break;case "gesturechange":this._gestChange(a);break;case "gestureend":case "gesturecancel":this._gestEnd(a);
break;case "mousewheel":this._wheel(a)}},_scrollbar:function(a){var b=document,c;this[a+"Scrollbar"]?(this[a+"ScrollbarWrapper"]||(c=b.createElement("div"),this.options.scrollbarClass?c.className=this.options.scrollbarClass+a.toUpperCase():c.style.cssText="position:absolute;z-index:100;"+("h"==a?"height:7px;bottom:1px;left:2px;right:7px":"width:7px;bottom:7px;top:2px;right:1px"),c.style.cssText+="pointer-events:none;-webkit-transition-property:opacity;-webkit-transition-duration:"+(this.options.fadeScrollbar?
"350ms":"0")+";overflow:hidden;opacity:"+(this.options.hideScrollbar?"0":"1"),this.wrapper.appendChild(c),this[a+"ScrollbarWrapper"]=c,c=b.createElement("div"),this.options.scrollbarClass||(c.style.cssText="position:absolute;z-index:100;background:rgba(0,0,0,0.5);border:1px solid rgba(255,255,255,0.9);-webkit-background-clip:padding-box;-webkit-box-sizing:border-box;"+("h"==a?"height:100%;-webkit-border-radius:4px 3px;":"width:100%;-webkit-border-radius:3px 4px;")),c.style.cssText+="pointer-events:none;-webkit-transition-property:-webkit-transform;-webkit-transition-timing-function:cubic-bezier(0.33,0.66,0.66,1);-webkit-transition-duration:0;-webkit-transform:"+
q+"0,0"+s,this[a+"ScrollbarWrapper"].appendChild(c),this[a+"ScrollbarIndicator"]=c),"h"==a?(this.hScrollbarSize=this.hScrollbarWrapper.clientWidth,this.hScrollbarIndicatorSize=n.max(n.round(this.hScrollbarSize*this.hScrollbarSize/this.scrollerW),8),this.hScrollbarIndicator.style.width=this.hScrollbarIndicatorSize+"px",this.hScrollbarMaxScroll=this.hScrollbarSize-this.hScrollbarIndicatorSize,this.hScrollbarProp=this.hScrollbarMaxScroll/this.maxScrollX):(this.vScrollbarSize=this.vScrollbarWrapper.clientHeight,
this.vScrollbarIndicatorSize=n.max(n.round(this.vScrollbarSize*this.vScrollbarSize/this.scrollerH),8),this.vScrollbarIndicator.style.height=this.vScrollbarIndicatorSize+"px",this.vScrollbarMaxScroll=this.vScrollbarSize-this.vScrollbarIndicatorSize,this.vScrollbarProp=this.vScrollbarMaxScroll/this.maxScrollY),this._indicatorPos(a,!0)):this[a+"ScrollbarWrapper"]&&(this[a+"ScrollbarIndicator"].style.webkitTransform="",this[a+"ScrollbarWrapper"].parentNode.removeChild(this[a+"ScrollbarWrapper"]),this[a+
"ScrollbarWrapper"]=null,this[a+"ScrollbarIndicator"]=null)},_resize:function(){var a=this;setTimeout(function(){a.refresh()},0)},_checkSize:function(){var a,b;!this.moved&&!this.zoomed&&this.contentReady&&(a=n.round(this.scroller.offsetWidth*this.scale),b=n.round((this.scroller.offsetHeight-this.offsetBottom-this.offsetTop)*this.scale),a==this.scrollerW&&b==this.scrollerH||this.refresh())},_pos:function(a,b){this.x=this.hScroll?a:0;this.y=this.vScroll?b:0;this.scroller.style.webkitTransform=q+this.x+
"px,"+this.y+"px"+s+" scale("+this.scale+")";this._indicatorPos("h");this._indicatorPos("v")},_indicatorPos:function(a,b){var c="h"==a?this.x:this.y;this[a+"Scrollbar"]&&(c*=this[a+"ScrollbarProp"],0>c?(c=this.options.fixedScrollbar?0:c+3*c,9>this[a+"ScrollbarIndicatorSize"]+c&&(c=-this[a+"ScrollbarIndicatorSize"]+8)):c>this[a+"ScrollbarMaxScroll"]&&(c=this.options.fixedScrollbar?this[a+"ScrollbarMaxScroll"]:c+3*(c-this[a+"ScrollbarMaxScroll"]),9>this[a+"ScrollbarIndicatorSize"]+this[a+"ScrollbarMaxScroll"]-
c&&(c=this[a+"ScrollbarIndicatorSize"]+this[a+"ScrollbarMaxScroll"]-8)),this[a+"ScrollbarWrapper"].style.webkitTransitionDelay="0",this[a+"ScrollbarWrapper"].style.opacity=b&&this.options.hideScrollbar?"0":"1",this[a+"ScrollbarIndicator"].style.webkitTransform=q+("h"==a?c+"px,0":"0,"+c+"px")+s)},_transitionTime:function(a){a+="ms";this.scroller.style.webkitTransitionDuration=a;this.hScrollbar&&(this.hScrollbarIndicator.style.webkitTransitionDuration=a);this.vScrollbar&&(this.vScrollbarIndicator.style.webkitTransitionDuration=
a)},_start:function(a){var b=c?a.changedTouches[0]:a,e;this.moved=!1;if({SELECT:1,INPUT:1,BUTTON:1,TEXTAREA:1}[a.target.tagName])return!0;a.preventDefault();c&&2==a.touches.length&&this.options.zoom&&d&&!this.zoomed&&(this.originX=n.abs(a.touches[0].pageX+a.touches[1].pageX-2*this.wrapperOffsetLeft)/2-this.x,this.originY=n.abs(a.touches[0].pageY+a.touches[1].pageY-2*this.wrapperOffsetTop)/2-this.y);this.moved=!1;this.returnTime=this.dirY=this.dirX=this.absDistY=this.absDistX=this.distY=this.distX=
0;this._transitionTime(0);if(this.options.momentum)if(this.scrollInterval&&(clearInterval(this.scrollInterval),this.scrollInterval=null),this.options.HWCompositing){if(e=new WebKitCSSMatrix(window.getComputedStyle(this.scroller,null).webkitTransform),e.m41!=this.x||e.m42!=this.y)this._unbind("webkitTransitionEnd"),this._pos(e.m41,e.m42)}else if(e=window.getComputedStyle(this.scroller,null),this.x+"px"!=e.left||this.y+"px"!=e.top)this._unbind("webkitTransitionEnd"),this._pos(1*e.left.replace(/[^0-9]/g),
1*e.top.replace(/[^0-9]/g));this.scroller.style.webkitTransitionTimingFunction="cubic-bezier(0.33,0.66,0.66,1)";this.hScrollbar&&(this.hScrollbarIndicator.style.webkitTransitionTimingFunction="cubic-bezier(0.33,0.66,0.66,1)");this.vScrollbar&&(this.vScrollbarIndicator.style.webkitTransitionTimingFunction="cubic-bezier(0.33,0.66,0.66,1)");this.startX=this.x;this.startY=this.y;this.pointX=b.pageX;this.pointY=b.pageY;this.startTime=a.timeStamp;this.options.onScrollStart&&this.options.onScrollStart.call(this);
this._bind(k);this._bind(j);this._bind(p)},_move:function(a){if(!(c&&1<a.touches.length)){var b=c?a.changedTouches[0]:a,d=b.pageX-this.pointX,e=b.pageY-this.pointY,f=this.x+d,h=this.y+e;a.preventDefault();this.pointX=b.pageX;this.pointY=b.pageY;if(0<f||f<this.maxScrollX)f=this.options.bounce?this.x+d/2.4:0<=f||0<=this.maxScrollX?0:this.maxScrollX;if(0<h||h<this.maxScrollY)h=this.options.bounce?this.y+e/2.4:0<=h||0<=this.maxScrollY?0:this.maxScrollY,this.options.pullToRefresh&&this.contentReady&&(this.pullDownToRefresh&&
h>this.offsetBottom?(this.pullDownEl.className="iScrollPullDown flip",this.pullDownLabel.innerText=this.options.pullDownLabel[1]):this.pullDownToRefresh&&this.pullDownEl.className.match("flip")&&(this.pullDownEl.className="iScrollPullDown",this.pullDownLabel.innerText=this.options.pullDownLabel[0]),this.pullUpToRefresh&&h<this.maxScrollY-this.offsetTop?(this.pullUpEl.className="iScrollPullUp flip",this.pullUpLabel.innerText=this.options.pullUpLabel[1]):this.pullUpToRefresh&&this.pullUpEl.className.match("flip")&&
(this.pullUpEl.className="iScrollPullUp",this.pullUpLabel.innerText=this.options.pullUpLabel[0]));4>this.absDistX&&4>this.absDistY?(this.distX+=d,this.distY+=e,this.absDistX=n.abs(this.distX),this.absDistY=n.abs(this.distY)):(this.options.lockDirection&&(this.absDistX>this.absDistY+3?(h=this.y,e=0):this.absDistY>this.absDistX+3&&(f=this.x,d=0)),this.moved=!0,this._pos(f,h),this.dirX=0<d?-1:0>d?1:0,this.dirY=0<e?-1:0>e?1:0,300<a.timeStamp-this.startTime&&(this.startTime=a.timeStamp,this.startX=this.x,
this.startY=this.y))}},_end:function(a){if(!(c&&0!=a.touches.length)){var b=this,d=c?a.changedTouches[0]:a,e,f,h={dist:0,time:0},g={dist:0,time:0},i=a.timeStamp-b.startTime,w=b.x,q=b.y;b._unbind(k);b._unbind(j);b._unbind(p);if(!b.zoomed)if(b.moved){b.pullDownToRefresh&&b.contentReady&&b.pullDownEl.className.match("flip")&&(b.pullDownEl.className="iScrollPullDown loading",b.pullDownLabel.innerText=b.options.pullDownLabel[2],b.scroller.style.marginTop="0",b.offsetBottom=0,b.refresh(),b.contentReady=
!1,b.options.onPullDown());b.pullUpToRefresh&&b.contentReady&&b.pullUpEl.className.match("flip")&&(b.pullUpEl.className="iScrollPullUp loading",b.pullUpLabel.innerText=b.options.pullUpLabel[2],b.scroller.style.marginBottom="0",b.offsetTop=0,b.refresh(),b.contentReady=!1,b.options.onPullUp());if(300>i&&b.options.momentum){h=w?b._momentum(w-b.startX,i,-b.x,b.scrollerW-b.wrapperW+b.x,b.options.bounce?b.wrapperW:0):h;g=q?b._momentum(q-b.startY,i,-b.y,0>b.maxScrollY?b.scrollerH-b.wrapperH+b.y:0,b.options.bounce?
b.wrapperH:0):g;w=b.x+h.dist;q=b.y+g.dist;if(0<b.x&&0<w||b.x<b.maxScrollX&&w<b.maxScrollX)h={dist:0,time:0};if(0<b.y&&0<q||b.y<b.maxScrollY&&q<b.maxScrollY)g={dist:0,time:0}}h.dist||g.dist?(h=n.max(n.max(h.time,g.time),10),b.options.snap&&(g=b._snap(w,q),w=g.x,q=g.y,h=n.max(g.time,h)),b.scrollTo(w,q,h)):b.options.snap?(g=b._snap(b.x,b.y),(g.x!=b.x||g.y!=b.y)&&b.scrollTo(g.x,g.y,g.time)):b._resetPos()}else c&&(b.doubleTapTimer&&b.options.zoom?(clearTimeout(b.doubleTapTimer),b.doubleTapTimer=null,b.zoom(b.pointX,
b.pointY,1==b.scale?2:1)):b.doubleTapTimer=setTimeout(function(){b.doubleTapTimer=null;for(e=d.target;1!=e.nodeType;)e=e.parentNode;f=document.createEvent("MouseEvents");f.initMouseEvent("click",!0,!0,a.view,1,d.screenX,d.screenY,d.clientX,d.clientY,a.ctrlKey,a.altKey,a.shiftKey,a.metaKey,0,null);f._fake=!0;e.dispatchEvent(f)},b.options.zoom?250:0)),b._resetPos()}},_resetPos:function(a){var b=this.x,c=this.y;0<=this.x?b=0:this.x<this.maxScrollX&&(b=this.maxScrollX);0<=this.y||0<this.maxScrollY?c=
0:this.y<this.maxScrollY&&(c=this.maxScrollY);b==this.x&&c==this.y?(this.moved&&(this.options.onScrollEnd&&this.options.onScrollEnd.call(this),this.moved=!1),this.zoomed&&(this.options.onZoomEnd&&this.options.onZoomEnd.call(this),this.zoomed=!1),this.hScrollbar&&this.options.hideScrollbar&&(this.hScrollbarWrapper.style.webkitTransitionDelay="300ms",this.hScrollbarWrapper.style.opacity="0"),this.vScrollbar&&this.options.hideScrollbar&&(this.vScrollbarWrapper.style.webkitTransitionDelay="300ms",this.vScrollbarWrapper.style.opacity=
"0")):(void 0===a&&(a=200),a&&(this.scroller.style.webkitTransitionTimingFunction="cubic-bezier(0.33,0.0,0.33,1)",this.hScrollbar&&(this.hScrollbarIndicator.style.webkitTransitionTimingFunction="cubic-bezier(0.33,0.0,0.33,1)"),this.vScrollbar&&(this.vScrollbarIndicator.style.webkitTransitionTimingFunction="cubic-bezier(0.33,0.0,0.33,1)")),this.scrollTo(b,c,a))},_timedScroll:function(a,b,c){var d=this,e=d.x,f=d.y,h=(new Date).getTime(),g;d._transitionTime(0);d.scrollInterval&&(clearInterval(d.scrollInterval),
d.scrollInterval=null);d.scrollInterval=setInterval(function(){var i=(new Date).getTime();i>=h+c?(clearInterval(d.scrollInterval),d.scrollInterval=null,d._pos(a,b),d._transitionEnd()):(i=(i-h)/c-1,g=n.sqrt(1-i*i),i=(a-e)*g+e,d._pos(i,(b-f)*g+f))},20)},_transitionEnd:function(a){a&&a.stopPropagation();this._unbind("webkitTransitionEnd");this._resetPos(this.returnTime);this.returnTime=0},_gestStart:function(){this._transitionTime(0);this.lastScale=1;this.options.onZoomStart&&this.options.onZoomStart.call(this);
this._unbind("gesturestart");this._bind("gesturechange");this._bind("gestureend");this._bind("gesturecancel")},_gestChange:function(a){var a=this.scale*a.scale,b;this.zoomed=!0;a<this.options.zoomMin?a=this.options.zoomMin:a>this.options.zoomMax&&(a=this.options.zoomMax);b=a/this.scale;this.scroller.style.webkitTransform=q+(this.originX-this.originX*b+this.x)+"px,"+(this.originY-this.originY*b+this.y)+"px"+s+" scale("+a+")";this.lastScale=b},_gestEnd:function(){var a=this,b=a.scale,c=a.lastScale;
a.scale=b*c;a.scale<a.options.zoomMin+0.05?a.scale=a.options.zoomMin:a.scale>a.options.zoomMax-0.05&&(a.scale=a.options.zoomMax);c=a.scale/b;a.x=a.originX-a.originX*c+a.x;a.y=a.originY-a.originY*c+a.y;a.scroller.style.webkitTransform=q+a.x+"px,"+a.y+"px"+s+" scale("+a.scale+")";setTimeout(function(){a.refresh()},0);a._bind("gesturestart");a._unbind("gesturechange");a._unbind("gestureend");a._unbind("gesturecancel")},_wheel:function(a){var b=this.x+a.wheelDeltaX/12,a=this.y+a.wheelDeltaY/12;0<b?b=
0:b<this.maxScrollX&&(b=this.maxScrollX);0<a?a=0:a<this.maxScrollY&&(a=this.maxScrollY);this.scrollTo(b,a,0)},_momentum:function(a,b,c,d,e){var b=n.abs(a)/b,f=b*b/0.0012,h=0;0<a&&f>c?(h=e/(6/(6.0E-4*(f/b))),c+=h,this.returnTime=800/e*h+100,b=b*c/f,f=c):0>a&&f>d&&(h=e/(6/(6.0E-4*(f/b))),d+=h,this.returnTime=800/e*h+100,b=b*d/f,f=d);return{dist:f*(0>a?-1:1),time:n.round(b/6.0E-4)}},_offset:function(a,b){var c=-a.offsetLeft,d=-a.offsetTop;if(!b)return{x:c,y:d};for(;a=a.offsetParent;)c-=a.offsetLeft,
d-=a.offsetTop;return{x:c,y:d}},_snap:function(a,b){var c,d,e;e=this.pagesX.length-1;for(c=0,d=this.pagesX.length;c<d;c++)if(a>=this.pagesX[c]){e=c;break}e==this.currPageX&&0<e&&0>this.dirX&&e--;a=this.pagesX[e];d=(d=n.abs(a-this.pagesX[this.currPageX]))?500*(n.abs(this.x-a)/d):0;this.currPageX=e;e=this.pagesY.length-1;for(c=0;c<e;c++)if(b>=this.pagesY[c]){e=c;break}e==this.currPageY&&0<e&&0>this.dirY&&e--;b=this.pagesY[e];c=(c=n.abs(b-this.pagesY[this.currPageY]))?500*(n.abs(this.y-b)/c):0;this.currPageY=
e;e=n.round(n.max(d,c))||200;return{x:a,y:b,time:e}},_bind:function(a,b){(b||this.scroller).addEventListener(a,this,!1)},_unbind:function(a,b){(b||this.scroller).removeEventListener(a,this,!1)},destroy:function(){this.options.checkDOMChange&&clearTimeout(this.DOMChangeInterval);this.pullDownToRefresh&&this.pullDownEl.parentNode.removeChild(this.pullDownEl);this.pullUpToRefresh&&this.pullUpEl.parentNode.removeChild(this.pullUpEl);this.vScrollbar=this.hScrollbar=!1;this._scrollbar("h");this._scrollbar("v");
this.scroller.style.webkitTransform="";this._unbind("webkitTransitionEnd");this._unbind(i);this._unbind(h);this._unbind(k);this._unbind(j);this._unbind(p);this.options.zoom&&(this._unbind("gesturestart"),this._unbind("gesturechange"),this._unbind("gestureend"),this._unbind("gesturecancel"))},refresh:function(){var a=0,b=0,c,d,e;this.pullDownToRefresh&&((c=this.pullDownEl.className.match("loading"))&&!this.contentReady?(e=this.scrollerH,this.contentReady=!0,this.pullDownEl.className="iScrollPullDown",
this.pullDownLabel.innerText=this.options.pullDownLabel[0],this.offsetBottom=this.pullDownEl.offsetHeight,this.scroller.style.marginTop=-this.offsetBottom+"px"):c||(this.offsetBottom=this.pullDownEl.offsetHeight,this.scroller.style.marginTop=-this.offsetBottom+"px"));this.pullUpToRefresh&&((c=this.pullUpEl.className.match("loading"))&&!this.contentReady?(e=this.scrollerH,this.contentReady=!0,this.pullUpEl.className="iScrollPullUp",this.pullUpLabel.innerText=this.options.pullUpLabel[0],this.offsetTop=
this.pullUpEl.offsetHeight,this.scroller.style.marginBottom=-this.offsetTop+"px"):c||(this.offsetTop=this.pullUpEl.offsetHeight,this.scroller.style.marginBottom=-this.offsetTop+"px"));this.wrapperW=this.wrapper.clientWidth;this.wrapperH=this.wrapper.clientHeight;if(!this.wrapperW||!this.wrapperH)return!1;this.scrollerW=n.round(this.scroller.offsetWidth*this.scale);this.scrollerH=n.round((this.scroller.offsetHeight-this.offsetBottom-this.offsetTop)*this.scale);this.maxScrollX=this.wrapperW-this.scrollerW;
this.maxScrollY=this.wrapperH-this.scrollerH;this.dirY=this.dirX=0;this._transitionTime(0);this.hScroll=this.options.hScroll&&0>this.maxScrollX;this.vScroll=this.options.vScroll&&(!this.options.bounceLock&&!this.hScroll||this.scrollerH>this.wrapperH);this.hScrollbar=this.hScroll&&this.options.hScrollbar;this.vScrollbar=this.vScroll&&this.options.vScrollbar&&this.scrollerH>this.wrapperH;this._scrollbar("h");this._scrollbar("v");if("string"==typeof this.options.snap){this.pagesX=[];this.pagesY=[];d=
this.scroller.querySelectorAll(this.options.snap);for(b=0,c=d.length;b<c;b++)a=this._offset(d[b]),this.pagesX[b]=a.x<this.maxScrollX?this.maxScrollX:a.x*this.scale,this.pagesY[b]=a.y<this.maxScrollY?this.maxScrollY:a.y*this.scale}else if(this.options.snap){for(this.pagesX=[];a>=this.maxScrollX;)this.pagesX[b]=a,a-=this.wrapperW,b++;this.maxScrollX%this.wrapperW&&(this.pagesX[this.pagesX.length]=this.maxScrollX-this.pagesX[this.pagesX.length-1]+this.pagesX[this.pagesX.length-1]);b=a=0;for(this.pagesY=
[];a>=this.maxScrollY;)this.pagesY[b]=a,a-=this.wrapperH,b++;this.maxScrollY%this.wrapperH&&(this.pagesY[this.pagesY.length]=this.maxScrollY-this.pagesY[this.pagesY.length-1]+this.pagesY[this.pagesY.length-1])}this.options.zoom&&(a=this._offset(this.wrapper,!0),this.wrapperOffsetLeft=-a.x,this.wrapperOffsetTop=-a.y);e&&0==this.y&&(e=e-this.scrollerH+this.y,this.scrollTo(0,e,0));this._resetPos()},scrollTo:function(a,b,c,d){var e=this;d&&(a=e.x-a,b=e.y-b);c=!c||n.round(e.x)==n.round(a)&&n.round(e.y)==
n.round(b)?0:c;e.moved=!0;e.options.HWTransition?(c&&e._bind("webkitTransitionEnd"),e._transitionTime(c),e._pos(a,b),c||setTimeout(function(){e._transitionEnd()},0)):e._timedScroll(a,b,c)},scrollToElement:function(a,b){var c;if(a=a.nodeType?a:this.scroller.querySelector(a))c=this._offset(a),c.x=0<c.x?0:c.x<this.maxScrollX?this.maxScrollX:c.x,c.y=0<c.y?0:c.y<this.maxScrollY?this.maxScrollY:c.y,b=void 0===b?n.max(2*n.abs(c.x),2*n.abs(c.y)):b,this.scrollTo(c.x,c.y,b)},scrollToPage:function(a,b,c){this.options.snap?
(a="next"==a?this.currPageX+1:"prev"==a?this.currPageX-1:a,b="next"==b?this.currPageY+1:"prev"==b?this.currPageY-1:b,a=0>a?0:a>this.pagesX.length-1?this.pagesX.length-1:a,b=0>b?0:b>this.pagesY.length-1?this.pagesY.length-1:b,this.currPageX=a,this.currPageY=b,a=this.pagesX[a],b=this.pagesY[b]):(a*=-this.wrapperW,b*=-this.wrapperH,a<this.maxScrollX&&(a=this.maxScrollX),b<this.maxScrollY&&(b=this.maxScrollY));this.scrollTo(a,b,c||400)},zoom:function(a,b,c,d){var e=this,f=c/e.scale,a=a-e.wrapperOffsetLeft-
e.x,b=b-e.wrapperOffsetTop-e.y;e.x=a-a*f+e.x;e.y=b-b*f+e.y;e.scale=c;e.options.onZoomStart&&e.options.onZoomStart.call(e);e.refresh();e._bind("webkitTransitionEnd");e._transitionTime(null!==d?d:200);setTimeout(function(){e.zoomed=!0;e.scroller.style.webkitTransform=q+e.x+"px,"+e.y+"px"+s+" scale("+c+")"},0)}};var b="WebKitCSSMatrix"in window&&"m11"in new WebKitCSSMatrix,c="ontouchstart"in window,d="ongesturestart"in window,e="WebKitTransitionEvent"in window,f=/iphone|ipad/gi.test(navigator.appVersion),
g=/android/gi.test(navigator.appVersion),i="onorientationchange"in window?"orientationchange":"resize",h=c?"touchstart":"mousedown",k=c?"touchmove":"mousemove",j=c?"touchend":"mouseup",p=c?"touchcancel":"mouseup",q="translate"+(b?"3d(":"("),s=b?",0)":")",n=Math;"undefined"!==typeof exports?exports.iScroll=a:window.iScroll=a}());
dojo._hasResource["mulberry.ui.Scrollable"]||(dojo._hasResource["mulberry.ui.Scrollable"]=!0,dojo.provide("mulberry.ui.Scrollable"),dojo.declare("mulberry.ui.Scrollable",dijit._Widget,{postCreate:function(){this.inherited(arguments);this.subscribe("/page/transition/end","_makeScroller");this.subscribe("/window/resize","refreshScroller");this.subscribe("/fontsize","refreshScroller");this.subscribe("/content/update",function(){this.refreshScroller();this.scroller&&this.scroller.scrollTo(0,0)});dojo.addClass(this.domNode,
"scrollable")},_makeScroller:function(){1<this.domNode.children.length&&console.error("mulberry.ui.Scrollable::_makeScroller: More than one child element. Only the first one will be scrollable. Probably not what you want!");this.scroller=new iScroll(this.domNode,{vScrollbar:!1,onScrollStart:dojo.hitch(this,"onScrollStart"),onScrollEnd:dojo.hitch(this,"onScrollEnd")});this.scroller.refresh()},makeScroller:function(){this.scroller||this._makeScroller()},destroy:function(){this.scroller&&this.scroller.destroy();
this.inherited(arguments)},refreshScroller:function(){this.scroller&&this.scroller.refresh()},onScrollStart:function(){},onScrollEnd:function(){}}));
dojo._hasResource["mulberry.ui.Clickable"]||(dojo._hasResource["mulberry.ui.Clickable"]=!0,dojo.provide("mulberry.ui.Clickable"),dojo.declare("mulberry.ui.Clickable",null,{constructor:function(a,b){this.connections=[];this.secondaryConnections=[];this.subscriptions=[];this.handler=b;this.el=a;this.moved=!1;dojo.addClass(this.el,"not-moving");mulberry.app.UI.hasTouch?(this.connections.push(dojo.connect(a,"touchstart",this,"_onTouchStart")),this.connections.push(dojo.connect(a,"click",function(a){a.preventDefault()}))):
this.connections.push(dojo.connect(a,"click",this,"_handle"))},_onTouchStart:function(){this.touchStartTime=(new Date).getTime();this.secondaryConnections=[dojo.connect(this.el,"touchmove",this,"_onTouchMove"),dojo.connect(this.el,"touchend",this,"_handle")]},_onTouchMove:function(){dojo.removeClass(this.el,"not-moving");this.moved=!0},_handle:function(a){this.touchEndTime=(new Date).getTime();dojo.addClass(this.el,"not-moving");dojo.forEach(this.secondaryConnections||[],dojo.disconnect);this.secondaryConnections=
[];if(mulberry.animating)a.preventDefault(),console.log("click ignored during animation");else{var b=a.target,c=dojo.attr(b,"href");if(this.touchStartTime&&this.touchEndTime-this.touchStartTime>mulberry.app.UI.touchMoveDebounce&&this.moved)this.moved=!1;else{for(;!c&&b!==this.el;)c=dojo.attr(b,"href"),c||(b=b.parentNode);if(c&&(!this.handler||!(dojo.isFunction(this.handler)&&!1===this.handler(b,a)))&&/#/.test(c))if(c=c.split("#")[1])a.preventDefault(),a.stopPropagation(),mulberry.app.Router.go(c)}}},
destroy:function(){dojo.forEach(this.connections||[],dojo.disconnect);dojo.forEach(this.secondaryConnections||[],dojo.disconnect);dojo.forEach(this.subscriptions||[],dojo.unsubscribe)}}));
if(!dojo._hasResource["vendor.mustache"]){dojo._hasResource["vendor.mustache"]=!0;dojo.provide("vendor.mustache");var Mustache="undefined"!==typeof module&&module.exports||{};(function(a){function b(a){return(""+a).replace(/&(?!\w+;)|[<>"']/g,function(a){return J[a]||a})}function c(a,b,c,d){for(var d=d||"<template>",e=b.split("\n"),f=Math.max(c-3,0),h=Math.min(e.length,c+3),e=e.slice(f,h),g=0,i=e.length;g<i;++g)h=g+f+1,e[g]=(h===c?" >> ":"    ")+e[g];a.template=b;a.line=c;a.file=d;a.message=[d+":"+
c,e.join("\n"),"",a.message].join("\n");return a}function d(a,b,c){if("."===a)return b[b.length-1];for(var a=a.split("."),d=a.length-1,e=a[d],f,h,g=b.length,i,z;g;){z=b.slice(0);h=b[--g];for(i=0;i<d;){h=h[a[i++]];if(null==h)break;z.push(h)}if(h&&e in h){f=h[e];break}}"function"===typeof f&&(f=f.call(z[z.length-1]));return null==f&&!c?"":f}function e(a,b,c,e,f){b=d(b,e,!0);if(f)(null==b||!1===b||s(b)&&0===b.length)&&a(c());else if(s(b))n(b,function(b){e.push(b);a(c());e.pop()});else if("object"===
typeof b)e.push(b),a(c()),e.pop();else if("function"===typeof b){var g=e[e.length-1];a(b.call(g,c(),function(a){return h(a,g)})||"")}else b&&a(c())}function f(b,d){for(var d=d||{},e=d.tags||a.tags,f=e[0],h=e[e.length-1],g=["var line = 1;","\ntry {",'\nsend("'],i=[],k=!1,j=!1,z=function(){if(k&&!j&&!d.space)for(;i.length;)g.splice(i.pop(),1);else i=[];j=k=!1},B=[],L,n,o,p=function(a){e=u(a).split(/\s+/);n=e[0];o=e[e.length-1]},q=function(a){g.push('");',L,'\nvar partial = partials["'+u(a)+'"];',"\nif (partial) {",
"\n  send(render(partial, stack[stack.length - 1], partials));","\n}",'\nsend("')},s=function(a,e){var f=u(a);if(""===f)throw c(Error("Section name may not be empty"),b,m,d.file);B.push({name:f,inverted:e});g.push('");',L,'\nvar name = "'+f+'";',"\nvar callback = (function () {","\n  var buffer, send = function (chunk) { buffer.push(chunk); };","\n  return function () {","\n    buffer = [];",'\nsend("')},E=function(a){s(a,!0)},H=function(a){var a=u(a),d=0!=B.length&&B[B.length-1].name;if(!d||a!=d)throw c(Error('Section named "'+
a+'" was never opened'),b,m,file);a=B.pop();g.push('");','\n    return buffer.join("");',"\n  };","\n})();");a.inverted?g.push("\nsendSection(send,name,callback,stack,true);"):g.push("\nsendSection(send,name,callback,stack);");g.push('\nsend("')},aa=function(a){g.push('");',L,'\nsend(findName("'+u(a)+'", stack));','\nsend("')},C=function(a){g.push('");',L,'\nsend(escapeHTML(findName("'+u(a)+'", stack)));','\nsend("')},m=1,v,t,r=0,J=b.length;r<J;++r)if(b.slice(r,r+f.length)===f){r+=f.length;v=b.substr(r,
1);L="\nline = "+m+";";n=f;o=h;k=!0;switch(v){case "!":r++;t=null;break;case "=":r++;h="="+h;t=p;break;case ">":r++;t=q;break;case "#":r++;t=s;break;case "^":r++;t=E;break;case "/":r++;t=H;break;case "{":h="}"+h;case "&":r++;j=!0;t=aa;break;default:j=!0,t=C}v=b.indexOf(h,r);if(-1===v)throw c(Error('Tag "'+f+'" was not closed properly'),b,m,d.file);f=b.substring(r,v);t&&t(f);for(t=0;~(t=f.indexOf("\n",t));)m++,t++;r=v+h.length-1;f=n;h=o}else switch(v=b.substr(r,1),v){case '"':case "\\":j=!0;g.push("\\"+
v);break;case "\n":i.push(g.length);g.push("\\n");z();m++;break;default:A.test(v)?i.push(g.length):j=!0,g.push(v)}if(0!=B.length)throw c(Error('Section "'+B[B.length-1].name+'" was not closed properly'),b,m,d.file);z();g.push('");',"\nsend(null);","\n} catch (e) { throw {error: e, line: line}; }");h=g.join("").replace(/send\(""\);\n/g,"");d.debug&&("undefined"!=typeof console&&console.log?console.log(h):"function"===typeof print&&print(h));return h}function g(a,g){var i=f(a,g),k=new Function("view,partials,send,stack,findName,escapeHTML,sendSection,render",
i);return function(f,i,j){"function"===typeof i&&(j=i,i={});var i=i||{},n=[],o=[f];try{k(f,i,j||function(a){n.push(a)},o,d,b,e,h)}catch(z){throw c(z.error,a,z.line,g.file);}return n.join("")}}function i(a,b){b=b||{};return!1!==b.cache?(F[a]||(F[a]=g(a,b)),F[a]):g(a,b)}function h(a,b,c,d){return i(a)(b,c,d)}a.name="mustache.js";a.version="0.5.0-dev";a.tags=["{{","}}"];a.parse=f;a.compile=i;a.render=h;a.clearCache=function(){F={}};a.to_html=h;var k=Object.prototype.toString,j=Array.isArray,p=Array.prototype.forEach,
q=String.prototype.trim,s;s=j?j:function(a){return"[object Array]"===k.call(a)};var n;n=p?function(a,b,c){return p.call(a,b,c)}:function(a,b,c){for(var d=0,e=a.length;d<e;++d)b.call(c,a[d],d,a)};var A=/^\s*$/,u;if(q)u=function(a){return null==a?"":q.call(a)};else{var o,C;A.test("\u00a0")?(o=/^\s+/,C=/\s+$/):(o=/^[\s\xA0]+/,C=/[\s\xA0]+$/);u=function(a){return null==a?"":(""+a).replace(o,"").replace(C,"")}}var J={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},F={}})(Mustache)}
dojo._hasResource["mulberry._View"]||(dojo._hasResource["mulberry._View"]=!0,dojo.provide("mulberry._View"),function(){var a={},b={haml:{firstChars:[".","%"],tmplFn:Haml},mustache:{firstChars:["{","<"],tmplFn:function(a){return dojo.partial(Mustache.render,a)}}};dojo.declare("mulberry._View",[dijit._Widget,dijit._Templated,mulberry._Nls],{templateString:"%div",isHidden:!1,isDisabled:!1,postMixInProperties:function(){this.inherited(arguments);this.device||(this.device=mulberry.Device);this.phone="phone"===
this.device.type;this.tablet="tablet"===this.device.type},_skipNodeCache:!0,_stringRepl:function(c){var d=a[c];d||dojo.forIn(b,function(b,f){d||-1<dojo.indexOf(f.firstChars,c[0])&&(d=a[c]=f.tmplFn(c))});return d(this)},postCreate:function(){this.inherited(arguments)},adopt:function(a,b,e){a=new a(b,e);this._addItem(a);return a},_addItem:function(){this._addedItems=this._addedItems||[];this._addedItems.push.apply(this._addedItems,arguments)},orphan:function(a,b){this._addedItems=this._addedItems||
[];var e=dojo.indexOf(this._addedItems,a);0<=e&&this._addedItems.splice(e,1);b&&this._kill(a)},_kill:function(a){a&&a.destroyRecursive?a.destroyRecursive():a&&a.destroy&&a.destroy()},query:function(a){var b;if(a)a=this.domNode.querySelectorAll(a),b=new dojo.NodeList,dojo.forEach(a,function(a){b.push(a)});else return new dojo.NodeList(this.domNode);return b},preventClickDelay:function(a,b){this.clickables=this.clickables||[];this.clickables.push(new mulberry.ui.Clickable(a,dojo.hitch(this,b)))},destroy:function(){dojo.forEach(this._addedItems,
this._kill);dojo.forEach(this.scrollerHandles||[],function(a){a.destroy()});dojo.forEach(this.clickables||[],function(a){a.destroy()});this.inherited(arguments)},addClass:function(a){dojo.addClass(this.domNode,a)},removeClass:function(a){dojo.removeClass(this.domNode,a)},hasClass:function(a){return dojo.hasClass(this.domNode,a)},show:function(a){a&&a.nodeName?dojo.removeClass(a,"hidden"):(this.removeClass("hidden"),this.isHidden=!1)},hide:function(a){a&&a.nodeName?dojo.addClass(a,"hidden"):(this.addClass("hidden"),
this.isHidden=!0)},toggle:function(a){a?dojo.toggleClass(a,"hidden"):this.isHidden?this.show():this.hide()},enable:function(){this.removeClass("disabled");this.isDisabled=!1},disable:function(){this.addClass("disabled");this.isDisabled=!0}})}());
dojo._hasResource["mulberry.Utilities"]||(dojo._hasResource["mulberry.Utilities"]=!0,dojo.provide("mulberry.Utilities"),dojo.forIn=function(a,b,c){for(var d in a)a.hasOwnProperty(d)&&dojo.hitch(c||window,b)(d,a[d])},mulberry.util={truncate:function(a,b){var c,b=b||200,a=a.replace("</p>"," ").replace("<br>"," ").replace(/(<\/.>)|(<.>)|(<[^b][^r]?[^>]*>)/g,"");c=a=dojo.trim(a);(a=a.substr(0,b))&&c.length>b&&(a+=" &hellip;");return a},copyStyles:function(a,b,c){var d=window.getComputedStyle(a);dojo.forEach(c,
function(a){dojo.style(b,a,d[a])})}},mulberry.tmpl=function(a,b){return dojo.string.substitute(a,b)},mulberry.haml=Haml,mulberry.jsonp=function(a,b){b=dojo.isObject(a)?a:b||{};b.callbackParamName=b.callback||b.callbackParamName||"callback";a=dojo.isString(a)?a:b.url;return!a?void 0:dojo.io.script.get(dojo.delegate(b,{url:a}))},mulberry.page=function(a,b,c){mulberry.route(a,function(a){mulberry.showPage(mulberry.createPage(dojo.mixin(b,{params:a})))},c)});
dojo._hasResource["mulberry._Component"]||(dojo._hasResource["mulberry._Component"]=!0,dojo.provide("mulberry._Component"),dojo.declare("mulberry._Component",mulberry._View,{handleClicks:!1,prepareData:function(){},setupConnections:function(){},setupSubscriptions:function(){},setupChildComponents:function(){},adjustMarkup:function(){},resizeElements:function(){},teardown:function(){},populate:function(a,b){this.populateElement(this.domNode,a,b)},populateElement:function(a,b,c){dojo.isString(a)&&(a=
this[a]);a&&(a.innerHTML=dojo.isArray(c)?dojo.map(c,b).join(""):b(c),this.region&&this.region.refreshScroller())},postMixInProperties:function(){this.inherited(arguments);this.screen&&(this.screen.registerComponent(this),this.connect(this.screen,"startup","startup"));this.prepareData();this._loadHelpers();this.inherited(arguments)},postCreate:function(){this.inherited(arguments);this.isHidden&&this.hide();this.handleClicks&&this.preventClickDelay(this.clickableNode||this.domNode,this._clickHandler&&
dojo.hitch(this,"_clickHandler"));this.subscribe("/window/resize",function(){this.dimensions=null});this.setupChildComponents();this.adjustMarkup();this.setupConnections();this.setupSubscriptions()},startup:function(){this.inherited(arguments);this.resizeElements();this.when&&dojo.forIn(this.when,function(a,b){(this.node||this.baseObj)[a].then(dojo.hitch(this,b))},this)},destroy:function(){this.teardown();this.inherited(arguments)},_loadHelpers:function(){this.helpers&&dojo.isObject(this.helpers)&&
dojo.forIn(this.helpers,function(a,b){b&&(this.helpers[a]=Haml(b)())},this)},_setupTouch:function(a,b){var c=mulberry.app.UI.hasTouch;this.connect(a,c?"touchstart":"click",b);c&&this.connect(a,"click",function(a){a.preventDefault()})},getDimensions:function(){return this.dimensions=this.dimensions||{width:dojo.style(this.domNode,"width"),height:dojo.style(this.domNode,"height")}}}),mulberry.component=function(a,b){var c=dojo.mixin(b,{templateString:b.componentTemplate||"%div",prepareData:function(){this.inherited(arguments);
b.prep&&b.prep.call(this)},postCreate:function(){this.inherited(arguments);window.jQuery&&(this.$domNode=jQuery(this.domNode))},startup:function(){this.inherited(arguments);b.init&&b.init.call(this)}});dojo.declare("client.components."+a,mulberry._Component,c)});
dojo._hasResource["toura.components.SiblingNav"]||(dojo._hasResource["toura.components.SiblingNav"]=!0,dojo.provide("toura.components.SiblingNav"),dojo.declare("toura.components.SiblingNav",mulberry._Component,{templateString:dojo.cache("toura.components","SiblingNav/SiblingNav.haml",".component.sibling-nav\n  .handle{ dojoAttachPoint : 'handleNode' }\n    .toggler\n  %nav\n    .controller.prev{ dojoAttachPoint : 'prevButton' } prev\n    %ol.nodes{ dojoAttachPoint : 'siblingList' }\n    .controller.next{ dojoAttachPoint : 'nextButton' } next\n\n\n"),
siblingTemplate:Haml(dojo.cache("toura.components","SiblingNav/Sibling.haml","%li{ class : className }\n  %span{ data-href : url }= name\n")),setupConnections:function(){var a=mulberry.app.UI.hasTouch?"touchstart":"click";this.connect(this.handleNode,a,"toggle");this.connect(this.prevButton,a,dojo.hitch(this,"_handleButton","prev"));this.connect(this.nextButton,a,dojo.hitch(this,"_handleButton","next"));this.connect(this.siblingList,a,"_handleLink")},toggle:function(){this.set("open",!this.open)},
_handleButton:function(a){var b=this[a+"Item"];"prev"===a&&mulberry.app.UI.set("navDirection","back");mulberry.app.Router.go(b.url,!0)},_handleLink:function(a){var a=a.target,b=dojo.attr(a,"data-href");b&&(dojo.hasClass(a.parentNode,"prev")&&mulberry.app.UI.set("navDirection","back"),mulberry.app.Router.go(b,!0))},_setOpenAttr:function(a){dojo[a?"addClass":"removeClass"](this.domNode,"open");this.open=a},_setNodeAttr:function(a){!a||!a.siblings||!a.siblings.length?(this.hide(),this.set("open",!1),
this.siblings=!1):(this.show(),this._processSiblings(a.siblings,a))},_processSiblings:function(a,b){this.siblings=a.length?!0:!1;dojo.forEach(a,function(a,c){a.id===b.id&&(this.currentIndex=c)},this);var c=this.currentIndex+1,d=this.currentIndex-1;this.nextItem=c>=a.length?null:a[c];this.prevItem=0>d?null:a[d];this._updateButtons();this._updateLinks()},_updateButtons:function(){dojo[this.nextItem?"removeClass":"addClass"](this.nextButton,"inactive");dojo[this.prevItem?"removeClass":"addClass"](this.prevButton,
"inactive")},_updateLinks:function(){var a;dojo.empty(this.siblingList);this.prevItem&&(a=dojo.mixin(this.prevItem,{className:"prev"}),this.prevLink=dojo.place(this.siblingTemplate(a),this.siblingList));this.nextItem&&(a=dojo.mixin(this.nextItem,{className:"next"}),this.nextLink=dojo.place(this.siblingTemplate(a),this.siblingList))}}));
dojo._hasResource["toura.components.AdTag"]||(dojo._hasResource["toura.components.AdTag"]=!0,dojo.provide("toura.components.AdTag"),dojo.declare("toura.components.AdTag",mulberry._Component,{templateString:dojo.cache("toura.components","AdTag/AdTag.haml",".component.ad-tag\n  %iframe{ dojoAttachPoint : 'adFrame', scrolling : 'no' }\n"),adjustMarkup:function(){this.adConfig&&dojo.attr(this.adFrame,"src",this.adConfig)},startup:function(){this.adConfig||this.destroy()}}));
dojo._hasResource["toura.UI"]||(dojo._hasResource["toura.UI"]=!0,dojo.provide("toura.UI"),function(a){dojo.declare("toura.UI",dojo.Stateful,{constructor:function(){this.body=dojo.body();this._setupFeatureClasses();this._setupSiblingNav();dojo.connect(a.app.UI,"showPage",this,"_onShowPage");this.watch("siblingNavVisible",dojo.hitch(this,"_onSiblingNavVisible"))},_onShowPage:function(a,c){this.siblingNav&&(this.set("siblingNavVisible",!0),this.siblingNav.set("node",c));this._setupAdTag()},_setupFeatureClasses:function(){dojo.forIn(toura.features,
function(a,c){c&&dojo.addClass(this.body,"feature-"+a)},this)},_setupSiblingNav:function(){toura.features.siblingNav&&!toura.features.ads&&(this.siblingNav=a.app.UI.addPersistentComponent(toura.components.SiblingNav,{},"first"),this.set("siblingNavVisible",!1),dojo.connect(this.siblingNav,"show",this,function(){dojo.addClass(this.body,"sibling-nav-visible");dojo.publish("/window/resize")}),dojo.connect(this.siblingNav,"hide",this,function(){dojo.removeClass(this.body,"sibling-nav-visible");dojo.publish("/window/resize")}))},
_setupAdTag:function(){if(toura.features.ads){var b=a.app.UI.currentPage&&a.app.UI.currentPage.baseObj.isHomeNode,c=dojo.body();this.adTag&&this.adTag.destroy();b?dojo.removeClass(c,"has-ads"):mulberry.app.PhoneGap.network.isReachable().then(dojo.hitch(this,function(b){b?(b=mulberry.app.Config.get("app"),b.ads&&b.ads[a.Device.type]&&(dojo.addClass(c,"has-ads"),this.adTag=a.app.UI.addPersistentComponent(toura.components.AdTag,{adConfig:b.ads[a.Device.type]},"last"),this.adTag.startup())):dojo.removeClass(c,
"has-ads")}))}},_onSiblingNavVisible:function(a,c,d){if(this.siblingNav)if(this.siblingNav.siblings)this.siblingNav[d?"show":"hide"]();else this.siblingNav.hide()}});dojo.subscribe("/ui/ready",function(){toura.UI=new toura.UI})}(mulberry));
dojo._hasResource["toura.Analytics"]||(dojo._hasResource["toura.Analytics"]=!0,dojo.provide("toura.Analytics"),function(){var a=function(a){return{log:function(){return a?function(a,b){console.log("mulberry.app.PhoneGap::logAnalyticsEvent()");PhoneGap.exec(function(){},function(a){mulberry.log("Could not log flurry event.  Error: "+a)},"FlurryCommand","logEvent",[a,b])}:function(){console.log("mulberry.app.PhoneGap::logAnalyticsEvent()")}}()}}(mulberry.app.PhoneGap.present,mulberry.Device);dojo.declare("toura.Analytics",
null,{constructor:function(a){this.appId=a;dojo.subscribe("/video/play",dojo.hitch(this,"_trackEvent","Video Play"));dojo.subscribe("/audio/play",dojo.hitch(this,"_trackEvent","Audio Play"));dojo.subscribe("/image/view",dojo.hitch(this,"_trackEvent","Image View"));dojo.subscribe("/share",dojo.hitch(this,"_trackEvent","Share"));dojo.subscribe("/node/view",this,"_trackPageview");dojo.subscribe("/search",this,"_trackSearch")},_trackEvent:function(b,c){a.log(b,{data:c})},_trackPageview:function(b){a.log("/tour/"+
mulberry.app.Config.get("app").id+b)},_trackSearch:function(b){(b=b?dojo.trim(b):!1)&&a.log("Search",{searchTerm:b})}});toura.Analytics=new toura.Analytics}());dojo._hasResource["mulberry.app.PhoneGap.notification"]||(dojo._hasResource["mulberry.app.PhoneGap.notification"]=!0,dojo.provide("mulberry.app.PhoneGap.notification"),mulberry.app.PhoneGap.notification=function(a){return{alert:function(b){a?navigator.notification.alert(b):alert(b)}}});
dojo._hasResource["mulberry.app.PhoneGap.device"]||(dojo._hasResource["mulberry.app.PhoneGap.device"]=!0,dojo.provide("mulberry.app.PhoneGap.device"),function(){function a(a){if(!a||!dojo.isString(a)||!dojo.trim(a))return"unknown";return a.match("Android")?(a=dojo.trim(a.split("Android")[1].split(";")[0]).split("-")[0].split("."),b(a)):-1<a.indexOf("AppleWebKit")&&0<=a.indexOf("iPhone")+a.indexOf("iPad")+a.indexOf("iPod")?"unknown-ios-webkit":"unknown"}function b(a){return[a[0],a[1]||"0"].join("-")}
mulberry.app.PhoneGap.device=function(c){return{version:c?b(window.device.version.split("-")[0].split(".")):a(window.navigator.userAgent),_parseVersion:a}}}());
dojo._hasResource["mulberry.app.PhoneGap.network"]||(dojo._hasResource["mulberry.app.PhoneGap.network"]=!0,dojo.provide("mulberry.app.PhoneGap.network"),mulberry.app.PhoneGap.network=function(){var a,b,c;return{isReachable:function(){console.log("mulberry.app.PhoneGap.network::isReachable()");var d=new dojo.Deferred,e=(new Date).getTime();if(b&&!c&&3E5>e-b)return d.resolve(c),d;b=e;navigator.network&&navigator.network.connection?(a=navigator.network.connection.type,c=a===Connection.UNKNOWN||a===Connection.NONE?
!1:!0):c=!0;d.resolve(c);return d.promise},state:function(){var a={},b;return navigator.network&&navigator.network.connection?(a[Connection.UNKNOWN]="Unknown connection",a[Connection.ETHERNET]="Ethernet connection",a[Connection.WIFI]="WiFi connection",a[Connection.CELL_2G]="Cell 2G connection",a[Connection.CELL_3G]="Cell 3G connection",a[Connection.CELL_4G]="Cell 4G connection",a[Connection.NONE]="No network connection",b=navigator.network.connection.type,{state:b,description:a[b]}):{state:-1,description:"Unknown connection"}}}});
dojo._hasResource["mulberry.app.PhoneGap.audio"]||(dojo._hasResource["mulberry.app.PhoneGap.audio"]=!0,dojo.provide("mulberry.app.PhoneGap.audio"),mulberry.app.PhoneGap.audio=function(a){var b,c=function(){},d=function(){};return{play:function(e){console.log("mulberry.app.PhoneGap.audio::play()");a&&(e=/^http/.test(e)?e:"/android_asset/www/"+e,b=new Media(e,c,d),b.play())},stop:function(){console.log("mulberry.app.PhoneGap.audio::stop()");a&&b&&b.pause()},destroy:function(){b&&(b.stop(),b.release(),
b=null)}}});
dojo._hasResource["vendor.urbanairship.push"]||(dojo._hasResource["vendor.urbanairship.push"]=!0,dojo.provide("vendor.urbanairship.push"),vendor.urbanairship.push=function(){var a=function(){};a.prototype.register=function(a,c,d){PhoneGap.exec(a,c,"PushNotification","registerAPN",d)};a.prototype.startNotify=function(){PhoneGap.exec(null,null,"PushNotification","startNotify",[])};a.prototype.log=function(a){PhoneGap.exec(null,null,"PushNotification","log",[{msg:a}])};PhoneGap.addConstructor(function(){window.plugins||(window.plugins=
{});window.plugins.pushNotification=new a})});dojo._hasResource["mulberry.app.PhoneGap.push"]||(dojo._hasResource["mulberry.app.PhoneGap.push"]=!0,dojo.provide("mulberry.app.PhoneGap.push"),mulberry.app.PhoneGap.push=function(a){a&&vendor.urbanairship.push()});
dojo._hasResource["mulberry.app.PhoneGap.browser"]||(dojo._hasResource["mulberry.app.PhoneGap.browser"]=!0,dojo.provide("mulberry.app.PhoneGap.browser"),mulberry.app.PhoneGap.browser=function(a,b){function c(){}window.ChildBrowser=c;var d=b.os,e={ios:function(){c._onLocationChange=function(a){window.plugins.childBrowser.onLocationChange(a)};c._onClose=function(){window.plugins.childBrowser.onClose()};c._onOpenExternal=function(){window.plugins.childBrowser.onOpenExternal()};c._onJSCallback=function(){};
c.prototype.showWebPage=function(a){PhoneGap.exec("ChildBrowserCommand.showWebPage",a)};c.prototype.close=function(){PhoneGap.exec("ChildBrowserCommand.close")};c.prototype.jsExec=function(){};c.install=function(){window.plugins||(window.plugins={});window.plugins.childBrowser=new c;return window.plugins.childBrowser};c.install()},android:function(){c.prototype.showWebPage=function(a,b){PhoneGap.exec(null,null,"ChildBrowser","showWebPage",[a,b])};PhoneGap.addConstructor(function(){PhoneGap.addPlugin("childBrowser",
new c);PluginManager.addService("ChildBrowser","com.phonegap.plugins.childBrowser.ChildBrowser")})}};if(a&&e[d])e[d]();return{url:function(b){a?"android"===d?PhoneGap.exec(null,null,"ChildBrowser","showWebPage",[b,!1]):window.plugins.childBrowser.showWebPage(b):window.location=b},getBrowser:function(){if(!window.plugins.childBrowser)throw Error("Can't find childBrowser plugin");return window.plugins.childBrowser}}});
dojo._hasResource["mulberry.app.PhoneGap.camera"]||(dojo._hasResource["mulberry.app.PhoneGap.camera"]=!0,dojo.provide("mulberry.app.PhoneGap.camera"),mulberry.app.PhoneGap.camera=function(a){var b=function(){};return{getPicture:function(c,d,e){dojo.isFunction(c)||(e=c,d=c=!1);var f=new dojo.Deferred;a&&navigator&&navigator.camera?navigator.camera.getPicture(function(a){(c||b)(a);f.resolve(a)},function(a){(d||b)(a);f.reject(a)},e):f.resolve();return f.promise}}});
dojo._hasResource["mulberry.app.PhoneGap.geolocation"]||(dojo._hasResource["mulberry.app.PhoneGap.geolocation"]=!0,dojo.provide("mulberry.app.PhoneGap.geolocation"),mulberry.app.PhoneGap.geolocation=function(){var a=function(){};return{getCurrentPosition:function(b,c,d){dojo.isFunction(b)||(d=b,c=b=!1);var e=new dojo.Deferred,f=function(b){(c||a)(b);e.reject(b)};navigator.geolocation&&navigator.geolocation.getCurrentPosition?navigator.geolocation.getCurrentPosition(function(c){(b||a)(c);e.resolve(c)},
f,d):f("Geolocation API not available");return e.promise},watchPosition:function(a,c,d){return navigator.geolocation&&navigator.geolocation.watchPosition?navigator.geolocation.watchPosition(a,c,d):!1},clearWatch:function(a){a&&navigator.geolocation&&navigator.geolocation.clearWatch&&navigator.geolocation.clearWatch(a)}}});
dojo._hasResource["mulberry.app.PhoneGap.accelerometer"]||(dojo._hasResource["mulberry.app.PhoneGap.accelerometer"]=!0,dojo.provide("mulberry.app.PhoneGap.accelerometer"),mulberry.app.PhoneGap.accelerometer=function(){var a=function(){};return{getCurrentAcceleration:function(b,c){var d=new dojo.Deferred,e=function(b){(c||a)(b);d.reject(b)};navigator.accelerometer&&navigator.accelerometer.getCurrentAcceleration?navigator.accelerometer.getCurrentAcceleration(function(c){(b||a)(c);d.resolve(c)},e):e("Accelerometer API not available");
return d.promise},watchAcceleration:function(a,c){return navigator.accelerometer&&navigator.accelerometer.watchAcceleration?navigator.accelerometer.watchAcceleration(a,c):!1},clearWatch:function(a){a=a.watchId||a;navigator.accelerometer&&navigator.accelerometer.clearWatch&&a&&navigator.accelerometer.clearWatch(a)}}});
dojo._hasResource["mulberry.app.PhoneGap"]||(dojo._hasResource["mulberry.app.PhoneGap"]=!0,dojo.provide("mulberry.app.PhoneGap"),function(){mulberry.app.PhoneGap.registerAPI=function(a,b){var c=dojo.subscribe("/app/deviceready",function(){var d=mulberry.Device,e=mulberry.app.PhoneGap.present=window.device&&window.device.phonegap;mulberry.app.PhoneGap[a]=b(e,d);dojo.unsubscribe(c)})};dojo.forEach("notification,device,network,audio,push,browser,camera,geolocation,accelerometer".split(","),function(a){mulberry.app.PhoneGap.registerAPI(a,
mulberry.app.PhoneGap[a])})}());
dojo._hasResource["mulberry.app.DeviceStorage"]||(dojo._hasResource["mulberry.app.DeviceStorage"]=!0,dojo.provide("mulberry.app.DeviceStorage"),mulberry.app.DeviceStorage=function(){var a={tour:{tableName:"items",fields:["id text","json text"],insertStatement:function(a,c){return["INSERT INTO "+a+"( id, json ) VALUES ( ?, ? )",[c.id,JSON.stringify(c)]]},processSelecton:function(a){var c=[],d=a.rows.length,e,f;for(f=0;f<d;f++)e=a.rows.item(f).json,c.push(e?JSON.parse(e):{});return c}}};return{init:function(a){this.appId=
a;if("openDatabase"in window){var c=this._db=openDatabase(a+"-"+mulberry.version,"1.0",a+" Database",5242880);c||console.log("No database. This will end badly.");this._sql=function(a,b){var f=new dojo.Deferred,g,a=dojo.isArray(a)?a:[a];g=a.length;c.transaction(function(c){dojo.forEach(a,function(a,d){var j,p,q=[];d+1===g?(j=dojo.isFunction(b)?function(a,c){f.callback(b(c))}:f.callback,p=f.errback):j=p=function(){};dojo.isArray(a)&&(q=a[1],a=a[0]);c.executeSql(a,q,j,p)})});return f}}else this._sql=
function(){var a=new dojo.Deferred;a.resolve();return a.promise};return this._db},drop:function(){var b=[];dojo.forIn(a,function(a,d){b.push("DROP TABLE IF EXISTS "+d.tableName)});window.localStorage.clear();return this._sql&&this._sql(b)},set:function(b,c){var d=a[b],e;if(d)return e=["DROP TABLE IF EXISTS "+d.tableName,"CREATE TABLE "+d.tableName+"("+d.fields.join(",")+")"],dojo.forEach(c,function(a){e.push(d.insertStatement(d.tableName,a))}),this._sql(e);window.localStorage.setItem(b,JSON.stringify(c));
return!0},get:function(b){var c=a[b];if(c)return this._sql("SELECT * FROM "+c.tableName,c.processSelecton);b=window.localStorage.getItem(b);"undefined"===b&&(b=null);return b=b&&JSON.parse(b)}}}());
dojo._hasResource["dojo.io.script"]||(dojo._hasResource["dojo.io.script"]=!0,dojo.provide("dojo.io.script"),dojo.getObject("io",!0,dojo),function(){var a=dojo.isIE?"onreadystatechange":"load",b=/complete|loaded/;dojo.io.script={get:function(c){var d=this._makeScriptDeferred(c),e=d.ioArgs;dojo._ioAddQueryToUrl(e);dojo._ioNotifyStart(d);if(this._canAttach(e)){var f=this.attach(e.id,e.url,c.frameDoc);if(!e.jsonp&&!e.args.checkString)var g=dojo.connect(f,a,function(a){if("load"==a.type||b.test(f.readyState))dojo.disconnect(g),
e.scriptLoaded=a})}dojo._ioWatch(d,this._validCheck,this._ioCheck,this._resHandle);return d},attach:function(a,b,e){var e=e||dojo.doc,f=e.createElement("script");f.type="text/javascript";f.src=b;f.id=a;f.charset="utf-8";return e.getElementsByTagName("head")[0].appendChild(f)},remove:function(a,b){dojo.destroy(dojo.byId(a,b));this["jsonp_"+a]&&delete this["jsonp_"+a]},_makeScriptDeferred:function(a){var b=dojo._ioSetArgs(a,this._deferredCancel,this._deferredOk,this._deferredError),e=b.ioArgs;e.id=
dojo._scopeName+"IoScript"+this._counter++;e.canDelete=!1;e.jsonp=a.callbackParamName||a.jsonp;e.jsonp&&(e.query=e.query||"",0<e.query.length&&(e.query+="&"),e.query+=e.jsonp+"="+(a.frameDoc?"parent.":"")+dojo._scopeName+".io.script.jsonp_"+e.id+"._jsonpCallback",e.frameDoc=a.frameDoc,e.canDelete=!0,b._jsonpCallback=this._jsonpCallback,this["jsonp_"+e.id]=b);return b},_deferredCancel:function(a){a.canceled=!0;a.ioArgs.canDelete&&dojo.io.script._addDeadScript(a.ioArgs)},_deferredOk:function(a){a=a.ioArgs;
a.canDelete&&dojo.io.script._addDeadScript(a);return a.json||a.scriptLoaded||a},_deferredError:function(a,b){b.ioArgs.canDelete&&("timeout"==a.dojoType?dojo.io.script.remove(b.ioArgs.id,b.ioArgs.frameDoc):dojo.io.script._addDeadScript(b.ioArgs));console.log("dojo.io.script error",a);return a},_deadScripts:[],_counter:1,_addDeadScript:function(a){dojo.io.script._deadScripts.push({id:a.id,frameDoc:a.frameDoc});a.frameDoc=null},_validCheck:function(){var a=dojo.io.script,b=a._deadScripts;if(b&&0<b.length){for(var e=
0;e<b.length;e++)a.remove(b[e].id,b[e].frameDoc),b[e].frameDoc=null;dojo.io.script._deadScripts=[]}return!0},_ioCheck:function(a){a=a.ioArgs;return a.json||a.scriptLoaded&&!a.args.checkString?!0:(a=a.args.checkString)&&eval("typeof("+a+") != 'undefined'")?!0:!1},_resHandle:function(a){dojo.io.script._ioCheck(a)?a.callback(a):a.errback(Error("inconceivable dojo.io.script._resHandle error"))},_canAttach:function(){return!0},_jsonpCallback:function(a){this.ioArgs.json=a}}}());
dojo._hasResource["toura.models._Updateable"]||(dojo._hasResource["toura.models._Updateable"]=!0,dojo.provide("toura.models._Updateable"),dojo.declare("toura.models._Updateable",null,{bundleDataUrl:"",remoteDataUrl:"",remoteVersionUrl:"",storageKey:"",lastChecked:0,constructor:function(a){dojo.mixin(this,a)},getItems:function(){return this._items||[]},bootstrap:function(){var a=this._getLocalVersion(),b=this.deferred=new dojo.Deferred;this.getBundleData().then(dojo.hitch(this,function(b){var d=b.version;
dojo.when(null===a||null===d||a<d?this._initializeData(b):!0,dojo.hitch(this,"_updateIfNecessary")).then(dojo.hitch(this,"_onUpdate"))}));return b.promise},_onUpdate:function(a){a?a.appVersion&&this._isAppVersionCompatible(a.appVersion)?dojo.when(this._store(a),dojo.hitch(this,function(){this._onDataReady();this.deferred.resolve(!0)})):this.deferred.resolve(!1):this.deferred.resolve(!1)},_isAppVersionCompatible:function(a){return this._parseMajorVersion(mulberry.app.Config.get("appVersion"))===this._parseMajorVersion(a)},
_updateIfNecessary:function(){var a=new dojo.Deferred,b=this._getLocalVersion();dojo.when(this._getRemoteVersion(),dojo.hitch(this,function(c){this._parseMajorVersion(mulberry.app.Config.get("appVersion"));c&&(c.appVersion=c.appVersion||"2.0");c&&this._isAppVersionCompatible(c.appVersion)&&c.version>b?this._getRemoteData().then(dojo.hitch(this,function(b){b?a.resolve(b):a.resolve(!1)})):(this._onDataReady(),a.resolve(!1))}),dojo.hitch(this,function(b){(404===b.status||503===b.status)&&this._onDataReady();
a.resolve(!1)}));return a.promise},_xhr:function(a,b){return dojo.xhrGet({url:a,preventCache:!0,handleAs:"json",contentType:!1,load:b.resolve,error:b.reject})},_getRemoteVersion:function(){this.lastChecked=(new Date).getTime();var a=new dojo.Deferred;mulberry.skipVersionCheck||!this.remoteVersionUrl?a.resolve(null):mulberry.app.PhoneGap.network.isReachable().then(dojo.hitch(this,function(b){b?this._xhr(this.remoteVersionUrl,a):a.resolve(null)}),a.reject);return a.promise},_getLocalVersion:function(){return mulberry.app.DeviceStorage.get(this.storageKey+
"-version")},_setLocalVersion:function(a){mulberry.app.DeviceStorage.set(this.storageKey+"-version",a)},_getRemoteData:function(){var a=new dojo.Deferred;this.remoteDataUrl?mulberry.app.PhoneGap.network.isReachable().then(dojo.hitch(this,function(){this._xhr(this.remoteDataUrl,a)}),function(){a.resolve(!1)}):a.resolve(!1);return a.promise},getBundleData:function(){var a=new dojo.Deferred;if(!this.bundleDataUrl)return a.resolve(),a.promise;dojo.io.script.get({url:this.bundleDataUrl,preventCache:!0}).then(a.resolve,
a.reject);return a.promise},_initializeData:function(a){var b=new dojo.Deferred;dojo.when(a||this.getBundleData(),dojo.hitch(this,function(a){a?dojo.when(this._store(a),function(){b.resolve(!0)}):b.resolve(!1)}));return b.promise},_store:function(a){this.lastUpdated=(new Date).getTime();this._items=a.items;this._setLocalVersion(a&&a.version)},_parseMajorVersion:function(a){return+a.split(".")[0]},_onDataReady:function(){}}));
dojo._hasResource["toura.models.Tour"]||(dojo._hasResource["toura.models.Tour"]=!0,dojo.provide("toura.models.Tour"),dojo.declare("toura.models.Tour",toura.models._Updateable,{storageKey:"tour",getItems:function(){var a=new dojo.Deferred;this._items?a.resolve(this._items):mulberry.app.DeviceStorage.get("tour").then(dojo.hitch(this,function(b){this._items=b;a.resolve(b)}));return a.promise},_store:function(a){this.inherited(arguments);var b=new dojo.Deferred;a.app&&mulberry.app.DeviceStorage.set("app",
a.app);a.items&&mulberry.app.DeviceStorage.set("tour",a.items).then(function(){b.resolve(!0)});return b.promise},getBundleData:function(){var a=new dojo.Deferred;a.resolve(toura.data.local);return a.promise},_onDataReady:function(){var a=mulberry.app.DeviceStorage.get("app");mulberry.app.Config.set("app",a)}}));
dojo._hasResource["toura.Bootstrapper"]||(dojo._hasResource["toura.Bootstrapper"]=!0,dojo.provide("toura.Bootstrapper"),function(){var a=function(){var a=new dojo.Deferred,c=mulberry.app,d;0===c.DeviceStorage.get("tour-version")&&c.DeviceStorage.set("tour-verison",null);d=new toura.models.Tour({remoteDataUrl:c.Config.get("updateUrl"),remoteVersionUrl:c.Config.get("versionUrl")});dojo.subscribe("/page/transition/end",function(){var a=d.lastChecked;(new Date).getTime()-a>36E5*(mulberry.otaInterval||
8)&&d.bootstrap().then(function(a){a&&dojo.when(d.getItems(),function(a){toura.Data.loadData(a);mulberry.app.PhoneGap.notification.alert(dojo.i18n.getLocalization("mulberry","mulberry",mulberry.app.Config.get("locale")).OTA_UPDATE_NOTICE);mulberry.app.Router.home()})})});d.bootstrap().then(function(){a.resolve(d)},a.reject);return a.promise};dojo.subscribe("/app/deviceready",function(){a().then(function(a){a.getItems().then(function(a){toura.Data=new toura.Data(a);setTimeout(function(){dojo.publish("/app/ready");
mulberry.app.PhoneGap.network.isReachable().then(function(a){a||mulberry.app.PhoneGap.notification.alert(dojo.i18n.getLocalization("mulberry","mulberry",mulberry.app.Config.get("locale")).STARTUP_NO_NETWORK)})},200)})})})}());
dojo._hasResource["dojo.data.util.filter"]||(dojo._hasResource["dojo.data.util.filter"]=!0,dojo.provide("dojo.data.util.filter"),dojo.getObject("data.util.filter",!0,dojo),dojo.data.util.filter.patternToRegExp=function(a,b){for(var c="^",d=null,e=0;e<a.length;e++)switch(d=a.charAt(e),d){case "\\":c+=d;e++;c+=a.charAt(e);break;case "*":c+=".*";break;case "?":c+=".";break;case "$":case "^":case "/":case "+":case ".":case "|":case "(":case ")":case "{":case "}":case "[":case "]":c+="\\";default:c+=d}c+=
"$";return b?RegExp(c,"mi"):RegExp(c,"m")});
dojo._hasResource["dojo.data.util.sorter"]||(dojo._hasResource["dojo.data.util.sorter"]=!0,dojo.provide("dojo.data.util.sorter"),dojo.getObject("data.util.sorter",!0,dojo),dojo.data.util.sorter.basicComparator=function(a,b){var c=-1;null===a&&(a=void 0);null===b&&(b=void 0);if(a==b)c=0;else if(a>b||null==a)c=1;return c},dojo.data.util.sorter.createSortFunction=function(a,b){function c(a,b,c,d){return function(e,f){var h=d.getValue(e,a),g=d.getValue(f,a);return b*c(h,g)}}for(var d=[],e,f=b.comparatorMap,
g=dojo.data.util.sorter.basicComparator,i=0;i<a.length;i++){e=a[i];var h=e.attribute;if(h){e=e.descending?-1:1;var k=g;f&&("string"!==typeof h&&"toString"in h&&(h=h.toString()),k=f[h]||g);d.push(c(h,e,k,b))}}return function(a,b){for(var c=0;c<d.length;){var e=d[c++](a,b);if(0!==e)return e}return 0}});
dojo._hasResource["dojo.data.util.simpleFetch"]||(dojo._hasResource["dojo.data.util.simpleFetch"]=!0,dojo.provide("dojo.data.util.simpleFetch"),dojo.getObject("data.util.simpleFetch",!0,dojo),dojo.data.util.simpleFetch.fetch=function(a){a=a||{};a.store||(a.store=this);var b=this;this._fetchItems(a,function(a,d){var e=d.abort||null,f=!1,g=d.start?d.start:0,i=d.count&&Infinity!==d.count?g+d.count:a.length;d.abort=function(){f=!0;e&&e.call(d)};var h=d.scope||dojo.global;d.store||(d.store=b);d.onBegin&&
d.onBegin.call(h,a.length,d);d.sort&&a.sort(dojo.data.util.sorter.createSortFunction(d.sort,b));if(d.onItem)for(var k=g;k<a.length&&k<i;++k){var j=a[k];f||d.onItem.call(h,j,d)}d.onComplete&&!f&&(k=null,d.onItem||(k=a.slice(g,i)),d.onComplete.call(h,k,d))},function(a,b){b.onError&&b.onError.call(b.scope||dojo.global,a,b)});return a});
dojo._hasResource["dojo.data.ItemFileReadStore"]||(dojo._hasResource["dojo.data.ItemFileReadStore"]=!0,dojo.provide("dojo.data.ItemFileReadStore"),dojo.declare("dojo.data.ItemFileReadStore",null,{constructor:function(a){this._arrayOfAllItems=[];this._arrayOfTopLevelItems=[];this._loadFinished=!1;this.url=this._ccUrl=this._jsonFileUrl=a.url;this._jsonData=a.data;this.data=null;this._datatypeMap=a.typeMap||{};this._datatypeMap.Date||(this._datatypeMap.Date={type:Date,deserialize:function(a){return dojo.date.stamp.fromISOString(a)}});
this._features={"dojo.data.api.Read":!0,"dojo.data.api.Identity":!0};this._itemsByIdentity=null;this._storeRefPropName="_S";this._itemNumPropName="_0";this._rootItemPropName="_RI";this._reverseRefMap="_RRM";this._loadInProgress=!1;this._queuedFetches=[];void 0!==a.urlPreventCache&&(this.urlPreventCache=a.urlPreventCache?!0:!1);void 0!==a.hierarchical&&(this.hierarchical=a.hierarchical?!0:!1);a.clearOnClose&&(this.clearOnClose=!0);"failOk"in a&&(this.failOk=a.failOk?!0:!1)},url:"",_ccUrl:"",data:null,
typeMap:null,clearOnClose:!1,urlPreventCache:!1,failOk:!1,hierarchical:!0,_assertIsItem:function(a){if(!this.isItem(a))throw Error("dojo.data.ItemFileReadStore: Invalid item argument.");},_assertIsAttribute:function(a){if("string"!==typeof a)throw Error("dojo.data.ItemFileReadStore: Invalid attribute argument.");},getValue:function(a,b,c){a=this.getValues(a,b);return 0<a.length?a[0]:c},getValues:function(a,b){this._assertIsItem(a);this._assertIsAttribute(b);return(a[b]||[]).slice(0)},getAttributes:function(a){this._assertIsItem(a);
var b=[],c;for(c in a)c!==this._storeRefPropName&&c!==this._itemNumPropName&&c!==this._rootItemPropName&&c!==this._reverseRefMap&&b.push(c);return b},hasAttribute:function(a,b){this._assertIsItem(a);this._assertIsAttribute(b);return b in a},containsValue:function(a,b,c){var d=void 0;"string"===typeof c&&(d=dojo.data.util.filter.patternToRegExp(c,!1));return this._containsValue(a,b,c,d)},_containsValue:function(a,b,c,d){return dojo.some(this.getValues(a,b),function(a){if(null!==a&&!dojo.isObject(a)&&
d){if(a.toString().match(d))return!0}else if(c===a)return!0})},isItem:function(a){return a&&a[this._storeRefPropName]===this&&this._arrayOfAllItems[a[this._itemNumPropName]]===a?!0:!1},isItemLoaded:function(a){return this.isItem(a)},loadItem:function(a){this._assertIsItem(a.item)},getFeatures:function(){return this._features},getLabel:function(a){if(this._labelAttr&&this.isItem(a))return this.getValue(a,this._labelAttr)},getLabelAttributes:function(){return this._labelAttr?[this._labelAttr]:null},
_fetchItems:function(a,b,c){var d=this,e=function(a,c){var e=[],f,g;if(a.query){var i;f=a.queryOptions?a.queryOptions.ignoreCase:!1;var n={};for(g in a.query)i=a.query[g],"string"===typeof i?n[g]=dojo.data.util.filter.patternToRegExp(i,f):i instanceof RegExp&&(n[g]=i);for(f=0;f<c.length;++f){var A=!0,u=c[f];if(null===u)A=!1;else for(g in a.query)i=a.query[g],d._containsValue(u,g,i,n[g])||(A=!1);A&&e.push(u)}}else for(f=0;f<c.length;++f)g=c[f],null!==g&&e.push(g);b(e,a)};if(this._loadFinished)e(a,
this._getItemsArray(a.queryOptions));else if(this._jsonFileUrl!==this._ccUrl?(dojo.deprecated("dojo.data.ItemFileReadStore: ","To change the url, set the url property of the store, not _jsonFileUrl.  _jsonFileUrl support will be removed in 2.0"),this.url=this._ccUrl=this._jsonFileUrl):this.url!==this._ccUrl&&(this._ccUrl=this._jsonFileUrl=this.url),null!=this.data&&(this._jsonData=this.data,this.data=null),this._jsonFileUrl)if(this._loadInProgress)this._queuedFetches.push({args:a,filter:e});else{this._loadInProgress=
!0;var f=dojo.xhrGet({url:d._jsonFileUrl,handleAs:"json-comment-optional",preventCache:this.urlPreventCache,failOk:this.failOk});f.addCallback(function(b){try{d._getItemsFromLoadedData(b),d._loadFinished=!0,d._loadInProgress=!1,e(a,d._getItemsArray(a.queryOptions)),d._handleQueuedFetches()}catch(f){d._loadFinished=!0,d._loadInProgress=!1,c(f,a)}});f.addErrback(function(b){d._loadInProgress=!1;c(b,a)});var g=null;a.abort&&(g=a.abort);a.abort=function(){f&&-1===f.fired&&f.cancel();g&&g.call(a)}}else if(this._jsonData)try{this._loadFinished=
!0,this._getItemsFromLoadedData(this._jsonData),this._jsonData=null,e(a,this._getItemsArray(a.queryOptions))}catch(i){c(i,a)}else c(Error("dojo.data.ItemFileReadStore: No JSON source data was provided as either URL or a nested Javascript object."),a)},_handleQueuedFetches:function(){if(0<this._queuedFetches.length){for(var a=0;a<this._queuedFetches.length;a++){var b=this._queuedFetches[a],c=b.args;(b=b.filter)?b(c,this._getItemsArray(c.queryOptions)):this.fetchItemByIdentity(c)}this._queuedFetches=
[]}},_getItemsArray:function(a){return a&&a.deep?this._arrayOfAllItems:this._arrayOfTopLevelItems},close:function(){this.clearOnClose&&this._loadFinished&&!this._loadInProgress&&((""==this._jsonFileUrl||null==this._jsonFileUrl)&&(""==this.url||null==this.url)&&null==this.data&&console.debug("dojo.data.ItemFileReadStore: WARNING!  Data reload  information has not been provided.  Please set 'url' or 'data' to the appropriate value before the next fetch"),this._arrayOfAllItems=[],this._arrayOfTopLevelItems=
[],this._loadFinished=!1,this._itemsByIdentity=null,this._loadInProgress=!1,this._queuedFetches=[])},_getItemsFromLoadedData:function(a){function b(a){return null!==a&&"object"===typeof a&&(!dojo.isArray(a)||d)&&!dojo.isFunction(a)&&(a.constructor==Object||dojo.isArray(a))&&"undefined"===typeof a._reference&&"undefined"===typeof a._type&&"undefined"===typeof a._value&&e.hierarchical}function c(a){e._arrayOfAllItems.push(a);for(var d in a){var f=a[d];if(f)if(dojo.isArray(f))for(var g=0;g<f.length;++g){var h=
f[g];b(h)&&c(h)}else b(f)&&c(f)}}var d=!1,e=this;this._labelAttr=a.label;var f,g;this._arrayOfAllItems=[];this._arrayOfTopLevelItems=a.items;for(f=0;f<this._arrayOfTopLevelItems.length;++f)g=this._arrayOfTopLevelItems[f],dojo.isArray(g)&&(d=!0),c(g),g[this._rootItemPropName]=!0;var i={},h;for(f=0;f<this._arrayOfAllItems.length;++f)for(h in g=this._arrayOfAllItems[f],g){if(h!==this._rootItemPropName){var k=g[h];null!==k?dojo.isArray(k)||(g[h]=[k]):g[h]=[null]}i[h]=h}for(;i[this._storeRefPropName];)this._storeRefPropName+=
"_";for(;i[this._itemNumPropName];)this._itemNumPropName+="_";for(;i[this._reverseRefMap];)this._reverseRefMap+="_";if(i=a.identifier){this._itemsByIdentity={};this._features["dojo.data.api.Identity"]=i;for(f=0;f<this._arrayOfAllItems.length;++f)if(g=this._arrayOfAllItems[f],a=g[i],a=a[0],Object.hasOwnProperty.call(this._itemsByIdentity,a)){if(this._jsonFileUrl)throw Error("dojo.data.ItemFileReadStore:  The json data as specified by: ["+this._jsonFileUrl+"] is malformed.  Items within the list have identifier: ["+
i+"].  Value collided: ["+a+"]");if(this._jsonData)throw Error("dojo.data.ItemFileReadStore:  The json data provided by the creation arguments is malformed.  Items within the list have identifier: ["+i+"].  Value collided: ["+a+"]");}else this._itemsByIdentity[a]=g}else this._features["dojo.data.api.Identity"]=Number;for(f=0;f<this._arrayOfAllItems.length;++f)g=this._arrayOfAllItems[f],g[this._storeRefPropName]=this,g[this._itemNumPropName]=f;for(f=0;f<this._arrayOfAllItems.length;++f)for(h in g=
this._arrayOfAllItems[f],g){a=g[h];for(i=0;i<a.length;++i)if(k=a[i],null!==k&&"object"==typeof k){if("_type"in k&&"_value"in k){var j=k._type,p=this._datatypeMap[j];if(p)if(dojo.isFunction(p))a[i]=new p(k._value);else if(dojo.isFunction(p.deserialize))a[i]=p.deserialize(k._value);else throw Error("dojo.data.ItemFileReadStore: Value provided in typeMap was neither a constructor, nor a an object with a deserialize function");else throw Error("dojo.data.ItemFileReadStore: in the typeMap constructor arg, no object class was specified for the datatype '"+
j+"'");}if(k._reference){k=k._reference;if(dojo.isObject(k))for(j=0;j<this._arrayOfAllItems.length;++j){var p=this._arrayOfAllItems[j],q=!0,s;for(s in k)p[s]!=k[s]&&(q=!1);q&&(a[i]=p)}else a[i]=this._getItemByIdentity(k);this.referenceIntegrity&&(k=a[i],this.isItem(k)&&this._addReferenceToMap(k,g,h))}else this.isItem(k)&&this.referenceIntegrity&&this._addReferenceToMap(k,g,h)}}},_addReferenceToMap:function(){},getIdentity:function(a){var b=this._features["dojo.data.api.Identity"];return b===Number?
a[this._itemNumPropName]:(a=a[b])?a[0]:null},fetchItemByIdentity:function(a){var b,c;if(this._loadFinished)b=this._getItemByIdentity(a.identity),a.onItem&&(c=a.scope?a.scope:dojo.global,a.onItem.call(c,b));else{var d=this;this._jsonFileUrl!==this._ccUrl?(dojo.deprecated("dojo.data.ItemFileReadStore: ","To change the url, set the url property of the store, not _jsonFileUrl.  _jsonFileUrl support will be removed in 2.0"),this.url=this._ccUrl=this._jsonFileUrl):this.url!==this._ccUrl&&(this._ccUrl=this._jsonFileUrl=
this.url);null!=this.data&&null==this._jsonData&&(this._jsonData=this.data,this.data=null);this._jsonFileUrl?this._loadInProgress?this._queuedFetches.push({args:a}):(this._loadInProgress=!0,c=dojo.xhrGet({url:d._jsonFileUrl,handleAs:"json-comment-optional",preventCache:this.urlPreventCache,failOk:this.failOk}),c.addCallback(function(c){var f=a.scope?a.scope:dojo.global;try{d._getItemsFromLoadedData(c),d._loadFinished=!0,d._loadInProgress=!1,b=d._getItemByIdentity(a.identity),a.onItem&&a.onItem.call(f,
b),d._handleQueuedFetches()}catch(g){d._loadInProgress=!1,a.onError&&a.onError.call(f,g)}}),c.addErrback(function(b){d._loadInProgress=!1;a.onError&&a.onError.call(a.scope?a.scope:dojo.global,b)})):this._jsonData&&(d._getItemsFromLoadedData(d._jsonData),d._jsonData=null,d._loadFinished=!0,b=d._getItemByIdentity(a.identity),a.onItem&&(c=a.scope?a.scope:dojo.global,a.onItem.call(c,b)))}},_getItemByIdentity:function(a){var b=null;this._itemsByIdentity&&Object.hasOwnProperty.call(this._itemsByIdentity,
a)?b=this._itemsByIdentity[a]:Object.hasOwnProperty.call(this._arrayOfAllItems,a)&&(b=this._arrayOfAllItems[a]);void 0===b&&(b=null);return b},getIdentityAttributes:function(){var a=this._features["dojo.data.api.Identity"];return a===Number?null:[a]},_forceLoad:function(){var a=this;this._jsonFileUrl!==this._ccUrl?(dojo.deprecated("dojo.data.ItemFileReadStore: ","To change the url, set the url property of the store, not _jsonFileUrl.  _jsonFileUrl support will be removed in 2.0"),this.url=this._ccUrl=
this._jsonFileUrl):this.url!==this._ccUrl&&(this._ccUrl=this._jsonFileUrl=this.url);null!=this.data&&(this._jsonData=this.data,this.data=null);if(this._jsonFileUrl){var b=dojo.xhrGet({url:this._jsonFileUrl,handleAs:"json-comment-optional",preventCache:this.urlPreventCache,failOk:this.failOk,sync:!0});b.addCallback(function(b){try{if(!0!==a._loadInProgress&&!a._loadFinished)a._getItemsFromLoadedData(b),a._loadFinished=!0;else if(a._loadInProgress)throw Error("dojo.data.ItemFileReadStore:  Unable to perform a synchronous load, an async load is in progress.");
}catch(d){throw console.log(d),d;}});b.addErrback(function(a){throw a;})}else this._jsonData&&(a._getItemsFromLoadedData(a._jsonData),a._jsonData=null,a._loadFinished=!0)}}),dojo.extend(dojo.data.ItemFileReadStore,dojo.data.util.simpleFetch));
dojo._hasResource["toura.models.TextAsset"]||(dojo._hasResource["toura.models.TextAsset"]=!0,dojo.provide("toura.models.TextAsset"),dojo.declare("toura.models.TextAsset",null,{constructor:function(a,b){dojo.mixin(this,{id:a.getValue(b,"id"),body:a.getValue(b,"body"),name:a.getValue(b,"name"),contexts:a.getValues(b,"contexts")})}}));
dojo._hasResource["toura.URL"]||(dojo._hasResource["toura.URL"]=!0,dojo.provide("toura.URL"),toura.URL={home:function(){return"#/home"},about:function(){return"#/about"},maps:function(){return"#/maps"},favorites:function(){return"#/favorites"},node:function(a){return"#/node/"+a},search:function(){return"#/search"},searchTerm:function(a){return toura.URL.search()+"/"+a},searchResult:function(a){var b=["node",a.node];"node"!==a.type&&b.push(a.type,a.id);return"#/"+b.join("/")},update:function(){return"#/update"},
storedAsset:function(a,b){return["media",{image:"images",video:"videos",audio:"audios",html:"html",videoPoster:"videos/poster"}[a],b].join("/")},feedItem:function(a,b){return"/feed/"+a+"/item/"+b}});
dojo._hasResource["toura.models.SimpleNode"]||(dojo._hasResource["toura.models.SimpleNode"]=!0,dojo.provide("toura.models.SimpleNode"),function(){var a={};dojo.subscribe("/tour/update",function(){a={}});dojo.declare("toura.models.SimpleNode",null,{constructor:function(b,c){var d=b.getValue(c,"id");a[d]?dojo.mixin(this,a[d]):(dojo.mixin(this,{id:b.getValue(c,"id"),name:b.getValue(c,"name")}),this.url=toura.URL.node(this.id),a[d]=this)}})}());
dojo._hasResource["toura.models._CaptionedAsset"]||(dojo._hasResource["toura.models._CaptionedAsset"]=!0,dojo.provide("toura.models._CaptionedAsset"),dojo.declare("toura.models._CaptionedAsset",null,{_processCaption:function(a,b){b.caption&&a.fetchItemByIdentity({identity:b.caption._reference,onItem:function(b){dojo.mixin(this,{caption:a.getValue(b,"body"),name:a.getValue(b,"name")||this.name})},scope:this})}}));
dojo._hasResource["toura.models._StorableAsset"]||(dojo._hasResource["toura.models._StorableAsset"]=!0,dojo.provide("toura.models._StorableAsset"),function(){var a=toura.URL.storedAsset;dojo.declare("toura.models._StorableAsset",[],{_getUrl:function(b,c){this.store=b;var d=b.getValue(c,"type"),e="image"===d?["featuredSmall","featured","gallery","original"]:!1;e?dojo.forEach(e,function(e){var g=this[e]=b.getValue(c,e),e=this._isStreamed(c,e);g.url=e&&g.url?g.url:a(d,g.filename)},this):(e=b.getValue(c,
"url"),this.url=this._isStreamed(c)&&e?e:a(d,b.getValue(c,"filename")))},_isStreamed:function(a,c){if(mulberry.forceStreaming)return!0;if(mulberry.forceLocal)return!1;if(!toura.manifest||!toura.manifest||this.store.getValue(a,"streamed"))return!0;var d=c?this.store.getValue(a,c).filename:this.store.getValue(a,"filename"),e=toura.manifest[this.store.getValue(a,"type")+"s"];return!e||!dojo.isArray(e)?!0:-1<dojo.indexOf(e,d)?!1:!0}})}());
dojo._hasResource["toura.models.Image"]||(dojo._hasResource["toura.models.Image"]=!0,dojo.provide("toura.models.Image"),dojo.declare("toura.models.Image",[toura.models._CaptionedAsset,toura.models._StorableAsset],{constructor:function(a,b){a.fetchItemByIdentity({identity:b.image._reference,onItem:function(b){dojo.mixin(this,{id:a.getValue(b,"id"),name:a.getValue(b,"name"),height:a.getValue(b,"height")||null,width:a.getValue(b,"width")||null});this._getUrl(a,b)},scope:this});this._processCaption(a,
b)}}));
dojo._hasResource["toura.models.HeaderImage"]||(dojo._hasResource["toura.models.HeaderImage"]=!0,dojo.provide("toura.models.HeaderImage"),dojo.declare("toura.models.HeaderImage",[toura.models._StorableAsset,toura.models._CaptionedAsset],{constructor:function(a,b){dojo.mixin(this,{id:a.getValue(b,"id"),name:a.getValue(b,"name"),height:a.getValue(b,"height")||null,width:a.getValue(b,"width")||null});this._getUrl(a,b);this._processCaption(a,b);this.destination=/^http/.test(this.name)?this.name:!1}}));
dojo._hasResource["toura.models.BackgroundImage"]||(dojo._hasResource["toura.models.BackgroundImage"]=!0,dojo.provide("toura.models.BackgroundImage"),dojo.declare("toura.models.BackgroundImage",toura.models._StorableAsset,{constructor:function(a,b){dojo.mixin(this,{id:a.getValue(b,"id"),name:a.getValue(b,"name"),height:a.getValue(b,"height")||null,width:a.getValue(b,"width")||null});this._getUrl(a,b)}}));
dojo._hasResource["toura.models.FeaturedImage"]||(dojo._hasResource["toura.models.FeaturedImage"]=!0,dojo.provide("toura.models.FeaturedImage"),dojo.declare("toura.models.FeaturedImage",toura.models._StorableAsset,{constructor:function(a,b){b.image&&a.fetchItemByIdentity({identity:b.image._reference,onItem:function(a){b=a}});this._getUrl(a,b);this.small=this.featuredSmall;this.large=this.featured;delete this.featured_small;delete this.featured;delete this.gallery;delete this.original}}));
dojo._hasResource["toura.models.Video"]||(dojo._hasResource["toura.models.Video"]=!0,dojo.provide("toura.models.Video"),dojo.declare("toura.models.Video",[toura.models._CaptionedAsset,toura.models._StorableAsset],{constructor:function(a,b){b.video?(a.fetchItemByIdentity({identity:b.video._reference,onItem:function(b){dojo.mixin(this,{id:a.getValue(b,"id"),name:a.getValue(b,"name"),poster:a.getValue(b,"poster")});this._getUrl(a,b)},scope:this}),this._processCaption(a,b),this.poster&&(this.poster=this._posterOnDevice()?
toura.URL.storedAsset("videoPoster",this.poster.filename):this.poster.url)):dojo.mixin(this,{id:a.getValue(b,"id"),name:a.getValue(b,"name"),url:a.getValue(b,"url")})},_posterOnDevice:function(){var a=this.poster.filename;return toura.manifest&&toura.manifest.videos&&-1<dojo.indexOf(toura.manifest.videos.posters||[],a)}}));
dojo._hasResource["toura.models.Audio"]||(dojo._hasResource["toura.models.Audio"]=!0,dojo.provide("toura.models.Audio"),dojo.declare("toura.models.Audio",[toura.models._CaptionedAsset,toura.models._StorableAsset],{constructor:function(a,b){a.fetchItemByIdentity({identity:b.audio._reference,onItem:function(b){dojo.mixin(this,{id:a.getValue(b,"id"),name:a.getValue(b,"name")});this._getUrl(a,b)},scope:this});this._processCaption(a,b)}}));
dojo._hasResource["toura.models.Data"]||(dojo._hasResource["toura.models.Data"]=!0,dojo.provide("toura.models.Data"),dojo.declare("toura.models.Data",null,{constructor:function(a,b){a.fetchItemByIdentity({identity:b.dataAsset._reference,onItem:function(b){dojo.mixin(this,{id:a.getValue(b,"id"),name:a.getValue(b,"name"),type:a.getValue(b,"dataType"),json:JSON.parse(a.getValue(b,"value"))})},scope:this})}}));
dojo._hasResource["toura.models.GoogleMapPin"]||(dojo._hasResource["toura.models.GoogleMapPin"]=!0,dojo.provide("toura.models.GoogleMapPin"),dojo.declare("toura.models.GoogleMapPin",toura.models._CaptionedAsset,{constructor:function(a,b){a.fetchItemByIdentity({identity:b.googleMapPin._reference,onItem:function(b){dojo.mixin(this,{id:a.getValue(b,"id"),name:a.getValue(b,"name"),lat:a.getValue(b,"lat"),lon:a.getValue(b,"lon"),address:a.getValue(b,"address"),phoneNumber:a.getValue(b,"phoneNumber"),website:a.getValue(b,
"website")})},scope:this});this._processCaption(a,b)}}));
dojo._hasResource["toura.models.Feed"]||(dojo._hasResource["toura.models.Feed"]=!0,dojo.provide("toura.models.Feed"),function(){dojo.declare("toura.models.Feed",null,{throttle:3E5,constructor:function(a,b){b&&b.feed?a.fetchItemByIdentity({identity:b.feed._reference,onItem:function(b){dojo.mixin(this,{feedUrl:a.getValue(b,"feedUrl"),id:a.getValue(b,"id"),name:a.getValue(b,"name")})},scope:this}):dojo.mixin(this,{feedUrl:a.getValue(b,"feedUrl"),id:a.getValue(b,"id"),name:a.getValue(b,"name")});this.lastChecked=
mulberry.app.DeviceStorage.get(this.id+"-checked")},load:function(){var a=mulberry.app.PhoneGap.present?dojo.hitch(dojo,"xhrGet"):dojo.hitch(dojo.io.script,"get"),b=new dojo.Deferred;(new Date).getTime()-this.lastChecked<this.throttle?b.resolve(this._get()):mulberry.app.PhoneGap.network.isReachable().then(dojo.hitch(this,function(c){c?a(this._createArgs(b)):b.resolve(this._get())}));return b.promise},getItem:function(a){this._get();a=this.items[a];a.siblings=this.items;return a},_onLoad:function(a,
b){this.lastChecked=(new Date).getTime();b&&b.query&&b.query.results&&b.query.results.item?(this.items=dojo.map(b.query.results.item,function(a,b){a.index=b;return new toura.models.FeedItem(a,this)},this),this.updated=new dojo.date.stamp.fromISOString(b.query.created)):(console.warn("There were no results for feed",this.id,b),this.items=[]);this._store();a.resolve(this._get())},_onError:function(a){a.resolve(this._get()||[])},_store:function(){mulberry.app.DeviceStorage.set(this.id,this.items);mulberry.app.DeviceStorage.set(this.id+
"-checked",this.lastChecked)},_get:function(){return this.items=dojo.map(mulberry.app.DeviceStorage.get(this.id)||[],function(a){a.pubDate=new Date(a.pubDate);return a})},_createArgs:function(a){a={url:"http://query.yahooapis.com/v1/public/yql",content:{q:"select * from feed where url='{{feed}}' limit 15".replace("{{feed}}",this.feedUrl),format:"json"},preventCache:!0,load:dojo.hitch(this,"_onLoad",a),error:dojo.hitch(this,"_onError",a)};mulberry.app.PhoneGap.present?a.handleAs="json":a.callbackParamName=
"callback";return a}});dojo.declare("toura.models.FeedItem",null,{constructor:function(a,b){this.type="feedItem";dojo.mixin(this,{title:a.title||"",body:a.description||"",url:toura.URL.feedItem(b.id,a.index),link:a.link,pubDate:a.pubDate,name:a.title,feedName:b.name,id:b.id+"-"+a.index});dojo.isObject(this.body)&&(this.body=this.body.content||null);dojo.isObject(this.link)&&(this.link=this.link.content||null);dojo.isObject(this.title)&&(this.title=this.title.content||null);this.image=this._getImage(a);
this.author=this._getAuthor(a)},_getImage:function(a){return(a=a.enclosure||a.content)&&a.type&&a.type.match(/(jpeg|png)/i)?{url:a.url}:""},_getAuthor:function(a){return(a=a.author)&&a.displayName?a.displayName:""}})}());
dojo._hasResource["toura.models.Node"]||(dojo._hasResource["toura.models.Node"]=!0,dojo.provide("toura.models.Node"),function(){var a={};dojo.subscribe("/tour/update",function(){a={}});dojo.declare("toura.models.Node",null,{constructor:function(b,c){var d=b.getValue(c,"id"),e=mulberry.Device;if(a[d])dojo.mixin(this,a[d]);else{this.store=b;this._dataCache={};var f=function(a,d){return dojo.map(b.getValues(c,a)||[],function(a){return new d(b,a)})};dojo.mixin(this,{type:"node",id:d,name:b.getValue(c,
"name"),headerImage:{phone:f("phoneHeaderImage",toura.models.HeaderImage)[0],tablet:f("tabletHeaderImage",toura.models.HeaderImage)[0]},backgroundImage:{phone:f("phoneBackgroundImage",toura.models.BackgroundImage)[0],tablet:f("tabletBackgroundImage",toura.models.BackgroundImage)[0]},featuredImage:f("featuredImage",toura.models.FeaturedImage)[0],children:b.getValues(c,"children"),bodyText:b.getValue(c,"bodyText"),images:f("images",toura.models.Image),audios:f("audios",toura.models.Audio),videos:f("videos",
toura.models.Video),data:f("dataAssets",toura.models.Data),staticMapImages:f("imageMapImages",toura.models.Image),googleMapPins:f("googleMapPins",toura.models.GoogleMapPin),feeds:f("feeds",toura.models.Feed),pageDef:b.getValue(c,"pageController"),sharingURL:b.getValue(c,"sharingUrl"),parent:b.getValue(c,"parent")});dojo.mixin(this,{url:toura.URL.node(this.id),bodyText:this.bodyText&&new toura.models.TextAsset(b,this.bodyText),assetTypeUrl:function(a){return this.url+"/"+a},parent:this.parent&&new toura.models.Node(b,
this.parent),isHomeNode:this.id===mulberry.app.Config.get("app").homeNodeId});this.pageDef=dojo.isObject(this.pageDef)?this.pageDef[e.type]:this.pageDef;this.pageDef||(this.pageDef="default");this.siblings=this.parent?dojo.map(this.parent.children,function(a){return new toura.models.SimpleNode(this.store,a)},this):[];this._assetCache={};dojo.forIn(b.getValue(c,"custom"),function(a,b){this[a]=this[a]||b},this);a[d]=this}},_pluralize:function(a){var c={"google-map-pin":"googleMapPins",image:"images",
video:"videos",audio:"audios","static-map-image":"staticMapImages"};c[a]||console.warn("toura.models.Node::_pluralize(): no property found for",a);return c[a]||a+"s"},getAssetById:function(a,c){var d=a+c,e;this._assetCache[d]||(e=this[this._pluralize(a)],e||(console.warn("toura.models.Node::getAssetById(): No matching asset property found for",a),e=[]),e=dojo.filter(e,function(a){return a.id===c}),this._assetCache[d]=e.length?e[0]:!1);return this._assetCache[d]},getBackgroundImage:function(a){var c=
"phone"===a.type?"gallery":"original";return this.backgroundImage&&this.backgroundImage[a.type]?this.backgroundImage[a.type][c]:!1},populateChildren:function(){this.childrenPopulated||(this.children=dojo.map(this.children,function(a){return new toura.models.Node(this.store,a)},this),this.childrenPopulated=!0)},getData:function(a){if(!this._dataCache[a]){var c=dojo.filter(this.data,function(c){return c.type===a});this._dataCache[a]=!c.length?!1:c[0].json}return this._dataCache[a]}})}());
dojo._hasResource["toura.models.SearchResult"]||(dojo._hasResource["toura.models.SearchResult"]=!0,dojo.provide("toura.models.SearchResult"),dojo.declare("toura.models.SearchResult",null,{constructor:function(a,b){var c=b.context,d=b.textAsset;c?(dojo.mixin(this,{nodeId:c.node,type:c.type,displayName:d.name,displayText:d.body,url:toura.URL.searchResult(c)}),a.fetchItemByIdentity({identity:c.node,onItem:function(b){b=new toura.models.Node(a,b);this.nodeTitle=b.name;"node"!==c.type&&(this.asset=b.getAssetById(c.type,
c.id))},scope:this})):(d=new toura.models.Node(a,b),dojo.mixin(this,{type:"node",nodeId:d.id,displayName:d.name,displayText:d.bodyText?d.bodyText.body||"":"",url:toura.URL.searchResult({type:"node",node:d.id}),nodeTitle:d.name}))}}));
dojo._hasResource["toura.Data"]||(dojo._hasResource["toura.Data"]=!0,dojo.provide("toura.Data"),dojo.declare("toura.Data",null,{cache:{},searchCache:{},models:{node:toura.models.Node,backgroundImage:toura.models.BackgroundImage,feed:toura.models.Feed,featuredImage:toura.models.FeaturedImage},constructor:function(a){this.loadData(a)},loadData:function(a){this.cache={};this.searchCache={};this._store=new dojo.data.ItemFileReadStore({data:{identifier:"id",items:a},hierarchical:!1});this.onLoadData(a)},
onLoadData:function(a){dojo.publish("/data/loaded",[a])},getModel:function(a,b){if(!a)throw Error("toura.Data::getModel requires an id. Possibly your hash string is invalid?");if(!dojo.isString(a))throw Error("toura.Data::getModel requires the id to be a string");var c=this.cache,d=this._store,e,f;if(!c[a]){e=this.getById(a);if(!e)return!1;b=b||d.getValue(e,"type");f=this.models[b];if(e&&!f)throw Error("toura.Data::getModel no model for type "+b);c[a]=new f(d,e)}return c[a]},getById:function(a){var b;
this._store.fetchItemByIdentity({identity:a,scope:this,onItem:dojo.hitch(this,function(a){b=a})});return b},search:function(a){if(!a||!dojo.trim(a))return[];a=dojo.trim(a.replace(/\W/g," "));if(this.searchCache[a])return this.searchCache[a];var b=[],c=[],d=this._store,e=function(a){b=b.concat(a)},f=RegExp(a,"i"),g={},i,h=toura.models.SearchResult;dojo.forEach([{type:"text-asset",body:f},{type:"text-asset",name:f}],function(a){d.fetch({query:a,onComplete:e})});dojo.forEach(b,function(a){var b=new toura.models.TextAsset(d,
a);c=c.concat(dojo.map(b.contexts,function(a){return new h(d,{textAsset:b,context:a})}))},this);d.fetch({query:{type:"node",name:f},onComplete:function(a){c=c.concat(dojo.map(a,function(a){return new h(d,a)}))}});d.fetch({query:{type:"node",identifier:f},onComplete:function(a){i=dojo.map(a,function(a){return new toura.models.SearchResult(d,a)})}});c=i.concat(c);c=dojo.filter(c,function(a){if(g[a.nodeId]&&"node"===a.type||g[a.url])return!1;g[a.url]=!0;return g[a.nodeId]=!0});return this.searchCache[a]=
c}}));
dojo._hasResource["toura.Manifest"]||(dojo._hasResource["toura.Manifest"]=!0,dojo.provide("toura.Manifest"),dojo.declare("toura.Manifest",null,{url:"./media/manifest.js",constructor:function(){dojo.when(this._load(),dojo.hitch(this,"_parse"))},_load:function(){return toura.forceStreaming?void 0:this.manifest||dojo.io.script.get({url:this.url})},_parse:function(){if(toura.manifest){var a={};this._parseDir(a,toura.manifest.dirs);toura.manifest=a}else toura.manifest={}},_parseDir:function(a,b){dojo.forIn(b,function(b,
d){a[b]=d.files?d.files:[];d.dirs&&dojo.forIn(d.dirs,function(d,f){this._parseDir(a[b],f)},this)},this)}}),dojo.subscribe("/app/deviceready",function(){toura.Manifest=new toura.Manifest}));
dojo._hasResource["toura.Routes"]||(dojo._hasResource["toura.Routes"]=!0,dojo.provide("toura.Routes"),function(){var a=function(){function a(){if(!g&&(g=mulberry.app.Config.get("app").backgroundImage))g=(g=g[f.type])?toura.Data.getModel(g,"backgroundImage")["phone"===f.type?"gallery":"original"]:"";return g}function c(c,d,e){var e=e||{},g=toura.Data.getModel(d),p=mulberry.app.UI.currentPage,q;if(g){if(!p||!p.node||d!==p.node.id){try{q=mulberry.createPage(dojo.mixin(g,{pageBackground:g.getBackgroundImage(f)||
a()}))}catch(s){console.error("toura.Routes: can't create a page",s,g);"node-home"!==d&&mulberry.app.Router.back();return}if(q.failure){dojo.isString(q.failure)&&mulberry.app.PhoneGap.notification.alert(q.failure);mulberry.app.Router.back();return}q.init(e);mulberry.app.UI.showPage(q,g)}else p.init(e);d&&!e.assetType&&dojo.publish("/node/view",[c.hash]);mulberry.endLogSection("NODE ROUTE");return!0}console.log("Request for invalid hash",c.hash);mulberry.app.Router.home()}var d,e=function(){var a=
mulberry.app.Config.get("app");e=function(){return a};return a},f=mulberry.Device,g;d=[{route:"/home",handler:function(a,b){toura.lastSearchTerm=null;return c(b,e().homeNodeId)},isDefault:!0},{route:"/about",handler:function(a,b){return c(b,e().aboutNodeId)}},{route:"/maps",handler:function(a,b){return c(b,e().mapNodeId)}},{route:/\/node\/(.*)/,handler:function(a,b){var d=a.splat[0].split("/");return c(b,d[0],{assetType:d[1],assetId:d[2],assetSubId:d[3]})}},{route:/\/search\/?(.*)/,handler:function(c){var d=
mulberry.app.UI.currentPage,c=c.splat&&c.splat[0].split("/")[0],d=mulberry.createPage({pageDef:"search",term:c,getResults:dojo.hitch(toura.Data,"search"),backgroundImage:a()});mulberry.app.UI.showPage(d);return!0}},{route:"/feed/:feedId/item/:itemIndex",handler:function(c){var c=toura.Data.getModel(c.feedId,"feed").getItem(c.itemIndex),d=mulberry.createPage(dojo.mixin(c,{pageDef:"feed-item",backgroundImage:a()}));mulberry.app.UI.showPage(d,c)}}];toura.features.debugPage&&d.push({route:"/debug/:query",
handler:function(c){c=mulberry.createPage({pageDef:"debug",name:"Debug",query:c.query,backgroundImage:a()});mulberry.app.UI.showPage(c)}});toura.features.favorites&&d.push({route:"/favorites",handler:function(){var c=mulberry.createPage({name:dojo.i18n.getLocalization("mulberry","mulberry",mulberry.app.Config.get("locale")).FAVORITES,pageDef:"favorites",favorites:toura.user.Favorites.load(),backgroundImage:a()});mulberry.app.UI.showPage(c)}});return d}();mulberry.routes(a)}());
dojo._hasResource["toura.user.Facebook.android"]||(dojo._hasResource["toura.user.Facebook.android"]=!0,dojo.provide("toura.user.Facebook.android"),toura.user.Facebook.android={init:function(a){this.appId=a;(function(){function a(){}a.prototype.authorize=function(a,b){PhoneGap.exec(b,null,"FacebookAuth","authorize",[a])};a.prototype.request=function(a,b){PhoneGap.exec(b,null,"FacebookAuth","request",[a])};a.prototype.getAccess=function(a){PhoneGap.exec(a,null,"FacebookAuth","getAccess",[])};PhoneGap.addConstructor(function(){PhoneGap.addPlugin("facebook",
new a);PluginManager.addService("FacebookAuth","com.phonegap.plugins.facebook.FacebookAuth")})})()},_realGetAuth:function(){var a=new dojo.Deferred;window.plugins.facebook.authorize(this.appId,dojo.hitch(this,function(b){b.token?(this.token=b.token,a.resolve(b.token)):window.plugins.facebook.getAccess(dojo.hitch(this,function(b){b.token?(this.token=b.token,a.resolve(b.token)):a.reject()}))}));return a}});
dojo._hasResource["toura.user.Facebook.ios"]||(dojo._hasResource["toura.user.Facebook.ios"]=!0,dojo.provide("toura.user.Facebook.ios"),toura.user.Facebook.ios={init:function(a){this.authUrl="https://graph.facebook.com/oauth/authorize?"+dojo.objectToQuery({client_id:a,display:"touch",redirect_uri:"https://www.facebook.com/connect/login_success.html",response_type:"token",scope:"publish_stream,offline_access"});this.childBrowser=mulberry.app.PhoneGap.browser.getBrowser()},_realGetAuth:function(){var a=
new dojo.Deferred;this.childBrowser.showWebPage(this.authUrl);this.childBrowser.onLocationChange=dojo.hitch(this,function(b){(b=this._findToken(b))?(this.childBrowser.close(),a.resolve(b)):a.reject()});return a},_findToken:function(a){return a.indexOf("login_success")?dojo.queryToObject(unescape(a).split("#")[1]).access_token:!1}});
dojo._hasResource["toura.user.Facebook.browser"]||(dojo._hasResource["toura.user.Facebook.browser"]=!0,dojo.provide("toura.user.Facebook.browser"),toura.user.Facebook.browser={init:function(a){if(toura.features.socialInBrowser){window.fbAsyncInit=function(){FB.init({appId:a})};var b=document.createElement("script");b.src=document.location.protocol+"//connect.facebook.net/en_US/all.js";b.async=!0;var c=document.getElementsByTagName("script")[0];c.parentNode.insertBefore(b,c)}},_realGetAuth:function(){var a=
new dojo.Deferred;FB?FB.login(function(b){a.resolve(b.session&&b.session.access_token)},{perms:"publish_stream"}):a.resolve();return a},_postMessage:function(a){var b=new dojo.Deferred;FB?FB.api("/me/feed","post",{message:a},function(a){!a||a.error?b.reject(a&&a.error):b.resolve()}):b.resolve();return b.promise}});
dojo._hasResource["toura.user.Facebook.base"]||(dojo._hasResource["toura.user.Facebook.base"]=!0,dojo.provide("toura.user.Facebook.base"),dojo.declare("toura.user.Facebook.base",null,{token:null,constructor:function(){this.device=mulberry.Device;dojo.mixin(this,toura.user.Facebook[mulberry.app.PhoneGap.present?this.device.os:"browser"]);var a=mulberry.app.Config.get("app").facebookApiKey;a?this.init(a):this.disabled=!0},isAuthenticated:function(){console.log("toura.user.Facebook::isAuthenticated()");
return!!this.token},postMessage:function(a){console.log("toura.user.Facebook::postMessage()");if(a){var b=new dojo.Deferred;dojo.when(this._getAuth(),dojo.hitch(this,function(c){this.token=c;this._postMessage(a,c).then(b.resolve,b.reject)}));return b.promise}},_postMessage:function(a,b){var c="https://graph.facebook.com/me/feed?"+dojo.objectToQuery({message:a,link:"",picture:""})+"&access_token="+b;return dojo.xhrPost({url:c})},_getAuth:function(){console.log("toura.user.Facebook::_getAuth()");return this.token||
this._realGetAuth().promise}}));
dojo._hasResource["vendor.sha"]||(dojo._hasResource["vendor.sha"]=!0,dojo.provide("vendor.sha"),function(){var a=function(a,b){this.highOrder=a;this.lowOrder=b},b=function(a){var b=[],c=8*a.length,d;for(d=0;d<c;d+=8)b[d>>5]|=(a.charCodeAt(d/8)&255)<<24-d%32;return b},c=function(a){var b=[],c=a.length,d,e;for(d=0;d<c;d+=2){e=parseInt(a.substr(d,2),16);if(isNaN(e))return"INVALID HEX STRING";b[d>>3]|=e<<24-4*(d%8)}return b},d=function(a){var b="",c=4*a.length,d,e;for(d=0;d<c;d+=1)e=a[d>>2]>>8*(3-d%4),
b+="0123456789abcdef".charAt(e>>4&15)+"0123456789abcdef".charAt(e&15);return b},e=function(a){var b="",c=4*a.length,d,e,f;for(d=0;d<c;d+=3){f=(a[d>>2]>>8*(3-d%4)&255)<<16|(a[d+1>>2]>>8*(3-(d+1)%4)&255)<<8|a[d+2>>2]>>8*(3-(d+2)%4)&255;for(e=0;4>e;e+=1)b=8*d+6*e<=32*a.length?b+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(f>>6*(3-e)&63):b+""}return b},f=function(a,b){return a<<b|a>>>32-b},g=function(a,b){return a>>>b|a<<32-b},i=function(b,c){return 32>=c?new a(b.highOrder>>>
c|b.lowOrder<<32-c,b.lowOrder>>>c|b.highOrder<<32-c):new a(b.lowOrder>>>c|b.highOrder<<32-c,b.highOrder>>>c|b.lowOrder<<32-c)},h=function(b,c){return 32>=c?new a(b.highOrder>>>c,b.lowOrder>>>c|b.highOrder<<32-c):new a(0,b.highOrder<<32-c)},k=function(a,b,c){return a&b^~a&c},j=function(b,c,d){return new a(b.highOrder&c.highOrder^~b.highOrder&d.highOrder,b.lowOrder&c.lowOrder^~b.lowOrder&d.lowOrder)},p=function(a,b,c){return a&b^a&c^b&c},q=function(b,c,d){return new a(b.highOrder&c.highOrder^b.highOrder&
d.highOrder^c.highOrder&d.highOrder,b.lowOrder&c.lowOrder^b.lowOrder&d.lowOrder^c.lowOrder&d.lowOrder)},s=function(a){return g(a,2)^g(a,13)^g(a,22)},n=function(b){var c=i(b,28),d=i(b,34),b=i(b,39);return new a(c.highOrder^d.highOrder^b.highOrder,c.lowOrder^d.lowOrder^b.lowOrder)},A=function(a){return g(a,6)^g(a,11)^g(a,25)},u=function(b){var c=i(b,14),d=i(b,18),b=i(b,41);return new a(c.highOrder^d.highOrder^b.highOrder,c.lowOrder^d.lowOrder^b.lowOrder)},o=function(a){return g(a,7)^g(a,18)^a>>>3},
C=function(b){var c=i(b,1),d=i(b,8),b=h(b,7);return new a(c.highOrder^d.highOrder^b.highOrder,c.lowOrder^d.lowOrder^b.lowOrder)},J=function(a){return g(a,17)^g(a,19)^a>>>10},F=function(b){var c=i(b,19),d=i(b,61),b=h(b,6);return new a(c.highOrder^d.highOrder^b.highOrder,c.lowOrder^d.lowOrder^b.lowOrder)},G=function(a,b){var c=(a&65535)+(b&65535);return((a>>>16)+(b>>>16)+(c>>>16)&65535)<<16|c&65535},X=function(a,b,c,d){var e=(a&65535)+(b&65535)+(c&65535)+(d&65535);return((a>>>16)+(b>>>16)+(c>>>16)+
(d>>>16)+(e>>>16)&65535)<<16|e&65535},w=function(a,b,c,d,e){var f=(a&65535)+(b&65535)+(c&65535)+(d&65535)+(e&65535);return((a>>>16)+(b>>>16)+(c>>>16)+(d>>>16)+(e>>>16)+(f>>>16)&65535)<<16|f&65535},Y=function(b,c){var d,e,f;d=(b.lowOrder&65535)+(c.lowOrder&65535);e=(b.lowOrder>>>16)+(c.lowOrder>>>16)+(d>>>16);f=(e&65535)<<16|d&65535;d=(b.highOrder&65535)+(c.highOrder&65535)+(e>>>16);e=(b.highOrder>>>16)+(c.highOrder>>>16)+(d>>>16);return new a((e&65535)<<16|d&65535,f)},Z=function(b,c,d,e){var f,g,
h;f=(b.lowOrder&65535)+(c.lowOrder&65535)+(d.lowOrder&65535)+(e.lowOrder&65535);g=(b.lowOrder>>>16)+(c.lowOrder>>>16)+(d.lowOrder>>>16)+(e.lowOrder>>>16)+(f>>>16);h=(g&65535)<<16|f&65535;f=(b.highOrder&65535)+(c.highOrder&65535)+(d.highOrder&65535)+(e.highOrder&65535)+(g>>>16);g=(b.highOrder>>>16)+(c.highOrder>>>16)+(d.highOrder>>>16)+(e.highOrder>>>16)+(f>>>16);return new a((g&65535)<<16|f&65535,h)},$=function(b,c,d,e,f){var g,h,i;g=(b.lowOrder&65535)+(c.lowOrder&65535)+(d.lowOrder&65535)+(e.lowOrder&
65535)+(f.lowOrder&65535);h=(b.lowOrder>>>16)+(c.lowOrder>>>16)+(d.lowOrder>>>16)+(e.lowOrder>>>16)+(f.lowOrder>>>16)+(g>>>16);i=(h&65535)<<16|g&65535;g=(b.highOrder&65535)+(c.highOrder&65535)+(d.highOrder&65535)+(e.highOrder&65535)+(f.highOrder&65535)+(h>>>16);h=(b.highOrder>>>16)+(c.highOrder>>>16)+(d.highOrder>>>16)+(e.highOrder>>>16)+(f.highOrder>>>16)+(g>>>16);return new a((h&65535)<<16|g&65535,i)},D=function(a,b){var c=[],d,e,g,h,i,j,k,n,o,m=[1732584193,4023233417,2562383102,271733878,3285377520],
q=[1518500249,1518500249,1518500249,1518500249,1518500249,1518500249,1518500249,1518500249,1518500249,1518500249,1518500249,1518500249,1518500249,1518500249,1518500249,1518500249,1518500249,1518500249,1518500249,1518500249,1859775393,1859775393,1859775393,1859775393,1859775393,1859775393,1859775393,1859775393,1859775393,1859775393,1859775393,1859775393,1859775393,1859775393,1859775393,1859775393,1859775393,1859775393,1859775393,1859775393,2400959708,2400959708,2400959708,2400959708,2400959708,2400959708,
2400959708,2400959708,2400959708,2400959708,2400959708,2400959708,2400959708,2400959708,2400959708,2400959708,2400959708,2400959708,2400959708,2400959708,3395469782,3395469782,3395469782,3395469782,3395469782,3395469782,3395469782,3395469782,3395469782,3395469782,3395469782,3395469782,3395469782,3395469782,3395469782,3395469782,3395469782,3395469782,3395469782,3395469782];a[b>>5]|=128<<24-b%32;a[(b+65>>9<<4)+15]=b;o=a.length;for(k=0;k<o;k+=16){d=m[0];e=m[1];g=m[2];h=m[3];i=m[4];for(n=0;80>n;n+=1)c[n]=
16>n?a[n+k]:f(c[n-3]^c[n-8]^c[n-14]^c[n-16],1),j=20>n?w(f(d,5),e&g^~e&h,i,q[n],c[n]):40>n?w(f(d,5),e^g^h,i,q[n],c[n]):60>n?w(f(d,5),p(e,g,h),i,q[n],c[n]):w(f(d,5),e^g^h,i,q[n],c[n]),i=h,h=g,g=f(e,30),e=d,d=j;m[0]=G(d,m[0]);m[1]=G(e,m[1]);m[2]=G(g,m[2]);m[3]=G(h,m[3]);m[4]=G(i,m[4])}return m},y=function(b,c,d){var e,f,g,h,i,E,H,y,D,m,v,t,r,O,M,x,N,P,Q,R,S,T,U,V,l,W,I=[],K;if("SHA-224"===d||"SHA-256"===d)v=64,e=(c+65>>9<<4)+15,O=16,M=1,l=Number,x=G,N=X,P=w,Q=o,R=J,S=s,T=A,V=p,U=k,W=[1116352408,1899447441,
3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,
506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298],m="SHA-224"===d?[3238371032,914150663,812702999,4144912697,4290775857,1750603025,1694076839,3204075428]:[1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225];else if("SHA-384"===d||"SHA-512"===d)v=80,e=(c+128>>10<<5)+31,O=32,M=2,l=a,x=Y,N=Z,P=$,Q=C,R=F,S=n,T=u,V=q,U=j,W=[new l(1116352408,3609767458),new l(1899447441,
602891725),new l(3049323471,3964484399),new l(3921009573,2173295548),new l(961987163,4081628472),new l(1508970993,3053834265),new l(2453635748,2937671579),new l(2870763221,3664609560),new l(3624381080,2734883394),new l(310598401,1164996542),new l(607225278,1323610764),new l(1426881987,3590304994),new l(1925078388,4068182383),new l(2162078206,991336113),new l(2614888103,633803317),new l(3248222580,3479774868),new l(3835390401,2666613458),new l(4022224774,944711139),new l(264347078,2341262773),new l(604807628,
2007800933),new l(770255983,1495990901),new l(1249150122,1856431235),new l(1555081692,3175218132),new l(1996064986,2198950837),new l(2554220882,3999719339),new l(2821834349,766784016),new l(2952996808,2566594879),new l(3210313671,3203337956),new l(3336571891,1034457026),new l(3584528711,2466948901),new l(113926993,3758326383),new l(338241895,168717936),new l(666307205,1188179964),new l(773529912,1546045734),new l(1294757372,1522805485),new l(1396182291,2643833823),new l(1695183700,2343527390),new l(1986661051,
1014477480),new l(2177026350,1206759142),new l(2456956037,344077627),new l(2730485921,1290863460),new l(2820302411,3158454273),new l(3259730800,3505952657),new l(3345764771,106217008),new l(3516065817,3606008344),new l(3600352804,1432725776),new l(4094571909,1467031594),new l(275423344,851169720),new l(430227734,3100823752),new l(506948616,1363258195),new l(659060556,3750685593),new l(883997877,3785050280),new l(958139571,3318307427),new l(1322822218,3812723403),new l(1537002063,2003034995),new l(1747873779,
3602036899),new l(1955562222,1575990012),new l(2024104815,1125592928),new l(2227730452,2716904306),new l(2361852424,442776044),new l(2428436474,593698344),new l(2756734187,3733110249),new l(3204031479,2999351573),new l(3329325298,3815920427),new l(3391569614,3928383900),new l(3515267271,566280711),new l(3940187606,3454069534),new l(4118630271,4000239992),new l(116418474,1914138554),new l(174292421,2731055270),new l(289380356,3203993006),new l(460393269,320620315),new l(685471733,587496836),new l(852142971,
1086792851),new l(1017036298,365543100),new l(1126000580,2618297676),new l(1288033470,3409855158),new l(1501505948,4234509866),new l(1607167915,987167468),new l(1816402316,1246189591)],m="SHA-384"===d?[new l(3418070365,3238371032),new l(1654270250,914150663),new l(2438529370,812702999),new l(355462360,4144912697),new l(1731405415,4290775857),new l(41048885895,1750603025),new l(3675008525,1694076839),new l(1203062813,3204075428)]:[new l(1779033703,4089235720),new l(3144134277,2227873595),new l(1013904242,
4271175723),new l(2773480762,1595750129),new l(1359893119,2917565137),new l(2600822924,725511199),new l(528734635,4215389547),new l(1541459225,327033209)];b[c>>5]|=128<<24-c%32;b[e]=c;K=b.length;for(t=0;t<K;t+=O){c=m[0];e=m[1];f=m[2];g=m[3];h=m[4];i=m[5];E=m[6];H=m[7];for(r=0;r<v;r+=1)I[r]=16>r?new l(b[r*M+t],b[r*M+t+1]):N(R(I[r-2]),I[r-7],Q(I[r-15]),I[r-16]),y=P(H,T(h),U(h,i,E),W[r],I[r]),D=x(S(c),V(c,e,f)),H=E,E=i,i=h,h=x(g,y),g=f,f=e,e=c,c=x(y,D);m[0]=x(c,m[0]);m[1]=x(e,m[1]);m[2]=x(f,m[2]);m[3]=
x(g,m[3]);m[4]=x(h,m[4]);m[5]=x(i,m[5]);m[6]=x(E,m[6]);m[7]=x(H,m[7])}switch(d){case "SHA-224":return[m[0],m[1],m[2],m[3],m[4],m[5],m[6]];case "SHA-256":return m;case "SHA-384":return[m[0].highOrder,m[0].lowOrder,m[1].highOrder,m[1].lowOrder,m[2].highOrder,m[2].lowOrder,m[3].highOrder,m[3].lowOrder,m[4].highOrder,m[4].lowOrder,m[5].highOrder,m[5].lowOrder];case "SHA-512":return[m[0].highOrder,m[0].lowOrder,m[1].highOrder,m[1].lowOrder,m[2].highOrder,m[2].lowOrder,m[3].highOrder,m[3].lowOrder,m[4].highOrder,
m[4].lowOrder,m[5].highOrder,m[5].lowOrder,m[6].highOrder,m[6].lowOrder,m[7].highOrder,m[7].lowOrder];default:return[]}},K=function(a,d){this.strToHash=this.strBinLen=this.sha512=this.sha384=this.sha256=this.sha224=this.sha1=null;if("HEX"===d){if(0!==a.length%2)return"TEXT MUST BE IN BYTE INCREMENTS";this.strBinLen=4*a.length;this.strToHash=c(a)}else if("ASCII"===d||"undefined"===typeof d)this.strBinLen=8*a.length,this.strToHash=b(a);else return"UNKNOWN TEXT INPUT TYPE"};K.prototype={getHash:function(a,
b){var c=null,f=this.strToHash.slice();switch(b){case "HEX":c=d;break;case "B64":c=e;break;default:return"FORMAT NOT RECOGNIZED"}switch(a){case "SHA-1":return null===this.sha1&&(this.sha1=D(f,this.strBinLen)),c(this.sha1);case "SHA-224":return null===this.sha224&&(this.sha224=y(f,this.strBinLen,a)),c(this.sha224);case "SHA-256":return null===this.sha256&&(this.sha256=y(f,this.strBinLen,a)),c(this.sha256);case "SHA-384":return null===this.sha384&&(this.sha384=y(f,this.strBinLen,a)),c(this.sha384);
case "SHA-512":return null===this.sha512&&(this.sha512=y(f,this.strBinLen,a)),c(this.sha512);default:return"HASH NOT RECOGNIZED"}},getHMAC:function(a,f,g,h){var i,j,k,n,o;j=[];var p=[];switch(h){case "HEX":h=d;break;case "B64":h=e;break;default:return"FORMAT NOT RECOGNIZED"}switch(g){case "SHA-1":i=64;o=160;break;case "SHA-224":i=64;o=224;break;case "SHA-256":i=64;o=256;break;case "SHA-384":i=128;o=384;break;case "SHA-512":i=128;o=512;break;default:return"HASH NOT RECOGNIZED"}if("HEX"===f){if(0!==
a.length%2)return"KEY MUST BE IN BYTE INCREMENTS";f=c(a);n=4*a.length}else if("ASCII"===f)f=b(a),n=8*a.length;else return"UNKNOWN KEY INPUT TYPE";a=8*i;k=i/4-1;i<n/8?(f="SHA-1"===g?D(f,n):y(f,n,g),f[k]&=4294967040):i>n/8&&(f[k]&=4294967040);for(i=0;i<=k;i+=1)j[i]=f[i]^909522486,p[i]=f[i]^1549556828;"SHA-1"===g?(j=D(j.concat(this.strToHash),a+this.strBinLen),j=D(p.concat(j),a+o)):(j=y(j.concat(this.strToHash),a+this.strBinLen,g),j=y(p.concat(j),a+o,g));return h(j)}};window.jsSHA=K}());
dojo._hasResource["toura.user.Twitter"]||(dojo._hasResource["toura.user.Twitter"]=!0,dojo.provide("toura.user.Twitter"),function(){var a;dojo.declare("toura.user.Twitter",null,{constructor:function(){var a={customerKey:mulberry.app.Config.get("app").twitterCustomerKey,customerSecret:mulberry.app.Config.get("app").twitterCustomerSecret};a.customerKey&&a.customerSecret?(this.twitterConfig=a,mulberry.app.PhoneGap.present&&(this.childBrowser=mulberry.app.PhoneGap.browser.getBrowser())):this.disabled=
!0},setUserInfo:function(b){console.log("toura.user.Twitter::setUserInfo()");return b.username&&b.password?(a=b,!0):!1},isAuthenticated:function(){console.log("toura.user.Twitter::isAuthenticated()");return mulberry.app.PhoneGap.present?!(!this.oauth_token||!this.oauth_token_secret):!1},postMessage:function(a){console.log("toura.user.Twitter::postMessage()");if(a){mulberry.silenceSharing&&console.log("sharing silenced; twitter message would have been",a);var c=new dojo.Deferred;dojo.when(this._getAuth(),
dojo.hitch(this,function(d){this._postMessage(a,d).then(c.resolve,c.reject)}));return c.promise}},_postMessage:function(a){console.log("toura.user.Twitter::_postMessage()");var c=new toura.user._TwitterAPI({customerKey:this.twitterConfig.customerKey,consumerSecret:this.twitterConfig.customerSecret}),d=this._getAuthTokenFields(),e=new dojo.Deferred;c.setAuth(d);c.setupUpdate(a)?dojo.xhrPost({url:c.getPostTarget(),headers:c.getAuthHeader(),load:e.resolve}):e.reject();return e.promise},_getAuthTokenFields:function(){console.log("toura.user.Twitter::_getAuthTokenFields()");
return{oauth_token:this.oauth_token,oauth_token_secret:this.oauth_token_secret}},_getAuth:function(){console.log("toura.user.Twitter::_getAuth()");var b=new dojo.Deferred,c;if(!mulberry.app.PhoneGap.present)return b.resolve(!0),b.promise;if(this.isAuthenticated())return this._getAuthTokenFields();if(a)return c=new toura.user._TwitterAPI({customerKey:this.twitterConfig.customerKey,consumerSecret:this.twitterConfig.customerSecret}),c.setupAuthPost(a.username,a.password),dojo.xhrPost({url:c.getPostTarget(),
headers:c.getAuthHeader()}).then(dojo.hitch(this,function(a){a=dojo.queryToObject(a);dojo.mixin(this,a);b.resolve({oauth_token:this.oauth_token,oauth_token_secret:this.oauth_token_secret})}),b.reject),b.promise;console.error("user not found")}})}(),dojo.declare("toura.user._TwitterAPI",null,{sigBaseTemplate:"POST&{{ path }}&oauth_consumer_key%3D{{ customer_key }}%26oauth_nonce%3D{{ nonce }}%26oauth_signature_method%3DHMAC-SHA1%26oauth_timestamp%3D{{ time }}%26{{ optional_token }}oauth_version%3D1.0%26{{ post_body }}",
authTemplate:'OAuth oauth_nonce="{{ nonce }}", oauth_signature_method="HMAC-SHA1", oauth_timestamp="{{ time }}", oauth_consumer_key="{{ customer_key }}", {{ optional_token }}oauth_signature="{{ signature }}", oauth_version="1.0"',constructor:function(a){this.config=a;this.consumerSecret=this.config.consumerSecret+"&";this.nonce=this._createNonce();this.timestamp=(new Date((new Date).toUTCString())).getTime()/1E3},_encode:function(a){return encodeURIComponent(a).replace(/!/g,"%21").replace(/'/g,"%27").replace(/\(/g,
"%28").replace(/\)/g,"%29").replace(/\*/g,"%2A")},_createNonce:function(){for(var a=[],b=5;b--;)a.push((65536*(1+Math.random())).toString(16).substring(1));return a.join("")},getPostTarget:function(){return[this.path,this.postBody].join("?")},setSignature:function(a){this.signature=(new jsSHA(this.signatureBaseString,"ASCII")).getHMAC(a,"ASCII","SHA-1","B64")+"%3D"},setupBaseString:function(a){this.signatureBaseString=this.sigBaseTemplate.split("{{ path }}").join(encodeURIComponent(this.path)).split("{{ customer_key }}").join(this.config.customerKey).split("{{ optional_token }}").join(a?
"oauth_token%3D"+a+"%26":"").split("{{ nonce }}").join(this.nonce).split("{{ time }}").join(this.timestamp).split("{{ post_body }}").join(encodeURIComponent(this.postBody))},setupAuthHeader:function(a){this.authHeader=this.authTemplate.split("{{ nonce }}").join(this.nonce).split("{{ customer_key }}").join(this.config.customerKey).split("{{ optional_token }}").join(a?'oauth_token="'+a+'", ':"").split("{{ time }}").join(this.timestamp).split("{{ signature }}").join(this.signature)},getAuthHeader:function(){return{Authorization:this.authHeader}},
setupAuthPost:function(a,b){this.path="https://api.twitter.com/oauth/access_token";this.postBody="x_auth_mode=client_auth&x_auth_password="+this._encode(b)+"&x_auth_username="+this._encode(a);this.setupBaseString();this.setSignature(this.consumerSecret);this.setupAuthHeader();return!0},setupUpdate:function(a){this.path="https://api.twitter.com/1/statuses/update.json";this.postBody="status="+this._encode(a);if(!this.token||!this.tokenSecret)return!1;this.setupBaseString(this.token);this.setSignature(this.consumerSecret+
this.tokenSecret);this.setupAuthHeader(this.token);return!0},setAuth:function(a){this.token=a.oauth_token;this.tokenSecret=a.oauth_token_secret}}),function(){if((!window.device||!window.device.phonegap)&&toura.features.socialInBrowser){var a=mulberry.app.Config.get("app").twitter_anywhere_key;if(a){var b=document.createElement("script"),a="//platform.twitter.com/anywhere.js?"+dojo.objectToQuery({id:a,v:1});b.src=document.location.protocol+a;b.async=!0;document.body.appendChild(b)}}}());
dojo._hasResource["toura.Sharing"]||(dojo._hasResource["toura.Sharing"]=!0,dojo.provide("toura.Sharing"),toura.Sharing={lastPost:{},getMessage:function(a,b){console.log("toura.Sharing::getMessage",arguments);var c=mulberry.app.Config.get("app"),d=c.sharingText||mulberry.sharingText||"${sharingURL}",e=0,b=b||{name:c.name};console.log("app sharing URL is "+c.sharingUrl);b.sharingURL=b.sharingURL||c.sharingUrl||mulberry.sharingURL;b.sharingURL||console.error("No sharing URL defined for object or app. This will end badly.");
d||console.error("No sharing text template defined. This will end badly.");"twitter"===a?(e+=b.sharingURL.length,c=dojo.string.substitute(d,b).split(b.sharingURL),c[1]&&(e+=c[1].length),c=[dojo.trim(c[0].substr(0,140-e)),b.sharingURL,c[1]||""].join(" ")):c=dojo.string.substitute(d,b)+" "+b.sharingURL;return c},share:function(a,b,c){console.log("toura.Sharing::share()");var d=new dojo.Deferred,e=a.name,f=!0;if(!0!==(a.beforePost?!!a.beforePost(b):!0))console.log("beforePost was not true"),d.reject(a.beforePostError),
f=!1;this.lastPost[e]&&this.lastPost[e]===b.msg&&(d.reject("The message is a duplicate."),f=!1);f&&(console.log("doing it"),a.api.postMessage(b.msg).then(dojo.hitch(this,function(){this.lastPost[e]=b.msg;dojo.publish("/share",[[e,c.id,b.msg].join(": ")]);d.resolve()})));return d.promise},getServices:function(){var a=dojo.i18n.getLocalization("mulberry","mulberry",mulberry.app.Config.get("locale")),b=[];toura.user.Twitter.disabled||b.push({name:"twitter",api:toura.user.Twitter,requireAuth:!toura.user.Twitter.isAuthenticated(),
maxLength:140,beforePost:function(a){return!!toura.user.Twitter.setUserInfo(a)},beforePostError:a.TWITTER_AUTHENTICATION_ERROR});toura.user.Facebook.disabled||b.push({name:"facebook",api:toura.user.Facebook});return b}},dojo.subscribe("/app/ready",function(){toura.user.Facebook=new toura.user.Facebook.base;toura.user.Twitter=new toura.user.Twitter}));
dojo._hasResource["mulberry._Capability"]||(dojo._hasResource["mulberry._Capability"]=!0,dojo.provide("mulberry._Capability"),dojo.declare("mulberry._Capability",null,{requirements:{},connects:[],constructor:function(a){dojo.mixin(this,a);this.domNode=this.page.domNode;this.node=this.page.node;this.involved=this._loadInvolvedComponents();if(!this._checkRequirements())throw console.error("Did not find required components for capability",this.declaredClass),console.error("These are the components I know about",
this.involved),"Did not find required components for capability "+this.declaredClass;this._doLookups();this._doConnects();this.init()},init:function(){},_loadInvolvedComponents:function(){var a={};dojo.forEach(this.components||[],function(b){var c=b.split(":"),b=c[0],c=c[1],d=this.page.getScreen(b).getComponent(c);d||console.error("Capability",this.declaredClass,"did not find component for",c,"on the",b,"screen");a[c]=d},this);return a},_checkRequirements:function(){var a=!0;dojo.forIn(this.requirements,
function(b,c){var d=!!this.involved[c]||this.page.getComponent(c);a=a&&d;d||console.warn("did not find",c)},this);return a},_doLookups:function(){dojo.forIn(this.requirements,function(a,b){this[a]=this.involved[b]||this.page.getComponent(b)},this)},_doConnects:function(){dojo.forEach(this.connects,function(a){this.connect.apply(this,a)},this)},connect:function(a,b,c){dojo.isString(a)&&(a=this[a]);this.page.connect(a,b,dojo.hitch(this,c))}}),mulberry.capability=function(a,b){dojo.declare("mulberry.capabilities."+
a,mulberry._Capability,b)});
dojo._hasResource["toura.capabilities.Page_Images"]||(dojo._hasResource["toura.capabilities.Page_Images"]=!0,dojo.provide("toura.capabilities.Page_Images"),dojo.declare("toura.capabilities.Page_Images",mulberry._Capability,{requirements:{imageGallery:"ImageGallery",imageCaption:"ImageCaption"},connects:[["page","init","_setup"]],_setup:function(a){if(a){var b=a.assetId,c;if(b&&(a=dojo.filter(this.baseObj.images,function(a,e){if(a.id===b)return c=e,a})[0]))this.imageGallery&&this.connect(this.imageGallery,
"startup",function(){this.imageGallery.scrollToIndex(c)}),this.imageCaption&&this.imageCaption.set("content",a.caption||"")}}}));
dojo._hasResource["toura.capabilities.Page_GoogleMapTablet"]||(dojo._hasResource["toura.capabilities.Page_GoogleMapTablet"]=!0,dojo.provide("toura.capabilities.Page_GoogleMapTablet"),dojo.declare("toura.capabilities.Page_GoogleMapTablet",mulberry._Capability,{requirements:{googleMap:"GoogleMap",pinInfo:"PinInfo"},connects:[["googleMap","onShowInfo","_showPin"]],init:function(){this.pinInfo.region.hide();this.googleMap.set("pinInfo",this.pinInfo)},_showPin:function(a){this.pinInfo.set("pin",a)}}));
dojo._hasResource["toura.capabilities.Page_GoogleMapPhone"]||(dojo._hasResource["toura.capabilities.Page_GoogleMapPhone"]=!0,dojo.provide("toura.capabilities.Page_GoogleMapPhone"),dojo.declare("toura.capabilities.Page_GoogleMapPhone",mulberry._Capability,{requirements:{googleMap:"GoogleMap",pinInfo:"PinInfo",detailTitle:"DetailTitle"},connects:[["googleMap","onShowInfo","_showPin"],["detailTitle","onClose","_hidePin"]],init:function(){this.googleMap.set("pinInfo",this.pinInfo)},_showPin:function(a){this.page.showScreen("detail");
this.pinInfo.set("pin",a);this.detailTitle.set("screenTitle",a.name)},_hidePin:function(){this.page.showScreen("index")}}));
dojo._hasResource["toura.capabilities.Page_FullScreenImages"]||(dojo._hasResource["toura.capabilities.Page_FullScreenImages"]=!0,dojo.provide("toura.capabilities.Page_FullScreenImages"),dojo.declare("toura.capabilities.Page_FullScreenImages",mulberry._Capability,{requirements:{imageGallery:"ZoomableImageGallery",pageNav:"PageNav"},connects:[["page","init","_setup"],["imageGallery","onHideChrome","_hideNav"],["imageGallery","onShowChrome","_showNav"]],_setup:function(a){var b=0;a.assetId&&dojo.forEach(this.baseObj.images,
function(c,d){c.id===a.assetId&&(b=d)});this.imageGallery.set("currentImageIndex",b)},_hideNav:function(){this.pageNav.hide()},_showNav:function(){this.pageNav.show()}}));
dojo._hasResource["toura.capabilities.ImageGallery_ImageCaption"]||(dojo._hasResource["toura.capabilities.ImageGallery_ImageCaption"]=!0,dojo.provide("toura.capabilities.ImageGallery_ImageCaption"),dojo.declare("toura.capabilities.ImageGallery_ImageCaption",mulberry._Capability,{requirements:{imageGallery:"ImageGallery",imageCaption:"ImageCaption"},connects:[["imageGallery","onScrollEnd","_setCaption"]],_setCaption:function(a){a=this.baseObj.images[a];this.imageCaption.set("content",a&&a.caption||
"")}}));
dojo._hasResource["mulberry.containers.Viewport"]||(dojo._hasResource["mulberry.containers.Viewport"]=!0,dojo.provide("mulberry.containers.Viewport"),dojo.declare("mulberry.containers.Viewport",mulberry._View,{templateString:dojo.cache("mulberry.containers","Viewport/Viewport.haml","%ol.viewport\n"),direction:"next",postCreate:function(){this.connect(this.domNode,"webkitAnimationEnd","_onAnimationEnd")},_setNavDirectionAttr:function(a){this.direction="back"===a?"prev":"next"},_setContentAttr:function(a){if(!mulberry.animating){var b=this.domNode,
c="next"===this.direction;this.direction="next";this.currentPage=a;b.children.length?(mulberry.animating=!0,this.addClass("pre-slide"),a.placeAt(b,c?"last":"first"),this.addClass(c?"slide-left":"slide-right")):(a.placeAt(b,"last"),this._onAnimationEnd());setTimeout(function(){this.animating&&this._onAnimationEnd()},600)}},_cleanupOldPage:function(){var a=document.querySelectorAll("ol.viewport > li");dojo.forEach(a,function(a){this.currentPage.domNode!==a&&(dojo.destroy(a),(a=dijit.byNode(a))&&a.destroy())},
this);this.removeClass(["slide-left","slide-right","pre-slide"])},_onAnimationEnd:function(){this._cleanupOldPage();mulberry.animating=!1;dojo.publish("/page/transition/end")}}));
dojo._hasResource["mulberry.app.UI"]||(dojo._hasResource["mulberry.app.UI"]=!0,dojo.provide("mulberry.app.UI"),dojo.declare("mulberry.app.UI",dojo.Stateful,{containers:{},currentPage:null,constructor:function(a){this.device=a;this.body=dojo.body();this.hasTouch="ontouchstart"in window;this.touchMoveDebounce="android"===a.os?200:0;this._containersSetup();this._watchers();this._updateViewport();this._uiSetup();this._eventSetup()},addPersistentComponent:function(a,b,c){a=new a(b);a.placeAt(this.body,
c);return a},_watchers:function(){dojo.forIn({fontSize:function(a,b,c){a=this.body;b&&dojo.removeClass(a,b);dojo.addClass(a,c);mulberry.app.DeviceStorage.set("fontSize",c);dojo.publish("/fontsize")},navDirection:function(a,b,c){this.containers.viewport.set("navDirection",c)}},this.watch,this)},_updateViewport:function(){this.viewport={width:this.body.offsetWidth,height:this.body.offsetHeight}},_uiSetup:function(){var a=this.body,b=this.device;dojo.addClass(a,b.type);dojo.addClass(a,b.os);dojo.addClass(a,
"version-"+mulberry.app.PhoneGap.device.version);this.set("fontSize",mulberry.app.DeviceStorage.get("fontSize"));mulberry.isMAP&&dojo.addClass(a,"layout-MAP");mulberry.features&&mulberry.features.debugToolbar&&mulberry.app._Debug()},_containersSetup:function(){this.containers.viewport=(new mulberry.containers.Viewport).placeAt(this.body,"first")},_eventSetup:function(){dojo.connect(document,"touchmove",function(a){a.preventDefault()});dojo.connect(window,"resize",this,function(){this._updateViewport();
dojo.publish("/window/resize")});dojo.connect(document,"menubutton",this,function(a){a.preventDefault();dojo.publish("/button/menu")});dojo.connect(document,"backbutton",this,function(a){a.preventDefault();mulberry.app.Router.back()});dojo.connect(document,"searchbutton",this,function(a){mulberry.app.Router.go("/search");a.preventDefault()})},showPage:function(a){if(!a)throw Error("mulberry.app.UI::showPage called without a page to show");if(a.startup)var b=dojo.subscribe("/page/transition/end",function(){a.startup();
dojo.unsubscribe(b)});this.containers.viewport.set("content",a);this.currentPage=a},hideSplash:function(){var a=dojo.byId("splash");a&&dojo.destroy(a)}}),dojo.subscribe("/app/ready",function(){mulberry.app.UI=new mulberry.app.UI(mulberry.Device);dojo.publish("/ui/ready");mulberry.showPage=dojo.hitch(mulberry.app.UI,"showPage")}));
dojo._hasResource["toura.capabilities.ImageGalleryDetail"]||(dojo._hasResource["toura.capabilities.ImageGalleryDetail"]=!0,dojo.provide("toura.capabilities.ImageGalleryDetail"),dojo.declare("toura.capabilities.ImageGalleryDetail",mulberry._Capability,{requirements:{imageGallery:"ImageGallery",imageDetail:"ZoomableImageGallery",detailTitle:"DetailTitle"},connects:[["imageGallery","onShowDetail","_showDetail"],["detailTitle","onClose","_hideDetail"],["imageDetail","onImageChange","_setTitle"],["imageDetail",
"onShowChrome","_showDetailTitle"],["imageDetail","onHideChrome","_hideDetailTitle"]],_showDetail:function(a){mulberry.app.UI.set("siblingNavVisible",!1);this.detailTitle.hide();this.page.showScreen("detail");this.imageDetail.set("currentImageIndex",a);this.imageDetail.set("chromeVisible",!1)},_hideDetail:function(){this.page.showScreen("index");mulberry.app.UI.set("siblingNavVisible",!0);this.imageGallery.scrollToIndex(this.imageDetail.currentImageIndex)},_setTitle:function(a){this.detailTitle.set("screenTitle",
a.name)},_showDetailTitle:function(){this.detailTitle.show()},_hideDetailTitle:function(){this.detailTitle.hide()}}));
dojo._hasResource["toura.capabilities.FeedItemList_FeedItemPage"]||(dojo._hasResource["toura.capabilities.FeedItemList_FeedItemPage"]=!0,dojo.provide("toura.capabilities.FeedItemList_FeedItemPage"),dojo.declare("toura.capabilities.FeedItemList_FeedItemPage",mulberry._Capability,{requirements:{feedItemList:"FeedItemList"},connects:[["feedItemList","onSelect","_navigateToFeedItemPage"]],_navigateToFeedItemPage:function(a,b){var c=toura.URL.feedItem(a,b);mulberry.app.Router.go(c)}}));
dojo._hasResource["toura.capabilities.FeedItemList_FeedItemDetail"]||(dojo._hasResource["toura.capabilities.FeedItemList_FeedItemDetail"]=!0,dojo.provide("toura.capabilities.FeedItemList_FeedItemDetail"),dojo.declare("toura.capabilities.FeedItemList_FeedItemDetail",mulberry._Capability,{requirements:{feedItemList:"FeedItemList",feedItemDetail:"FeedItemDetail"},connects:[["feedItemList","onSelect","_showFeedItem"],["feedItemList","onPopulate","_showFirstItem"]],_showFeedItem:function(a,b){this.feedItemDetail.set("item",
this.feedItemList.feed.getItem(b))},_showFirstItem:function(){this.feedItemDetail.set("item",this.feedItemList.feed.getItem(0))}}));dojo._hasResource["toura.capabilities.PageNav_FeedTitle"]||(dojo._hasResource["toura.capabilities.PageNav_FeedTitle"]=!0,dojo.provide("toura.capabilities.PageNav_FeedTitle"),dojo.declare("toura.capabilities.PageNav_FeedTitle",mulberry._Capability,{requirements:{feedItemDetail:"FeedItemDetail",pageNav:"PageNav"},init:function(){this.pageNav.set("screenTitle",this.page.baseObj.feedName)}}));
dojo._hasResource["toura.capabilities.Page_Audios"]||(dojo._hasResource["toura.capabilities.Page_Audios"]=!0,dojo.provide("toura.capabilities.Page_Audios"),dojo.declare("toura.capabilities.Page_Audios",mulberry._Capability,{requirements:{audioPlayer:"AudioPlayer",audioList:"AudioList"},connects:[["page","init","_setup"]],_setup:function(a){2>this.baseObj.audios.length&&dojo.destroy(this.audioList.domNode);this._loadAudio(a)},_loadAudio:function(a){if(a.assetId&&"audios"===a.assetType){var a=a.assetId,
b=this._audioById(a);this.audioList&&this.audioList.set("currentAsset",a);this.audioCaption&&this.audioCaption.set("content",b.caption||"");this.audioPlayer.set("mediaId",a)}}}));
dojo._hasResource["toura.capabilities.AudioList_AudioPlayer"]||(dojo._hasResource["toura.capabilities.AudioList_AudioPlayer"]=!0,dojo.provide("toura.capabilities.AudioList_AudioPlayer"),dojo.declare("toura.capabilities.AudioList_AudioPlayer",mulberry._Capability,{requirements:{audioList:"AudioList",audioPlayer:"AudioPlayer"},connects:[["audioList","onSelect","_playAudio"]],_playAudio:function(a){this.audioPlayer.play(a)}}));
dojo._hasResource["toura.capabilities.AudioList_AudioCaption"]||(dojo._hasResource["toura.capabilities.AudioList_AudioCaption"]=!0,dojo.provide("toura.capabilities.AudioList_AudioCaption"),dojo.declare("toura.capabilities.AudioList_AudioCaption",mulberry._Capability,{requirements:{audioList:"AudioList",audioCaption:"AudioCaption"},connects:[["audioList","onSelect","_setCaption"]],_setCaption:function(a){(a=this.baseObj.getAssetById("audio",a))&&this.audioCaption.set("content",a.caption||"")}}));
dojo._hasResource["toura.capabilities.Page_Videos"]||(dojo._hasResource["toura.capabilities.Page_Videos"]=!0,dojo.provide("toura.capabilities.Page_Videos"),dojo.declare("toura.capabilities.Page_Videos",mulberry._Capability,{requirements:{videoPlayer:"VideoPlayer",videoList:"VideoList"},connects:[["page","init","_setup"]],_setup:function(a){this._loadVideo(a)},_loadVideo:function(a){if(a.assetId&&"videos"===a.assetType){var a=a.assetId,b=this._videoById(a);this.videoList&&this.videoList.set("currentAsset",
a);this.videoCaption&&this.videoCaption.set("content",b.caption||"");this.videoPlayer.set("mediaId",a)}}}));dojo._hasResource["toura.capabilities.VideoList_VideoPlayer"]||(dojo._hasResource["toura.capabilities.VideoList_VideoPlayer"]=!0,dojo.provide("toura.capabilities.VideoList_VideoPlayer"),dojo.declare("toura.capabilities.VideoList_VideoPlayer",mulberry._Capability,{requirements:{videoList:"VideoList",videoPlayer:"VideoPlayer"},connects:[["videoList","onSelect","_playVideo"]],_playVideo:function(a){this.videoPlayer.play(a)}}));
dojo._hasResource["toura.capabilities.VideoList_VideoCaption"]||(dojo._hasResource["toura.capabilities.VideoList_VideoCaption"]=!0,dojo.provide("toura.capabilities.VideoList_VideoCaption"),dojo.declare("toura.capabilities.VideoList_VideoCaption",mulberry._Capability,{requirements:{videoList:"VideoList",videoCaption:"VideoCaption"},connects:[["videoList","onSelect","_setCaption"]],_setCaption:function(a){(a=this.baseObj.getAssetById("video",a))&&this.videoCaption.set("content",a.caption||"")}}));
dojo._hasResource["toura.capabilities.Page_Search"]||(dojo._hasResource["toura.capabilities.Page_Search"]=!0,dojo.provide("toura.capabilities.Page_Search"),dojo.declare("toura.capabilities.Page_Search",mulberry._Capability,{requirements:{searchInput:"SearchInput",searchResults:"SearchResults"},connects:[["searchInput","search","_handleSearch"]],init:function(){var a=this.baseObj.term||toura.lastSearchTerm;this.getResults=this.baseObj.getResults;a&&this._handleSearch(a)},_handleSearch:function(a){a!==
this.lastSearchTerm&&(this.searchInput.set("searchTerm",a),this.searchResults.set("results",this.getResults(a)),this.lastSearchTerm=toura.lastSearchTerm=a)}}));
dojo._hasResource["toura.capabilities.Text_ChildNodes"]||(dojo._hasResource["toura.capabilities.Text_ChildNodes"]=!0,dojo.provide("toura.capabilities.Text_ChildNodes"),dojo.declare("toura.capabilities.Text_ChildNodes",mulberry._Capability,{requirements:{text:"BodyText",childNodes:"ChildNodes"},init:function(){0===this.childNodes.children.length&&dojo.addClass(this.childNodes.region.domNode,"empty")}}));
dojo._hasResource["toura.capabilities.Text_ChildNodes_VideoList"]||(dojo._hasResource["toura.capabilities.Text_ChildNodes_VideoList"]=!0,dojo.provide("toura.capabilities.Text_ChildNodes_VideoList"),dojo.declare("toura.capabilities.Text_ChildNodes_VideoList",mulberry._Capability,{requirements:{text:"BodyText",childNodes:"ChildNodes",videoList:"VideoList"},init:function(){0===this.childNodes.children.length&&1>=this.videoList.assets.length&&dojo.addClass(this.childNodes.region.domNode,"empty")}}));
dojo._hasResource["toura.capabilities._base"]||(dojo._hasResource["toura.capabilities._base"]=!0,dojo.provide("toura.capabilities._base"));
dojo._hasResource["toura.components.buttons._Button"]||(dojo._hasResource["toura.components.buttons._Button"]=!0,dojo.provide("toura.components.buttons._Button"),dojo.declare("toura.components.buttons._Button",mulberry._Component,{templateString:dojo.cache("toura.components.buttons","_Button/_Button.haml","%a.button{ title: i18n_text }\n"),url:"#",i18n_text:"",preventWhenAnimating:!1,setupConnections:function(){this._setupTouch(this.domNode,"_handleClick")},_handleClick:function(a){a&&a.preventDefault();
if(!this.preventWhenAnimating||!mulberry.animating)this.onClick(a)},onClick:function(){this.url&&"#"!==this.url&&mulberry.app.Router.go(this.url)}}));dojo._hasResource["toura.components.buttons.SearchButton"]||(dojo._hasResource["toura.components.buttons.SearchButton"]=!0,dojo.provide("toura.components.buttons.SearchButton"),dojo.declare("toura.components.buttons.SearchButton",toura.components.buttons._Button,{"class":"search",url:toura.URL.search(),preventWhenAnimating:!0}));
dojo._hasResource["toura.components.buttons.AboutButton"]||(dojo._hasResource["toura.components.buttons.AboutButton"]=!0,dojo.provide("toura.components.buttons.AboutButton"),dojo.declare("toura.components.buttons.AboutButton",toura.components.buttons._Button,{"class":"about",prepareData:function(){this.url=toura.URL.about()},initializeStrings:function(){this.i18n_text=this.getString("ABOUT")}}),dojo.mixin(toura.components.buttons.AboutButton,{isAvailable:function(){var a=mulberry.app.Config.get("app");
return a.aboutEnabled&&!!a.aboutNodeId}}));
dojo._hasResource["toura.components.buttons.MapsButton"]||(dojo._hasResource["toura.components.buttons.MapsButton"]=!0,dojo.provide("toura.components.buttons.MapsButton"),dojo.declare("toura.components.buttons.MapsButton",toura.components.buttons._Button,{"class":"maps",prepareData:function(){this.url=toura.URL.maps()},initializeStrings:function(){this.i18n_text=this.getString("MAPS")}}),dojo.mixin(toura.components.buttons.MapsButton,{isAvailable:function(){var a=mulberry.app.Config.get("app");return a.mapsEnabled&&
!!a.mapNodeId}}));dojo._hasResource["toura.components.buttons.FavoritesButton"]||(dojo._hasResource["toura.components.buttons.FavoritesButton"]=!0,dojo.provide("toura.components.buttons.FavoritesButton"),dojo.declare("toura.components.buttons.FavoritesButton",toura.components.buttons._Button,{"class":"favorites",prepareData:function(){this.url=toura.URL.favorites()},initializeStrings:function(){this.i18n_text=this.getString("FAVORITES")}}),dojo.mixin(toura.components.buttons.FavoritesButton,{isAvailable:function(){return toura.features.favorites}}));
dojo._hasResource["toura.components.AppNav"]||(dojo._hasResource["toura.components.AppNav"]=!0,dojo.provide("toura.components.AppNav"),dojo.declare("toura.components.AppNav",mulberry._Component,{templateString:dojo.cache("toura.components","AppNav/AppNav.haml","%nav.component.app-nav\n  %ol{ dojoAttachPoint : 'buttonList' }\n"),widgetsInTemplate:!0,handleClicks:!0,setupChildComponents:function(){dojo.forEach([toura.components.buttons.SearchButton,toura.components.buttons.AboutButton,toura.components.buttons.MapsButton,
toura.components.buttons.FavoritesButton],function(a){if(a.isAvailable&&a.isAvailable()||!a.isAvailable){var b=dojo.create("li");this.adopt(a).placeAt(b);dojo.place(b,this.buttonList,"last")}},this)}}));
dojo._hasResource["toura.components.AssetList"]||(dojo._hasResource["toura.components.AssetList"]=!0,dojo.provide("toura.components.AssetList"),dojo.declare("toura.components.AssetList",mulberry._Component,{templateString:dojo.cache("toura.components","AssetList/AssetList.haml",".component.asset-list\n  %ul{ dojoAttachPoint : 'list' }\n    :each a in assets\n      %li{ id : 'asset-' + a.id, data-id : a.id }\n        %a{ href : '#' }= a.name\n\n"),"class":"assets",prepareData:function(){this.assets=
this.assets||this.type&&this.node[this.type]||[];this.assets=dojo.map(this.assets,function(a){return dojo.mixin(a,{assetUrl:this.baseUrl+"/"+a.id})},this);this.baseUrl=this.node.assetTypeUrl(this.type)},setupConnections:function(){this.connect(this.domNode,"touchmove",function(){this.handle=null});this.connect(this.domNode,"touchend",function(){this.handle&&dojo.isFunction(this.handle)&&this.handle()});dojo.forEach(this.list.children,function(a){var b=dojo.attr(a,"data-id");mulberry.app.UI.hasTouch?
(this.connect(a,"touchstart",function(){this.handle=dojo.hitch(this,"_onSelect",b)}),this.connect(a,"click",function(a){a.preventDefault()})):this.connect(a,"click",function(a){a.preventDefault();this._onSelect(b)})},this)},_onSelect:function(a){this.set("currentAsset",a);this.onSelect(a)},onSelect:function(){},_setCurrentAssetAttr:function(a){var b=this.query("#asset-"+a)[0];this.query(".asset-list li").removeClass("current");dojo.addClass(b,"current");this.currentAsset=a}}));
dojo._hasResource["toura.components.BodyText"]||(dojo._hasResource["toura.components.BodyText"]=!0,dojo.provide("toura.components.BodyText"),dojo.declare("toura.components.BodyText",mulberry._Component,{templateString:dojo.cache("toura.components","BodyText/BodyText.haml",".component.body-text\n  %div{ dojoAttachPoint : 'bodyTextContainer' }= bodyText\n"),prepareData:function(){this.bodyText=this.bodyText||this._getBodyText()},adjustMarkup:function(){dojo.trim(this.bodyText)||this.addClass("empty")},
_getBodyText:function(){return!this.node?"":this.node.bodyText?this.node.bodyText.body:""},setupConnections:function(){this.query('a[rel="external"]').attr("target","_blank");this.connect(this.domNode,"click","_handleClick")},_handleClick:function(a){var b=a.target,c;"a"===b.nodeName.toLowerCase()&&(c=dojo.attr(b,"rel"),c&&"external"===c||(b=dojo.attr(b,"href"),/^http/.test(b)&&(a.preventDefault(),mulberry.app.PhoneGap.browser.url(b))))},_setContentAttr:function(a){this.bodyTextContainer.innerHTML=
a;dojo[a?"removeClass":"addClass"](this.domNode,"empty");dojo.publish("/content/update")}}));dojo._hasResource["toura.components.AudioCaption"]||(dojo._hasResource["toura.components.AudioCaption"]=!0,dojo.provide("toura.components.AudioCaption"),dojo.declare("toura.components.AudioCaption",toura.components.BodyText,{"class":"audio-caption",_getBodyText:function(){return!this.node||!this.node.audios?"":this.node.audios[0]?this.node.audios[0].caption||"":""}}));
dojo._hasResource["toura.components.AudioList"]||(dojo._hasResource["toura.components.AudioList"]=!0,dojo.provide("toura.components.AudioList"),dojo.declare("toura.components.AudioList",toura.components.AssetList,{"class":"audio-list",postMixInProperties:function(){this.assets=this.node.audios||[];this.inherited(arguments)}}));
dojo._hasResource["toura.components._MediaPlayer"]||(dojo._hasResource["toura.components._MediaPlayer"]=!0,dojo.provide("toura.components._MediaPlayer"),function(){dojo.declare("toura.components._MediaPlayer",mulberry._Component,{useHtml5Player:!0,prepareData:function(){this.inherited(arguments);this.mediasCache={};this.medias=dojo.map(this.medias||[],function(a){return this.mediasCache[a.id]=a=dojo.mixin(a,{assetUrl:[this.baseUrl,a.id].join("/")})},this);this.media=this.medias[0]||{};this.useHtml5Player=
mulberry.app.Has.html5Player()},setupSubscriptions:function(){this.inherited(arguments);this.useHtml5Player&&this.subscribe("/page/transition/end","_setupPlayer")},adjustMarkup:function(){this.useHtml5Player||this.addClass("has-html5-player")},play:function(a){this.set("mediaId",a);this._play(this.media)},_play:function(){this.useHtml5Player&&this.player.play();dojo.publish("/"+this.playerType+"/play",[this.media.id])},_pause:function(){this.useHtml5Player&&this.player&&this.player.pause()},_setMediaIdAttr:function(a){a=
this.media=this.mediasCache[a];this.useHtml5Player&&!this.player?this._queuedMedia=a:(this._queuedMedia=null,this.player&&(this.player.src=a.url))},_setupPlayer:function(){if(this.useHtml5Player&&this.media){var a=this.domNode,b=this.player=dojo.create(this.playerType,dojo.mixin({src:this.media.url},this.playerSettings)),c=dojo.partial(dojo.place,b,a),d=dojo.connect(b,"loadstart",this,function(){dojo.disconnect(d);d=!1;a&&c()});setTimeout(function(){d&&(dojo.disconnect(d),c())},100)}}})}());
dojo._hasResource["toura.components.AudioPlayer"]||(dojo._hasResource["toura.components.AudioPlayer"]=!0,dojo.provide("toura.components.AudioPlayer"),dojo.declare("toura.components.AudioPlayer",toura.components._MediaPlayer,{templateString:dojo.cache("toura.components","AudioPlayer/AudioPlayer.haml",".component.audio-player\n  :if !useHtml5Player\n    %form\n      %input{ type : 'button', class : 'play', dojoAttachPoint : 'controller' }\n"),playerType:"audio",isPlaying:!1,playerSettings:{preload:"auto",
controls:!0,autobuffer:!0},prepareData:function(){this.medias=this.node.audios||[];this.inherited(arguments)},setupConnections:function(){this.inherited(arguments);this.useHtml5Player||this.connect(this.controller,"click","_handleControllerClick")},_handleControllerClick:function(){this.useHtml5Player||(this.isPlaying?(this._pause(),this.isPlaying=!1,this.removeClass("playing")):(this._play(),this.isPlaying=!0,this.addClass("playing")))},_play:function(a){this.inherited(arguments);if(!this.useHtml5Player){var b=
mulberry.app.PhoneGap;b.audio.destroy();b.audio.play(this.media.url)}},_pause:function(){this.inherited(arguments);this.useHtml5Player||mulberry.app.PhoneGap.audio.stop()},teardown:function(){this.useHtml5Player||mulberry.app.PhoneGap.audio.destroy()}}));
dojo._hasResource["mulberry.ui.BackgroundImage"]||(dojo._hasResource["mulberry.ui.BackgroundImage"]=!0,dojo.provide("mulberry.ui.BackgroundImage"),dojo.declare("mulberry.ui.BackgroundImage",dijit._Widget,{imageUrl:"",isLoaded:!1,loadOnInit:!1,postCreate:function(){this.inherited(arguments);this.loadOnInit&&this.loadImage()},loadImage:function(){this.isLoaded||(dojo.style(this.domNode,{backgroundImage:"url("+this.imageUrl+")",backgroundRepeat:"no-repeat"}),this.isLoaded=!0)},unloadImage:function(){dojo.style(this.domNode,
"backgroundImage",null);this.isLoaded=!1},_setBackgroundImageAttr:function(a){a&&(this.imageUrl=a.url)}}));
dojo._hasResource["toura.components.ChildNodeGrid"]||(dojo._hasResource["toura.components.ChildNodeGrid"]=!0,dojo.provide("toura.components.ChildNodeGrid"),dojo.declare("toura.components.ChildNodeGrid",mulberry._Component,{templateString:dojo.cache("toura.components","ChildNodeGrid/ChildNodeGrid.haml","%ul.component.child-node-grid\n  :each c in children\n    %li\n      %a{ href : c.url }\n        :if tablet\n          .image{ dojoType : 'mulberry.ui.BackgroundImage', imageUrl : c.featuredImage.large.url, loadOnInit: true }\n        :if phone\n          .image{ dojoType : 'mulberry.ui.BackgroundImage', imageUrl : c.featuredImage.small.url, loadOnInit: true }\n        %h3= c.name\n"),widgetsInTemplate:!0,
handleClicks:!0,prepareData:function(){this.node.populateChildren();this.children=dojo.filter(this.node.children||[],function(a){return void 0!==a.featuredImage});this.tablet&&(this["class"]="size-"+(11<this.children.length?"medium":"large"));if(!("ios"===this.device.os||toura.components.ChildNodeGrid.placedCSS)){var a=dojo.cache("toura.components.ChildNodeGrid","child-node-grid.css.tpl",'<style id="component-css-child-node-grid">\n\n  .browser.phone .child-node-grid li,\n  .android.phone .child-node-grid li {\n    height: ${height}px;\n    width: ${width}px;\n  }\n\n  .browser.phone .child-node-grid li h3,\n  .android.phone .child-node-grid li h3 {\n    height: 2.5em;\n    overflow: hidden;\n  }\n\n  .browser.phone .child-node-grid li .image,\n  .android.phone .child-node-grid li .image {\n    width: ${width}px;\n    height: ${imageHeight}px;\n  }\n\n</style>\n'),
b=Math.floor(mulberry.app.UI.viewport.width/2-18),a=dojo.string.substitute(a,{width:b,height:Math.floor(1.4*0.75*b),imageHeight:0.75*b});dojo.place(a,document.querySelector("head"));toura.components.ChildNodeGrid.placedCSS=!0}}}));
dojo._hasResource["toura.components.ChildNodes"]||(dojo._hasResource["toura.components.ChildNodes"]=!0,dojo.provide("toura.components.ChildNodes"),dojo.declare("toura.components.ChildNodes",mulberry._Component,{templateString:dojo.cache("toura.components","ChildNodes/ChildNodes.haml","%ul.component.child-nodes\n  :each c in children\n    %li\n      %a{ href : '#/node/' + c.id }= c.name\n"),handleClicks:!0,prepareData:function(){this.children=this.node.children||[]},adjustMarkup:function(){this.children.length||
this.addClass("empty")},_clickHandler:function(a){dojo.addClass(a,"tapped")}}));
dojo._hasResource["toura.components.HeaderImage"]||(dojo._hasResource["toura.components.HeaderImage"]=!0,dojo.provide("toura.components.HeaderImage"),dojo.declare("toura.components.HeaderImage",mulberry._Component,{templateString:dojo.cache("toura.components","HeaderImage/HeaderImage.haml",".component.header-image\n  :if viewImage\n    %img{ src : viewImage.url, width : viewImage.width, height : viewImage.height, dojoAttachPoint : 'imageNode' }\n"),prepareData:function(){this.inherited(arguments);
var a=this.device.type,b=this.phone?"gallery":"original";this.node.headerImage&&this.node.headerImage[a]?(this.image=this.node.headerImage[a][b],this.viewImage=dojo.mixin({},this.image)):this.viewImage=!1},setupConnections:function(){if(this.image){var a=this.node.headerImage[this.device.type];a.destination&&this.connect(this.domNode,"click",function(){mulberry.app.PhoneGap.browser.url(a.destination)})}},setupSubscriptions:function(){this.subscribe("/window/resize","_resizeImage")},teardown:function(){dojo.destroy(this.domNode)},
resizeElements:function(){this.viewImage?this._resizeImage():this.destroy()},_resizeImage:function(){this.imageNode&&dojo.attr(this.imageNode,this._calculateDimensions())},_calculateDimensions:function(){var a=this._getWidth(),b=this.image;return{width:b?a:0,height:b?Math.ceil(b.height*(a/b.width)):0}},_getWidth:function(){return this.getDimensions().width}}));
dojo._hasResource["toura.components.ColumnHeaderImage"]||(dojo._hasResource["toura.components.ColumnHeaderImage"]=!0,dojo.provide("toura.components.ColumnHeaderImage"),dojo.declare("toura.components.ColumnHeaderImage",toura.components.HeaderImage,{"class":"column-header-image"}));
dojo._hasResource["toura.components.DetailTitle"]||(dojo._hasResource["toura.components.DetailTitle"]=!0,dojo.provide("toura.components.DetailTitle"),dojo.declare("toura.components.DetailTitle",mulberry._Component,{templateString:dojo.cache("toura.components","DetailTitle/DetailTitle.haml",".component.detail-title\n  %a.close{ href : '#', dojoAttachPoint : 'closeButton' }= i18n_close\n  %h1{ dojoAttachPoint : 'titleElement' }= title\n"),setupConnections:function(){this.connect(this.closeButton,"click",
"_close")},_close:function(a){a.preventDefault();this.onClose()},onClose:function(){},initializeStrings:function(){this.i18n_close=this.getString("CLOSE")},attributeMap:{screenTitle:{node:"titleElement",type:"innerHTML"}}}));
dojo._hasResource["toura.components.DropDownText"]||(dojo._hasResource["toura.components.DropDownText"]=!0,dojo.provide("toura.components.DropDownText"),dojo.declare("toura.components.DropDownText",toura.components.BodyText,{templateString:dojo.cache("toura.components","DropDownText/DropDownText.haml",".component.drop-down-text\n  .open-wrapper{ dojoAttachPoint : 'openButton' }\n    .button.open\n      %span=i18n_instructions\n\n  .text-wrapper{ dojoAttachPoint : 'textWrapper' }\n    .body-text-container{ dojoAttachPoint : 'bodyTextContainer' }= bodyText\n    .button.close{ dojoAttachPoint : 'closeButton' }\n      %span=i18n_close\n\n"),
adjustMarkup:function(){this.hide(this.textWrapper)},initializeStrings:function(){this.i18n_close=this.getString("CLOSE");this.i18n_instructions=this.getString("INSTRUCTIONS")},setupConnections:function(){this.connect(this.openButton,"click",function(){this.hide(this.openButton);this.show(this.textWrapper)});this.connect(this.textWrapper,"click",function(){this.hide(this.textWrapper);this.show(this.openButton)})}}));
dojo._hasResource["toura.components.buttons.DeleteButton"]||(dojo._hasResource["toura.components.buttons.DeleteButton"]=!0,dojo.provide("toura.components.buttons.DeleteButton"),dojo.declare("toura.components.buttons.DeleteButton",toura.components.buttons._Button,{templateString:dojo.cache("toura.components.buttons","DeleteButton/DeleteButton.haml","%div.button{ title: i18n_text }\n"),objId:"",deleting:!1,onClick:function(){if(this.deleting)this.onDelete(this.objId,this.domNode);else dojo.addClass(this.domNode,
"deleting"),this.deleting=!0},initializeStrings:function(){this.i18n_text=this.getString("DELETE")},onDelete:function(){}}));
dojo._hasResource["toura.components.Favorites"]||(dojo._hasResource["toura.components.Favorites"]=!0,dojo.provide("toura.components.Favorites"),dojo.declare("toura.components.Favorites",mulberry._Component,{templateString:dojo.cache("toura.components","Favorites/Favorites.haml",".component.favorites\n  %ul{ dojoAttachPoint : 'favoritesList' }\n    :if favorites.length\n\n      :each fav in favorites\n        %li{ class : fav.type }\n\n          %a{ href : fav.model.url }\n            :if fav.img\n              .img{ dojoType : 'mulberry.ui.BackgroundImage', imageUrl : fav.img, loadOnInit : true }\n\n            :if !fav.img\n              .img.default\n\n            .text\n              %h2= fav.name\n\n              :if fav.displayText\n                %p= fav.displayText\n\n          .delete{ dojoType : 'toura.components.buttons.DeleteButton', objId : fav.id, dojoAttachEvent : 'onDelete: _deleteFavorite' }\n\n    :if !favorites.length\n      %li= i18n_noFavorites\n"),handleClicks:!0,
widgetsInTemplate:!0,prepareData:function(){this.favorites=dojo.filter(this.node.favorites||[],function(a){return!a.deleted});this.favorites=dojo.map(this.favorites,function(a){a.img=a.model.featuredImage&&a.model.featuredImage.small.url;a.displayText=a.model.bodyText&&a.model.bodyText.body?mulberry.util.truncate(a.model.bodyText.body,200):!1;return a},this)},initializeStrings:function(){this.i18n_noFavorites=this.getString("FAVORITES_NO_FAVORITES")},_deleteFavorite:function(a,b){dojo.publish("/favorite/remove",
[a]);dojo.destroy(b.parentNode)}}));
dojo._hasResource["dojo.date"]||(dojo._hasResource["dojo.date"]=!0,dojo.provide("dojo.date"),dojo.getObject("date",!0,dojo),dojo.date.getDaysInMonth=function(a){var b=a.getMonth(),c=[31,28,31,30,31,30,31,31,30,31,30,31];return 1==b&&dojo.date.isLeapYear(a)?29:c[b]},dojo.date.isLeapYear=function(a){a=a.getFullYear();return!(a%400)||!(a%4)&&!!(a%100)},dojo.date.getTimezoneName=function(a){var b=a.toString(),c="",d=b.indexOf("(");if(-1<d)c=b.substring(++d,b.indexOf(")"));else if(d=/([A-Z\/]+) \d{4}$/,
b=b.match(d))c=b[1];else if(b=a.toLocaleString(),d=/ ([A-Z\/]+)$/,b=b.match(d))c=b[1];return"AM"==c||"PM"==c?"":c},dojo.date.compare=function(a,b,c){a=new Date(+a);b=new Date(+(b||new Date));"date"==c?(a.setHours(0,0,0,0),b.setHours(0,0,0,0)):"time"==c&&(a.setFullYear(0,0,0),b.setFullYear(0,0,0));return a>b?1:a<b?-1:0},dojo.date.add=function(a,b,c){var d=new Date(+a),e=!1,f="Date";switch(b){case "day":break;case "weekday":var g;(b=c%5)?g=parseInt(c/5):(b=0<c?5:-5,g=0<c?(c-5)/5:(c+5)/5);var i=a.getDay(),
h=0;6==i&&0<c?h=1:0==i&&0>c&&(h=-1);i+=b;if(0==i||6==i)h=0<c?2:-2;c=7*g+b+h;break;case "year":f="FullYear";e=!0;break;case "week":c*=7;break;case "quarter":c*=3;case "month":e=!0;f="Month";break;default:f="UTC"+b.charAt(0).toUpperCase()+b.substring(1)+"s"}if(f)d["set"+f](d["get"+f]()+c);e&&d.getDate()<a.getDate()&&d.setDate(0);return d},dojo.date.difference=function(a,b,c){var b=b||new Date,c=c||"day",d=b.getFullYear()-a.getFullYear(),e=1;switch(c){case "quarter":a=a.getMonth();b=b.getMonth();a=Math.floor(a/
3)+1;b=Math.floor(b/3)+1;e=b+4*d-a;break;case "weekday":d=Math.round(dojo.date.difference(a,b,"day"));c=parseInt(dojo.date.difference(a,b,"week"));if(0==d%7)d=5*c;else{var e=0,f=a.getDay(),g=b.getDay(),c=parseInt(d/7),b=d%7,a=new Date(a);a.setDate(a.getDate()+7*c);a=a.getDay();if(0<d)switch(!0){case 6==f:e=-1;break;case 0==f:e=0;break;case 6==g:e=-1;break;case 0==g:e=-2;break;case 5<a+b:e=-2}else if(0>d)switch(!0){case 6==f:e=0;break;case 0==f:e=1;break;case 6==g:e=2;break;case 0==g:e=1;break;case 0>
a+b:e=2}d=d+e-2*c}e=d;break;case "year":e=d;break;case "month":e=b.getMonth()-a.getMonth()+12*d;break;case "week":e=parseInt(dojo.date.difference(a,b,"day")/7);break;case "day":e/=24;case "hour":e/=60;case "minute":e/=60;case "second":e/=1E3;case "millisecond":e*=b.getTime()-a.getTime()}return Math.round(e)});
dojo._hasResource["dojo.cldr.supplemental"]||(dojo._hasResource["dojo.cldr.supplemental"]=!0,dojo.provide("dojo.cldr.supplemental"),dojo.getObject("cldr.supplemental",!0,dojo),dojo.cldr.supplemental.getFirstDayOfWeek=function(a){a={mv:5,ae:6,af:6,bh:6,dj:6,dz:6,eg:6,er:6,et:6,iq:6,ir:6,jo:6,ke:6,kw:6,ly:6,ma:6,om:6,qa:6,sa:6,sd:6,so:6,sy:6,tn:6,ye:6,ar:0,as:0,az:0,bw:0,ca:0,cn:0,fo:0,ge:0,gl:0,gu:0,hk:0,il:0,"in":0,jm:0,jp:0,kg:0,kr:0,la:0,mh:0,mn:0,mo:0,mp:0,mt:0,nz:0,ph:0,pk:0,sg:0,th:0,tt:0,tw:0,
um:0,us:0,uz:0,vi:0,zw:0}[dojo.cldr.supplemental._region(a)];return void 0===a?1:a},dojo.cldr.supplemental._region=function(a){var a=dojo.i18n.normalizeLocale(a),a=a.split("-"),b=a[1];b?4==b.length&&(b=a[2]):b={de:"de",en:"us",es:"es",fi:"fi",fr:"fr",he:"il",hu:"hu",it:"it",ja:"jp",ko:"kr",nl:"nl",pt:"br",sv:"se",zh:"cn"}[a[0]];return b},dojo.cldr.supplemental.getWeekend=function(a){var b=dojo.cldr.supplemental._region(a),a={"in":0,af:4,dz:4,ir:4,om:4,sa:4,ye:4,ae:5,bh:5,eg:5,il:5,iq:5,jo:5,kw:5,
ly:5,ma:5,qa:5,sd:5,sy:5,tn:5}[b],b={af:5,dz:5,ir:5,om:5,sa:5,ye:5,ae:6,bh:5,eg:6,il:6,iq:6,jo:6,kw:6,ly:6,ma:6,qa:6,sd:6,sy:6,tn:6}[b];void 0===a&&(a=6);void 0===b&&(b=0);return{start:a,end:b}});
dojo._hasResource["dojo.regexp"]||(dojo._hasResource["dojo.regexp"]=!0,dojo.provide("dojo.regexp"),dojo.getObject("regexp",!0,dojo),dojo.regexp.escapeString=function(a,b){return a.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g,function(a){return b&&-1!=b.indexOf(a)?a:"\\"+a})},dojo.regexp.buildGroupRE=function(a,b,c){if(!(a instanceof Array))return b(a);for(var d=[],e=0;e<a.length;e++)d.push(b(a[e]));return dojo.regexp.group(d.join("|"),c)},dojo.regexp.group=function(a,b){return"("+(b?"?:":"")+a+")"});
dojo._hasResource["dojo.date.locale"]||(dojo._hasResource["dojo.date.locale"]=!0,dojo.provide("dojo.date.locale"),dojo.getObject("date.locale",!0,dojo),function(){function a(a,b,c,g){return g.replace(/([a-z])\1*/ig,function(i){var h,k,j=i.charAt(0),i=i.length,p=["abbr","wide","narrow"];switch(j){case "G":h=b[4>i?"eraAbbr":"eraNames"][0>a.getFullYear()?0:1];break;case "y":h=a.getFullYear();switch(i){case 1:break;case 2:if(!c.fullYear){h=""+h;h=h.substr(h.length-2);break}default:k=!0}break;case "Q":case "q":h=
Math.ceil((a.getMonth()+1)/3);k=!0;break;case "M":h=a.getMonth();3>i?(h+=1,k=!0):(j=["months-format",p[i-3]].join("-"),h=b[j][h]);break;case "w":h=dojo.date.locale._getWeekOfYear(a,0);k=!0;break;case "d":h=a.getDate();k=!0;break;case "D":h=dojo.date.locale._getDayOfYear(a);k=!0;break;case "E":h=a.getDay();3>i?(h+=1,k=!0):(j=["days-format",p[i-3]].join("-"),h=b[j][h]);break;case "a":h=12>a.getHours()?"am":"pm";h=c[h]||b["dayPeriods-format-wide-"+h];break;case "h":case "H":case "K":case "k":k=a.getHours();
switch(j){case "h":h=k%12||12;break;case "H":h=k;break;case "K":h=k%12;break;case "k":h=k||24}k=!0;break;case "m":h=a.getMinutes();k=!0;break;case "s":h=a.getSeconds();k=!0;break;case "S":h=Math.round(a.getMilliseconds()*Math.pow(10,i-3));k=!0;break;case "v":case "z":if(h=dojo.date.locale._getZone(a,!0,c))break;i=4;case "Z":h=dojo.date.locale._getZone(a,!1,c);h=[0>=h?"+":"-",dojo.string.pad(Math.floor(Math.abs(h)/60),2),dojo.string.pad(Math.abs(h)%60,2)];4==i&&(h.splice(0,0,"GMT"),h.splice(3,0,":"));
h=h.join("");break;default:throw Error("dojo.date.locale.format: invalid pattern char: "+g);}k&&(h=dojo.string.pad(h,i));return h})}function b(a,b,c,g){var i=function(a){return a},b=b||i,c=c||i,g=g||i,h=a.match(/(''|[^'])+/g),k="'"==a.charAt(0);dojo.forEach(h,function(a,d){a?(h[d]=(k?c:b)(a.replace(/''/g,"'")),k=!k):h[d]=""});return g(h.join(""))}function c(a,b,c,g){g=dojo.regexp.escapeString(g);c.strict||(g=g.replace(" a"," ?a"));return g.replace(/([a-z])\1*/ig,function(g){var h;h=g.charAt(0);var k=
g.length,j="",p="";c.strict?(1<k&&(j="0{"+(k-1)+"}"),2<k&&(p="0{"+(k-2)+"}")):(j="0?",p="0{0,2}");switch(h){case "y":h="\\d{2,4}";break;case "M":h=2<k?"\\S+?":j+"[1-9]|1[0-2]";break;case "D":h=j+"[1-9]|"+p+"[1-9][0-9]|[12][0-9][0-9]|3[0-5][0-9]|36[0-6]";break;case "d":h="3[01]|[12]\\d|"+j+"[1-9]";break;case "w":h=j+"[1-9]|[1-4][0-9]|5[0-3]";break;case "E":h="\\S+";break;case "h":h=j+"[1-9]|1[0-2]";break;case "k":h=j+"\\d|1[01]";break;case "H":h=j+"\\d|1\\d|2[0-3]";break;case "K":h=j+"[1-9]|1\\d|2[0-4]";
break;case "m":case "s":h="[0-5]\\d";break;case "S":h="\\d{"+k+"}";break;case "a":k=c.am||b["dayPeriods-format-wide-am"];j=c.pm||b["dayPeriods-format-wide-pm"];c.strict?h=k+"|"+j:(h=k+"|"+j,k!=k.toLowerCase()&&(h+="|"+k.toLowerCase()),j!=j.toLowerCase()&&(h+="|"+j.toLowerCase()),-1!=h.indexOf(".")&&(h+="|"+h.replace(/\./g,"")));h=h.replace(/\./g,"\\.");break;default:h=".*"}a&&a.push(g);return"("+h+")"}).replace(/[\xa0 ]/g,"[\\s\\xa0]")}dojo.date.locale._getZone=function(a,b){return b?dojo.date.getTimezoneName(a):
a.getTimezoneOffset()};dojo.date.locale.format=function(c,e){var e=e||{},f=dojo.i18n.normalizeLocale(e.locale),g=e.formatLength||"short",f=dojo.date.locale._getGregorianBundle(f),i=[],h=dojo.hitch(this,a,c,f,e);if("year"==e.selector)return b(f["dateFormatItem-yyyy"]||"yyyy",h);var k;"date"!=e.selector&&(k=e.timePattern||f["timeFormat-"+g])&&i.push(b(k,h));"time"!=e.selector&&(k=e.datePattern||f["dateFormat-"+g])&&i.push(b(k,h));return 1==i.length?i[0]:f["dateTimeFormat-"+g].replace(/\{(\d+)\}/g,function(a,
b){return i[b]})};dojo.date.locale.regexp=function(a){return dojo.date.locale._parseInfo(a).regexp};dojo.date.locale._parseInfo=function(a){var a=a||{},e=dojo.i18n.normalizeLocale(a.locale),e=dojo.date.locale._getGregorianBundle(e),f=a.formatLength||"short",g=a.datePattern||e["dateFormat-"+f],i=a.timePattern||e["timeFormat-"+f],f="date"==a.selector?g:"time"==a.selector?i:e["dateTimeFormat-"+f].replace(/\{(\d+)\}/g,function(a,b){return[i,g][b]}),h=[];return{regexp:b(f,dojo.hitch(this,c,h,e,a)),tokens:h,
bundle:e}};dojo.date.locale.parse=function(a,b){var c=/[\u200E\u200F\u202A\u202E]/g,g=dojo.date.locale._parseInfo(b),i=g.tokens,h=g.bundle,c=RegExp("^"+g.regexp.replace(c,"")+"$",g.strict?"":"i").exec(a&&a.replace(c,""));if(!c)return null;var k=["abbr","wide","narrow"],j=[1970,0,1,0,0,0,0],p="",c=dojo.every(c,function(a,c){if(!c)return!0;var d=i[c-1],f=d.length;switch(d.charAt(0)){case "y":if(2!=f&&b.strict)j[0]=a;else if(100>a)a=Number(a),f=""+(new Date).getFullYear(),d=100*f.substring(0,2),f=Math.min(Number(f.substring(2,
4))+20,99),j[0]=a<f?d+a:d-100+a;else{if(b.strict)return!1;j[0]=a}break;case "M":if(2<f){if(d=h["months-format-"+k[f-3]].concat(),b.strict||(a=a.replace(".","").toLowerCase(),d=dojo.map(d,function(a){return a.replace(".","").toLowerCase()})),a=dojo.indexOf(d,a),-1==a)return!1}else a--;j[1]=a;break;case "E":case "e":d=h["days-format-"+k[f-3]].concat();b.strict||(a=a.toLowerCase(),d=dojo.map(d,function(a){return a.toLowerCase()}));a=dojo.indexOf(d,a);if(-1==a)return!1;break;case "D":j[1]=0;case "d":j[2]=
a;break;case "a":d=b.am||h["dayPeriods-format-wide-am"];f=b.pm||h["dayPeriods-format-wide-pm"];if(!b.strict)var g=/\./g,a=a.replace(g,"").toLowerCase(),d=d.replace(g,"").toLowerCase(),f=f.replace(g,"").toLowerCase();if(b.strict&&a!=d&&a!=f)return!1;p=a==f?"p":a==d?"a":"";break;case "K":24==a&&(a=0);case "h":case "H":case "k":if(23<a)return!1;j[3]=a;break;case "m":j[4]=a;break;case "s":j[5]=a;break;case "S":j[6]=a}return!0}),g=+j[3];"p"===p&&12>g?j[3]=g+12:"a"===p&&12==g&&(j[3]=0);g=new Date(j[0],
j[1],j[2],j[3],j[4],j[5],j[6]);b.strict&&g.setFullYear(j[0]);var q=i.join(""),s=-1!=q.indexOf("d"),q=-1!=q.indexOf("M");if(!c||q&&g.getMonth()>j[1]||s&&g.getDate()>j[2])return null;if(q&&g.getMonth()<j[1]||s&&g.getDate()<j[2])g=dojo.date.add(g,"hour",1);return g}}(),function(){var a=[];dojo.date.locale.addCustomFormats=function(b,c){a.push({pkg:b,name:c})};dojo.date.locale._getGregorianBundle=function(b){var c={};dojo.forEach(a,function(a){a=dojo.i18n.getLocalization(a.pkg,a.name,b);c=dojo.mixin(c,
a)},this);return c}}(),dojo.date.locale.addCustomFormats("dojo.cldr","gregorian"),dojo.date.locale.getNames=function(a,b,c,d){var e,d=dojo.date.locale._getGregorianBundle(d),a=[a,c,b];"standAlone"==c&&(c=a.join("-"),e=d[c],1==e[0]&&(e=void 0));a[1]="format";return(e||d[a.join("-")]).concat()},dojo.date.locale.isWeekend=function(a,b){var c=dojo.cldr.supplemental.getWeekend(b),d=(a||new Date).getDay();c.end<c.start&&(c.end+=7,d<c.start&&(d+=7));return d>=c.start&&d<=c.end},dojo.date.locale._getDayOfYear=
function(a){return dojo.date.difference(new Date(a.getFullYear(),0,1,a.getHours()),a)+1},dojo.date.locale._getWeekOfYear=function(a,b){1==arguments.length&&(b=0);var c=(new Date(a.getFullYear(),0,1)).getDay(),d=Math.floor((dojo.date.locale._getDayOfYear(a)+(c-b+7)%7-1)/7);c==b&&d++;return d});
dojo._hasResource["toura.components.FeedItemDetail"]||(dojo._hasResource["toura.components.FeedItemDetail"]=!0,dojo.provide("toura.components.FeedItemDetail"),dojo.declare("toura.components.FeedItemDetail",mulberry._Component,{templateString:dojo.cache("toura.components","FeedItemDetail/FeedItemDetail.haml",".component.feed-item-detail\n  %article{ dojoAttachPoint : 'content' }\n  %a.full{ dojoAttachPoint : 'externalLink' }= i18n_viewOriginal\n"),itemTemplate:Haml(dojo.cache("toura.components","FeedItemDetail/Item.haml",
":if image\n  .image{ style: 'background-image: url(' + image.url + ')' }\n\n.date= pubDate\n\n%h2= title\n.item-body{ dojoAttachPoint : 'itemBody' }= body\n")),prepareData:function(){this.item=this.node},setupConnections:function(){this.connect(this.externalLink,"click",function(a){a.preventDefault();mulberry.app.PhoneGap.browser.url(this.item.link)})},initializeStrings:function(){this.i18n_viewOriginal=this.getString("FEED_VIEW_ORIGINAL")},_setItemAttr:function(a){"feedItem"===a.type&&(this.item=
a,dojo.empty(this.content),dojo.place(this.itemTemplate(dojo.delegate(this.item,{pubDate:dojo.date.locale.format(this.item.pubDate),i18n_viewOriginal:this.i18n_viewOriginal})),this.content),dojo.attr(this.externalLink,"href",this.item.link),this._setupLinks(),this.region&&this.region.refreshScroller())},_setupLinks:function(){dojo.forEach(this.domNode.querySelectorAll(".content a"),function(a){dojo.attr(a,"target","_blank")},this)}}));
dojo._hasResource["toura.components.FeedItemList"]||(dojo._hasResource["toura.components.FeedItemList"]=!0,dojo.provide("toura.components.FeedItemList"),dojo.declare("toura.components.FeedItemList",mulberry._Component,{templateString:dojo.cache("toura.components","FeedItemList/FeedItemList.haml",".component.feed-item-list\n  %header\n    .updated\n      %span Last Updated:\n      %span{ dojoAttachPoint : 'lastUpdated' }\n    .refresh{ dojoAttachPoint : 'refreshButton' }= i18n_feedRefresh\n    .spinner\n\n  %ol{ dojoAttachPoint : 'feedItemList' }\n\n"),
itemTemplate:Haml(dojo.cache("toura.components","FeedItemList/FeedItem.haml","%li{ data-index : index }\n  %div\n    :if image\n      .image{ style: 'background: url(' + image.url + ')' }\n\n    %h2= title\n    %p.summary= displayText\n    %p.date= pubDate\n\n")),prepareData:function(){this.feed=this.node.feeds&&this.node.feeds[0]},setupConnections:function(){this.inherited(arguments);this.feed&&this.connect(this.refreshButton,"click","_loadFeed")},startup:function(){this.inherited(arguments);this._loadFeed()},
_loadFeed:function(){this.addClass("loading");this.feed.load().then(dojo.hitch(this,"_populate"),dojo.hitch(this,"_handleNoNetwork"));this.connect(this.feedItemList,"click","_onSelect")},_populate:function(a){this.removeClass("loading");a.length?(this.populateElement(this.feedItemList,dojo.hitch(this,function(a,c){a.displayText=mulberry.util.truncate(a.body,200);a.index=c;a.pubDate=dojo.date.locale.format(a.pubDate);return this.itemTemplate(a)}),a),this.lastUpdated.innerHTML=" "+dojo.date.locale.format(new Date),
this.region.refreshScroller(),this.onPopulate()):(a=dojo.create("li",{innerHTML:this.i18n_noItems}),dojo.place(a,this.feedItemList,"only"))},onPopulate:function(){},_handleNoNetwork:function(){this.removeClass("loading");var a=dojo.create("li",{innerHTML:this.i18n_noNetwork});dojo.place(a,this.feedItemList,"only")},_onSelect:function(a){a.preventDefault();for(var a=a.target,b;"li"!==a.nodeName.toLowerCase();)a=a.parentNode;b=dojo.attr(a,"data-index");dojo.forEach(a.parentNode.childNodes,function(a){dojo.removeClass(a,
"active")});dojo.addClass(a,"active");if(b)this.onSelect(this.feed.id,b)},onSelect:function(a,b){console.log("onSelect",a,b)},initializeStrings:function(){this.i18n_noNetwork=this.getString("NO_NETWORK");this.i18n_noItems=this.getString("FEED_NO_ITEMS");this.i18n_feedRefresh=this.getString("FEED_REFRESH")}}));
dojo._hasResource["toura.components.GoogleMap"]||(dojo._hasResource["toura.components.GoogleMap"]=!0,dojo.provide("toura.components.GoogleMap"),function(a){var b=0;a.declare("toura.components.GoogleMap",mulberry._Component,{templateString:a.cache("toura.components","GoogleMap/GoogleMap.haml",".component.google-map\n  .map{ dojoAttachPoint : 'mapNode' }\n"),mapType:"roadmap",apiURL:mulberry.app.URL.protocol()+"://maps.google.com/maps/api/js?v=3.4&sensor=false&callback=",prepareData:function(){this.queue=
[];this.googleTries=0;this.pinCache={};this.markerCache={};this.isBuilt=!1;this.pins=this.node.googleMapPins;a.forEach(this.pins,function(a){this.pinCache[a.id]=a},this)},postCreate:function(){this.inherited(arguments);this.callbackName="GoogleMapCallback"+ ++b;window[this.callbackName]=a.hitch(this,"_buildMap");a.io.script.get({url:this.apiURL+this.callbackName})},_buildMap:function(){delete window[this.callbackName];this.map=new google.maps.Map(this.mapNode,{mapTypeId:this.mapType,streetViewControl:!1,
mapTypeControl:!1,zoom:0,zoomControl:!0,zoomControlOptions:{position:google.maps.ControlPosition.TOP_RIGHT}});var b=new google.maps.LatLngBounds;this.markers=a.map(this.pins||[],function(d){var e=new google.maps.LatLng(d.lat,d.lon),f=new google.maps.Marker({map:this.map,position:e,title:d.name});google.maps.event.addListener(f,"click",a.hitch(this,"_showInfo",f,d));b.extend(e);return this.markerCache[d.id]=f},this);1<this.pins.length?this.map.fitBounds(b):this.pins[0]&&(this.map.setCenter(new google.maps.LatLng(this.pins[0].lat,
this.pins[0].lon)),this.map.setZoom(15));this.isBuilt=!0;this._doQueue();this.onMapBuilt()},_showInfo:function(a,b){var e;this.tablet&&(e=new google.maps.InfoWindow({content:this.pinInfo.domNode}),e.open(this.map,a));this.onShowInfo(b)},onShowInfo:function(){},onMapBuilt:function(){},_setCenterAttr:function(a){a=new google.maps.LatLng(a.lat,a.lng);this.map.setCenter(a);this.map.setZoom(15)},_setPinAttr:function(b){if(b)if(this.isBuilt){var d=this.markerCache[b],b=this.pinCache[b];this.map.panTo(new google.maps.LatLng(b.lat,
b.lon));this._showInfo(d,b);this.pin=b}else this._addToQueue(a.hitch(this,"set","pin",b))},teardown:function(){window.google&&window.google.maps&&window.google.maps.event&&(a.forEach(this.markers,function(a){google.maps.event.clearInstanceListeners(a);a.setMap(null)}),google.maps.event.clearInstanceListeners(this.map))},_addToQueue:function(a){this.queue.push(a)},_doQueue:function(){a.forEach(this.queue,function(a){a()},this)}})}(dojo));
dojo._hasResource["toura.components.Hotspots"]||(dojo._hasResource["toura.components.Hotspots"]=!0,dojo.provide("toura.components.Hotspots"),dojo.declare("toura.components.Hotspots",mulberry._Component,{templateString:dojo.cache("toura.components","Hotspots/Hotspots.haml",".component.hotspots\n  .image-wrapper{ dojoAttachPoint : 'imageWrapper', style : 'text-align: center' }\n    %img{ src : image.url, dojoAttachPoint : 'imageNode' }\n"),widgetsInTemplate:!0,prepareData:function(){this.hotspots=this.node.data[0].json.hotspots;
this.image=this.node.images[0].original},setupConnections:function(){this.connect(this.imageNode,"click","_handleImageClick")},postCreate:function(){this.inherited(arguments);this.scroller=new iScroll(this.domNode,{zoom:!1,bounce:!1});dojo.style(this.imageWrapper,{width:this.image.width+"px",height:this.image.height+"px"})},_handleImageClick:function(a){a.preventDefault();var b=a.offsetX,c=a.offsetY,d;dojo.forEach(this.hotspots,function(a){if(!d&&("rectangle"===a.shape&&b>a.left&&c>a.top&&b<a.left+
a.width&&c<a.top+a.height&&(d=a),"circle"===a.shape)){var f=a.width/2,g=a.left+f;Math.sqrt(Math.pow(a.top+f-c,2)+Math.pow(g-b,2))<f&&(d=a)}},this);d&&(mulberry.app.UI.click={x:b,y:c},mulberry.app.Router.go(toura.URL.node(d.node_id)))},startup:function(){this.inherited(arguments);var a=this.domNode.clientHeight,b=this.domNode.clientWidth,c,d;mulberry.app.UI.click?(d=mulberry.app.UI.click,c=+d.x,d=+d.y):(c=this.image.width/2,d=this.image.height/2);mulberry.app.UI.click=!1;c=c>b/2?c-b/2:0;d=d>a/2?d-
a/2:0;this.scroller.refresh();this.scroller.scrollTo(-1*c,-1*d,"0ms")}}));
dojo._hasResource["toura.components._ImageGallery"]||(dojo._hasResource["toura.components._ImageGallery"]=!0,dojo.provide("toura.components._ImageGallery"),dojo.declare("toura.components._ImageGallery",null,{widgetsInTemplate:!0,postCreate:function(){this.inherited(arguments)},startup:function(){this._setWidth();this._setupClick();this.subscribe("/window/resize","_setWidth")},_setWidth:function(){this.widthItems=this.widthItems||this.query(".image");this.widthItems.style("width",mulberry.app.UI.viewport.width+
"px")},_setCurrentImageIndexAttr:function(a){this.bgImgs=this.bgImgs||dojo.filter(dijit.findWidgets(this.domNode),function(a){return a.isInstanceOf(mulberry.ui.BackgroundImage)});dojo.forEach(this.bgImgs,function(b,c){null!==a&&c>=a-1&&c<=a+1?b.loadImage():b.unloadImage()},this);this.currentImageIndex=a},_setupClick:function(){if(this._handleClick&&this.clickNode){var a=mulberry.app.UI.hasTouch?{start:"touchstart",move:"touchmove",end:"touchend"}:{start:"mousedown",move:"mousemove",end:"mouseup"};
this.connect(this.clickNode,a.start,function(){var b=[],c,d=dojo.hitch(this,"_handleClick"),e=(new Date).getTime();b.push(dojo.connect(this.imageList,a.move,function(){c=!0}));b.push(dojo.connect(this.imageList,a.end,function(a){dojo.forEach(b,dojo.disconnect);(new Date).getTime()-e>mulberry.app.UI.touchMoveDebounce&&c||d(a)}))})}}}));
dojo._hasResource["toura.components._ImageScroller"]||(dojo._hasResource["toura.components._ImageScroller"]=!0,dojo.provide("toura.components._ImageScroller"),dojo.declare("toura.components._ImageScroller",toura.components._ImageGallery,{templateString:dojo.cache("toura.components","_ImageScroller/ImageScroller.haml",".component.image-scroller\n  .wrapper\n    %ol.images{ dojoAttachPoint : 'imageList' }\n      :each img in images\n        %li{ class : 'image ' + img.id }\n          .image{ dojoType : 'mulberry.ui.BackgroundImage', imageUrl : img.url }\n  %ol.indicator{ dojoAttachPoint : 'indicator' }\n    :each img in images\n      %li &#183;\n"),
postMixInProperties:function(){this.inherited(arguments);this.useScroller=1<this.images.length},startup:function(){this.inherited(arguments);this.useScroller?this._setupImageScroller():this.set("currentImageIndex",0)},_setupImageScroller:function(){if(this.useScroller&&this.scrollerNode){var a=this;(this.scrollerHandle=new iScroll(this.scrollerNode.parentNode,{snap:!0,momentum:!1,hScrollbar:!1,onScrollEnd:function(){a.set("currentImageIndex",this.currPageX);a.onScrollEnd(this.currPageX)}})).refresh();
this.onScrollerSetupComplete()}this.set("currentImageIndex",0)},onScrollerSetupComplete:function(){console.log("toura.components._ImageScroller::onScrollerSetupComplete()")},onScrollEnd:function(){},_setWidth:function(){var a=mulberry.app.UI.viewport.width;this.scrollerNode.style.width=this.images.length*a+"px";this.query(".image").style("width",a+"px");this.scrollerHandle&&(this.scrollerHandle.refresh(),this.scrollToIndex(this.currentImageIndex))},_setCurrentImageIndexAttr:function(a){var b=this.indicator.childNodes;
this.inherited(arguments);dojo.forEach(b,function(a){dojo.removeClass(a,"active")});0<b.length&&dojo.addClass(b[a],"active")},postCreate:function(){this.inherited(arguments);1>=this.images.length&&this.hide(this.indicator)},_updateIndicator:function(){},scrollToIndex:function(a){this.scrollerHandle&&a!==this.currentImageIndex&&(this.scrollerHandle.scrollToPage(a,0,"0ms"),this.set("currentImageIndex",a))},refresh:function(){this.scrollerHandle&&this.scrollerHandle.refresh()},destroy:function(){this.scrollerHandle&&
this.scrollerHandle.destroy();this.inherited(arguments)}}));
dojo._hasResource["toura.components.ImageGallery"]||(dojo._hasResource["toura.components.ImageGallery"]=!0,dojo.provide("toura.components.ImageGallery"),dojo.declare("toura.components.ImageGallery",[mulberry._Component,toura.components._ImageScroller],{"class":"image-gallery",prepareData:function(){this.images=dojo.map(this.node.images||[],function(a){return dojo.mixin(a,{url:a.gallery.url,height:a.gallery.height,width:a.gallery.width})},this)},postCreate:function(){this.scrollerNode=this.clickNode=
this.imageList;this.inherited(arguments)},_handleClick:function(){this.onShowDetail(this.currentImageIndex)},onShowDetail:function(){}}));dojo._hasResource["mulberry.app.URL"]||(dojo._hasResource["mulberry.app.URL"]=!0,dojo.provide("mulberry.app.URL"),mulberry.app.URL={protocol:function(){return/^https/.test(document.location.protocol)?"https":"http"},tel:function(a){return"tel:"+a.replace(/\W/g,"")},googleMapAddress:function(a){return"http://maps.google.com/maps?"+dojo.objectToQuery({q:a})}});
dojo._hasResource["toura.components.LocationList"]||(dojo._hasResource["toura.components.LocationList"]=!0,dojo.provide("toura.components.LocationList"),dojo.declare("toura.components.LocationList",mulberry._Component,{templateString:dojo.cache("toura.components","LocationList/LocationList.haml","%ul.component.location-list\n  :each location in locations\n    %li\n      .address\n        %p= location.name\n\n        :if location.address\n          %p= location.address\n\n      %a.directions{ target : '_blank', href : location.directionsUrl }= i18n_directions\n\n      :if location.phoneNumber\n        %a.phone-number{ href : location.phoneUrl }\n          %span.label= i18n_phone\n          %span= location.phoneNumber\n\n      :if location.website\n          %a.website{ href : location.website }= i18n_website\n"),
prepareData:function(){this.locations=dojo.map(this.node.googleMapPins,function(a){var b=dojo.mixin({},a);b.directionsUrl=a.address&&mulberry.app.URL.googleMapAddress(a.address);b.phoneUrl=a.phoneNumber&&mulberry.app.URL.tel(a.phoneNumber);return b})},setupConnections:function(){dojo.forEach(this.query("a.website"),function(a){this.connect(a,"click",function(b){b.preventDefault();mulberry.app.PhoneGap.browser.url(dojo.attr(a,"href"))})},this)},initializeStrings:function(){this.i18n_phone=this.getString("PHONE");
this.i18n_website=this.getString("WEBSITE");this.i18n_directions=this.getString("DIRECTIONS")}}));
dojo._hasResource["dojo.store.util.QueryResults"]||(dojo._hasResource["dojo.store.util.QueryResults"]=!0,dojo.provide("dojo.store.util.QueryResults"),dojo.getObject("store.util",!0,dojo),dojo.store.util.QueryResults=function(a){function b(b){a[b]||(a[b]=function(){var d=arguments;return dojo.when(a,function(a){Array.prototype.unshift.call(d,a);return dojo.store.util.QueryResults(dojo[b].apply(dojo,d))})})}if(!a)return a;a.then&&(a=dojo.delegate(a));b("forEach");b("filter");b("map");a.total||(a.total=
dojo.when(a,function(a){return a.length}));return a});
dojo._hasResource["dojo.store.util.SimpleQueryEngine"]||(dojo._hasResource["dojo.store.util.SimpleQueryEngine"]=!0,dojo.provide("dojo.store.util.SimpleQueryEngine"),dojo.getObject("store.util",!0,dojo),dojo.store.util.SimpleQueryEngine=function(a,b){function c(c){c=dojo.filter(c,a);b&&b.sort&&c.sort(function(a,c){for(var d,e=0;d=b.sort[e];e++){var f=a[d.attribute],p=c[d.attribute];if(f!=p)return!!d.descending==f>p?-1:1}return 0});if(b&&(b.start||b.count)){var d=c.length,c=c.slice(b.start||0,(b.start||
0)+(b.count||Infinity));c.total=d}return c}switch(typeof a){default:throw Error("Can not query with a "+typeof a);case "object":case "undefined":var d=a,a=function(a){for(var b in d){var c=d[b];if(c&&c.test){if(!c.test(a[b]))return!1}else if(c!=a[b])return!1}return!0};break;case "string":if(!this[a])throw Error("No filter function "+a+" was found in store");a=this[a];case "function":}c.matches=a;return c});
dojo._hasResource["dojo.store.Memory"]||(dojo._hasResource["dojo.store.Memory"]=!0,dojo.provide("dojo.store.Memory"),dojo.declare("dojo.store.Memory",null,{constructor:function(a){this.index={};dojo.mixin(this,a);this.setData(this.data||[])},data:null,idProperty:"id",index:null,queryEngine:dojo.store.util.SimpleQueryEngine,get:function(a){return this.index[a]},getIdentity:function(a){return a[this.idProperty]},put:function(a,b){var c=b&&b.id||a[this.idProperty]||Math.random();this.index[c]=a;for(var d=
this.data,e=this.idProperty,f=0,g=d.length;f<g;f++)if(d[f][e]==c)return d[f]=a,c;this.data.push(a);return c},add:function(a,b){if(this.index[b&&b.id||a[this.idProperty]])throw Error("Object already exists");return this.put(a,b)},remove:function(a){delete this.index[a];for(var b=this.data,c=this.idProperty,d=0,e=b.length;d<e;d++)if(b[d][c]==a){b.splice(d,1);break}},query:function(a,b){return dojo.store.util.QueryResults(this.queryEngine(a,b)(this.data))},setData:function(a){a.items?(this.idProperty=
a.identifier,a=this.data=a.items):this.data=a;for(var b=0,c=a.length;b<c;b++){var d=a[b];this.index[d[this.idProperty]]=d}}}));dojo._hasResource["toura.models.Favorite"]||(dojo._hasResource["toura.models.Favorite"]=!0,dojo.provide("toura.models.Favorite"),dojo.declare("toura.models.Favorite",null,{constructor:function(a){a={id:a.id,type:"node",name:a.name,added:(new Date).getTime()};dojo.mixin(this,a)}}));
dojo._hasResource["toura.user.Favorites"]||(dojo._hasResource["toura.user.Favorites"]=!0,dojo.provide("toura.user.Favorites"),function(){var a=mulberry.app.DeviceStorage;dojo.declare("toura.user.Favorites",null,{constructor:function(){this._init();this.subscriptions=[dojo.subscribe("/favorite/add",this,"_addFavorite"),dojo.subscribe("/favorite/remove",this,"_removeFavorite"),dojo.subscribe("/favorites/clear",this,"_empty"),dojo.subscribe("/data/loaded",this,"_refresh")]},hasFavorites:function(){return!!this.store.data.length},
_init:function(){var b=a.get("favorites");this.store=new dojo.store.Memory({data:b||[]});this._refresh()},_refresh:function(){dojo.forEach(this.store.data,function(a){toura.Data.getById(a.id)||(a.deleted=!0,this.store.put(a))},this);this.onRefresh(this.store.data)},onRefresh:function(){},load:function(a,c){a||(a="added",c=!0);return this._sort(a||"added",c)},isFavorite:function(a){return!!a&&!!a.id&&!!this.store.get(a.id)},_removeFavorite:function(a){console.log("toura.user.Favorites::_removeFavorite()",
a);this.store.remove(dojo.isString(a)?a:a.id);this._save()},_empty:function(){this._save([]);this._init()},_save:function(b){console.log("will try to save",this.store.data);a.set("favorites",b||this.store.data)},_addFavorite:function(a){console.log("toura.user.Favorites::_addFavorite()",a);this.isFavorite(a)||(this.store.add(new toura.models.Favorite(a)),this._save())},_sort:function(a,c){if(!a)throw Error("toura.user.Favorites::_sort requires a property for sorting");var d=[].concat(this.store.data);
return this._makeModels(d[0]&&d[0][a]?d.sort(function(d,f){d=d[a];f=f[a];return d<f?c?1:-1:d>f?c?-1:1:0}):d)},_makeModels:function(a){return dojo.map(a,function(a){return dojo.mixin({model:toura.Data.getModel(a.id)},a)},this)},destroy:function(){dojo.forEach(this.subscriptions,dojo.unsubscribe)}})}(),dojo.subscribe("/app/ready",function(){toura.user.Favorites=new toura.user.Favorites}));
dojo._hasResource["toura.components.buttons.HomeButton"]||(dojo._hasResource["toura.components.buttons.HomeButton"]=!0,dojo.provide("toura.components.buttons.HomeButton"),dojo.declare("toura.components.buttons.HomeButton",toura.components.buttons._Button,{preventWhenAnimating:!0,onClick:function(a){a.preventDefault();mulberry.app.Router.home()}}));
dojo._hasResource["toura.components.buttons.FontSize"]||(dojo._hasResource["toura.components.buttons.FontSize"]=!0,dojo.provide("toura.components.buttons.FontSize"),dojo.declare("toura.components.buttons.FontSize",toura.components.buttons._Button,{sizes:["small","medium","large"],"class":"font-size",defaultSize:"medium",sizePrefix:"font-size-",onClick:function(a){a.preventDefault();dojo.body();a=this.sizePrefix+(this.sizes[dojo.indexOf(this.sizes,(mulberry.app.UI.fontSize||this.sizePrefix+this.defaultSize).replace(this.sizePrefix,
""))+1]||this.sizes[0]);mulberry.app.UI.set("fontSize",a)},initializeStrings:function(){this.i18n_font=this.getString("FONT")}}));
dojo._hasResource["toura.components.SocialMessage"]||(dojo._hasResource["toura.components.SocialMessage"]=!0,dojo.provide("toura.components.SocialMessage"),dojo.declare("toura.components.SocialMessage",mulberry._Component,{templateString:dojo.cache("toura.components","SocialMessage/SocialMessage.haml","%form.component.social-message\n  :if requireAuth\n    %fieldset.auth\n      %input{ type : 'text', name : 'username', placeholder : 'username', dojoAttachPoint : 'username', autocapitalize : 'off', autocorrect : 'off' }\n      %input{ type : 'password', name : 'password', placeholder : 'password', dojoAttachPoint : 'password' }\n\n\n  %textarea{ dojoAttachPoint : 'message', name : 'msg', autocorrect : 'off' }= messageText\n\n  :if maxLength\n    .count{ dojoAttachPoint : 'count' }= availLength\n\n  %fieldset.buttons\n    %input.highlight{ type : 'submit', dojoAttachPoint : 'submitBtn', value : i18n_submitLabel }\n    %input{ type : 'reset', dojoAttachPoint : 'cancelBtn', value : i18n_cancelLabel }\n"),requireAuth:!1,
maxLength:!1,errorClass:"error",warningClass:"warning",prepareData:function(){this.messageText=this.messageText||"";this.availLength=this.maxLength-this.messageText.length},setupConnections:function(){this.connect(this.submitBtn,"click","_onSubmit");this.connect(this.cancelBtn,"click","_onCancel");dojo.forEach([this.message,this.username,this.password],dojo.hitch(this,function(a){this.connect(a,"blur","_onSocialBlur")}));dojo.forEach(["keyup","change"],dojo.hitch(this,function(a){this.connect(this.message,
a,"_resize")}));this.maxLength&&this.connect(this.message,"keyup","_updateCharCount")},_updateCharCount:function(){var a=this.message.value.length,b=11>this.maxLength-a,c=0>=this.maxLength-a;this.count.innerHTML=this.maxLength-a;dojo[c?"addClass":"removeClass"](this.count,this.errorClass);dojo[b&&!c?"addClass":"removeClass"](this.count,this.warningClass)},_onSubmit:function(a){a.preventDefault();var a={msg:this.message.value,username:this.username&&this.username.value,password:this.password&&this.password.value},
b;a.msg=dojo.trim(a.msg);b=this._validate(a);if(b.length)this._handleErrors(b);else this.onSubmit(a)},_validate:function(a){var b=[];this.requireAuth&&(a.username||b.push(this.i18n_usernameRequired),a.password||b.push(this.i18n_passwordRequired),b.length&&b.push(this.i18n_privacy));a.msg||b.push(this.i18n_messageRequired);this.maxLength&&a.msg.length>this.maxLength&&b.push(this.i18n_messageLength);return b},_resize:function(){var a=this.message;a.style.height="auto";a.style.height=a.scrollHeight+
"px"},_handleErrors:function(a){mulberry.app.PhoneGap.notification.alert(a.join("\n"))},onSubmit:function(a){console.log(a)},_onCancel:function(){this.onCancel()},onCancel:function(){console.log("toura.components.SocialMessage::onCancel()")},_onSocialBlur:function(){window.scrollTo(0,0)},initializeStrings:function(){this.i18n_submitLabel=this.getString("SEND");this.i18n_cancelLabel=this.getString("CANCEL");this.i18n_usernameRequired=this.getString("SOCIAL_USERNAME_REQUIRED");this.i18n_passwordRequired=
this.getString("SOCIAL_PASSWORD_REQUIRED");this.i18n_privacy=this.getString("SOCIAL_PRIVACY");this.i18n_messageRequired=this.getString("SOCIAL_MESSAGE_REQUIRED");this.i18n_messageLength=this.getString("SOCIAL_MESSAGE_LENGTH")}}));
dojo._hasResource["toura.components.MoreDrawer"]||(dojo._hasResource["toura.components.MoreDrawer"]=!0,dojo.provide("toura.components.MoreDrawer"),dojo.declare("toura.components.MoreDrawer",mulberry._Component,{templateString:dojo.cache("toura.components","MoreDrawer/MoreDrawer.haml",".component.more-drawer\n  :if phone\n    %section\n      %menu\n        =helpers.homeButton\n        =helpers.fontSizeButton\n        =helpers.searchButton\n\n    %section\n      %menu\n        =helpers.favoriteButton\n        =helpers.sharingButtons\n\n  :if tablet\n    %section\n      %menu\n        =helpers.fontSizeButton\n        =helpers.favoriteButton\n        =helpers.sharingButtons\n\n  %section{ dojoAttachPoint : 'shareSection' }\n"),
helpers:{sharingButtons:dojo.cache("toura.components","MoreDrawer/_SharingButtons.haml","%li.facebook\n  %a{ dojoAttachPoint : 'facebook' }\n\n%li.twitter\n  %a{ dojoAttachPoint : 'twitter' }\n\n%li.email\n  %a{ dojoAttachPoint : 'email', href : '#' }\n"),favoriteButton:dojo.cache("toura.components","MoreDrawer/_FavoriteButton.haml","%li.favorite\n  %input{ type : 'checkbox', dojoAttachPoint : 'favorite' }\n"),homeButton:dojo.cache("toura.components","MoreDrawer/_HomeButton.haml","%li.home\n  %a{ dojoType : 'toura.components.buttons.HomeButton', dojoAttachPoint : 'homeButton' }\n"),
fontSizeButton:dojo.cache("toura.components","MoreDrawer/_FontSizeButton.haml","%li.font-size\n  %a{ dojoType : 'toura.components.buttons.FontSize' }\n"),searchButton:dojo.cache("toura.components","MoreDrawer/_SearchButton.haml","%li.search\n  %a{ dojoType : 'toura.components.buttons.SearchButton', dojoAttachPoint : 'searchButton' }\n")},widgetsInTemplate:!0,isHidden:!0,prepareData:function(){this.sharingDisabled=!toura.features.sharing;this.favoritesDisabled=!toura.features.favorites;this.fontSizeDisabled=
!toura.features.fontSize;this.sharingDisabled||(this.socialMediaServices=toura.Sharing.getServices(),this.socialMediaServices.length||(this.sharingDisabled=!0));this.helpers.sharingButtons=this.sharingDisabled?"":this.helpers.sharingButtons;this.helpers.favoriteButton=this.favoritesDisabled?"":this.helpers.favoriteButton;this.helpers.fontSizeButton=this.fontSizeDisabled?"":this.helpers.fontSizeButton;this.inherited(arguments)},setupConnections:function(){var a=mulberry.app.UI.hasTouch,b=a?"touchstart":
"click",c=function(a){a.preventDefault()};this.sharingDisabled||(dojo.forEach(this.socialMediaServices,function(d){var e=this[d.name];e&&(this.connect(e,b,dojo.hitch(this,"_handleSocialMessageClick",d)),a&&this.connect(e,"click",c))},this),this._createMailLink(),this.hide(this.shareSection));this.favoritesDisabled||(this.connect(this.favorite,b,"_handleFavorite"),a&&this.connect(this.favorite,"click",c))},adjustMarkup:function(){this.sharingDisabled||dojo.forEach(["facebook","twitter"],function(a){dojo.filter(this.socialMediaServices,
function(b){return b.name===a}).length||dojo.destroy(this.query("."+a)[0])},this)},_createMailLink:function(){this.email&&(dojo.attr(this.email,"href","mailto:?"+dojo.objectToQuery({subject:mulberry.app.Config.get("app").name,body:toura.Sharing.getMessage("email",this.node)})),this.connect(this.email,"click",function(){dojo.publish("/share",[["email",this.node.id].join(": ")])}))},_handleSocialMessageClick:function(a){console.log("toura.components.MoreDrawer::_handleSocialMessageClick()");mulberry.app.PhoneGap.network.isReachable().then(dojo.hitch(this,
function(b){if(b){if(this.socialMessage&&(b=this.socialMessage.name===a.name,this.orphan(this.socialMessage,!0),delete this.socialMessage,b)){dojo.removeClass(this[a.name],"active");return}dojo.addClass(this[a.name],"active");var b=dojo.mixin({messageText:toura.Sharing.getMessage(a.name,this.node)},a),c=this.socialMessage=this.adopt(toura.components.SocialMessage,b);c.placeAt(this.shareSection);this.show(this.shareSection);this.connect(c,"onSubmit",function(b){toura.Sharing.share(a,b,this.node).then(dojo.hitch(this,
function(){this.hide(this.shareSection)}),function(a){a&&mulberry.app.PhoneGap.notification.alert(a)})});this.connect(c,"onCancel",function(){this.hide(this.shareSection);this.orphan(c,!0);delete this.socialMessage})}else mulberry.app.PhoneGap.notification.alert(this.i18n_noNetwork)}),function(){mulberry.app.PhoneGap.notification.alert(this.i18n_noNetwork)})},_handleFavorite:function(){console.log("toura.components.MoreDrawer::_handleFavorite");if(this.node){var a=this.node,b=toura.user.Favorites.isFavorite(a);
dojo.publish("/favorite/"+(b?"remove":"add"),[a]);this.favorite.checked=!b}},_setNodeAttr:function(a){this.node=a;this.favorite&&(this.favorite.checked=toura.user.Favorites.isFavorite(a))},toggle:function(){this.isHidden?dojo.publish("/MoreDrawer/show"):(dojo.publish("/MoreDrawer/hide"),this.hide(this.shareSection));this.inherited(arguments)},initializeStrings:function(){this.i18n_noNetwork=this.getString("NO_NETWORK")}}));
dojo._hasResource["toura.components.NodeGallery"]||(dojo._hasResource["toura.components.NodeGallery"]=!0,dojo.provide("toura.components.NodeGallery"),dojo.declare("toura.components.NodeGallery",[mulberry._Component,toura.components._ImageScroller],{"class":"node-gallery",prepareData:function(){this.node.populateChildren();this.children=this.node.children;this.images=dojo.map(this.children||[],function(a){a=a.images[0];return dojo.mixin(a,this.phone?{url:a.gallery.url,height:a.gallery.height,width:a.gallery.width}:
{url:a.original.url,height:a.original.height,width:a.original.width})},this)},postCreate:function(){this.scrollerNode=this.clickNode=this.imageList;this.inherited(arguments)},setupConnections:function(){this.connect(this.clickNode,"click","_handle")},_handle:function(a){var b=this.children[this.currentImageIndex],a={x:a.offsetX,y:a.offsetY},c=this.images[this.currentImageIndex],d=this.domNode.clientHeight,e=this.domNode.clientWidth,f=e/c.width;c.height*f>d&&(a.y+=(c.height*f-d)/2);c=c.original.width/
e;a.x=Math.floor(a.x*c);a.y=Math.floor(a.y*c);mulberry.app.UI.click=a;mulberry.app.Router.go(b.url)},onScrollEnd:function(){}}));
dojo._hasResource["toura.components.NodeTitleBanner"]||(dojo._hasResource["toura.components.NodeTitleBanner"]=!0,dojo.provide("toura.components.NodeTitleBanner"),dojo.declare("toura.components.NodeTitleBanner",mulberry._Component,{templateString:dojo.cache("toura.components","NodeTitleBanner/NodeTitleBanner.haml",".component.node-title-banner\n  :if image\n    .image{ dojoType : 'mulberry.ui.BackgroundImage', imageUrl : image.url, loadOnInit: true }\n\n  %header\n    :if parentTitle\n      %h3= parentTitle\n\n    %h2= nodeTitle\n"),widgetsInTemplate:!0,
prepareData:function(){this.image=this.node.featuredImage?this.node.featuredImage[this.phone?"small":"large"]:!1;this.parentTitle=this.node.parent&&this.node.parent.name;this.nodeTitle=this.node.name}}));
dojo._hasResource["toura.components.PageHeaderImage"]||(dojo._hasResource["toura.components.PageHeaderImage"]=!0,dojo.provide("toura.components.PageHeaderImage"),dojo.declare("toura.components.PageHeaderImage",toura.components.HeaderImage,{"class":"page-header-image",prepareData:function(){this.inherited(arguments);this.viewImage&&dojo.mixin(this.viewImage,this._calculateDimensions())},_getWidth:function(){return mulberry.app.UI.viewport.width}}));
dojo._hasResource["toura.components.buttons.MoreDrawerButton"]||(dojo._hasResource["toura.components.buttons.MoreDrawerButton"]=!0,dojo.provide("toura.components.buttons.MoreDrawerButton"),dojo.declare("toura.components.buttons.MoreDrawerButton",toura.components.buttons._Button,{initializeStrings:function(){this.i18n_text=this.getString("MORE")}}));
dojo._hasResource["toura.components.buttons.BackButton"]||(dojo._hasResource["toura.components.buttons.BackButton"]=!0,dojo.provide("toura.components.buttons.BackButton"),dojo.declare("toura.components.buttons.BackButton",toura.components.buttons._Button,{preventWhenAnimating:!0,onClick:function(a){a.preventDefault();toura.features.disableBackButton||mulberry.app.Router.back()},initializeStrings:function(){this.i18n_text=this.getString("BACK")}}));
dojo._hasResource["toura.components.PageNav"]||(dojo._hasResource["toura.components.PageNav"]=!0,dojo.provide("toura.components.PageNav"),dojo.declare("toura.components.PageNav",mulberry._Component,{templateString:dojo.cache("toura.components","PageNav/PageNav.haml","%nav.component.page-nav\n  .top\n    :if tablet\n      %ul\n        %li.back\n          %a{ dojoType : 'toura.components.buttons.BackButton', dojoAttachPoint : 'backButton' }\n        %li.home\n          %a{ dojoType : 'toura.components.buttons.HomeButton', dojoAttachPoint : 'homeButton' }\n\n      %h1\n        %span{ dojoAttachPoint : 'titleElement' }= title\n\n      %ul\n        :if shareable\n          %li.more\n            %a{ dojoType : 'toura.components.buttons.MoreDrawerButton', dojoAttachPoint : 'moreDrawerButton' }\n\n        %li.search\n          %a{ href : searchUrl }\n\n    :if phone\n      .back\n        %a{ dojoType : 'toura.components.buttons.BackButton', dojoAttachPoint : 'backButton' }\n\n      %h1\n        %span{ dojoAttachPoint : 'titleElement' }= title\n\n      :if shareable\n        .more\n          %a{ dojoType : 'toura.components.buttons.MoreDrawerButton', dojoAttachPoint : 'moreDrawerButton' }\n\n      :if !shareable\n        .home\n          %a{ dojoType : 'toura.components.buttons.BackButton', dojoAttachPoint : 'backButton' }\n\n  :if shareable\n    %div{ dojoType : 'toura.components.MoreDrawer', dojoAttachPoint : 'moreDrawer' }\n"),
widgetsInTemplate:!0,shareable:!0,prepareData:function(){this.searchUrl=toura.URL.search();this.homeUrl=toura.URL.home();this.title=this.node?this.node.name:this.title;this.shareable=this.node&&this.node.shareable},setupConnections:function(){this.moreDrawerButton&&this.connect(this.moreDrawerButton,"onClick","_showMoreDrawer")},setupSubscriptions:function(){this.subscribe("/button/menu","_showMoreDrawer")},setupChildComponents:function(){this.shareable&&this.moreDrawer.set("node",this.node)},initializeStrings:function(){this.i18n_more=
this.getString("MORE")},_showMoreDrawer:function(a){a&&a.preventDefault();this.moreDrawer.toggle()},attributeMap:{screenTitle:{node:"titleElement",type:"innerHTML"}}}));dojo._hasResource["toura.components.PinCaption"]||(dojo._hasResource["toura.components.PinCaption"]=!0,dojo.provide("toura.components.PinCaption"),dojo.declare("toura.components.PinCaption",toura.components.BodyText,{"class":"pin-caption",_getBodyText:function(){return this.caption||this.inherited(arguments)}}));
dojo._hasResource["toura.components.PinInfo"]||(dojo._hasResource["toura.components.PinInfo"]=!0,dojo.provide("toura.components.PinInfo"),dojo.declare("toura.components.PinInfo",mulberry._Component,{templateString:dojo.cache("toura.components","PinInfo/PinInfo.haml",".component.pin-info\n\n  %a.directions{ dojoAttachPoint : 'directionsNode', target : '_blank' }= i18n_directions\n  %a.phone-number{ dojoAttachPoint : 'phoneNumberContainerNode' }\n    %span.label= i18n_phone\n    %span{ dojoAttachPoint : 'phoneNumberNode' }\n  %a.website{ dojoAttachPoint : 'websiteContainerNode' }= i18n_website\n\n  .bottom\n    %section\n      %header\n        %h2{ dojoAttachPoint : 'nameNode' }\n        %p{ dojoAttachPoint : 'addressNode' }\n      %div{ dojoAttachPoint : 'captionNode' }\n\n"),
widgetsInTemplate:!0,setupChildComponents:function(){this.scroller&&this.scroller.makeScroller();this.captionNode=this.adopt(toura.components.PinCaption).placeAt(this.captionNode,"replace")},setupConnections:function(){this.connect(this.websiteContainerNode,"click",function(a){a.preventDefault();mulberry.app.PhoneGap.browser.url(dojo.attr(this.websiteContainerNode,"data-url"))})},_onClose:function(){this.onClose()},onClose:function(){},_setPinAttr:function(a){a&&(this.set("pinName",a.name),this.set("address",
a.address),this.set("directionsUrl",mulberry.app.URL.googleMapAddress(a.address)),this.set("phoneNumber",a.phoneNumber),this.set("website",a.website),this.captionNode.set("content",a.caption||""))},_setPhoneNumberAttr:function(a){a?(this.show(this.phoneNumberContainerNode),this.phoneNumberNode.innerHTML=a,dojo.attr(this.phoneNumberContainerNode,"href",mulberry.app.URL.tel(a))):this.hide(this.phoneNumberContainerNode)},_setWebsiteAttr:function(a){a?(this.show(this.websiteContainerNode),dojo.attr(this.websiteContainerNode,
"data-url",a)):this.hide(this.websiteContainerNode)},attributeMap:{pinName:{node:"nameNode",type:"innerHTML"},address:{node:"addressNode",type:"innerHTML"},directionsUrl:{node:"directionsNode",type:"attribute",attribute:"href"}},initializeStrings:function(){this.i18n_directions=this.getString("DIRECTIONS");this.i18n_phone=this.getString("PHONE");this.i18n_website=this.getString("WEBSITE")}}));
dojo._hasResource["toura.components.SearchInput"]||(dojo._hasResource["toura.components.SearchInput"]=!0,dojo.provide("toura.components.SearchInput"),dojo.declare("toura.components.SearchInput",mulberry._Component,{templateString:dojo.cache("toura.components","SearchInput/SearchInput.haml",".component.search-input\n  %a.back{ dojoType : 'toura.components.buttons.BackButton' }\n  %form.search{ dojoAttachPoint : 'searchForm' }\n    %input{ type : 'search', name : 'query', placeholder : i18n_placeholderText, autocorrect : 'off', dojoAttachPoint : 'queryInput' }\n    %input{ type : 'submit', value : 'Search', dojoAttachPoint : 'searchButton' }\n"),
_oldValue:null,keybuffer:3,debounceTime:300,timeout:null,widgetsInTemplate:!0,setupConnections:function(){this.connect(this.queryInput,"focus",function(){window.scrollTo(0,0);this.queryInput.value=""});this.connect(this.queryInput,"keyup","_handleInput");mulberry.app.UI.hasTouch&&this.connect(this.searchButton,"touchstart","_handleSubmit");this.connect(this.searchForm,"submit","_handleSubmit")},_setSearchTermAttr:function(a){this.queryInput.value=a||""},_handleInput:function(){dojo.trim(this.queryInput.value).length<
this.keybuffer||(clearTimeout(this.timeout),this.timeout=setTimeout(dojo.hitch(this,function(){this._search(this.queryInput.value)}),this.debounceTime))},_handleSubmit:function(a){a.preventDefault();a.stopPropagation();a=this.queryInput.value;/^mulberry:./.test(a)?(console.log("found mulberry:"),dojo.publish("/debug/user",[a])):this._search(a)},_search:function(a){(a=dojo.trim(a))&&a!==this._oldValue&&this.search(a)},search:function(){},initializeStrings:function(){this.i18n_placeholderText=this.getString("SEARCH_PLACEHOLDER_TEXT")}}));
dojo._hasResource["toura.components.SearchResults"]||(dojo._hasResource["toura.components.SearchResults"]=!0,dojo.provide("toura.components.SearchResults"),dojo.declare("toura.components.SearchResults",mulberry._Component,{templateString:dojo.cache("toura.components","SearchResults/SearchResults.haml",".component.search-results\n  %ul{ dojoAttachPoint : 'resultsContainer' }\n"),resultTemplate:Haml(dojo.cache("toura.components","SearchResults/Result.haml","%li{ class : type }\n  %a.text{ href : url }\n    %h2= nodeTitle\n    %p= displayText\n")),
handleClicks:!0,resultsToShow:25,postCreate:function(){this.clickableNode=this.resultsContainer;this.inherited(arguments)},_setResultsAttr:function(a){if(a&&!dojo.isArray(a))throw Error("toura.components.SearchResults::_setResultsAttr: results argument must be an array");dojo.empty(this.resultsContainer);if(a)if(a.length){var b=a.length>this.resultsToShow;this.results=a=a.slice(0,this.resultsToShow);this.populateElement(this.resultsContainer,dojo.hitch(this,function(a){var a=dojo.mixin({},a),b=a.asset;
a.thumbnailURL=b&&b.featured&&b.featured.url;a.displayText=this._truncate(a.displayText);return this.resultTemplate(a)}),a);b&&(b=dojo.create("li",{innerHTML:this.i18n_moreResults,className:"more-results"}),dojo.place(b,this.resultsContainer,"last"));dojo.publish("/content/update")}else this._handleNoResults();else this._handleEmptySearch()},_handleNoResults:function(){this.resultsContainer.innerHTML="<li>"+this.i18n_noResults+"</li>"},_handleEmptySearch:function(){this.resultsContainer.innerHTML=
"<li>"+this.i18n_instructions+"</li>"},initializeStrings:function(){this.i18n_instructions=this.getString("SEARCH_INSTRUCTIONS");this.i18n_noResults=this.getString("SEARCH_NO_RESULTS");this.i18n_moreResults=this.getString("SEARCH_MORE_RESULTS")},_truncate:function(a){return mulberry.util.truncate(a,200)}}));
dojo._hasResource["toura.components.VideoList"]||(dojo._hasResource["toura.components.VideoList"]=!0,dojo.provide("toura.components.VideoList"),dojo.declare("toura.components.VideoList",toura.components.AssetList,{"class":"video-list",postMixInProperties:function(){this.assets=this.node.videos||[];this.inherited(arguments)},adjustMarkup:function(){1>=this.assets.length&&this.hide()}}));
dojo._hasResource["toura.components.VideoPlayer"]||(dojo._hasResource["toura.components.VideoPlayer"]=!0,dojo.provide("toura.components.VideoPlayer"),dojo.declare("toura.components.VideoPlayer",toura.components._MediaPlayer,{templateString:dojo.cache("toura.components","VideoPlayer/VideoPlayer.haml",".component.video-player\n  .fake-video{ dojoAttachPoint : \"videoPlaceholder\", dojoType : 'mulberry.ui.BackgroundImage', imageUrl : media.poster }\n    .play-button{ dojoAttachPoint : 'playButton' }\n\n"),
widgetsInTemplate:!0,playerType:"video",playerSettings:{controls:!0},prepareData:function(){var a="";this.medias=this.node.videos||[];this.inherited(arguments);a=this.media.poster||"";this.useHtml5Player&&a&&(this.playerSettings=dojo.mixin(this.playerSettings,{poster:a}))},startup:function(){this.inherited(arguments);0===this.node.videos.length&&this.destroy();this.media.poster&&this.videoPlaceholder.loadImage()},setupConnections:function(){this.inherited(arguments);this.useHtml5Player?(this.subscribe("/MoreDrawer/show",
dojo.hitch(this,"disable")),this.subscribe("/MoreDrawer/hide",dojo.hitch(this,"enable"))):(this.connect(this.videoPlaceholder,"click","_play"),this.connect(this.playButton,"click","_play"))},_play:function(a){this.inherited(arguments);this.useHtml5Player||mulberry.app.PhoneGap.browser.url(this.media.url)},_setMediaIdAttr:function(a){this.inherited(arguments);this.set("poster",this.media.poster)},_setPosterAttr:function(a){this.useHtml5Player?this.player&&(this.player.poster=a||""):this.videoPlaceholder.set("imageUrl",
a)}}));
dojo._hasResource["toura.components._MediaCaption"]||(dojo._hasResource["toura.components._MediaCaption"]=!0,dojo.provide("toura.components._MediaCaption"),dojo.declare("toura.components._MediaCaption",toura.components.BodyText,{_fixCaptionAlignment:function(){var a=dojo.position(this.domNode).w,b;dojo.style(this.domNode,{"float":"left"});b=dojo.position(this.domNode).w;a>b?this.addClass("short-caption"):this.removeClass("short-caption");dojo.style(this.domNode,{"float":""})},resizeElements:function(){this.inherited(arguments);this._fixCaptionAlignment()},
setupSubscriptions:function(){this.subscribe("/content/update","_fixCaptionAlignment");this.subscribe("/window/resize","_fixCaptionAlignment")}}));
dojo._hasResource["toura.components.VideoCaption"]||(dojo._hasResource["toura.components.VideoCaption"]=!0,dojo.provide("toura.components.VideoCaption"),dojo.declare("toura.components.VideoCaption",toura.components._MediaCaption,{"class":"video-caption",_getBodyText:function(){return!this.node||!this.node.videos?"":this.node.videos[0]?this.node.videos[0].caption||"":""}}));
dojo._hasResource["toura.components.ImageCaption"]||(dojo._hasResource["toura.components.ImageCaption"]=!0,dojo.provide("toura.components.ImageCaption"),dojo.declare("toura.components.ImageCaption",toura.components._MediaCaption,{"class":"image-caption",_getBodyText:function(){return!this.node||!this.node.images?"":this.node.images[0]?this.node.images[0].caption||"":""}}));
dojo._hasResource["mulberry.ui.PinchZoom"]||(dojo._hasResource["mulberry.ui.PinchZoom"]=!0,dojo.provide("mulberry.ui.PinchZoom"),dojo.declare("mulberry.ui.PinchZoom",null,{zoomMax:3,_makeScroller:function(a){var b=this,c=dijit.byNode(a.firstChild);this.scroller&&this.scroller.destroy();this.scroller=new iScroll(a,{zoom:mulberry.app.Has.iScrollZoom(),onZoomEnd:function(){b.onZoomEnd(c,this)},zoomMin:0.33,zoomMax:this.zoomMax})},onZoomEnd:function(a,b){this.zoomTimeout||(this.zoomTimeout=setTimeout(dojo.hitch(this,
function(){var c=b.scale,d=dojo.style(a.domNode,"width"),e=dojo.style(a.domNode,"height"),f=d*c,c=e*c,g=b.x,i=b.y;a.imageWidth>a.imageHeight?f<mulberry.app.UI.viewport.width&&(f=mulberry.app.UI.viewport.width,c=f/ratio):c<mulberry.app.UI.viewport.height&&(c=mulberry.app.UI.viewport.height,f=c*ratio);f>mulberry.app.UI.viewport.width*this.zoomMax&&(f=d,c=e,g=i=0);dojo.style(a.domNode,"width",f+"px");dojo.style(a.domNode,"height",c+"px");b.zoom(g,i,1,0);clearTimeout(this.zoomTimeout);this.zoomTimeout=
null}),0))}}));
dojo._hasResource["toura.components.ZoomableImageGallery"]||(dojo._hasResource["toura.components.ZoomableImageGallery"]=!0,dojo.provide("toura.components.ZoomableImageGallery"),dojo.declare("toura.components.ZoomableImageGallery",[mulberry._Component,toura.components._ImageGallery,mulberry.ui.PinchZoom],{templateString:dojo.cache("toura.components","ZoomableImageGallery/ZoomableImageGallery.haml",".component.zoomable-image-gallery\n  .content\n    .image-nav.prev{ dojoAttachPoint : 'prevButton' }\n\n    %ol{ dojoAttachPoint : 'imageList' }\n      :each img in images\n        %li.image\n          .wrapper{ dojoType : 'mulberry.ui.BackgroundImage', imageUrl : img.url }\n\n    .image-nav.next{ dojoAttachPoint : 'nextButton' }\n\n    .caption{ dojoType : 'toura.components.ImageCaption', dojoAttachPoint : 'caption' }\n"),widgetsInTemplate:!0,
chromeVisible:!1,prepareData:function(){this.inherited(arguments);this.images=dojo.map(this.node.images||[],function(a){var b={tablet:"original",phone:"gallery"}[this.device.type];dojo.forEach(["url","height","width"],function(c){a[c]=a[b][c]});return a},this)},setupConnections:function(){this.clickNode=this.imageList;this.connect(this.nextButton,"click",this._go(1));this.connect(this.prevButton,"click",this._go(-1))},_go:function(a){return dojo.hitch(this,function(){this.set("currentImageIndex",
this.currentImageIndex+a)})},_setCurrentImageIndexAttr:function(a){this.inherited(arguments);var b=this.images[a];this.set("caption",b.caption||"");this._updateImages(a);this._updateButtons(a);this.onImageChange(b)},_handleClick:function(){this.set("chromeVisible",!this.chromeVisible)},_setChromeVisibleAttr:function(a){this[a?"removeClass":"addClass"]("chrome-hidden");this.chromeVisible=a;this[a?"onShowChrome":"onHideChrome"]()},onShowChrome:function(){},onHideChrome:function(){},onImageChange:function(){},
_updateImages:function(a){dojo.forEach(this.bgImgs,function(b,c){var d=b.domNode.parentNode,e=c===a;this[e?"show":"hide"](d);e&&this._makeScroller(d)},this)},_updateButtons:function(a){var b=a===this.images.length-1;this[0===a?"hide":"show"](this.prevButton);this[b?"hide":"show"](this.nextButton)},_setCaptionAttr:function(a){this.caption.set("content",a);this.caption[a?"show":"hide"]()}}));dojo._hasResource["toura.components._base"]||(dojo._hasResource["toura.components._base"]=!0,dojo.provide("toura.components._base"));
dojo._hasResource["toura.base"]||(dojo._hasResource["toura.base"]=!0,dojo.provide("toura.base"),toura.data=toura.data||{},mulberry.registerComponentNamespace(toura.components),mulberry.registerCapabilityNamespace(toura.capabilities),mulberry.components.Debug.registerFeaturesObject(toura.features));dojo._hasResource["client.routes"]||(dojo._hasResource["client.routes"]=!0,dojo.provide("client.routes"));dojo.i18n._preloadLocalizations("client.nls.base",["ROOT","en","en-us","xx"]);
