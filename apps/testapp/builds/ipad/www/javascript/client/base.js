/*******************************************************************************
 *
 *  Copyright (c)  2011 Toura, LLC.	All Rights Reserved.
 *  http://toura.com
 *
 *  LICENSE: https://github.com/Toura/mulberry/blob/master/LICENSE.txt
 *
 *******************************************************************************/
dojo.provide("client.base");if(!dojo._hasResource["toura.xhr"]){dojo._hasResource["toura.xhr"]=true;dojo.provide("toura.xhr");var _d=dojo,cfg=_d.config;function setValue(_1,_2,_3){if(_3===null){return;}var _4=_1[_2];if(typeof _4=="string"){_1[_2]=[_4,_3];}else{if(_d.isArray(_4)){_4.push(_3);}else{_1[_2]=_3;}}};dojo.fieldToObject=function(_5){var _6=null;var _7=_d.byId(_5);if(_7){var _8=_7.name;var _9=(_7.type||"").toLowerCase();if(_8&&_9&&!_7.disabled){if(_9=="radio"||_9=="checkbox"){if(_7.checked){_6=_7.value;}}else{if(_7.multiple){_6=[];_d.query("option",_7).forEach(function(_a){if(_a.selected){_6.push(_a.value);}});}else{_6=_7.value;}}}}return _6;};dojo.formToObject=function(_b){var _c={};var _d="file|submit|image|reset|button|";_d.forEach(dojo.byId(_b).elements,function(_e){var _f=_e.name;var _10=(_e.type||"").toLowerCase();if(_f&&_10&&_d.indexOf(_10)==-1&&!_e.disabled){setValue(_c,_f,_d.fieldToObject(_e));if(_10=="image"){_c[_f+".x"]=_c[_f+".y"]=_c[_f].x=_c[_f].y=0;}}});return _c;};dojo.objectToQuery=function(map){var enc=encodeURIComponent;var _11=[];var _12={};for(var _13 in map){var _14=map[_13];if(_14!=_12[_13]){var _15=enc(_13)+"=";if(_d.isArray(_14)){for(var i=0;i<_14.length;i++){_11.push(_15+enc(_14[i]));}}else{_11.push(_15+enc(_14));}}}return _11.join("&");};dojo.formToQuery=function(_16){return _d.objectToQuery(_d.formToObject(_16));};dojo.formToJson=function(_17,_18){return _d.toJson(_d.formToObject(_17),_18);};dojo.queryToObject=function(str){var ret={};var qp=str.split("&");var dec=decodeURIComponent;_d.forEach(qp,function(_19){if(_19.length){var _1a=_19.split("=");var _1b=dec(_1a.shift());var val=dec(_1a.join("="));if(typeof ret[_1b]=="string"){ret[_1b]=[ret[_1b]];}if(_d.isArray(ret[_1b])){ret[_1b].push(val);}else{ret[_1b]=val;}}});return ret;};dojo._blockAsync=false;var handlers=_d._contentHandlers=dojo.contentHandlers={text:function(xhr){return xhr.responseText;},json:function(xhr){return _d.fromJson(xhr.responseText||null);},"json-comment-filtered":function(xhr){if(!dojo.config.useCommentedJson){console.warn("Consider using the standard mimetype:application/json."+" json-commenting can introduce security issues. To"+" decrease the chances of hijacking, use the standard the 'json' handler and"+" prefix your json with: {}&&\n"+"Use djConfig.useCommentedJson=true to turn off this message.");}var _1c=xhr.responseText;var _1d=_1c.indexOf("/*");var _1e=_1c.lastIndexOf("*/");if(_1d==-1||_1e==-1){throw new Error("JSON was not comment filtered");}return _d.fromJson(_1c.substring(_1d+2,_1e));},javascript:function(xhr){return _d.eval(xhr.responseText);},xml:function(xhr){var _1f=xhr.responseXML;return _1f;},"json-comment-optional":function(xhr){if(xhr.responseText&&/^[^{\[]*\/\*/.test(xhr.responseText)){return handlers["json-comment-filtered"](xhr);}else{return handlers["json"](xhr);}}};dojo._ioSetArgs=function(_20,_21,_22,_23){var _24={args:_20,url:_20.url};var _25=null;if(_20.form){var _26=_d.byId(_20.form);var _27=_26.getAttributeNode("action");_24.url=_24.url||(_27?_27.value:null);_25=_d.formToObject(_26);}var _28=[{}];if(_25){_28.push(_25);}if(_20.content){_28.push(_20.content);}if(_20.preventCache){_28.push({"dojo.preventCache":new Date().valueOf()});}_24.query=_d.objectToQuery(_d.mixin.apply(null,_28));_24.handleAs=_20.handleAs||"text";var d=new _d.Deferred(_21);d.addCallbacks(_22,function(_29){return _23(_29,d);});var ld=_20.load;if(ld&&_d.isFunction(ld)){d.addCallback(function(_2a){return ld.call(_20,_2a,_24);});}var err=_20.error;if(err&&_d.isFunction(err)){d.addErrback(function(_2b){return err.call(_20,_2b,_24);});}var _2c=_20.handle;if(_2c&&_d.isFunction(_2c)){d.addBoth(function(_2d){return _2c.call(_20,_2d,_24);});}if(cfg.ioPublish&&_d.publish&&_24.args.ioPublish!==false){d.addCallbacks(function(res){_d.publish("/dojo/io/load",[d,res]);return res;},function(res){_d.publish("/dojo/io/error",[d,res]);return res;});d.addBoth(function(res){_d.publish("/dojo/io/done",[d,res]);return res;});}d.ioArgs=_24;return d;};var _deferredCancel=function(dfd){dfd.canceled=true;var xhr=dfd.ioArgs.xhr;var _2e=typeof xhr.abort;if(_2e=="function"||_2e=="object"||_2e=="unknown"){xhr.abort();}var err=dfd.ioArgs.error;if(!err){err=new Error("xhr cancelled");err.dojoType="cancel";}return err;};var _deferredOk=function(dfd){var ret=handlers[dfd.ioArgs.handleAs](dfd.ioArgs.xhr);return ret===undefined?null:ret;};var _deferError=function(_2f,dfd){if(!dfd.ioArgs.args.failOk){console.error(_2f);}return _2f;};var _inFlightIntvl=null;var _inFlight=[];var _pubCount=0;var _checkPubCount=function(dfd){if(_pubCount<=0){_pubCount=0;if(cfg.ioPublish&&_d.publish&&(!dfd||dfd&&dfd.ioArgs.args.ioPublish!==false)){_d.publish("/dojo/io/stop");}}};var _watchInFlight=function(){var now=(new Date()).getTime();if(!_d._blockAsync){for(var i=0,tif;i<_inFlight.length&&(tif=_inFlight[i]);i++){var dfd=tif.dfd;var _30=function(){if(!dfd||dfd.canceled||!tif.validCheck(dfd)){_inFlight.splice(i--,1);_pubCount-=1;}else{if(tif.ioCheck(dfd)){_inFlight.splice(i--,1);tif.resHandle(dfd);_pubCount-=1;}else{if(dfd.startTime){if(dfd.startTime+(dfd.ioArgs.args.timeout||0)<now){_inFlight.splice(i--,1);var err=new Error("timeout exceeded");err.dojoType="timeout";dfd.errback(err);dfd.cancel();_pubCount-=1;}}}}};if(dojo.config.debugAtAllCosts){_30.call(this);}else{try{_30.call(this);}catch(e){dfd.errback(e);}}}}_checkPubCount(dfd);if(!_inFlight.length){clearInterval(_inFlightIntvl);_inFlightIntvl=null;return;}};dojo._ioCancelAll=function(){try{_d.forEach(_inFlight,function(i){try{i.dfd.cancel();}catch(e){}});}catch(e){}};_d._ioNotifyStart=function(dfd){if(cfg.ioPublish&&_d.publish&&dfd.ioArgs.args.ioPublish!==false){if(!_pubCount){_d.publish("/dojo/io/start");}_pubCount+=1;_d.publish("/dojo/io/send",[dfd]);}};_d._ioWatch=function(dfd,_31,_32,_33){var _34=dfd.ioArgs.args;if(_34.timeout){dfd.startTime=(new Date()).getTime();}_inFlight.push({dfd:dfd,validCheck:_31,ioCheck:_32,resHandle:_33});if(!_inFlightIntvl){_inFlightIntvl=setInterval(_watchInFlight,50);}if(_34.sync){_watchInFlight();}};var _defaultContentType="application/x-www-form-urlencoded";var _validCheck=function(dfd){return dfd.ioArgs.xhr.readyState;};var _ioCheck=function(dfd){return 4==dfd.ioArgs.xhr.readyState;};var _resHandle=function(dfd){var xhr=dfd.ioArgs.xhr;if(_d._isDocumentOk(xhr)){dfd.callback(dfd);}else{var err=new Error("Unable to load "+dfd.ioArgs.url+" status:"+xhr.status);err.status=xhr.status;err.responseText=xhr.responseText;dfd.errback(err);}};dojo._ioAddQueryToUrl=function(_35){if(_35.query.length){_35.url+=(_35.url.indexOf("?")==-1?"?":"&")+_35.query;_35.query=null;}};dojo.xhr=function(_36,_37,_38){var dfd=_d._ioSetArgs(_37,_deferredCancel,_deferredOk,_deferError);var _39=dfd.ioArgs;var xhr=_39.xhr=_d._xhrObj(_39.args);if(!xhr){dfd.cancel();return dfd;}if("postData" in _37){_39.query=_37.postData;}else{if("putData" in _37){_39.query=_37.putData;}else{if("rawBody" in _37){_39.query=_37.rawBody;}else{if((arguments.length>2&&!_38)||"POST|PUT".indexOf(_36.toUpperCase())==-1){_d._ioAddQueryToUrl(_39);}}}}xhr.open(_36,_39.url,_37.sync!==true,_37.user||undefined,_37.password||undefined);if(_37.headers){for(var hdr in _37.headers){if(hdr.toLowerCase()==="content-type"&&!_37.contentType){_37.contentType=_37.headers[hdr];}else{if(_37.headers[hdr]){xhr.setRequestHeader(hdr,_37.headers[hdr]);}}}}if(_37.contentType!==false){xhr.setRequestHeader("Content-Type",_37.contentType||_defaultContentType);}if(!_37.headers||!("X-Requested-With" in _37.headers)){xhr.setRequestHeader("X-Requested-With","XMLHttpRequest");}_d._ioNotifyStart(dfd);if(dojo.config.debugAtAllCosts){xhr.send(_39.query);}else{try{xhr.send(_39.query);}catch(e){_39.error=e;dfd.cancel();}}_d._ioWatch(dfd,_validCheck,_ioCheck,_resHandle);xhr=null;return dfd;};dojo.xhrGet=function(_3a){return _d.xhr("GET",_3a);};dojo.rawXhrPost=dojo.xhrPost=function(_3b){return _d.xhr("POST",_3b,true);};dojo.rawXhrPut=dojo.xhrPut=function(_3c){return _d.xhr("PUT",_3c,true);};dojo.xhrDelete=function(_3d){return _d.xhr("DELETE",_3d);};}if(!dojo._hasResource["mulberry.app.Config"]){dojo._hasResource["mulberry.app.Config"]=true;dojo.provide("mulberry.app.Config");(function(d,_3e){var _3f={};mulberry.app.Config={get:function(key){return _3f[key];},set:function(key,val){_3f=_3f||{};_3f[key]=val;},registerConfig:function(_40){_3f=_40||{};}};if(mulberry._Config){mulberry.app.Config.registerConfig(mulberry._Config);}}(dojo));}if(!dojo._hasResource["mulberry.Device"]){dojo._hasResource["mulberry.Device"]=true;dojo.provide("mulberry.Device");mulberry._loadDeviceConfig=function(){function _41(){var _42=dojo.body(),_43=Math.min(_42.offsetWidth,_42.offsetHeight);return _43>640?"tablet":"phone";};mulberry.Device=mulberry.app.Config.get("device")||{type:_41(),os:"browser"};};mulberry._loadDeviceConfig();}if(!dojo._hasResource["mulberry._Nls"]){dojo._hasResource["mulberry._Nls"]=true;dojo.provide("mulberry._Nls");dojo.declare("mulberry._Nls",null,{data:{__initialized:false},constructor:function(){if(!this.data.__initialized){this.data.nlsStrings=dojo.i18n.getLocalization("mulberry","mulberry",mulberry.app.Config.get("locale"));this.data.__initialized=true;}},getString:function(key,_44){var str=this.data.nlsStrings[key];return (_44)?dojo.string.substitute(str,_44):str;},postMixInProperties:function(){this.inherited("postMixInProperties",arguments);this.initializeStrings();},initializeStrings:function(){}});}if(!dojo._hasResource["vendor.iscroll"]){dojo._hasResource["vendor.iscroll"]=true;dojo.provide("vendor.iscroll");(function(){function _45(el,_46){var _47=this,doc=document,div,i;_47.wrapper=typeof el=="object"?el:doc.getElementById(el);_47.wrapper.style.overflow="hidden";_47.scroller=_47.wrapper.children[0];_47.options={HWTransition:true,HWCompositing:true,hScroll:true,vScroll:true,hScrollbar:true,vScrollbar:true,fixedScrollbar:_48,fadeScrollbar:(_49&&_4a)||!_4b,hideScrollbar:_49||!_4b,scrollbarClass:"",bounce:_4a,bounceLock:false,momentum:_4a,lockDirection:true,zoom:false,zoomMin:1,zoomMax:4,snap:false,pullToRefresh:false,pullDownLabel:["Pull down to refresh...","Release to refresh...","Loading..."],pullUpLabel:["Pull up to refresh...","Release to refresh...","Loading..."],onPullDown:function(){},onPullUp:function(){},onScrollStart:null,onScrollEnd:null,onZoomStart:null,onZoomEnd:null,checkDOMChange:false};for(i in _46){_47.options[i]=_46[i];}_47.options.HWCompositing=_47.options.HWCompositing&&_b2;_47.options.HWTransition=_47.options.HWTransition&&_b2;if(_47.options.HWCompositing){_47.scroller.style.cssText+="-webkit-transition-property:-webkit-transform;-webkit-transform-origin:0 0;-webkit-transform:"+_53+"0,0"+_54;}else{_47.scroller.style.cssText+="-webkit-transition-property:top,left;-webkit-transform-origin:0 0;top:0;left:0";}if(_47.options.HWTransition){_47.scroller.style.cssText+="-webkit-transition-timing-function:cubic-bezier(0.33,0.66,0.66,1);-webkit-transition-duration:0;";}_47.options.hScrollbar=_47.options.hScroll&&_47.options.hScrollbar;_47.options.vScrollbar=_47.options.vScroll&&_47.options.vScrollbar;_47.pullDownToRefresh=_47.options.pullToRefresh=="down"||_47.options.pullToRefresh=="both";_47.pullUpToRefresh=_47.options.pullToRefresh=="up"||_47.options.pullToRefresh=="both";if(_47.pullDownToRefresh){div=doc.createElement("div");div.className="iScrollPullDown";div.innerHTML="<span class=\"iScrollPullDownIcon\"></span><span class=\"iScrollPullDownLabel\">"+_47.options.pullDownLabel[0]+"</span>\n";_47.scroller.insertBefore(div,_47.scroller.children[0]);_47.options.bounce=true;_47.pullDownEl=div;_47.pullDownLabel=div.getElementsByTagName("span")[1];}if(_47.pullUpToRefresh){div=doc.createElement("div");div.className="iScrollPullUp";div.innerHTML="<span class=\"iScrollPullUpIcon\"></span><span class=\"iScrollPullUpLabel\">"+_47.options.pullUpLabel[0]+"</span>\n";_47.scroller.appendChild(div);_47.options.bounce=true;_47.pullUpEl=div;_47.pullUpLabel=div.getElementsByTagName("span")[1];}_47.refresh();_47._bind(_51,window);_47._bind(_4d);if(_61&&_47.options.zoom){_47._bind("gesturestart");_47.scroller.style.webkitTransform=_47.scroller.style.webkitTransform+" scale(1)";}if(!_4b){_47._bind("mousewheel");}if(_47.options.checkDOMChange){_47.DOMChangeInterval=setInterval(function(){_47._checkSize();},250);}};_45.prototype={x:0,y:0,currPageX:0,currPageY:0,pagesX:[],pagesY:[],offsetBottom:0,offsetTop:0,scale:1,lastScale:1,contentReady:true,handleEvent:function(e){var _4c=this;switch(e.type){case _4d:_4c._start(e);break;case _4e:_4c._move(e);break;case _4f:case _50:_4c._end(e);break;case "webkitTransitionEnd":_4c._transitionEnd(e);break;case _51:_4c._resize();break;case "gesturestart":_4c._gestStart(e);break;case "gesturechange":_4c._gestChange(e);break;case "gestureend":case "gesturecancel":_4c._gestEnd(e);break;case "mousewheel":_4c._wheel(e);break;}},_scrollbar:function(dir){var _52=this,doc=document,bar;if(!_52[dir+"Scrollbar"]){if(_52[dir+"ScrollbarWrapper"]){_52[dir+"ScrollbarIndicator"].style.webkitTransform="";_52[dir+"ScrollbarWrapper"].parentNode.removeChild(_52[dir+"ScrollbarWrapper"]);_52[dir+"ScrollbarWrapper"]=null;_52[dir+"ScrollbarIndicator"]=null;}return;}if(!_52[dir+"ScrollbarWrapper"]){bar=doc.createElement("div");if(_52.options.scrollbarClass){bar.className=_52.options.scrollbarClass+dir.toUpperCase();}else{bar.style.cssText="position:absolute;z-index:100;"+(dir=="h"?"height:7px;bottom:1px;left:2px;right:7px":"width:7px;bottom:7px;top:2px;right:1px");}bar.style.cssText+="pointer-events:none;-webkit-transition-property:opacity;-webkit-transition-duration:"+(_52.options.fadeScrollbar?"350ms":"0")+";overflow:hidden;opacity:"+(_52.options.hideScrollbar?"0":"1");_52.wrapper.appendChild(bar);_52[dir+"ScrollbarWrapper"]=bar;bar=doc.createElement("div");if(!_52.options.scrollbarClass){bar.style.cssText="position:absolute;z-index:100;background:rgba(0,0,0,0.5);border:1px solid rgba(255,255,255,0.9);-webkit-background-clip:padding-box;-webkit-box-sizing:border-box;"+(dir=="h"?"height:100%;-webkit-border-radius:4px 3px;":"width:100%;-webkit-border-radius:3px 4px;");}bar.style.cssText+="pointer-events:none;-webkit-transition-property:-webkit-transform;-webkit-transition-timing-function:cubic-bezier(0.33,0.66,0.66,1);-webkit-transition-duration:0;-webkit-transform:"+_53+"0,0"+_54;_52[dir+"ScrollbarWrapper"].appendChild(bar);_52[dir+"ScrollbarIndicator"]=bar;}if(dir=="h"){_52.hScrollbarSize=_52.hScrollbarWrapper.clientWidth;_52.hScrollbarIndicatorSize=m.max(m.round(_52.hScrollbarSize*_52.hScrollbarSize/_52.scrollerW),8);_52.hScrollbarIndicator.style.width=_52.hScrollbarIndicatorSize+"px";_52.hScrollbarMaxScroll=_52.hScrollbarSize-_52.hScrollbarIndicatorSize;_52.hScrollbarProp=_52.hScrollbarMaxScroll/_52.maxScrollX;}else{_52.vScrollbarSize=_52.vScrollbarWrapper.clientHeight;_52.vScrollbarIndicatorSize=m.max(m.round(_52.vScrollbarSize*_52.vScrollbarSize/_52.scrollerH),8);_52.vScrollbarIndicator.style.height=_52.vScrollbarIndicatorSize+"px";_52.vScrollbarMaxScroll=_52.vScrollbarSize-_52.vScrollbarIndicatorSize;_52.vScrollbarProp=_52.vScrollbarMaxScroll/_52.maxScrollY;}_52._indicatorPos(dir,true);},_resize:function(){var _55=this;setTimeout(function(){_55.refresh();},0);},_checkSize:function(){var _56=this,_57,_58;if(_56.moved||_56.zoomed||!_56.contentReady){return;}_57=m.round(_56.scroller.offsetWidth*_56.scale),_58=m.round((_56.scroller.offsetHeight-_56.offsetBottom-_56.offsetTop)*_56.scale);if(_57==_56.scrollerW&&_58==_56.scrollerH){return;}_56.refresh();},_pos:function(x,y){var _59=this;_59.x=_59.hScroll?x:0;_59.y=_59.vScroll?y:0;_59.scroller.style.webkitTransform=_53+_59.x+"px,"+_59.y+"px"+_54+" scale("+_59.scale+")";_59._indicatorPos("h");_59._indicatorPos("v");},_indicatorPos:function(dir,_5a){var _5b=this,pos=dir=="h"?_5b.x:_5b.y;if(!_5b[dir+"Scrollbar"]){return;}pos=_5b[dir+"ScrollbarProp"]*pos;if(pos<0){pos=_5b.options.fixedScrollbar?0:pos+pos*3;if(_5b[dir+"ScrollbarIndicatorSize"]+pos<9){pos=-_5b[dir+"ScrollbarIndicatorSize"]+8;}}else{if(pos>_5b[dir+"ScrollbarMaxScroll"]){pos=_5b.options.fixedScrollbar?_5b[dir+"ScrollbarMaxScroll"]:pos+(pos-_5b[dir+"ScrollbarMaxScroll"])*3;if(_5b[dir+"ScrollbarIndicatorSize"]+_5b[dir+"ScrollbarMaxScroll"]-pos<9){pos=_5b[dir+"ScrollbarIndicatorSize"]+_5b[dir+"ScrollbarMaxScroll"]-8;}}}_5b[dir+"ScrollbarWrapper"].style.webkitTransitionDelay="0";_5b[dir+"ScrollbarWrapper"].style.opacity=_5a&&_5b.options.hideScrollbar?"0":"1";_5b[dir+"ScrollbarIndicator"].style.webkitTransform=_53+(dir=="h"?pos+"px,0":"0,"+pos+"px")+_54;},_transitionTime:function(_5c){var _5d=this;_5c+="ms";_5d.scroller.style.webkitTransitionDuration=_5c;if(_5d.hScrollbar){_5d.hScrollbarIndicator.style.webkitTransitionDuration=_5c;}if(_5d.vScrollbar){_5d.vScrollbarIndicator.style.webkitTransitionDuration=_5c;}},_start:function(e){var _5e=this,_5f=_4b?e.changedTouches[0]:e,_60;_5e.moved=false;e.preventDefault();if(_4b&&e.touches.length==2&&_5e.options.zoom&&_61&&!_5e.zoomed){_5e.originX=m.abs(e.touches[0].pageX+e.touches[1].pageX-_5e.wrapperOffsetLeft*2)/2-_5e.x;_5e.originY=m.abs(e.touches[0].pageY+e.touches[1].pageY-_5e.wrapperOffsetTop*2)/2-_5e.y;}_5e.moved=false;_5e.distX=0;_5e.distY=0;_5e.absDistX=0;_5e.absDistY=0;_5e.dirX=0;_5e.dirY=0;_5e.returnTime=0;_5e._transitionTime(0);if(_5e.options.momentum){if(_5e.scrollInterval){clearInterval(_5e.scrollInterval);_5e.scrollInterval=null;}if(_5e.options.HWCompositing){_60=new WebKitCSSMatrix(window.getComputedStyle(_5e.scroller,null).webkitTransform);if(_60.m41!=_5e.x||_60.m42!=_5e.y){_5e._unbind("webkitTransitionEnd");_5e._pos(_60.m41,_60.m42);}}else{_60=window.getComputedStyle(_5e.scroller,null);if(_5e.x+"px"!=_60.left||_5e.y+"px"!=_60.top){_5e._unbind("webkitTransitionEnd");_5e._pos(_60.left.replace(/[^0-9]/g)*1,_60.top.replace(/[^0-9]/g)*1);}}}_5e.scroller.style.webkitTransitionTimingFunction="cubic-bezier(0.33,0.66,0.66,1)";if(_5e.hScrollbar){_5e.hScrollbarIndicator.style.webkitTransitionTimingFunction="cubic-bezier(0.33,0.66,0.66,1)";}if(_5e.vScrollbar){_5e.vScrollbarIndicator.style.webkitTransitionTimingFunction="cubic-bezier(0.33,0.66,0.66,1)";}_5e.startX=_5e.x;_5e.startY=_5e.y;_5e.pointX=_5f.pageX;_5e.pointY=_5f.pageY;_5e.startTime=e.timeStamp;if(_5e.options.onScrollStart){_5e.options.onScrollStart.call(_5e);}_5e._bind(_4e);_5e._bind(_4f);_5e._bind(_50);},_move:function(e){if(_4b&&e.touches.length>1){return;}var _62=this,_63=_4b?e.changedTouches[0]:e,_64=_63.pageX-_62.pointX,_65=_63.pageY-_62.pointY,_66=_62.x+_64,_67=_62.y+_65;e.preventDefault();_62.pointX=_63.pageX;_62.pointY=_63.pageY;if(_66>0||_66<_62.maxScrollX){_66=_62.options.bounce?_62.x+(_64/2.4):_66>=0||_62.maxScrollX>=0?0:_62.maxScrollX;}if(_67>0||_67<_62.maxScrollY){_67=_62.options.bounce?_62.y+(_65/2.4):_67>=0||_62.maxScrollY>=0?0:_62.maxScrollY;if(_62.options.pullToRefresh&&_62.contentReady){if(_62.pullDownToRefresh&&_67>_62.offsetBottom){_62.pullDownEl.className="iScrollPullDown flip";_62.pullDownLabel.innerText=_62.options.pullDownLabel[1];}else{if(_62.pullDownToRefresh&&_62.pullDownEl.className.match("flip")){_62.pullDownEl.className="iScrollPullDown";_62.pullDownLabel.innerText=_62.options.pullDownLabel[0];}}if(_62.pullUpToRefresh&&_67<_62.maxScrollY-_62.offsetTop){_62.pullUpEl.className="iScrollPullUp flip";_62.pullUpLabel.innerText=_62.options.pullUpLabel[1];}else{if(_62.pullUpToRefresh&&_62.pullUpEl.className.match("flip")){_62.pullUpEl.className="iScrollPullUp";_62.pullUpLabel.innerText=_62.options.pullUpLabel[0];}}}}if(_62.absDistX<4&&_62.absDistY<4){_62.distX+=_64;_62.distY+=_65;_62.absDistX=m.abs(_62.distX);_62.absDistY=m.abs(_62.distY);return;}if(_62.options.lockDirection){if(_62.absDistX>_62.absDistY+3){_67=_62.y;_65=0;}else{if(_62.absDistY>_62.absDistX+3){_66=_62.x;_64=0;}}}_62.moved=true;_62._pos(_66,_67);_62.dirX=_64>0?-1:_64<0?1:0;_62.dirY=_65>0?-1:_65<0?1:0;if(e.timeStamp-_62.startTime>300){_62.startTime=e.timeStamp;_62.startX=_62.x;_62.startY=_62.y;}},_end:function(e){if(_4b&&e.touches.length!=0){return;}var _68=this,_69=_4b?e.changedTouches[0]:e,_6a,ev,_6b={dist:0,time:0},_6c={dist:0,time:0},_6d=e.timeStamp-_68.startTime,_6e=_68.x,_6f=_68.y,_70,_71;_68._unbind(_4e);_68._unbind(_4f);_68._unbind(_50);if(_68.zoomed){return;}if(!_68.moved){if(_4b){if(_68.doubleTapTimer&&_68.options.zoom){clearTimeout(_68.doubleTapTimer);_68.doubleTapTimer=null;_68.zoom(_68.pointX,_68.pointY,_68.scale==1?2:1);}else{_68.doubleTapTimer=setTimeout(function(){_68.doubleTapTimer=null;_6a=_69.target;while(_6a.nodeType!=1){_6a=_6a.parentNode;}ev=document.createEvent("MouseEvents");ev.initMouseEvent("click",true,true,e.view,1,_69.screenX,_69.screenY,_69.clientX,_69.clientY,e.ctrlKey,e.altKey,e.shiftKey,e.metaKey,0,null);ev._fake=true;_6a.dispatchEvent(ev);},_68.options.zoom?250:0);}}_68._resetPos();return;}if(_68.pullDownToRefresh&&_68.contentReady&&_68.pullDownEl.className.match("flip")){_68.pullDownEl.className="iScrollPullDown loading";_68.pullDownLabel.innerText=_68.options.pullDownLabel[2];_68.scroller.style.marginTop="0";_68.offsetBottom=0;_68.refresh();_68.contentReady=false;_68.options.onPullDown();}if(_68.pullUpToRefresh&&_68.contentReady&&_68.pullUpEl.className.match("flip")){_68.pullUpEl.className="iScrollPullUp loading";_68.pullUpLabel.innerText=_68.options.pullUpLabel[2];_68.scroller.style.marginBottom="0";_68.offsetTop=0;_68.refresh();_68.contentReady=false;_68.options.onPullUp();}if(_6d<300&&_68.options.momentum){_6b=_6e?_68._momentum(_6e-_68.startX,_6d,-_68.x,_68.scrollerW-_68.wrapperW+_68.x,_68.options.bounce?_68.wrapperW:0):_6b;_6c=_6f?_68._momentum(_6f-_68.startY,_6d,-_68.y,(_68.maxScrollY<0?_68.scrollerH-_68.wrapperH+_68.y:0),_68.options.bounce?_68.wrapperH:0):_6c;_6e=_68.x+_6b.dist;_6f=_68.y+_6c.dist;if((_68.x>0&&_6e>0)||(_68.x<_68.maxScrollX&&_6e<_68.maxScrollX)){_6b={dist:0,time:0};}if((_68.y>0&&_6f>0)||(_68.y<_68.maxScrollY&&_6f<_68.maxScrollY)){_6c={dist:0,time:0};}}if(_6b.dist||_6c.dist){_70=m.max(m.max(_6b.time,_6c.time),10);if(_68.options.snap){_71=_68._snap(_6e,_6f);_6e=_71.x;_6f=_71.y;_70=m.max(_71.time,_70);}_68.scrollTo(_6e,_6f,_70);return;}if(_68.options.snap){_71=_68._snap(_68.x,_68.y);if(_71.x!=_68.x||_71.y!=_68.y){_68.scrollTo(_71.x,_71.y,_71.time);}return;}_68._resetPos();},_resetPos:function(_72){var _73=this,_74=_73.x,_75=_73.y;if(_73.x>=0){_74=0;}else{if(_73.x<_73.maxScrollX){_74=_73.maxScrollX;}}if(_73.y>=0||_73.maxScrollY>0){_75=0;}else{if(_73.y<_73.maxScrollY){_75=_73.maxScrollY;}}if(_74==_73.x&&_75==_73.y){if(_73.moved){if(_73.options.onScrollEnd){_73.options.onScrollEnd.call(_73);}_73.moved=false;}if(_73.zoomed){if(_73.options.onZoomEnd){_73.options.onZoomEnd.call(_73);}_73.zoomed=false;}if(_73.hScrollbar&&_73.options.hideScrollbar){_73.hScrollbarWrapper.style.webkitTransitionDelay="300ms";_73.hScrollbarWrapper.style.opacity="0";}if(_73.vScrollbar&&_73.options.hideScrollbar){_73.vScrollbarWrapper.style.webkitTransitionDelay="300ms";_73.vScrollbarWrapper.style.opacity="0";}return;}if(_72===undefined){_72=200;}if(_72){_73.scroller.style.webkitTransitionTimingFunction="cubic-bezier(0.33,0.0,0.33,1)";if(_73.hScrollbar){_73.hScrollbarIndicator.style.webkitTransitionTimingFunction="cubic-bezier(0.33,0.0,0.33,1)";}if(_73.vScrollbar){_73.vScrollbarIndicator.style.webkitTransitionTimingFunction="cubic-bezier(0.33,0.0,0.33,1)";}}_73.scrollTo(_74,_75,_72);},_timedScroll:function(_76,_77,_78){var _79=this,_7a=_79.x,_7b=_79.y,_7c=(new Date).getTime(),_7d;_79._transitionTime(0);if(_79.scrollInterval){clearInterval(_79.scrollInterval);_79.scrollInterval=null;}_79.scrollInterval=setInterval(function(){var now=(new Date).getTime(),_7e,_7f;if(now>=_7c+_78){clearInterval(_79.scrollInterval);_79.scrollInterval=null;_79._pos(_76,_77);_79._transitionEnd();return;}now=(now-_7c)/_78-1;_7d=m.sqrt(1-now*now);_7e=(_76-_7a)*_7d+_7a;_7f=(_77-_7b)*_7d+_7b;_79._pos(_7e,_7f);},20);},_transitionEnd:function(e){var _80=this;if(e){e.stopPropagation();}_80._unbind("webkitTransitionEnd");_80._resetPos(_80.returnTime);_80.returnTime=0;},_gestStart:function(e){var _81=this;_81._transitionTime(0);_81.lastScale=1;if(_81.options.onZoomStart){_81.options.onZoomStart.call(_81);}_81._unbind("gesturestart");_81._bind("gesturechange");_81._bind("gestureend");_81._bind("gesturecancel");},_gestChange:function(e){var _82=this,_83=_82.scale*e.scale,x,y,_84;_82.zoomed=true;if(_83<_82.options.zoomMin){_83=_82.options.zoomMin;}else{if(_83>_82.options.zoomMax){_83=_82.options.zoomMax;}}_84=_83/_82.scale;x=_82.originX-_82.originX*_84+_82.x;y=_82.originY-_82.originY*_84+_82.y;_82.scroller.style.webkitTransform=_53+x+"px,"+y+"px"+_54+" scale("+_83+")";_82.lastScale=_84;},_gestEnd:function(e){var _85=this,_86=_85.scale,_87=_85.lastScale;_85.scale=_86*_87;if(_85.scale<_85.options.zoomMin+0.05){_85.scale=_85.options.zoomMin;}else{if(_85.scale>_85.options.zoomMax-0.05){_85.scale=_85.options.zoomMax;}}_87=_85.scale/_86;_85.x=_85.originX-_85.originX*_87+_85.x;_85.y=_85.originY-_85.originY*_87+_85.y;_85.scroller.style.webkitTransform=_53+_85.x+"px,"+_85.y+"px"+_54+" scale("+_85.scale+")";setTimeout(function(){_85.refresh();},0);_85._bind("gesturestart");_85._unbind("gesturechange");_85._unbind("gestureend");_85._unbind("gesturecancel");},_wheel:function(e){var _88=this,_89=_88.x+e.wheelDeltaX/12,_8a=_88.y+e.wheelDeltaY/12;if(_89>0){_89=0;}else{if(_89<_88.maxScrollX){_89=_88.maxScrollX;}}if(_8a>0){_8a=0;}else{if(_8a<_88.maxScrollY){_8a=_88.maxScrollY;}}_88.scrollTo(_89,_8a,0);},_momentum:function(_8b,_8c,_8d,_8e,_8f){var _90=this,_91=0.0006,_92=m.abs(_8b)/_8c,_93=(_92*_92)/(2*_91),_94=0,_95=0;if(_8b>0&&_93>_8d){_95=_8f/(6/(_93/_92*_91));_8d=_8d+_95;_90.returnTime=800/_8f*_95+100;_92=_92*_8d/_93;_93=_8d;}else{if(_8b<0&&_93>_8e){_95=_8f/(6/(_93/_92*_91));_8e=_8e+_95;_90.returnTime=800/_8f*_95+100;_92=_92*_8e/_93;_93=_8e;}}_93=_93*(_8b<0?-1:1);_94=_92/_91;return {dist:_93,time:m.round(_94)};},_offset:function(el,_96){var _97=-el.offsetLeft,top=-el.offsetTop;if(!_96){return {x:_97,y:top};}while(el=el.offsetParent){_97-=el.offsetLeft;top-=el.offsetTop;}return {x:_97,y:top};},_snap:function(x,y){var _98=this,i,l,_99,_9a,_9b,_9c;_99=_98.pagesX.length-1;for(i=0,l=_98.pagesX.length;i<l;i++){if(x>=_98.pagesX[i]){_99=i;break;}}if(_99==_98.currPageX&&_99>0&&_98.dirX<0){_99--;}x=_98.pagesX[_99];_9b=m.abs(x-_98.pagesX[_98.currPageX]);_9b=_9b?m.abs(_98.x-x)/_9b*500:0;_98.currPageX=_99;_99=_98.pagesY.length-1;for(i=0;i<_99;i++){if(y>=_98.pagesY[i]){_99=i;break;}}if(_99==_98.currPageY&&_99>0&&_98.dirY<0){_99--;}y=_98.pagesY[_99];_9c=m.abs(y-_98.pagesY[_98.currPageY]);_9c=_9c?m.abs(_98.y-y)/_9c*500:0;_98.currPageY=_99;_9a=m.round(m.max(_9b,_9c))||200;return {x:x,y:y,time:_9a};},_bind:function(_9d,el){(el||this.scroller).addEventListener(_9d,this,false);},_unbind:function(_9e,el){(el||this.scroller).removeEventListener(_9e,this,false);},destroy:function(){var _9f=this;if(_9f.options.checkDOMChange){clearTimeout(_9f.DOMChangeInterval);}if(_9f.pullDownToRefresh){_9f.pullDownEl.parentNode.removeChild(_9f.pullDownEl);}if(_9f.pullUpToRefresh){_9f.pullUpEl.parentNode.removeChild(_9f.pullUpEl);}_9f.hScrollbar=false;_9f.vScrollbar=false;_9f._scrollbar("h");_9f._scrollbar("v");_9f.scroller.style.webkitTransform="";_9f._unbind("webkitTransitionEnd");_9f._unbind(_51);_9f._unbind(_4d);_9f._unbind(_4e);_9f._unbind(_4f);_9f._unbind(_50);if(_9f.options.zoom){_9f._unbind("gesturestart");_9f._unbind("gesturechange");_9f._unbind("gestureend");_9f._unbind("gesturecancel");}},refresh:function(){var _a0=this,pos=0,_a1=0,i,l,els,_a2,_a3,_a4;if(_a0.pullDownToRefresh){_a4=_a0.pullDownEl.className.match("loading");if(_a4&&!_a0.contentReady){_a2=_a0.scrollerH;_a0.contentReady=true;_a0.pullDownEl.className="iScrollPullDown";_a0.pullDownLabel.innerText=_a0.options.pullDownLabel[0];_a0.offsetBottom=_a0.pullDownEl.offsetHeight;_a0.scroller.style.marginTop=-_a0.offsetBottom+"px";}else{if(!_a4){_a0.offsetBottom=_a0.pullDownEl.offsetHeight;_a0.scroller.style.marginTop=-_a0.offsetBottom+"px";}}}if(_a0.pullUpToRefresh){_a4=_a0.pullUpEl.className.match("loading");if(_a4&&!_a0.contentReady){_a2=_a0.scrollerH;_a0.contentReady=true;_a0.pullUpEl.className="iScrollPullUp";_a0.pullUpLabel.innerText=_a0.options.pullUpLabel[0];_a0.offsetTop=_a0.pullUpEl.offsetHeight;_a0.scroller.style.marginBottom=-_a0.offsetTop+"px";}else{if(!_a4){_a0.offsetTop=_a0.pullUpEl.offsetHeight;_a0.scroller.style.marginBottom=-_a0.offsetTop+"px";}}}_a0.wrapperW=_a0.wrapper.clientWidth;_a0.wrapperH=_a0.wrapper.clientHeight;if(!_a0.wrapperW||!_a0.wrapperH){return false;}_a0.scrollerW=m.round(_a0.scroller.offsetWidth*_a0.scale);_a0.scrollerH=m.round((_a0.scroller.offsetHeight-_a0.offsetBottom-_a0.offsetTop)*_a0.scale);_a0.maxScrollX=_a0.wrapperW-_a0.scrollerW;_a0.maxScrollY=_a0.wrapperH-_a0.scrollerH;_a0.dirX=0;_a0.dirY=0;_a0._transitionTime(0);_a0.hScroll=_a0.options.hScroll&&_a0.maxScrollX<0;_a0.vScroll=_a0.options.vScroll&&(!_a0.options.bounceLock&&!_a0.hScroll||_a0.scrollerH>_a0.wrapperH);_a0.hScrollbar=_a0.hScroll&&_a0.options.hScrollbar;_a0.vScrollbar=_a0.vScroll&&_a0.options.vScrollbar&&_a0.scrollerH>_a0.wrapperH;_a0._scrollbar("h");_a0._scrollbar("v");if(typeof _a0.options.snap=="string"){_a0.pagesX=[];_a0.pagesY=[];els=_a0.scroller.querySelectorAll(_a0.options.snap);for(i=0,l=els.length;i<l;i++){pos=_a0._offset(els[i]);_a0.pagesX[i]=pos.x<_a0.maxScrollX?_a0.maxScrollX:pos.x*_a0.scale;_a0.pagesY[i]=pos.y<_a0.maxScrollY?_a0.maxScrollY:pos.y*_a0.scale;}}else{if(_a0.options.snap){_a0.pagesX=[];while(pos>=_a0.maxScrollX){_a0.pagesX[_a1]=pos;pos=pos-_a0.wrapperW;_a1++;}if(_a0.maxScrollX%_a0.wrapperW){_a0.pagesX[_a0.pagesX.length]=_a0.maxScrollX-_a0.pagesX[_a0.pagesX.length-1]+_a0.pagesX[_a0.pagesX.length-1];}pos=0;_a1=0;_a0.pagesY=[];while(pos>=_a0.maxScrollY){_a0.pagesY[_a1]=pos;pos=pos-_a0.wrapperH;_a1++;}if(_a0.maxScrollY%_a0.wrapperH){_a0.pagesY[_a0.pagesY.length]=_a0.maxScrollY-_a0.pagesY[_a0.pagesY.length-1]+_a0.pagesY[_a0.pagesY.length-1];}}}if(_a0.options.zoom){_a3=_a0._offset(_a0.wrapper,true);_a0.wrapperOffsetLeft=-_a3.x;_a0.wrapperOffsetTop=-_a3.y;}if(_a2&&_a0.y==0){_a2=_a2-_a0.scrollerH+_a0.y;_a0.scrollTo(0,_a2,0);}_a0._resetPos();},scrollTo:function(x,y,_a5,_a6){var _a7=this;if(_a6){x=_a7.x-x;y=_a7.y-y;}_a5=!_a5||(m.round(_a7.x)==m.round(x)&&m.round(_a7.y)==m.round(y))?0:_a5;_a7.moved=true;if(!_a7.options.HWTransition){_a7._timedScroll(x,y,_a5);return;}if(_a5){_a7._bind("webkitTransitionEnd");}_a7._transitionTime(_a5);_a7._pos(x,y);if(!_a5){setTimeout(function(){_a7._transitionEnd();},0);}},scrollToElement:function(el,_a8){var _a9=this,pos;el=el.nodeType?el:_a9.scroller.querySelector(el);if(!el){return;}pos=_a9._offset(el);pos.x=pos.x>0?0:pos.x<_a9.maxScrollX?_a9.maxScrollX:pos.x;pos.y=pos.y>0?0:pos.y<_a9.maxScrollY?_a9.maxScrollY:pos.y;_a8=_a8===undefined?m.max(m.abs(pos.x)*2,m.abs(pos.y)*2):_a8;_a9.scrollTo(pos.x,pos.y,_a8);},scrollToPage:function(_aa,_ab,_ac){var _ad=this,x,y;if(_ad.options.snap){_aa=_aa=="next"?_ad.currPageX+1:_aa=="prev"?_ad.currPageX-1:_aa;_ab=_ab=="next"?_ad.currPageY+1:_ab=="prev"?_ad.currPageY-1:_ab;_aa=_aa<0?0:_aa>_ad.pagesX.length-1?_ad.pagesX.length-1:_aa;_ab=_ab<0?0:_ab>_ad.pagesY.length-1?_ad.pagesY.length-1:_ab;_ad.currPageX=_aa;_ad.currPageY=_ab;x=_ad.pagesX[_aa];y=_ad.pagesY[_ab];}else{x=-_ad.wrapperW*_aa;y=-_ad.wrapperH*_ab;if(x<_ad.maxScrollX){x=_ad.maxScrollX;}if(y<_ad.maxScrollY){y=_ad.maxScrollY;}}_ad.scrollTo(x,y,_ac||400);},zoom:function(x,y,_ae,_af){var _b0=this,_b1=_ae/_b0.scale;x=x-_b0.wrapperOffsetLeft-_b0.x;y=y-_b0.wrapperOffsetTop-_b0.y;_b0.x=x-x*_b1+_b0.x;_b0.y=y-y*_b1+_b0.y;_b0.scale=_ae;if(_b0.options.onZoomStart){_b0.options.onZoomStart.call(_b0);}_b0.refresh();_b0._bind("webkitTransitionEnd");_b0._transitionTime(_af!==null?_af:200);setTimeout(function(){_b0.zoomed=true;_b0.scroller.style.webkitTransform=_53+_b0.x+"px,"+_b0.y+"px"+_54+" scale("+_ae+")";},0);}};var _4a="WebKitCSSMatrix" in window&&"m11" in new WebKitCSSMatrix(),_4b="ontouchstart" in window,_61="ongesturestart" in window,_b2="WebKitTransitionEvent" in window,_49=(/iphone|ipad/gi).test(navigator.appVersion),_48=(/android/gi).test(navigator.appVersion),_51="onorientationchange" in window?"orientationchange":"resize",_4d=_4b?"touchstart":"mousedown",_4e=_4b?"touchmove":"mousemove",_4f=_4b?"touchend":"mouseup",_50=_4b?"touchcancel":"mouseup",_53="translate"+(_4a?"3d(":"("),_54=_4a?",0)":")",m=Math;if(typeof exports!=="undefined"){exports.iScroll=_45;}else{window.iScroll=_45;}})();}if(!dojo._hasResource["mulberry.ui.Scrollable"]){dojo._hasResource["mulberry.ui.Scrollable"]=true;dojo.provide("mulberry.ui.Scrollable");dojo.declare("mulberry.ui.Scrollable",dijit._Widget,{postCreate:function(){this.inherited(arguments);this.subscribe("/page/transition/end","_makeScroller");this.subscribe("/window/resize","refreshScroller");this.subscribe("/fontsize","refreshScroller");this.subscribe("/content/update",function(){this.refreshScroller();if(this.scroller){this.scroller.scrollTo(0,0);}});dojo.addClass(this.domNode,"scrollable");},_makeScroller:function(){if(this.domNode.children.length>1){console.error("mulberry.ui.Scrollable::_makeScroller: More than one child element. Only the first one will be scrollable. Probably not what you want!");}this.scroller=new iScroll(this.domNode,{vScrollbar:false,onScrollStart:dojo.hitch(this,"onScrollStart"),onScrollEnd:dojo.hitch(this,"onScrollEnd")});this.scroller.refresh();},makeScroller:function(){if(!this.scroller){this._makeScroller();}},destroy:function(){if(this.scroller){this.scroller.destroy();}this.inherited(arguments);},refreshScroller:function(){if(this.scroller){this.scroller.refresh();}},onScrollStart:function(){},onScrollEnd:function(){}});}if(!dojo._hasResource["mulberry.ui.Clickable"]){dojo._hasResource["mulberry.ui.Clickable"]=true;dojo.provide("mulberry.ui.Clickable");dojo.declare("mulberry.ui.Clickable",null,{constructor:function(el,_b3){this.connections=[];this.secondaryConnections=[];this.subscriptions=[];this.handler=_b3;this.el=el;this.moved=false;dojo.addClass(this.el,"not-moving");if(mulberry.app.UI.hasTouch){this.connections.push(dojo.connect(el,"touchstart",this,"_onTouchStart"));this.connections.push(dojo.connect(el,"click",function(e){e.preventDefault();}));}else{this.connections.push(dojo.connect(el,"click",this,"_handle"));}},_onTouchStart:function(){this.touchStartTime=new Date().getTime();this.secondaryConnections=[dojo.connect(this.el,"touchmove",this,"_onTouchMove"),dojo.connect(this.el,"touchend",this,"_handle")];},_onTouchMove:function(){dojo.removeClass(this.el,"not-moving");this.moved=true;},_handle:function(e){this.touchEndTime=new Date().getTime();dojo.addClass(this.el,"not-moving");dojo.forEach(this.secondaryConnections||[],dojo.disconnect);this.secondaryConnections=[];if(mulberry.animating){e.preventDefault();console.log("click ignored during animation");return;}var _b4=e.target,_b5=dojo.attr(_b4,"href");if(this.touchStartTime&&(this.touchEndTime-this.touchStartTime>mulberry.app.UI.touchMoveDebounce)&&this.moved){this.moved=false;return;}while(!_b5&&_b4!==this.el){_b5=dojo.attr(_b4,"href");if(!_b5){_b4=_b4.parentNode;}}if(!_b5){return;}if(this.handler&&dojo.isFunction(this.handler)&&this.handler(_b4,e)===false){return;}if(!/#/.test(_b5)){return;}_b5=_b5.split("#")[1];if(_b5){e.preventDefault();e.stopPropagation();mulberry.app.Router.go(_b5);}},destroy:function(){dojo.forEach(this.connections||[],dojo.disconnect);dojo.forEach(this.secondaryConnections||[],dojo.disconnect);dojo.forEach(this.subscriptions||[],dojo.unsubscribe);}});}if(!dojo._hasResource["vendor.mustache"]){dojo._hasResource["vendor.mustache"]=true;dojo.provide("vendor.mustache");var Mustache=(typeof module!=="undefined"&&module.exports)||{};(function(_b6){_b6.name="mustache.js";_b6.version="0.5.0-dev";_b6.tags=["{{","}}"];_b6.parse=_b7;_b6.compile=_b8;_b6.render=_b9;_b6.clearCache=_ba;_b6.to_html=_b9;var _bb=Object.prototype.toString;var _bc=Array.isArray;var _bd=Array.prototype.forEach;var _be=String.prototype.trim;var _bf;if(_bc){_bf=_bc;}else{_bf=function(obj){return _bb.call(obj)==="[object Array]";};}var _c0;if(_bd){_c0=function(obj,_c1,_c2){return _bd.call(obj,_c1,_c2);};}else{_c0=function(obj,_c3,_c4){for(var i=0,len=obj.length;i<len;++i){_c3.call(_c4,obj[i],i,obj);}};}var _c5=/^\s*$/;function _c6(_c7){return _c5.test(_c7);};var _c8;if(_be){_c8=function(_c9){return _c9==null?"":_be.call(_c9);};}else{var _ca,_cb;if(_c6(" ")){_ca=/^\s+/;_cb=/\s+$/;}else{_ca=/^[\s\xA0]+/;_cb=/[\s\xA0]+$/;}_c8=function(_cc){return _cc==null?"":String(_cc).replace(_ca,"").replace(_cb,"");};}var _cd={"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"};function _ce(_cf){return String(_cf).replace(/&(?!\w+;)|[<>"']/g,function(s){return _cd[s]||s;});};function _d0(e,_d1,_d2,_d3){_d3=_d3||"<template>";var _d4=_d1.split("\n"),_d5=Math.max(_d2-3,0),end=Math.min(_d4.length,_d2+3),_d6=_d4.slice(_d5,end);var c;for(var i=0,len=_d6.length;i<len;++i){c=i+_d5+1;_d6[i]=(c===_d2?" >> ":"    ")+_d6[i];}e.template=_d1;e.line=_d2;e.file=_d3;e.message=[_d3+":"+_d2,_d6.join("\n"),"",e.message].join("\n");return e;};function _d7(_d8,_d9,_da){if(_d8==="."){return _d9[_d9.length-1];}var _db=_d8.split(".");var _dc=_db.length-1;var _dd=_db[_dc];var _de,_df,i=_d9.length,j,_e0;while(i){_e0=_d9.slice(0);_df=_d9[--i];j=0;while(j<_dc){_df=_df[_db[j++]];if(_df==null){break;}_e0.push(_df);}if(_df&&_dd in _df){_de=_df[_dd];break;}}if(typeof _de==="function"){_de=_de.call(_e0[_e0.length-1]);}if(_de==null&&!_da){return "";}return _de;};function _e1(_e2,_e3,_e4,_e5,_e6){var _e7=_d7(_e3,_e5,true);if(_e6){if(_e7==null||_e7===false||(_bf(_e7)&&_e7.length===0)){_e2(_e4());}}else{if(_bf(_e7)){_c0(_e7,function(_e8){_e5.push(_e8);_e2(_e4());_e5.pop();});}else{if(typeof _e7==="object"){_e5.push(_e7);_e2(_e4());_e5.pop();}else{if(typeof _e7==="function"){var _e9=_e5[_e5.length-1];var _ea=function(_eb){return _b9(_eb,_e9);};_e2(_e7.call(_e9,_e4(),_ea)||"");}else{if(_e7){_e2(_e4());}}}}}};function _b7(_ec,_ed){_ed=_ed||{};var _ee=_ed.tags||_b6.tags,_ef=_ee[0],_f0=_ee[_ee.length-1];var _f1=["var line = 1;","\ntry {","\nsend(\""];var _f2=[],_f3=false,_f4=false;var _f5=function(){if(_f3&&!_f4&&!_ed.space){while(_f2.length){_f1.splice(_f2.pop(),1);}}else{_f2=[];}_f3=false;_f4=false;};var _f6=[],_f7,_f8,_f9;var _fa=function(_fb){_ee=_c8(_fb).split(/\s+/);_f8=_ee[0];_f9=_ee[_ee.length-1];};var _fc=function(_fd){_f1.push("\");",_f7,"\nvar partial = partials[\""+_c8(_fd)+"\"];","\nif (partial) {","\n  send(render(partial, stack[stack.length - 1], partials));","\n}","\nsend(\"");};var _fe=function(_ff,_100){var name=_c8(_ff);if(name===""){throw _d0(new Error("Section name may not be empty"),_ec,line,_ed.file);}_f6.push({name:name,inverted:_100});_f1.push("\");",_f7,"\nvar name = \""+name+"\";","\nvar callback = (function () {","\n  var buffer, send = function (chunk) { buffer.push(chunk); };","\n  return function () {","\n    buffer = [];","\nsend(\"");};var _101=function(_102){_fe(_102,true);};var _103=function(_104){var name=_c8(_104);var _105=_f6.length!=0&&_f6[_f6.length-1].name;if(!_105||name!=_105){throw _d0(new Error("Section named \""+name+"\" was never opened"),_ec,line,file);}var _106=_f6.pop();_f1.push("\");","\n    return buffer.join(\"\");","\n  };","\n})();");if(_106.inverted){_f1.push("\nsendSection(send,name,callback,stack,true);");}else{_f1.push("\nsendSection(send,name,callback,stack);");}_f1.push("\nsend(\"");};var _107=function(_108){_f1.push("\");",_f7,"\nsend(findName(\""+_c8(_108)+"\", stack));","\nsend(\"");};var _109=function(_10a){_f1.push("\");",_f7,"\nsend(escapeHTML(findName(\""+_c8(_10a)+"\", stack)));","\nsend(\"");};var line=1,c,_10b;for(var i=0,len=_ec.length;i<len;++i){if(_ec.slice(i,i+_ef.length)===_ef){i+=_ef.length;c=_ec.substr(i,1);_f7="\nline = "+line+";";_f8=_ef;_f9=_f0;_f3=true;switch(c){case "!":i++;_10b=null;break;case "=":i++;_f0="="+_f0;_10b=_fa;break;case ">":i++;_10b=_fc;break;case "#":i++;_10b=_fe;break;case "^":i++;_10b=_101;break;case "/":i++;_10b=_103;break;case "{":_f0="}"+_f0;case "&":i++;_f4=true;_10b=_107;break;default:_f4=true;_10b=_109;}var end=_ec.indexOf(_f0,i);if(end===-1){throw _d0(new Error("Tag \""+_ef+"\" was not closed properly"),_ec,line,_ed.file);}var _10c=_ec.substring(i,end);if(_10b){_10b(_10c);}var n=0;while(~(n=_10c.indexOf("\n",n))){line++;n++;}i=end+_f0.length-1;_ef=_f8;_f0=_f9;}else{c=_ec.substr(i,1);switch(c){case "\"":case "\\":_f4=true;_f1.push("\\"+c);break;case "\n":_f2.push(_f1.length);_f1.push("\\n");_f5();line++;break;default:if(_c6(c)){_f2.push(_f1.length);}else{_f4=true;}_f1.push(c);}}}if(_f6.length!=0){throw _d0(new Error("Section \""+_f6[_f6.length-1].name+"\" was not closed properly"),_ec,line,_ed.file);}_f5();_f1.push("\");","\nsend(null);","\n} catch (e) { throw {error: e, line: line}; }");var body=_f1.join("").replace(/send\(""\);\n/g,"");if(_ed.debug){if(typeof console!="undefined"&&console.log){console.log(body);}else{if(typeof print==="function"){print(body);}}}return body;};function _10d(_10e,_10f){var args="view,partials,send,stack,findName,escapeHTML,sendSection,render";var body=_b7(_10e,_10f);var fn=new Function(args,body);return function(view,_110,_111){if(typeof _110==="function"){_111=_110;_110={};}_110=_110||{};var _112=[];var send=_111||function(_113){_112.push(_113);};var _114=[view];try{fn(view,_110,send,_114,_d7,_ce,_e1,_b9);}catch(e){throw _d0(e.error,_10e,e.line,_10f.file);}return _112.join("");};};var _115={};function _ba(){_115={};};function _b8(_116,_117){_117=_117||{};if(_117.cache!==false){if(!_115[_116]){_115[_116]=_10d(_116,_117);}return _115[_116];}return _10d(_116,_117);};function _b9(_118,view,_119,_11a){return _b8(_118)(view,_119,_11a);};})(Mustache);}if(!dojo._hasResource["mulberry._View"]){dojo._hasResource["mulberry._View"]=true;dojo.provide("mulberry._View");(function(){var _11b={},_11c={"haml":{firstChars:[".","%"],tmplFn:Haml},"mustache":{firstChars:["{","<"],tmplFn:function(tmpl){return dojo.partial(Mustache.render,tmpl);}}};dojo.declare("mulberry._View",[dijit._Widget,dijit._Templated,mulberry._Nls],{templateString:"%div",isHidden:false,isDisabled:false,postMixInProperties:function(){this.inherited(arguments);if(!this.device){this.device=mulberry.Device;}this.phone=this.device.type==="phone";this.tablet=this.device.type==="tablet";},_skipNodeCache:true,_stringRepl:function(tmpl){var t=_11b[tmpl];if(!t){dojo.forIn(_11c,function(lang,_11d){if(t){return;}if(dojo.indexOf(_11d.firstChars,tmpl[0])>-1){t=_11b[tmpl]=_11d.tmplFn(tmpl);}});}return t(this);},postCreate:function(){this.inherited(arguments);},adopt:function(cls,_11e,node){var x=new cls(_11e,node);this._addItem(x);return x;},_addItem:function(){this._addedItems=this._addedItems||[];this._addedItems.push.apply(this._addedItems,arguments);},orphan:function(_11f,_120){this._addedItems=this._addedItems||[];var i=dojo.indexOf(this._addedItems,_11f);if(i>=0){this._addedItems.splice(i,1);}if(_120){this._kill(_11f);}},_kill:function(w){if(w&&w.destroyRecursive){w.destroyRecursive();}else{if(w&&w.destroy){w.destroy();}}},query:function(sel){var nl,_121;if(!sel){return new dojo.NodeList(this.domNode);}else{_121=this.domNode.querySelectorAll(sel);nl=new dojo.NodeList();dojo.forEach(_121,function(n){nl.push(n);});}return nl;},preventClickDelay:function(el,_122){this.clickables=this.clickables||[];this.clickables.push(new mulberry.ui.Clickable(el,dojo.hitch(this,_122)));},destroy:function(){dojo.forEach(this._addedItems,this._kill);dojo.forEach(this.scrollerHandles||[],function(_123){_123.destroy();});dojo.forEach(this.clickables||[],function(c){c.destroy();});this.inherited(arguments);},addClass:function(_124){dojo.addClass(this.domNode,_124);},removeClass:function(_125){dojo.removeClass(this.domNode,_125);},show:function(_126){if(_126&&_126.nodeName){dojo.removeClass(_126,"hidden");return;}this.removeClass("hidden");this.isHidden=false;},hide:function(_127){if(_127&&_127.nodeName){dojo.addClass(_127,"hidden");return;}this.addClass("hidden");this.isHidden=true;},toggle:function(_128){if(_128){dojo.toggleClass(_128,"hidden");return;}if(this.isHidden){this.show();}else{this.hide();}},enable:function(){this.removeClass("disabled");this.isDisabled=false;},disable:function(){this.addClass("disabled");this.isDisabled=true;}});}());}if(!dojo._hasResource["mulberry.Utilities"]){dojo._hasResource["mulberry.Utilities"]=true;dojo.provide("mulberry.Utilities");dojo.forIn=function(obj,fn,_129){var k;for(k in obj){if(obj.hasOwnProperty(k)){dojo.hitch(_129||window,fn)(k,obj[k]);}}};mulberry.util={truncate:function(text,len){var _12a;len=len||200;text=text.replace("</p>"," ").replace("<br>"," ").replace(/(<\/.>)|(<.>)|(<[^b][^r]?[^>]*>)/g,"");_12a=text=dojo.trim(text);text=text.substr(0,len);if(text&&_12a.length>len){text=text+" &hellip;";}return text;},copyStyles:function(_12b,toEl,_12c){var _12d=window.getComputedStyle(_12b);dojo.forEach(_12c,function(_12e){dojo.style(toEl,_12e,_12d[_12e]);});}};mulberry.tmpl=function(str,data){return dojo.string.substitute(str,data);};mulberry.haml=Haml;mulberry.jsonp=function(url,_12f){_12f=dojo.isObject(url)?url:(_12f||{});_12f.callbackParamName=_12f.callback||_12f.callbackParamName||"callback";url=dojo.isString(url)?url:_12f.url;if(!url){return;}return dojo.io.script.get(dojo.delegate(_12f,{url:url}));};mulberry.page=function(_130,_131,_132){mulberry.route(_130,function(_133){mulberry.showPage(mulberry.createPage(dojo.mixin(_131,{params:_133})));},_132);};}if(!dojo._hasResource["mulberry._Component"]){dojo._hasResource["mulberry._Component"]=true;dojo.provide("mulberry._Component");dojo.declare("mulberry._Component",mulberry._View,{handleClicks:false,prepareData:function(){},setupConnections:function(){},setupSubscriptions:function(){},setupChildComponents:function(){},adjustMarkup:function(){},resizeElements:function(){},teardown:function(){},populate:function(_134,data){this.populateElement(this.domNode,_134,data);},populateElement:function(_135,_136,data){if(dojo.isString(_135)){_135=this[_135];}if(!_135){return;}_135.innerHTML=dojo.isArray(data)?dojo.map(data,_136).join(""):_136(data);if(this.region){this.region.refreshScroller();}},postMixInProperties:function(){this.inherited(arguments);if(this.screen){this.screen.registerComponent(this);this.connect(this.screen,"startup","startup");}this.prepareData();this._loadHelpers();this.inherited(arguments);},postCreate:function(){this.inherited(arguments);if(this.isHidden){this.hide();}if(this.handleClicks){this.preventClickDelay(this.clickableNode||this.domNode,this._clickHandler&&dojo.hitch(this,"_clickHandler"));}this.subscribe("/window/resize",function(){this.dimensions=null;});this.setupChildComponents();this.adjustMarkup();this.setupConnections();this.setupSubscriptions();},startup:function(){this.inherited(arguments);this.resizeElements();if(this.when){dojo.forIn(this.when,function(k,v){var node=this.node||this.baseObj;node[k].then(dojo.hitch(this,v));},this);}},destroy:function(){this.teardown();this.inherited(arguments);},_loadHelpers:function(){if(this.helpers&&dojo.isObject(this.helpers)){dojo.forIn(this.helpers,function(prop,tpl){if(tpl){this.helpers[prop]=Haml(tpl)();}},this);}},_setupTouch:function(ele,_137){var _138=mulberry.app.UI.hasTouch,evt=_138?"touchstart":"click";this.connect(ele,evt,_137);if(_138){this.connect(ele,"click",function(e){e.preventDefault();});}},getDimensions:function(){var _139=this[this.sizeNode];this.dimensions=this.dimensions||{width:dojo.style(this.domNode,"width"),height:dojo.style(this.domNode,"height")};return this.dimensions;}});mulberry.component=function(name,_13a){var p=dojo.mixin(_13a,{templateString:_13a.componentTemplate||"%div",prepareData:function(){this.inherited(arguments);if(_13a.prep){_13a.prep.call(this);}},postCreate:function(){this.inherited(arguments);if(window.jQuery){this.$domNode=jQuery(this.domNode);}},startup:function(){this.inherited(arguments);if(_13a.init){_13a.init.call(this);}}});dojo.declare("client.components."+name,mulberry._Component,p);};}if(!dojo._hasResource["toura.components.SiblingNav"]){dojo._hasResource["toura.components.SiblingNav"]=true;dojo.provide("toura.components.SiblingNav");dojo.declare("toura.components.SiblingNav",mulberry._Component,{templateString:dojo.cache("toura.components","SiblingNav/SiblingNav.haml",".component.sibling-nav\n  .handle{ dojoAttachPoint : 'handleNode' }\n    .toggler\n  %nav\n    .controller.prev{ dojoAttachPoint : 'prevButton' } prev\n    %ol.nodes{ dojoAttachPoint : 'siblingList' }\n    .controller.next{ dojoAttachPoint : 'nextButton' } next\n\n\n"),siblingTemplate:Haml(dojo.cache("toura.components","SiblingNav/Sibling.haml","%li{ class : className }\n  %span{ data-href : url }= name\n")),setupConnections:function(){var evt=mulberry.app.UI.hasTouch?"touchstart":"click";this.connect(this.handleNode,evt,"toggle");this.connect(this.prevButton,evt,dojo.hitch(this,"_handleButton","prev"));this.connect(this.nextButton,evt,dojo.hitch(this,"_handleButton","next"));this.connect(this.siblingList,evt,"_handleLink");},toggle:function(){this.set("open",!this.open);},_handleButton:function(dir){var node=this[dir+"Item"];if(dir==="prev"){mulberry.app.UI.set("navDirection","back");}mulberry.app.Router.go(node.url,true);},_handleLink:function(e){var _13b=e.target,url=dojo.attr(_13b,"data-href");if(!url){return;}if(dojo.hasClass(_13b.parentNode,"prev")){mulberry.app.UI.set("navDirection","back");}mulberry.app.Router.go(url,true);},_setOpenAttr:function(open){dojo[open?"addClass":"removeClass"](this.domNode,"open");this.open=open;},_setNodeAttr:function(node){if(!node||!node.siblings||!node.siblings.length){this.hide();this.set("open",false);this.siblings=false;return;}this.show();this._processSiblings(node.siblings,node);},_processSiblings:function(_13c,_13d){this.siblings=_13c.length?true:false;dojo.forEach(_13c,function(_13e,idx){if(_13e.id===_13d.id){this.currentIndex=idx;}},this);var _13f=this.currentIndex+1;var _140=this.currentIndex-1;this.nextItem=_13f>=_13c.length?null:_13c[_13f];this.prevItem=_140<0?null:_13c[_140];this._updateButtons();this._updateLinks();},_updateButtons:function(){dojo[this.nextItem?"removeClass":"addClass"](this.nextButton,"inactive");dojo[this.prevItem?"removeClass":"addClass"](this.prevButton,"inactive");},_updateLinks:function(){var html,_141;dojo.empty(this.siblingList);if(this.prevItem){_141=dojo.mixin(this.prevItem,{className:"prev"});this.prevLink=dojo.place(this.siblingTemplate(_141),this.siblingList);}if(this.nextItem){_141=dojo.mixin(this.nextItem,{className:"next"});this.nextLink=dojo.place(this.siblingTemplate(_141),this.siblingList);}}});}if(!dojo._hasResource["toura.components.AdTag"]){dojo._hasResource["toura.components.AdTag"]=true;dojo.provide("toura.components.AdTag");dojo.declare("toura.components.AdTag",mulberry._Component,{templateString:dojo.cache("toura.components","AdTag/AdTag.haml",".component.ad-tag\n  %iframe{ dojoAttachPoint : 'adFrame' }\n"),adjustMarkup:function(){var _142=mulberry.app.Config.get("app").ads,src=_142[this.device.type];dojo.attr(this.adFrame,"src",src);},startup:function(){var src=mulberry.app.Config.get("app").ads[this.device.type];if(!src){this.destroy();}}});}if(!dojo._hasResource["toura.UI"]){dojo._hasResource["toura.UI"]=true;dojo.provide("toura.UI");(function(m){dojo.declare("toura.UI",dojo.Stateful,{constructor:function(){this.body=dojo.body();this._setupFeatureClasses();this._setupSiblingNav();this._setupAdTag();dojo.connect(m.app.UI,"showPage",this,"_onShowPage");this.watch("siblingNavVisible",dojo.hitch(this,"_onSiblingNavVisible"));},_onShowPage:function(page,node){if(!this.siblingNav){return;}this.set("siblingNavVisible",true);this.siblingNav.set("node",node);},_setupFeatureClasses:function(){dojo.forIn(toura.features,function(_143,_144){if(!_144){return;}dojo.addClass(this.body,"feature-"+_143);},this);},_setupSiblingNav:function(){if(!toura.features.siblingNav){return;}this.siblingNav=m.app.UI.addPersistentComponent(toura.components.SiblingNav);this.set("siblingNavVisible",false);},_setupAdTag:function(){if(!toura.features.ads){return;}mulberry.app.PhoneGap.network.isReachable().then(function(_145){if(!_145){return;}m.app.UI.addPersistentComponent(toura.components.AdTag);});},_onSiblingNavVisible:function(k,old,_146){if(!this.siblingNav){return;}if(!this.siblingNav.siblings){this.siblingNav.hide();return;}this.siblingNav[_146?"show":"hide"]();}});dojo.subscribe("/ui/ready",function(){toura.UI=new toura.UI();});}(mulberry));}if(!dojo._hasResource["toura.Analytics"]){dojo._hasResource["toura.Analytics"]=true;dojo.provide("toura.Analytics");(function(){var _147=(function(pg,_148){var os=_148.os,_149;return {log:(function(){function _14a(){_149=_149||mulberry.app.Config.get("app").name.replace(/[^a-zA-Z]/g,"");return _149;};return pg?function(evt,_14b){console.log("mulberry.app.PhoneGap::logAnalyticsEvent()");PhoneGap.exec(function(){},function(_14c){mulberry.log("Could not log flurry event.  Error: "+_14c);},"FlurryCommand","logEvent",[evt,_14b]);}:function(evt,_14d){console.log("mulberry.app.PhoneGap::logAnalyticsEvent()");};}())};}(mulberry.app.PhoneGap.present,mulberry.Device));dojo.declare("toura.Analytics",null,{constructor:function(id){this.appId=id;dojo.subscribe("/video/play",dojo.hitch(this,"_trackEvent","Video Play"));dojo.subscribe("/audio/play",dojo.hitch(this,"_trackEvent","Audio Play"));dojo.subscribe("/image/view",dojo.hitch(this,"_trackEvent","Image View"));dojo.subscribe("/share",dojo.hitch(this,"_trackEvent","Share"));dojo.subscribe("/node/view",this,"_trackPageview");dojo.subscribe("/search",this,"_trackSearch");},_trackEvent:function(_14e,data){_147.log(_14e,{data:data});},_trackPageview:function(hash){_147.log("/tour/"+mulberry.app.Config.get("app").id+hash);},_trackSearch:function(term){term=term?dojo.trim(term):false;if(!term){return;}_147.log("Search",{searchTerm:term});}});toura.Analytics=new toura.Analytics();}());}if(!dojo._hasResource["mulberry.app.PhoneGap.notification"]){dojo._hasResource["mulberry.app.PhoneGap.notification"]=true;dojo.provide("mulberry.app.PhoneGap.notification");mulberry.app.PhoneGap.notification=function(pg,_14f){return {alert:function(msg){if(pg){navigator.notification.alert(msg);}else{alert(msg);}}};};}if(!dojo._hasResource["mulberry.app.PhoneGap.device"]){dojo._hasResource["mulberry.app.PhoneGap.device"]=true;dojo.provide("mulberry.app.PhoneGap.device");(function(){function _150(ua){if(!ua){return "unknown";}if(!dojo.isString(ua)){return "unknown";}if(!dojo.trim(ua)){return "unknown";}var v;if(ua.match("Android")){v=dojo.trim(ua.split("Android")[1].split(";")[0]).split("-")[0].split(".");return _151(v);}if(ua.indexOf("AppleWebKit")>-1&&(ua.indexOf("iPhone")+ua.indexOf("iPad")+ua.indexOf("iPod"))>=0){return "unknown-ios-webkit";}return "unknown";};function _151(_152){return [_152[0],_152[1]||"0"].join("-");};mulberry.app.PhoneGap.device=function(pg,_153){return {version:(function(){if(pg){return _151(window.device.version.split("-")[0].split("."));}return _150(window.navigator.userAgent);}()),_parseVersion:_150};};}());}if(!dojo._hasResource["mulberry.app.PhoneGap.network"]){dojo._hasResource["mulberry.app.PhoneGap.network"]=true;dojo.provide("mulberry.app.PhoneGap.network");mulberry.app.PhoneGap.network=function(pg,_154){var n=navigator,_155=5*60*1000,_156,_157,_158;return {isReachable:function(){console.log("mulberry.app.PhoneGap.network::isReachable()");var dfd=new dojo.Deferred(),now=new Date().getTime();if(_157&&!_158&&(now-_157<_155)){dfd.resolve(_158);return dfd;}_157=now;if(navigator.network&&navigator.network.connection){_156=navigator.network.connection.type;if(_156===Connection.UNKNOWN||_156===Connection.NONE){_158=false;}else{_158=true;}}else{_158=true;}dfd.resolve(_158);return dfd.promise;},state:function(){var _159={},type;if(navigator.network&&navigator.network.connection){_159[Connection.UNKNOWN]="Unknown connection";_159[Connection.ETHERNET]="Ethernet connection";_159[Connection.WIFI]="WiFi connection";_159[Connection.CELL_2G]="Cell 2G connection";_159[Connection.CELL_3G]="Cell 3G connection";_159[Connection.CELL_4G]="Cell 4G connection";_159[Connection.NONE]="No network connection";type=navigator.network.connection.type;return {state:type,description:_159[type]};}else{return {state:-1,description:"Unknown connection"};}}};};}if(!dojo._hasResource["mulberry.app.PhoneGap.audio"]){dojo._hasResource["mulberry.app.PhoneGap.audio"]=true;dojo.provide("mulberry.app.PhoneGap.audio");mulberry.app.PhoneGap.audio=function(pg,_15a){var _15b,_15c=function(){},_15d=function(err){};return {play:function(url){console.log("mulberry.app.PhoneGap.audio::play()");if(!pg){return;}url=/^http/.test(url)?url:("/android_asset/www/"+url);_15b=new Media(url,_15c,_15d);_15b.play();},stop:function(){console.log("mulberry.app.PhoneGap.audio::stop()");if(!pg||!_15b){return;}_15b.pause();},destroy:function(){if(!_15b){return;}_15b.stop();_15b.release();_15b=null;}};};}if(!dojo._hasResource["vendor.urbanairship.push"]){dojo._hasResource["vendor.urbanairship.push"]=true;dojo.provide("vendor.urbanairship.push");vendor.urbanairship.push=function(){var _15e=function(){};_15e.prototype.register=function(_15f,fail,_160){PhoneGap.exec(_15f,fail,"PushNotification","registerAPN",_160);};_15e.prototype.startNotify=function(_161){PhoneGap.exec(null,null,"PushNotification","startNotify",[]);};_15e.prototype.log=function(_162){PhoneGap.exec(null,null,"PushNotification","log",[{"msg":_162}]);};PhoneGap.addConstructor(function(){if(!window.plugins){window.plugins={};}window.plugins.pushNotification=new _15e();});};}if(!dojo._hasResource["mulberry.app.PhoneGap.push"]){dojo._hasResource["mulberry.app.PhoneGap.push"]=true;dojo.provide("mulberry.app.PhoneGap.push");mulberry.app.PhoneGap.push=function(pg,_163){if(!pg){return;}vendor.urbanairship.push();};}if(!dojo._hasResource["mulberry.app.PhoneGap.browser"]){dojo._hasResource["mulberry.app.PhoneGap.browser"]=true;dojo.provide("mulberry.app.PhoneGap.browser");mulberry.app.PhoneGap.browser=function(pg,_164){function _165(){};window.ChildBrowser=_165;var os=_164.os,init={ios:function(){_165._onLocationChange=function(_166){window.plugins.childBrowser.onLocationChange(_166);};_165._onClose=function(){window.plugins.childBrowser.onClose();};_165._onOpenExternal=function(){window.plugins.childBrowser.onOpenExternal();};_165._onJSCallback=function(js,loc){};_165.prototype.showWebPage=function(loc){PhoneGap.exec("ChildBrowserCommand.showWebPage",loc);};_165.prototype.close=function(){PhoneGap.exec("ChildBrowserCommand.close");};_165.prototype.jsExec=function(_167){};_165.install=function(){if(!window.plugins){window.plugins={};}window.plugins.childBrowser=new _165();return window.plugins.childBrowser;};_165.install();},android:function(){_165.prototype.showWebPage=function(url,_168){PhoneGap.exec(null,null,"ChildBrowser","showWebPage",[url,_168]);};PhoneGap.addConstructor(function(){PhoneGap.addPlugin("childBrowser",new _165());PluginManager.addService("ChildBrowser","com.phonegap.plugins.childBrowser.ChildBrowser");});}};if(pg&&init[os]){init[os]();}return {url:function(url){if(pg){if(os==="android"){PhoneGap.exec(null,null,"ChildBrowser","showWebPage",[url,false]);}else{window.plugins.childBrowser.showWebPage(url);}return;}window.location=url;},getBrowser:function(){if(!window.plugins.childBrowser){throw new Error("Can't find childBrowser plugin");}return window.plugins.childBrowser;}};};}if(!dojo._hasResource["mulberry.app.PhoneGap.camera"]){dojo._hasResource["mulberry.app.PhoneGap.camera"]=true;dojo.provide("mulberry.app.PhoneGap.camera");mulberry.app.PhoneGap.camera=function(pg,_169){var noop=function(){};return {getPicture:function(_16a,_16b,opts){if(!dojo.isFunction(_16a)){opts=_16a;_16a=false;_16b=false;}var dfd=new dojo.Deferred(),win=function(data){(_16a||noop)(data);dfd.resolve(data);},fail=function(msg){(_16b||noop)(msg);dfd.reject(msg);};if(pg&&navigator&&navigator.camera){navigator.camera.getPicture(win,fail,opts);}else{dfd.resolve();}return dfd.promise;}};};}if(!dojo._hasResource["mulberry.app.PhoneGap.geolocation"]){dojo._hasResource["mulberry.app.PhoneGap.geolocation"]=true;dojo.provide("mulberry.app.PhoneGap.geolocation");mulberry.app.PhoneGap.geolocation=function(pg,_16c){var noop=function(){};return {getCurrentPosition:function(_16d,_16e,opts){if(!dojo.isFunction(_16d)){opts=_16d;_16d=false;_16e=false;}var dfd=new dojo.Deferred(),win=function(data){(_16d||noop)(data);dfd.resolve(data);},fail=function(msg){(_16e||noop)(msg);dfd.reject(msg);},_16f="Geolocation API not available";if(navigator.geolocation&&navigator.geolocation.getCurrentPosition){navigator.geolocation.getCurrentPosition(win,fail,opts);}else{fail(_16f);}return dfd.promise;},watchPosition:function(_170,_171,opts){if(navigator.geolocation&&navigator.geolocation.watchPosition){return navigator.geolocation.watchPosition(_170,_171,opts);}return false;},clearWatch:function(_172){if(_172&&navigator.geolocation&&navigator.geolocation.clearWatch){navigator.geolocation.clearWatch(_172);}}};};}if(!dojo._hasResource["mulberry.app.PhoneGap.accelerometer"]){dojo._hasResource["mulberry.app.PhoneGap.accelerometer"]=true;dojo.provide("mulberry.app.PhoneGap.accelerometer");mulberry.app.PhoneGap.accelerometer=function(pg,_173){var noop=function(){};return {getCurrentAcceleration:function(_174,_175){var dfd=new dojo.Deferred(),win=function(data){(_174||noop)(data);dfd.resolve(data);},fail=function(msg){(_175||noop)(msg);dfd.reject(msg);},_176="Accelerometer API not available";if(navigator.accelerometer&&navigator.accelerometer.getCurrentAcceleration){navigator.accelerometer.getCurrentAcceleration(win,fail);}else{fail(_176);}return dfd.promise;},watchAcceleration:function(_177,_178){if(navigator.accelerometer&&navigator.accelerometer.watchAcceleration){return navigator.accelerometer.watchAcceleration(_177,_178);}else{return false;}},clearWatch:function(_179){var _17a=_179.watchId||_179;if(navigator.accelerometer&&navigator.accelerometer.clearWatch&&_17a){navigator.accelerometer.clearWatch(_17a);}}};};}if(!dojo._hasResource["mulberry.app.PhoneGap"]){dojo._hasResource["mulberry.app.PhoneGap"]=true;dojo.provide("mulberry.app.PhoneGap");(function(){mulberry.app.PhoneGap.registerAPI=function(name,_17b){var s=dojo.subscribe("/app/deviceready",function(){var _17c=mulberry.Device,_17d=mulberry.app.PhoneGap.present=window.device&&window.device.phonegap;console.log("NAME",name);mulberry.app.PhoneGap[name]=_17b(_17d,_17c);dojo.unsubscribe(s);});};var _17e=["notification","device","network","audio","push","browser","camera","geolocation","accelerometer"];dojo.forEach(_17e,function(_17f){mulberry.app.PhoneGap.registerAPI(_17f,mulberry.app.PhoneGap[_17f]);});}());}if(!dojo._hasResource["mulberry.app.DeviceStorage"]){dojo._hasResource["mulberry.app.DeviceStorage"]=true;dojo.provide("mulberry.app.DeviceStorage");mulberry.app.DeviceStorage=(function(){var _180={"tour":{tableName:"items",fields:["id text","json text"],insertStatement:function(_181,item){return ["INSERT INTO "+_181+"( id, json ) VALUES ( ?, ? )",[item.id,JSON.stringify(item)]];},processSelecton:function(_182){var _183=[],len=_182.rows.length,_184,i;for(i=0;i<len;i++){_184=_182.rows.item(i).json;_183.push(_184?JSON.parse(_184):{});}return _183;}}};return {init:function(_185){this.appId=_185;if(!window.localStorage){throw new Error("Local storage interface is not defined. Cannot create database. Aborting.");}if(!window.openDatabase){throw new Error("SQLite database interface is not defined. Cannot create database. Aborting.");}var db=this._db=openDatabase(_185+"-"+mulberry.version,"1.0",_185+" Database",5*1024*1024);if(!db){console.log("No database. This will end badly.");}this._sql=function(_186,_187){var dfd=new dojo.Deferred(),len;_186=dojo.isArray(_186)?_186:[_186];len=_186.length;db.transaction(function(t){dojo.forEach(_186,function(q,i){var last=i+1===len,cb,eb,_188=[];if(last){cb=dojo.isFunction(_187)?function(t,data){dfd.callback(_187(data));}:dfd.callback;eb=dfd.errback;}else{cb=eb=function(){};}if(dojo.isArray(q)){_188=q[1];q=q[0];}t.executeSql(q,_188,cb,eb);});});return dfd;};return this._db;},drop:function(){var _189=[];dojo.forIn(_180,function(_18a,_18b){_189.push("DROP TABLE IF EXISTS "+_18b.tableName);});window.localStorage.clear();return this._sql&&this._sql(_189);},set:function(k,v){var sql=_180[k],_18c;if(sql){_18c=["DROP TABLE IF EXISTS "+sql.tableName,"CREATE TABLE "+sql.tableName+"("+sql.fields.join(",")+")"];dojo.forEach(v,function(item){_18c.push(sql.insertStatement(sql.tableName,item));});return this._sql(_18c);}window.localStorage.setItem(k,JSON.stringify(v));return true;},get:function(k){var sql=_180[k];if(sql){return this._sql("SELECT * FROM "+sql.tableName,sql.processSelecton);}var ret=window.localStorage.getItem(k);if(ret==="undefined"){ret=null;}ret=ret&&JSON.parse(ret);return ret;}};}());}if(!dojo._hasResource["dojo.io.script"]){dojo._hasResource["dojo.io.script"]=true;dojo.provide("dojo.io.script");dojo.getObject("io",true,dojo);(function(){var _18d=dojo.isIE?"onreadystatechange":"load",_18e=/complete|loaded/;dojo.io.script={get:function(args){var dfd=this._makeScriptDeferred(args);var _18f=dfd.ioArgs;dojo._ioAddQueryToUrl(_18f);dojo._ioNotifyStart(dfd);if(this._canAttach(_18f)){var node=this.attach(_18f.id,_18f.url,args.frameDoc);if(!_18f.jsonp&&!_18f.args.checkString){var _190=dojo.connect(node,_18d,function(evt){if(evt.type=="load"||_18e.test(node.readyState)){dojo.disconnect(_190);_18f.scriptLoaded=evt;}});}}dojo._ioWatch(dfd,this._validCheck,this._ioCheck,this._resHandle);return dfd;},attach:function(id,url,_191){var doc=(_191||dojo.doc);var _192=doc.createElement("script");_192.type="text/javascript";_192.src=url;_192.id=id;_192.charset="utf-8";return doc.getElementsByTagName("head")[0].appendChild(_192);},remove:function(id,_193){dojo.destroy(dojo.byId(id,_193));if(this["jsonp_"+id]){delete this["jsonp_"+id];}},_makeScriptDeferred:function(args){var dfd=dojo._ioSetArgs(args,this._deferredCancel,this._deferredOk,this._deferredError);var _194=dfd.ioArgs;_194.id=dojo._scopeName+"IoScript"+(this._counter++);_194.canDelete=false;_194.jsonp=args.callbackParamName||args.jsonp;if(_194.jsonp){_194.query=_194.query||"";if(_194.query.length>0){_194.query+="&";}_194.query+=_194.jsonp+"="+(args.frameDoc?"parent.":"")+dojo._scopeName+".io.script.jsonp_"+_194.id+"._jsonpCallback";_194.frameDoc=args.frameDoc;_194.canDelete=true;dfd._jsonpCallback=this._jsonpCallback;this["jsonp_"+_194.id]=dfd;}return dfd;},_deferredCancel:function(dfd){dfd.canceled=true;if(dfd.ioArgs.canDelete){dojo.io.script._addDeadScript(dfd.ioArgs);}},_deferredOk:function(dfd){var _195=dfd.ioArgs;if(_195.canDelete){dojo.io.script._addDeadScript(_195);}return _195.json||_195.scriptLoaded||_195;},_deferredError:function(_196,dfd){if(dfd.ioArgs.canDelete){if(_196.dojoType=="timeout"){dojo.io.script.remove(dfd.ioArgs.id,dfd.ioArgs.frameDoc);}else{dojo.io.script._addDeadScript(dfd.ioArgs);}}console.log("dojo.io.script error",_196);return _196;},_deadScripts:[],_counter:1,_addDeadScript:function(_197){dojo.io.script._deadScripts.push({id:_197.id,frameDoc:_197.frameDoc});_197.frameDoc=null;},_validCheck:function(dfd){var _198=dojo.io.script;var _199=_198._deadScripts;if(_199&&_199.length>0){for(var i=0;i<_199.length;i++){_198.remove(_199[i].id,_199[i].frameDoc);_199[i].frameDoc=null;}dojo.io.script._deadScripts=[];}return true;},_ioCheck:function(dfd){var _19a=dfd.ioArgs;if(_19a.json||(_19a.scriptLoaded&&!_19a.args.checkString)){return true;}var _19b=_19a.args.checkString;if(_19b&&eval("typeof("+_19b+") != 'undefined'")){return true;}return false;},_resHandle:function(dfd){if(dojo.io.script._ioCheck(dfd)){dfd.callback(dfd);}else{dfd.errback(new Error("inconceivable dojo.io.script._resHandle error"));}},_canAttach:function(_19c){return true;},_jsonpCallback:function(json){this.ioArgs.json=json;}};})();}if(!dojo._hasResource["toura.models._Updateable"]){dojo._hasResource["toura.models._Updateable"]=true;dojo.provide("toura.models._Updateable");dojo.declare("toura.models._Updateable",null,{bundleDataUrl:"",remoteDataUrl:"",remoteVersionUrl:"",storageKey:"",lastChecked:0,constructor:function(_19d){dojo.mixin(this,_19d);},getItems:function(){return this._items||[];},bootstrap:function(){var _19e=this._getLocalVersion(),dfd=this.deferred=new dojo.Deferred();this._getBundleData().then(dojo.hitch(this,function(_19f){var _1a0=_19f.version,_1a1=(_19e===null)||(_1a0===null)||(_19e<_1a0);dojo.when(_1a1?this._initializeData(_19f):true,dojo.hitch(this,"_updateIfNecessary")).then(dojo.hitch(this,"_onUpdate"));}));return dfd.promise;},_onUpdate:function(_1a2){if(_1a2){if(_1a2.appVersion&&this._isAppVersionCompatible(_1a2.appVersion)){dojo.when(this._store(_1a2),dojo.hitch(this,function(){this._onDataReady();this.deferred.resolve(true);}));}else{this.deferred.resolve(false);}}else{this.deferred.resolve(false);}},_isAppVersionCompatible:function(_1a3){var _1a4=mulberry.app.Config.get("appVersion"),_1a5=this._parseMajorVersion(_1a4);return _1a5===this._parseMajorVersion(_1a3);},_updateIfNecessary:function(){var dfd=new dojo.Deferred(),_1a6=this._getLocalVersion();dojo.when(this._getRemoteVersion(),dojo.hitch(this,function(_1a7){var _1a8=this._parseMajorVersion(mulberry.app.Config.get("appVersion"));if(_1a7){_1a7.appVersion=_1a7.appVersion||"2.0";}if(_1a7&&this._isAppVersionCompatible(_1a7.appVersion)&&(_1a7.version>_1a6)){this._getRemoteData().then(dojo.hitch(this,function(_1a9){if(!_1a9){dfd.resolve(false);return;}dfd.resolve(_1a9);}));}else{this._onDataReady();dfd.resolve(false);}}),dojo.hitch(this,function(_1aa){if(_1aa.status===404||_1aa.status===503){this._onDataReady();}dfd.resolve(false);}));return dfd.promise;},_xhr:function(url,dfd){return dojo.xhrGet({url:url,preventCache:true,handleAs:"json",contentType:false,load:dfd.resolve,error:dfd.reject});},_getRemoteVersion:function(){this.lastChecked=new Date().getTime();var dfd=new dojo.Deferred();if(mulberry.skipVersionCheck||!this.remoteVersionUrl){console.log("No remote version URL -- skipping remote version check");dfd.resolve(null);}else{mulberry.app.PhoneGap.network.isReachable().then(dojo.hitch(this,function(_1ab){if(!_1ab){dfd.resolve(null);return;}this._xhr(this.remoteVersionUrl,dfd);}),dfd.reject);}return dfd.promise;},_getLocalVersion:function(){var v=mulberry.app.DeviceStorage.get(this.storageKey+"-version");return v;},_setLocalVersion:function(v){mulberry.app.DeviceStorage.set(this.storageKey+"-version",v);},_getRemoteData:function(){var dfd=new dojo.Deferred();if(!this.remoteDataUrl){console.log("No remote data URL -- skipping remote data check");dfd.resolve(false);}else{mulberry.app.PhoneGap.network.isReachable().then(dojo.hitch(this,function(){this._xhr(this.remoteDataUrl,dfd);}),function(){dfd.resolve(false);});}return dfd.promise;},_getBundleData:function(){var dfd=new dojo.Deferred();if(!this.bundleDataUrl){dfd.resolve();}dojo.io.script.get({url:this.bundleDataUrl,preventCache:true}).then(dojo.hitch(this,function(_1ac){dfd.resolve(this._processBundleData(_1ac));}),function(){dfd.reject("Could not load local bundle data");});return dfd.promise;},_processBundleData:function(data){return data;},_initializeData:function(_1ad){var dfd=new dojo.Deferred();dojo.when(_1ad||this._getBundleData(),dojo.hitch(this,function(data){if(!data){dfd.resolve(false);return;}dojo.when(this._store(data),function(){dfd.resolve(true);});}));return dfd.promise;},_store:function(_1ae){this.lastUpdated=new Date().getTime();this._items=_1ae.items;this._setLocalVersion(_1ae&&_1ae.version);},_parseMajorVersion:function(_1af){return +_1af.split(".")[0];},_onDataReady:function(){}});}if(!dojo._hasResource["toura.models.Tour"]){dojo._hasResource["toura.models.Tour"]=true;dojo.provide("toura.models.Tour");dojo.declare("toura.models.Tour",toura.models._Updateable,{storageKey:"tour",_store:function(data){this.inherited(arguments);var dfd=new dojo.Deferred();if(data.app){mulberry.app.DeviceStorage.set("app",data.app);}if(data.items){mulberry.app.DeviceStorage.set("tour",data.items).then(function(){dfd.resolve(true);});}return dfd.promise;},getItems:function(){var dfd=new dojo.Deferred();if(this._items){dfd.resolve(this._items);}else{mulberry.app.DeviceStorage.get("tour").then(dojo.hitch(this,function(_1b0){this._items=_1b0;dfd.resolve(_1b0);}));}return dfd.promise;},_processBundleData:function(){return toura.data.local;},_onDataReady:function(){var _1b1=mulberry.app.DeviceStorage.get("app");mulberry.app.Config.set("app",_1b1);}});}if(!dojo._hasResource["toura.Bootstrapper"]){dojo._hasResource["toura.Bootstrapper"]=true;dojo.provide("toura.Bootstrapper");(function(){var _1b2=function(){var dfd=new dojo.Deferred(),app=mulberry.app,tour;if(app.DeviceStorage.get("tour-version")===0){app.DeviceStorage.set("tour-verison",null);}tour=new toura.models.Tour({bundleDataUrl:"./data/tour.js"+(app.PhoneGap.present?".jet":""),remoteDataUrl:app.Config.get("updateUrl"),remoteVersionUrl:app.Config.get("versionUrl")});dojo.subscribe("/page/transition/end",function(){var _1b3=tour.lastChecked,now=new Date().getTime(),_1b4=now-_1b3,_1b5=1000*60*60*(mulberry.otaInterval||8),_1b6=_1b4>_1b5;if(!_1b6){return;}tour.bootstrap().then(function(_1b7){if(!_1b7){return;}dojo.when(tour.getItems(),function(data){toura.Data.loadData(data);mulberry.app.PhoneGap.notification.alert(dojo.i18n.getLocalization("mulberry","mulberry",mulberry.app.Config.get("locale")).OTA_UPDATE_NOTICE);mulberry.app.Router.home();});});});tour.bootstrap().then(function(){dfd.resolve(tour);},dfd.reject);return dfd.promise;};dojo.subscribe("/app/deviceready",function(){_1b2().then(function(tour){tour.getItems().then(function(data){toura.Data=new toura.Data(data);setTimeout(function(){dojo.publish("/app/ready");mulberry.app.PhoneGap.network.isReachable().then(function(_1b8){if(!_1b8){mulberry.app.PhoneGap.notification.alert(dojo.i18n.getLocalization("mulberry","mulberry",mulberry.app.Config.get("locale")).STARTUP_NO_NETWORK);}});},200);});});});}());}if(!dojo._hasResource["dojo.data.util.filter"]){dojo._hasResource["dojo.data.util.filter"]=true;dojo.provide("dojo.data.util.filter");dojo.getObject("data.util.filter",true,dojo);dojo.data.util.filter.patternToRegExp=function(_1b9,_1ba){var rxp="^";var c=null;for(var i=0;i<_1b9.length;i++){c=_1b9.charAt(i);switch(c){case "\\":rxp+=c;i++;rxp+=_1b9.charAt(i);break;case "*":rxp+=".*";break;case "?":rxp+=".";break;case "$":case "^":case "/":case "+":case ".":case "|":case "(":case ")":case "{":case "}":case "[":case "]":rxp+="\\";default:rxp+=c;}}rxp+="$";if(_1ba){return new RegExp(rxp,"mi");}else{return new RegExp(rxp,"m");}};}if(!dojo._hasResource["dojo.data.util.sorter"]){dojo._hasResource["dojo.data.util.sorter"]=true;dojo.provide("dojo.data.util.sorter");dojo.getObject("data.util.sorter",true,dojo);dojo.data.util.sorter.basicComparator=function(a,b){var r=-1;if(a===null){a=undefined;}if(b===null){b=undefined;}if(a==b){r=0;}else{if(a>b||a==null){r=1;}}return r;};dojo.data.util.sorter.createSortFunction=function(_1bb,_1bc){var _1bd=[];function _1be(attr,dir,comp,s){return function(_1bf,_1c0){var a=s.getValue(_1bf,attr);var b=s.getValue(_1c0,attr);return dir*comp(a,b);};};var _1c1;var map=_1bc.comparatorMap;var bc=dojo.data.util.sorter.basicComparator;for(var i=0;i<_1bb.length;i++){_1c1=_1bb[i];var attr=_1c1.attribute;if(attr){var dir=(_1c1.descending)?-1:1;var comp=bc;if(map){if(typeof attr!=="string"&&("toString" in attr)){attr=attr.toString();}comp=map[attr]||bc;}_1bd.push(_1be(attr,dir,comp,_1bc));}}return function(rowA,rowB){var i=0;while(i<_1bd.length){var ret=_1bd[i++](rowA,rowB);if(ret!==0){return ret;}}return 0;};};}if(!dojo._hasResource["dojo.data.util.simpleFetch"]){dojo._hasResource["dojo.data.util.simpleFetch"]=true;dojo.provide("dojo.data.util.simpleFetch");dojo.getObject("data.util.simpleFetch",true,dojo);dojo.data.util.simpleFetch.fetch=function(_1c2){_1c2=_1c2||{};if(!_1c2.store){_1c2.store=this;}var self=this;var _1c3=function(_1c4,_1c5){if(_1c5.onError){var _1c6=_1c5.scope||dojo.global;_1c5.onError.call(_1c6,_1c4,_1c5);}};var _1c7=function(_1c8,_1c9){var _1ca=_1c9.abort||null;var _1cb=false;var _1cc=_1c9.start?_1c9.start:0;var _1cd=(_1c9.count&&(_1c9.count!==Infinity))?(_1cc+_1c9.count):_1c8.length;_1c9.abort=function(){_1cb=true;if(_1ca){_1ca.call(_1c9);}};var _1ce=_1c9.scope||dojo.global;if(!_1c9.store){_1c9.store=self;}if(_1c9.onBegin){_1c9.onBegin.call(_1ce,_1c8.length,_1c9);}if(_1c9.sort){_1c8.sort(dojo.data.util.sorter.createSortFunction(_1c9.sort,self));}if(_1c9.onItem){for(var i=_1cc;(i<_1c8.length)&&(i<_1cd);++i){var item=_1c8[i];if(!_1cb){_1c9.onItem.call(_1ce,item,_1c9);}}}if(_1c9.onComplete&&!_1cb){var _1cf=null;if(!_1c9.onItem){_1cf=_1c8.slice(_1cc,_1cd);}_1c9.onComplete.call(_1ce,_1cf,_1c9);}};this._fetchItems(_1c2,_1c7,_1c3);return _1c2;};}if(!dojo._hasResource["dojo.data.ItemFileReadStore"]){dojo._hasResource["dojo.data.ItemFileReadStore"]=true;dojo.provide("dojo.data.ItemFileReadStore");dojo.declare("dojo.data.ItemFileReadStore",null,{constructor:function(_1d0){this._arrayOfAllItems=[];this._arrayOfTopLevelItems=[];this._loadFinished=false;this._jsonFileUrl=_1d0.url;this._ccUrl=_1d0.url;this.url=_1d0.url;this._jsonData=_1d0.data;this.data=null;this._datatypeMap=_1d0.typeMap||{};if(!this._datatypeMap["Date"]){this._datatypeMap["Date"]={type:Date,deserialize:function(_1d1){return dojo.date.stamp.fromISOString(_1d1);}};}this._features={"dojo.data.api.Read":true,"dojo.data.api.Identity":true};this._itemsByIdentity=null;this._storeRefPropName="_S";this._itemNumPropName="_0";this._rootItemPropName="_RI";this._reverseRefMap="_RRM";this._loadInProgress=false;this._queuedFetches=[];if(_1d0.urlPreventCache!==undefined){this.urlPreventCache=_1d0.urlPreventCache?true:false;}if(_1d0.hierarchical!==undefined){this.hierarchical=_1d0.hierarchical?true:false;}if(_1d0.clearOnClose){this.clearOnClose=true;}if("failOk" in _1d0){this.failOk=_1d0.failOk?true:false;}},url:"",_ccUrl:"",data:null,typeMap:null,clearOnClose:false,urlPreventCache:false,failOk:false,hierarchical:true,_assertIsItem:function(item){if(!this.isItem(item)){throw new Error("dojo.data.ItemFileReadStore: Invalid item argument.");}},_assertIsAttribute:function(_1d2){if(typeof _1d2!=="string"){throw new Error("dojo.data.ItemFileReadStore: Invalid attribute argument.");}},getValue:function(item,_1d3,_1d4){var _1d5=this.getValues(item,_1d3);return (_1d5.length>0)?_1d5[0]:_1d4;},getValues:function(item,_1d6){this._assertIsItem(item);this._assertIsAttribute(_1d6);return (item[_1d6]||[]).slice(0);},getAttributes:function(item){this._assertIsItem(item);var _1d7=[];for(var key in item){if((key!==this._storeRefPropName)&&(key!==this._itemNumPropName)&&(key!==this._rootItemPropName)&&(key!==this._reverseRefMap)){_1d7.push(key);}}return _1d7;},hasAttribute:function(item,_1d8){this._assertIsItem(item);this._assertIsAttribute(_1d8);return (_1d8 in item);},containsValue:function(item,_1d9,_1da){var _1db=undefined;if(typeof _1da==="string"){_1db=dojo.data.util.filter.patternToRegExp(_1da,false);}return this._containsValue(item,_1d9,_1da,_1db);},_containsValue:function(item,_1dc,_1dd,_1de){return dojo.some(this.getValues(item,_1dc),function(_1df){if(_1df!==null&&!dojo.isObject(_1df)&&_1de){if(_1df.toString().match(_1de)){return true;}}else{if(_1dd===_1df){return true;}}});},isItem:function(_1e0){if(_1e0&&_1e0[this._storeRefPropName]===this){if(this._arrayOfAllItems[_1e0[this._itemNumPropName]]===_1e0){return true;}}return false;},isItemLoaded:function(_1e1){return this.isItem(_1e1);},loadItem:function(_1e2){this._assertIsItem(_1e2.item);},getFeatures:function(){return this._features;},getLabel:function(item){if(this._labelAttr&&this.isItem(item)){return this.getValue(item,this._labelAttr);}return undefined;},getLabelAttributes:function(item){if(this._labelAttr){return [this._labelAttr];}return null;},_fetchItems:function(_1e3,_1e4,_1e5){var self=this,_1e6=function(_1e7,_1e8){var _1e9=[],i,key;if(_1e7.query){var _1ea,_1eb=_1e7.queryOptions?_1e7.queryOptions.ignoreCase:false;var _1ec={};for(key in _1e7.query){_1ea=_1e7.query[key];if(typeof _1ea==="string"){_1ec[key]=dojo.data.util.filter.patternToRegExp(_1ea,_1eb);}else{if(_1ea instanceof RegExp){_1ec[key]=_1ea;}}}for(i=0;i<_1e8.length;++i){var _1ed=true;var _1ee=_1e8[i];if(_1ee===null){_1ed=false;}else{for(key in _1e7.query){_1ea=_1e7.query[key];if(!self._containsValue(_1ee,key,_1ea,_1ec[key])){_1ed=false;}}}if(_1ed){_1e9.push(_1ee);}}_1e4(_1e9,_1e7);}else{for(i=0;i<_1e8.length;++i){var item=_1e8[i];if(item!==null){_1e9.push(item);}}_1e4(_1e9,_1e7);}};if(this._loadFinished){_1e6(_1e3,this._getItemsArray(_1e3.queryOptions));}else{if(this._jsonFileUrl!==this._ccUrl){dojo.deprecated("dojo.data.ItemFileReadStore: ","To change the url, set the url property of the store,"+" not _jsonFileUrl.  _jsonFileUrl support will be removed in 2.0");this._ccUrl=this._jsonFileUrl;this.url=this._jsonFileUrl;}else{if(this.url!==this._ccUrl){this._jsonFileUrl=this.url;this._ccUrl=this.url;}}if(this.data!=null){this._jsonData=this.data;this.data=null;}if(this._jsonFileUrl){if(this._loadInProgress){this._queuedFetches.push({args:_1e3,filter:_1e6});}else{this._loadInProgress=true;var _1ef={url:self._jsonFileUrl,handleAs:"json-comment-optional",preventCache:this.urlPreventCache,failOk:this.failOk};var _1f0=dojo.xhrGet(_1ef);_1f0.addCallback(function(data){try{self._getItemsFromLoadedData(data);self._loadFinished=true;self._loadInProgress=false;_1e6(_1e3,self._getItemsArray(_1e3.queryOptions));self._handleQueuedFetches();}catch(e){self._loadFinished=true;self._loadInProgress=false;_1e5(e,_1e3);}});_1f0.addErrback(function(_1f1){self._loadInProgress=false;_1e5(_1f1,_1e3);});var _1f2=null;if(_1e3.abort){_1f2=_1e3.abort;}_1e3.abort=function(){var df=_1f0;if(df&&df.fired===-1){df.cancel();df=null;}if(_1f2){_1f2.call(_1e3);}};}}else{if(this._jsonData){try{this._loadFinished=true;this._getItemsFromLoadedData(this._jsonData);this._jsonData=null;_1e6(_1e3,this._getItemsArray(_1e3.queryOptions));}catch(e){_1e5(e,_1e3);}}else{_1e5(new Error("dojo.data.ItemFileReadStore: No JSON source data was provided as either URL or a nested Javascript object."),_1e3);}}}},_handleQueuedFetches:function(){if(this._queuedFetches.length>0){for(var i=0;i<this._queuedFetches.length;i++){var _1f3=this._queuedFetches[i],_1f4=_1f3.args,_1f5=_1f3.filter;if(_1f5){_1f5(_1f4,this._getItemsArray(_1f4.queryOptions));}else{this.fetchItemByIdentity(_1f4);}}this._queuedFetches=[];}},_getItemsArray:function(_1f6){if(_1f6&&_1f6.deep){return this._arrayOfAllItems;}return this._arrayOfTopLevelItems;},close:function(_1f7){if(this.clearOnClose&&this._loadFinished&&!this._loadInProgress){if(((this._jsonFileUrl==""||this._jsonFileUrl==null)&&(this.url==""||this.url==null))&&this.data==null){console.debug("dojo.data.ItemFileReadStore: WARNING!  Data reload "+" information has not been provided."+"  Please set 'url' or 'data' to the appropriate value before"+" the next fetch");}this._arrayOfAllItems=[];this._arrayOfTopLevelItems=[];this._loadFinished=false;this._itemsByIdentity=null;this._loadInProgress=false;this._queuedFetches=[];}},_getItemsFromLoadedData:function(_1f8){var _1f9=false,self=this;function _1fa(_1fb){var _1fc=((_1fb!==null)&&(typeof _1fb==="object")&&(!dojo.isArray(_1fb)||_1f9)&&(!dojo.isFunction(_1fb))&&(_1fb.constructor==Object||dojo.isArray(_1fb))&&(typeof _1fb._reference==="undefined")&&(typeof _1fb._type==="undefined")&&(typeof _1fb._value==="undefined")&&self.hierarchical);return _1fc;};function _1fd(_1fe){self._arrayOfAllItems.push(_1fe);for(var _1ff in _1fe){var _200=_1fe[_1ff];if(_200){if(dojo.isArray(_200)){var _201=_200;for(var k=0;k<_201.length;++k){var _202=_201[k];if(_1fa(_202)){_1fd(_202);}}}else{if(_1fa(_200)){_1fd(_200);}}}}};this._labelAttr=_1f8.label;var i,item;this._arrayOfAllItems=[];this._arrayOfTopLevelItems=_1f8.items;for(i=0;i<this._arrayOfTopLevelItems.length;++i){item=this._arrayOfTopLevelItems[i];if(dojo.isArray(item)){_1f9=true;}_1fd(item);item[this._rootItemPropName]=true;}var _203={},key;for(i=0;i<this._arrayOfAllItems.length;++i){item=this._arrayOfAllItems[i];for(key in item){if(key!==this._rootItemPropName){var _204=item[key];if(_204!==null){if(!dojo.isArray(_204)){item[key]=[_204];}}else{item[key]=[null];}}_203[key]=key;}}while(_203[this._storeRefPropName]){this._storeRefPropName+="_";}while(_203[this._itemNumPropName]){this._itemNumPropName+="_";}while(_203[this._reverseRefMap]){this._reverseRefMap+="_";}var _205;var _206=_1f8.identifier;if(_206){this._itemsByIdentity={};this._features["dojo.data.api.Identity"]=_206;for(i=0;i<this._arrayOfAllItems.length;++i){item=this._arrayOfAllItems[i];_205=item[_206];var _207=_205[0];if(!Object.hasOwnProperty.call(this._itemsByIdentity,_207)){this._itemsByIdentity[_207]=item;}else{if(this._jsonFileUrl){throw new Error("dojo.data.ItemFileReadStore:  The json data as specified by: ["+this._jsonFileUrl+"] is malformed.  Items within the list have identifier: ["+_206+"].  Value collided: ["+_207+"]");}else{if(this._jsonData){throw new Error("dojo.data.ItemFileReadStore:  The json data provided by the creation arguments is malformed.  Items within the list have identifier: ["+_206+"].  Value collided: ["+_207+"]");}}}}}else{this._features["dojo.data.api.Identity"]=Number;}for(i=0;i<this._arrayOfAllItems.length;++i){item=this._arrayOfAllItems[i];item[this._storeRefPropName]=this;item[this._itemNumPropName]=i;}for(i=0;i<this._arrayOfAllItems.length;++i){item=this._arrayOfAllItems[i];for(key in item){_205=item[key];for(var j=0;j<_205.length;++j){_204=_205[j];if(_204!==null&&typeof _204=="object"){if(("_type" in _204)&&("_value" in _204)){var type=_204._type;var _208=this._datatypeMap[type];if(!_208){throw new Error("dojo.data.ItemFileReadStore: in the typeMap constructor arg, no object class was specified for the datatype '"+type+"'");}else{if(dojo.isFunction(_208)){_205[j]=new _208(_204._value);}else{if(dojo.isFunction(_208.deserialize)){_205[j]=_208.deserialize(_204._value);}else{throw new Error("dojo.data.ItemFileReadStore: Value provided in typeMap was neither a constructor, nor a an object with a deserialize function");}}}}if(_204._reference){var _209=_204._reference;if(!dojo.isObject(_209)){_205[j]=this._getItemByIdentity(_209);}else{for(var k=0;k<this._arrayOfAllItems.length;++k){var _20a=this._arrayOfAllItems[k],_20b=true;for(var _20c in _209){if(_20a[_20c]!=_209[_20c]){_20b=false;}}if(_20b){_205[j]=_20a;}}}if(this.referenceIntegrity){var _20d=_205[j];if(this.isItem(_20d)){this._addReferenceToMap(_20d,item,key);}}}else{if(this.isItem(_204)){if(this.referenceIntegrity){this._addReferenceToMap(_204,item,key);}}}}}}}},_addReferenceToMap:function(_20e,_20f,_210){},getIdentity:function(item){var _211=this._features["dojo.data.api.Identity"];if(_211===Number){return item[this._itemNumPropName];}else{var _212=item[_211];if(_212){return _212[0];}}return null;},fetchItemByIdentity:function(_213){var item,_214;if(!this._loadFinished){var self=this;if(this._jsonFileUrl!==this._ccUrl){dojo.deprecated("dojo.data.ItemFileReadStore: ","To change the url, set the url property of the store,"+" not _jsonFileUrl.  _jsonFileUrl support will be removed in 2.0");this._ccUrl=this._jsonFileUrl;this.url=this._jsonFileUrl;}else{if(this.url!==this._ccUrl){this._jsonFileUrl=this.url;this._ccUrl=this.url;}}if(this.data!=null&&this._jsonData==null){this._jsonData=this.data;this.data=null;}if(this._jsonFileUrl){if(this._loadInProgress){this._queuedFetches.push({args:_213});}else{this._loadInProgress=true;var _215={url:self._jsonFileUrl,handleAs:"json-comment-optional",preventCache:this.urlPreventCache,failOk:this.failOk};var _216=dojo.xhrGet(_215);_216.addCallback(function(data){var _217=_213.scope?_213.scope:dojo.global;try{self._getItemsFromLoadedData(data);self._loadFinished=true;self._loadInProgress=false;item=self._getItemByIdentity(_213.identity);if(_213.onItem){_213.onItem.call(_217,item);}self._handleQueuedFetches();}catch(error){self._loadInProgress=false;if(_213.onError){_213.onError.call(_217,error);}}});_216.addErrback(function(_218){self._loadInProgress=false;if(_213.onError){var _219=_213.scope?_213.scope:dojo.global;_213.onError.call(_219,_218);}});}}else{if(this._jsonData){self._getItemsFromLoadedData(self._jsonData);self._jsonData=null;self._loadFinished=true;item=self._getItemByIdentity(_213.identity);if(_213.onItem){_214=_213.scope?_213.scope:dojo.global;_213.onItem.call(_214,item);}}}}else{item=this._getItemByIdentity(_213.identity);if(_213.onItem){_214=_213.scope?_213.scope:dojo.global;_213.onItem.call(_214,item);}}},_getItemByIdentity:function(_21a){var item=null;if(this._itemsByIdentity&&Object.hasOwnProperty.call(this._itemsByIdentity,_21a)){item=this._itemsByIdentity[_21a];}else{if(Object.hasOwnProperty.call(this._arrayOfAllItems,_21a)){item=this._arrayOfAllItems[_21a];}}if(item===undefined){item=null;}return item;},getIdentityAttributes:function(item){var _21b=this._features["dojo.data.api.Identity"];if(_21b===Number){return null;}else{return [_21b];}},_forceLoad:function(){var self=this;if(this._jsonFileUrl!==this._ccUrl){dojo.deprecated("dojo.data.ItemFileReadStore: ","To change the url, set the url property of the store,"+" not _jsonFileUrl.  _jsonFileUrl support will be removed in 2.0");this._ccUrl=this._jsonFileUrl;this.url=this._jsonFileUrl;}else{if(this.url!==this._ccUrl){this._jsonFileUrl=this.url;this._ccUrl=this.url;}}if(this.data!=null){this._jsonData=this.data;this.data=null;}if(this._jsonFileUrl){var _21c={url:this._jsonFileUrl,handleAs:"json-comment-optional",preventCache:this.urlPreventCache,failOk:this.failOk,sync:true};var _21d=dojo.xhrGet(_21c);_21d.addCallback(function(data){try{if(self._loadInProgress!==true&&!self._loadFinished){self._getItemsFromLoadedData(data);self._loadFinished=true;}else{if(self._loadInProgress){throw new Error("dojo.data.ItemFileReadStore:  Unable to perform a synchronous load, an async load is in progress.");}}}catch(e){console.log(e);throw e;}});_21d.addErrback(function(_21e){throw _21e;});}else{if(this._jsonData){self._getItemsFromLoadedData(self._jsonData);self._jsonData=null;self._loadFinished=true;}}}});dojo.extend(dojo.data.ItemFileReadStore,dojo.data.util.simpleFetch);}if(!dojo._hasResource["toura.models.TextAsset"]){dojo._hasResource["toura.models.TextAsset"]=true;dojo.provide("toura.models.TextAsset");dojo.declare("toura.models.TextAsset",null,{constructor:function(_21f,item){dojo.mixin(this,{id:_21f.getValue(item,"id"),body:_21f.getValue(item,"body"),name:_21f.getValue(item,"name"),contexts:_21f.getValues(item,"contexts")});}});}if(!dojo._hasResource["toura.URL"]){dojo._hasResource["toura.URL"]=true;dojo.provide("toura.URL");toura.URL={home:function(){return "#/home";},about:function(){return "#/about";},maps:function(){return "#/maps";},favorites:function(){return "#/favorites";},node:function(_220){return "#/node/"+_220;},search:function(){return "#/search";},searchTerm:function(term){return toura.URL.search()+"/"+term;},searchResult:function(_221){var url=["node",_221.node];if(_221.type!=="node"){url.push(_221.type,_221.id);}return "#/"+url.join("/");},update:function(){return "#/update";},storedAsset:function(type,_222){var dirs={"image":"images","video":"videos","audio":"audios","html":"html","videoPoster":"videos/poster"};return ["media",dirs[type],_222].join("/");},feedItem:function(_223,_224){return "/feed/"+_223+"/item/"+_224;}};}if(!dojo._hasResource["toura.models.SimpleNode"]){dojo._hasResource["toura.models.SimpleNode"]=true;dojo.provide("toura.models.SimpleNode");(function(){var _225={};dojo.subscribe("/tour/update",function(){_225={};});dojo.declare("toura.models.SimpleNode",null,{constructor:function(_226,item){var id=_226.getValue(item,"id");if(_225[id]){dojo.mixin(this,_225[id]);return;}dojo.mixin(this,{id:_226.getValue(item,"id"),name:_226.getValue(item,"name")});this.url=toura.URL.node(this.id);_225[id]=this;}});}());}if(!dojo._hasResource["toura.models._CaptionedAsset"]){dojo._hasResource["toura.models._CaptionedAsset"]=true;dojo.provide("toura.models._CaptionedAsset");dojo.declare("toura.models._CaptionedAsset",null,{_processCaption:function(_227,item){if(!item.caption){return;}_227.fetchItemByIdentity({identity:item.caption._reference,onItem:function(item){dojo.mixin(this,{caption:_227.getValue(item,"body"),name:_227.getValue(item,"name")||this.name});},scope:this});}});}if(!dojo._hasResource["toura.models._StorableAsset"]){dojo._hasResource["toura.models._StorableAsset"]=true;dojo.provide("toura.models._StorableAsset");(function(){var _228=toura.URL.storedAsset;dojo.declare("toura.models._StorableAsset",[],{_getUrl:function(_229,item){this.store=_229;var _22a=_229.getValue(item,"type"),_22b=_22a==="image"?["featuredSmall","featured","gallery","original"]:false;if(_22b){dojo.forEach(_22b,function(_22c){var t=this[_22c]=_229.getValue(item,_22c),_22d=this._isStreamed(item,_22c);t.url=(_22d&&t.url)?t.url:_228(_22a,t.filename);},this);}else{var url=_229.getValue(item,"url");this.url=(this._isStreamed(item)&&url)?url:_228(_22a,_229.getValue(item,"filename"));}},_isStreamed:function(item,type){if(mulberry.forceStreaming){return true;}if(mulberry.forceLocal){return false;}if(!toura.manifest){return true;}if(!toura.manifest||this.store.getValue(item,"streamed")){return true;}var _22e=type?this.store.getValue(item,type).filename:this.store.getValue(item,"filename");var _22f=toura.manifest[this.store.getValue(item,"type")+"s"];if(!_22f||!dojo.isArray(_22f)){return true;}if(dojo.indexOf(_22f,_22e)>-1){return false;}return true;}});}());}if(!dojo._hasResource["toura.models.Image"]){dojo._hasResource["toura.models.Image"]=true;dojo.provide("toura.models.Image");dojo.declare("toura.models.Image",[toura.models._CaptionedAsset,toura.models._StorableAsset],{constructor:function(_230,item){_230.fetchItemByIdentity({identity:item.image._reference,onItem:function(item){dojo.mixin(this,{id:_230.getValue(item,"id"),name:_230.getValue(item,"name"),height:_230.getValue(item,"height")||null,width:_230.getValue(item,"width")||null});this._getUrl(_230,item);},scope:this});this._processCaption(_230,item);}});}if(!dojo._hasResource["toura.models.HeaderImage"]){dojo._hasResource["toura.models.HeaderImage"]=true;dojo.provide("toura.models.HeaderImage");dojo.declare("toura.models.HeaderImage",[toura.models._StorableAsset,toura.models._CaptionedAsset],{constructor:function(_231,item){dojo.mixin(this,{id:_231.getValue(item,"id"),name:_231.getValue(item,"name"),height:_231.getValue(item,"height")||null,width:_231.getValue(item,"width")||null});this._getUrl(_231,item);this._processCaption(_231,item);this.destination=/^http/.test(this.name)?this.name:false;}});}if(!dojo._hasResource["toura.models.BackgroundImage"]){dojo._hasResource["toura.models.BackgroundImage"]=true;dojo.provide("toura.models.BackgroundImage");dojo.declare("toura.models.BackgroundImage",toura.models._StorableAsset,{constructor:function(_232,item){dojo.mixin(this,{id:_232.getValue(item,"id"),name:_232.getValue(item,"name"),height:_232.getValue(item,"height")||null,width:_232.getValue(item,"width")||null});this._getUrl(_232,item);}});}if(!dojo._hasResource["toura.models.FeaturedImage"]){dojo._hasResource["toura.models.FeaturedImage"]=true;dojo.provide("toura.models.FeaturedImage");dojo.declare("toura.models.FeaturedImage",toura.models._StorableAsset,{constructor:function(_233,item){if(item.image){_233.fetchItemByIdentity({identity:item.image._reference,onItem:function(_234){item=_234;}});}this._getUrl(_233,item);this.small=this.featuredSmall;this.large=this.featured;delete this.featured_small;delete this.featured;delete this.gallery;delete this.original;}});}if(!dojo._hasResource["toura.models.Video"]){dojo._hasResource["toura.models.Video"]=true;dojo.provide("toura.models.Video");dojo.declare("toura.models.Video",[toura.models._CaptionedAsset,toura.models._StorableAsset],{constructor:function(_235,item){if(!item.video){dojo.mixin(this,{id:_235.getValue(item,"id"),name:_235.getValue(item,"name"),url:_235.getValue(item,"url")});return;}_235.fetchItemByIdentity({identity:item.video._reference,onItem:function(item){dojo.mixin(this,{id:_235.getValue(item,"id"),name:_235.getValue(item,"name"),poster:_235.getValue(item,"poster")});this._getUrl(_235,item);},scope:this});this._processCaption(_235,item);if(this.poster){this.poster=this._posterOnDevice()?toura.URL.storedAsset("videoPoster",this.poster.filename):this.poster.url;}},_posterOnDevice:function(){var _236=this.poster.filename;return toura.manifest&&toura.manifest.videos&&dojo.indexOf(toura.manifest.videos.posters||[],_236)>-1;}});}if(!dojo._hasResource["toura.models.Audio"]){dojo._hasResource["toura.models.Audio"]=true;dojo.provide("toura.models.Audio");dojo.declare("toura.models.Audio",[toura.models._CaptionedAsset,toura.models._StorableAsset],{constructor:function(_237,item){_237.fetchItemByIdentity({identity:item.audio._reference,onItem:function(item){dojo.mixin(this,{id:_237.getValue(item,"id"),name:_237.getValue(item,"name")});this._getUrl(_237,item);},scope:this});this._processCaption(_237,item);}});}if(!dojo._hasResource["toura.models.Data"]){dojo._hasResource["toura.models.Data"]=true;dojo.provide("toura.models.Data");dojo.declare("toura.models.Data",null,{constructor:function(_238,item){_238.fetchItemByIdentity({identity:item.dataAsset._reference,onItem:function(item){dojo.mixin(this,{id:_238.getValue(item,"id"),name:_238.getValue(item,"name"),type:_238.getValue(item,"dataType"),json:JSON.parse(_238.getValue(item,"value"))});},scope:this});}});}if(!dojo._hasResource["toura.models.GoogleMapPin"]){dojo._hasResource["toura.models.GoogleMapPin"]=true;dojo.provide("toura.models.GoogleMapPin");dojo.declare("toura.models.GoogleMapPin",toura.models._CaptionedAsset,{constructor:function(_239,item){_239.fetchItemByIdentity({identity:item.googleMapPin._reference,onItem:function(item){dojo.mixin(this,{id:_239.getValue(item,"id"),name:_239.getValue(item,"name"),lat:_239.getValue(item,"lat"),lon:_239.getValue(item,"lon"),address:_239.getValue(item,"address"),phoneNumber:_239.getValue(item,"phoneNumber"),website:_239.getValue(item,"website")});},scope:this});this._processCaption(_239,item);}});}if(!dojo._hasResource["toura.models.Feed"]){dojo._hasResource["toura.models.Feed"]=true;dojo.provide("toura.models.Feed");(function(){dojo.declare("toura.models.Feed",null,{throttle:5*60*1000,constructor:function(_23a,item){if(item&&item.feed){_23a.fetchItemByIdentity({identity:item.feed._reference,onItem:function(item){dojo.mixin(this,{feedUrl:_23a.getValue(item,"feedUrl"),id:_23a.getValue(item,"id"),name:_23a.getValue(item,"name")});},scope:this});}else{dojo.mixin(this,{feedUrl:_23a.getValue(item,"feedUrl"),id:_23a.getValue(item,"id"),name:_23a.getValue(item,"name")});}this.lastChecked=mulberry.app.DeviceStorage.get(this.id+"-checked");},load:function(){var fn=mulberry.app.PhoneGap.present?dojo.hitch(dojo,"xhrGet"):dojo.hitch(dojo.io.script,"get"),dfd=new dojo.Deferred();if(new Date().getTime()-this.lastChecked<this.throttle){dfd.resolve(this._get());}else{mulberry.app.PhoneGap.network.isReachable().then(dojo.hitch(this,function(_23b){if(!_23b){dfd.resolve(this._get());return;}fn(this._createArgs(dfd));}));}return dfd.promise;},getItem:function(_23c){this._get();var item=this.items[_23c];item.siblings=this.items;return item;},_onLoad:function(dfd,data){this.lastChecked=new Date().getTime();if(data&&data.query&&data.query.results&&data.query.results.item){this.items=dojo.map(data.query.results.item,function(item,_23d){item.index=_23d;return new toura.models.FeedItem(item,this);},this);this.updated=new dojo.date.stamp.fromISOString(data.query.created);}else{console.warn("There were no results for feed",this.id,data);this.items=[];}this._store();dfd.resolve(this._get());},_onError:function(dfd){dfd.resolve(this._get()||[]);},_store:function(){mulberry.app.DeviceStorage.set(this.id,this.items);mulberry.app.DeviceStorage.set(this.id+"-checked",this.lastChecked);},_get:function(){this.items=dojo.map(mulberry.app.DeviceStorage.get(this.id)||[],function(item){item.pubDate=new Date(item.pubDate);return item;});return this.items;},_createArgs:function(dfd){var req={url:"http://query.yahooapis.com/v1/public/yql",content:{q:"select * from feed where url='{{feed}}' limit 15".replace("{{feed}}",this.feedUrl),format:"json"},preventCache:true,load:dojo.hitch(this,"_onLoad",dfd),error:dojo.hitch(this,"_onError",dfd)};if(!mulberry.app.PhoneGap.present){req.callbackParamName="callback";}else{req.handleAs="json";}return req;}});dojo.declare("toura.models.FeedItem",null,{constructor:function(item,feed){this.type="feedItem";dojo.mixin(this,{title:item.title||"",body:item.description||"",url:toura.URL.feedItem(feed.id,item.index),link:item.link,pubDate:item.pubDate,name:item.title,feedName:feed.name,id:feed.id+"-"+item.index});if(dojo.isObject(this.body)){this.body=this.body.content||null;}if(dojo.isObject(this.link)){this.link=this.link.content||null;}if(dojo.isObject(this.title)){this.title=this.title.content||null;}this.image=this._getImage(item);this.author=this._getAuthor(item);},_getImage:function(item){var enc=item.enclosure||item.content;if(enc&&enc.type&&enc.type.match(/(jpeg|png)/i)){return {url:enc.url};}return "";},_getAuthor:function(item){var _23e=item.author;if(_23e&&_23e.displayName){return _23e.displayName;}return "";}});}());}if(!dojo._hasResource["toura.models.Node"]){dojo._hasResource["toura.models.Node"]=true;dojo.provide("toura.models.Node");(function(){var _23f={};dojo.subscribe("/tour/update",function(){_23f={};});dojo.declare("toura.models.Node",null,{constructor:function(_240,item){var id=_240.getValue(item,"id"),_241=mulberry.Device;if(_23f[id]){dojo.mixin(this,_23f[id]);return;}this.store=_240;this._dataCache={};var _242=function(_243,_244){return dojo.map(_240.getValues(item,_243)||[],function(_245){return new _244(_240,_245);});};dojo.mixin(this,{type:"node",id:id,name:_240.getValue(item,"name"),headerImage:{phone:_242("phoneHeaderImage",toura.models.HeaderImage)[0],tablet:_242("tabletHeaderImage",toura.models.HeaderImage)[0]},backgroundImage:{phone:_242("phoneBackgroundImage",toura.models.BackgroundImage)[0],tablet:_242("tabletBackgroundImage",toura.models.BackgroundImage)[0]},featuredImage:_242("featuredImage",toura.models.FeaturedImage)[0],children:_240.getValues(item,"children"),bodyText:_240.getValue(item,"bodyText"),images:_242("images",toura.models.Image),audios:_242("audios",toura.models.Audio),videos:_242("videos",toura.models.Video),data:_242("dataAssets",toura.models.Data),staticMapImages:_242("imageMapImages",toura.models.Image),googleMapPins:_242("googleMapPins",toura.models.GoogleMapPin),feeds:_242("feeds",toura.models.Feed),pageDef:_240.getValue(item,"pageController"),sharingURL:_240.getValue(item,"sharingUrl"),parent:_240.getValue(item,"parent")});dojo.mixin(this,{url:toura.URL.node(this.id),bodyText:this.bodyText&&new toura.models.TextAsset(_240,this.bodyText),assetTypeUrl:function(type){return this.url+"/"+type;},parent:this.parent&&new toura.models.Node(_240,this.parent),isHomeNode:this.id===mulberry.app.Config.get("app").homeNodeId});this.pageDef=dojo.isObject(this.pageDef)?this.pageDef[_241.type]:this.pageDef;if(!this.pageDef){this.pageDef="default";}this.siblings=this.parent?dojo.map(this.parent.children,function(c){return new toura.models.SimpleNode(this.store,c);},this):[];this._assetCache={};dojo.forIn(_240.getValue(item,"custom"),function(k,v){this[k]=this[k]||v;},this);_23f[id]=this;},_pluralize:function(type){var _246={"google-map-pin":"googleMapPins","image":"images","video":"videos","audio":"audios","static-map-image":"staticMapImages"};if(!_246[type]){console.warn("toura.models.Node::_pluralize(): no property found for",type);}return _246[type]||(type+"s");},getAssetById:function(type,id){var key=type+id,_247,_248;if(!this._assetCache[key]){_248=this[this._pluralize(type)];if(!_248){console.warn("toura.models.Node::getAssetById(): No matching asset property found for",type);_248=[];}_247=dojo.filter(_248,function(a){return a.id===id;});this._assetCache[key]=_247.length?_247[0]:false;}return this._assetCache[key];},getBackgroundImage:function(_249){var _24a=_249.type==="phone"?"gallery":"original";if(this.backgroundImage&&this.backgroundImage[_249.type]){return this.backgroundImage[_249.type][_24a];}return false;},populateChildren:function(){if(this.childrenPopulated){return;}this.children=dojo.map(this.children,function(c){return new toura.models.Node(this.store,c);},this);this.childrenPopulated=true;},getData:function(type){if(!this._dataCache[type]){var _24b=dojo.filter(this.data,function(d){return d.type===type;});this._dataCache[type]=!_24b.length?false:_24b[0].json;}return this._dataCache[type];}});}());}if(!dojo._hasResource["toura.models.SearchResult"]){dojo._hasResource["toura.models.SearchResult"]=true;dojo.provide("toura.models.SearchResult");dojo.declare("toura.models.SearchResult",null,{constructor:function(_24c,item){var _24d=item.context,_24e=item.textAsset,node;if(!_24d){node=new toura.models.Node(_24c,item);dojo.mixin(this,{type:"node",nodeId:node.id,displayName:node.name,displayText:node.bodyText?node.bodyText.body||"":"",url:toura.URL.searchResult({type:"node",node:node.id}),nodeTitle:node.name});return;}dojo.mixin(this,{nodeId:_24d.node,type:_24d.type,displayName:_24e.name,displayText:_24e.body,url:toura.URL.searchResult(_24d)});_24c.fetchItemByIdentity({identity:_24d.node,onItem:function(item){var n=new toura.models.Node(_24c,item);this.nodeTitle=n.name;if(_24d.type!=="node"){this.asset=n.getAssetById(_24d.type,_24d.id);}},scope:this});}});}if(!dojo._hasResource["toura.Data"]){dojo._hasResource["toura.Data"]=true;dojo.provide("toura.Data");dojo.declare("toura.Data",null,{cache:{},searchCache:{},models:{node:toura.models.Node,backgroundImage:toura.models.BackgroundImage,feed:toura.models.Feed,featuredImage:toura.models.FeaturedImage},constructor:function(data){this.loadData(data);},loadData:function(data){this.cache={};this.searchCache={};this._store=new dojo.data.ItemFileReadStore({data:{identifier:"id",items:data},hierarchical:false});this.onLoadData(data);},onLoadData:function(data){dojo.publish("/data/loaded",[data]);},getModel:function(id,type){if(!id){throw new Error("toura.Data::getModel requires an id. Possibly your hash string is invalid?");}if(!dojo.isString(id)){throw new Error("toura.Data::getModel requires the id to be a string");}var _24f=this.cache,_250=this._store,item,_251;if(!_24f[id]){item=this.getById(id);if(!item){return false;}type=type||_250.getValue(item,"type");_251=this.models[type];if(item&&!_251){throw new Error("toura.Data::getModel no model for type "+type);}_24f[id]=new _251(_250,item);}return _24f[id];},getById:function(id){var ret;this._store.fetchItemByIdentity({identity:id,scope:this,onItem:dojo.hitch(this,function(item){ret=item;})});return ret;},search:function(term){if(!term||!dojo.trim(term)){return [];}term=dojo.trim(term.replace(/\W/g," "));if(this.searchCache[term]){return this.searchCache[term];}var _252=[],_253=[],_254=this._store,_255=function(_256){_252=_252.concat(_256);},re=new RegExp(term,"i"),seen={},_257,_258=toura.models.SearchResult;var _259=[{type:"text-asset",body:re},{type:"text-asset",name:re}];dojo.forEach(_259,function(q){_254.fetch({query:q,onComplete:_255});});dojo.forEach(_252,function(a){var ta=new toura.models.TextAsset(_254,a);_253=_253.concat(dojo.map(ta.contexts,function(c){return new _258(_254,{textAsset:ta,context:c});}));},this);_254.fetch({query:{type:"node",name:re},onComplete:function(_25a){_253=_253.concat(dojo.map(_25a,function(item){return new _258(_254,item);}));}});_254.fetch({query:{type:"node",identifier:re},onComplete:function(_25b){_257=dojo.map(_25b,function(item){return new toura.models.SearchResult(_254,item);});}});_253=_257.concat(_253);_253=dojo.filter(_253,function(r){if(seen[r.nodeId]&&r.type==="node"){return false;}if(seen[r.url]){return false;}seen[r.url]=true;seen[r.nodeId]=true;return true;});this.searchCache[term]=_253;return _253;}});}if(!dojo._hasResource["toura.Manifest"]){dojo._hasResource["toura.Manifest"]=true;dojo.provide("toura.Manifest");dojo.declare("toura.Manifest",null,{url:"./media/manifest.js",constructor:function(){dojo.when(this._load(),dojo.hitch(this,"_parse"));},_load:function(){return this.manifest||dojo.io.script.get({url:this.url});},_parse:function(){if(!toura.manifest){toura.manifest={};return;}var _25c={};this._parseDir(_25c,toura.manifest.dirs);toura.manifest=_25c;},_parseDir:function(base,obj){dojo.forIn(obj,function(_25d,_25e){base[_25d]=_25e.files?_25e.files:[];if(_25e.dirs){dojo.forIn(_25e.dirs,function(_25f,_260){this._parseDir(base[_25d],_260);},this);}},this);}});dojo.subscribe("/app/deviceready",function(){toura.Manifest=new toura.Manifest();});}if(!dojo._hasResource["toura.Routes"]){dojo._hasResource["toura.Routes"]=true;dojo.provide("toura.Routes");(function(){var _261=(function(){var _262,app=function(){var _263=mulberry.app.Config.get("app");app=function(){return _263;};return _263;},_264=mulberry.Device,_265;function _266(){if(!_265){_265=mulberry.app.Config.get("app").backgroundImage;if(_265){_265=_265[_264.type];_265=_265?toura.Data.getModel(_265,"backgroundImage")[_264.type==="phone"?"gallery":"original"]:"";}}return _265;};function _267(_268,_269,_26a){_26a=_26a||{};var _26b=toura.Data.getModel(_269),page=mulberry.app.UI.currentPage,pf,_26c;if(!_26b){console.log("Request for invalid hash",_268.hash);mulberry.app.Router.home();return;}if(!page||!page.node||_269!==page.node.id){try{pf=mulberry.createPage(dojo.mixin(_26b,{pageBackground:_26b.getBackgroundImage(_264)||_266()}));}catch(e){console.error("toura.Routes: can't create a page",e,_26b);if(_269!=="node-home"){mulberry.app.Router.back();}return;}if(pf.failure){if(dojo.isString(pf.failure)){mulberry.app.PhoneGap.notification.alert(pf.failure);}mulberry.app.Router.back();return;}pf.init(_26a);mulberry.app.UI.showPage(pf,_26b);}else{page.init(_26a);}if(_269&&!_26a.assetType){dojo.publish("/node/view",[_268.hash]);}mulberry.endLogSection("NODE ROUTE");return true;};_262=[{route:"/home",handler:function(_26d,_26e){toura.lastSearchTerm=null;return _267(_26e,app().homeNodeId);},isDefault:true},{route:"/about",handler:function(_26f,_270){return _267(_270,app().aboutNodeId);}},{route:"/maps",handler:function(_271,_272){return _267(_272,app().mapNodeId);}},{route:/\/node\/(.*)/,handler:function(_273,_274){var _275=_273.splat[0].split("/"),_276=_275[0],_277={assetType:_275[1],assetId:_275[2],assetSubId:_275[3]};return _267(_274,_276,_277);}},{route:/\/search\/?(.*)/,handler:function(_278){var page=mulberry.app.UI.currentPage,term=_278.splat&&_278.splat[0].split("/")[0];page=mulberry.createPage({pageDef:"search",term:term,getResults:dojo.hitch(toura.Data,"search"),backgroundImage:_266()});mulberry.app.UI.showPage(page);return true;}},{route:"/feed/:feedId/item/:itemIndex",handler:function(_279){var feed=toura.Data.getModel(_279.feedId,"feed"),_27a=feed.getItem(_279.itemIndex),page=mulberry.createPage(dojo.mixin(_27a,{pageDef:"feed-item",backgroundImage:_266()}));mulberry.app.UI.showPage(page,_27a);}}];if(toura.features.debugPage){_262.push({route:"/debug/:query",handler:function(_27b,_27c){var page=mulberry.createPage({pageDef:"debug",name:"Debug",query:_27b.query,backgroundImage:_266()});mulberry.app.UI.showPage(page);}});}if(toura.features.favorites){_262.push({route:"/favorites",handler:function(){var page=mulberry.createPage({name:dojo.i18n.getLocalization("mulberry","mulberry",mulberry.app.Config.get("locale")).FAVORITES,pageDef:"favorites",favorites:toura.user.Favorites.load(),backgroundImage:_266()});mulberry.app.UI.showPage(page);}});}return _262;}());mulberry.routes(_261);}());}if(!dojo._hasResource["toura.user.Facebook.android"]){dojo._hasResource["toura.user.Facebook.android"]=true;dojo.provide("toura.user.Facebook.android");toura.user.Facebook.android={init:function(_27d){this.appId=_27d;(function(){function _27e(){};_27e.prototype.authorize=function(_27f,_280){PhoneGap.exec(_280,null,"FacebookAuth","authorize",[_27f]);};_27e.prototype.request=function(path,_281){PhoneGap.exec(_281,null,"FacebookAuth","request",[path]);};_27e.prototype.getAccess=function(_282){PhoneGap.exec(_282,null,"FacebookAuth","getAccess",[]);};PhoneGap.addConstructor(function(){PhoneGap.addPlugin("facebook",new _27e());PluginManager.addService("FacebookAuth","com.phonegap.plugins.facebook.FacebookAuth");});}());},_realGetAuth:function(){var dfd=new dojo.Deferred();window.plugins.facebook.authorize(this.appId,dojo.hitch(this,function(res){if(res.token){this.token=res.token;dfd.resolve(res.token);}else{window.plugins.facebook.getAccess(dojo.hitch(this,function(res){if(!res.token){dfd.reject();return;}this.token=res.token;dfd.resolve(res.token);}));}}));return dfd;}};}if(!dojo._hasResource["toura.user.Facebook.ios"]){dojo._hasResource["toura.user.Facebook.ios"]=true;dojo.provide("toura.user.Facebook.ios");toura.user.Facebook.ios={init:function(_283){this.authUrl="https://graph.facebook.com/oauth/authorize?"+dojo.objectToQuery({client_id:_283,display:"touch",redirect_uri:"https://www.facebook.com/connect/login_success.html",response_type:"token",scope:"publish_stream,offline_access"});this.childBrowser=mulberry.app.PhoneGap.browser.getBrowser();},_realGetAuth:function(){var dfd=new dojo.Deferred();this.childBrowser.showWebPage(this.authUrl);this.childBrowser.onLocationChange=dojo.hitch(this,function(loc){var _284=this._findToken(loc);if(!_284){dfd.reject();return;}this.childBrowser.close();dfd.resolve(_284);});return dfd;},_findToken:function(loc){if(loc.indexOf("login_success")){var _285=dojo.queryToObject(unescape(loc).split("#")[1]);return _285.access_token;}return false;}};}if(!dojo._hasResource["toura.user.Facebook.browser"]){dojo._hasResource["toura.user.Facebook.browser"]=true;dojo.provide("toura.user.Facebook.browser");toura.user.Facebook.browser={init:function(_286){if(!toura.features.socialInBrowser){return;}window.fbAsyncInit=function(){FB.init({appId:_286});};var e=document.createElement("script");e.src=document.location.protocol+"//connect.facebook.net/en_US/all.js";e.async=true;var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(e,s);},_realGetAuth:function(){var dfd=new dojo.Deferred();if(FB){FB.login(function(resp){dfd.resolve(resp.session&&resp.session.access_token);},{perms:"publish_stream"});}else{dfd.resolve();}return dfd;},_postMessage:function(msg){var dfd=new dojo.Deferred();if(FB){FB.api("/me/feed","post",{message:msg},function(resp){if(!resp||resp.error){dfd.reject(resp&&resp.error);}else{dfd.resolve();}});}else{dfd.resolve();}return dfd.promise;}};}if(!dojo._hasResource["toura.user.Facebook.base"]){dojo._hasResource["toura.user.Facebook.base"]=true;dojo.provide("toura.user.Facebook.base");dojo.declare("toura.user.Facebook.base",null,{token:null,constructor:function(){var self=this;this.device=mulberry.Device;dojo.mixin(this,toura.user.Facebook[mulberry.app.PhoneGap.present?this.device.os:"browser"]);var key=mulberry.app.Config.get("app").facebookApiKey;if(key){this.init(key);}else{this.disabled=true;}},isAuthenticated:function(){console.log("toura.user.Facebook::isAuthenticated()");return !!this.token;},postMessage:function(msg){console.log("toura.user.Facebook::postMessage()");if(!msg){return;}var dfd=new dojo.Deferred();dojo.when(this._getAuth(),dojo.hitch(this,function(t){this.token=t;this._postMessage(msg,t).then(dfd.resolve,dfd.reject);}));return dfd.promise;},_postMessage:function(msg,_287){var url="https://graph.facebook.com/me/feed"+"?"+dojo.objectToQuery({message:msg,link:"",picture:""})+"&access_token="+_287;return dojo.xhrPost({url:url});},_getAuth:function(){console.log("toura.user.Facebook::_getAuth()");return this.token||this._realGetAuth().promise;}});}if(!dojo._hasResource["vendor.sha"]){dojo._hasResource["vendor.sha"]=true;dojo.provide("vendor.sha");(function(){var _288=8,_289="",_28a=0,_28b=function(a,b){this.highOrder=a;this.lowOrder=b;},_28c=function(a){var b=[],mask=(1<<_288)-1,_28d=a.length*_288,i;for(i=0;i<_28d;i+=_288){b[i>>5]|=(a.charCodeAt(i/_288)&mask)<<(32-_288-(i%32));}return b;},_28e=function(a){var b=[],_28f=a.length,i,num;for(i=0;i<_28f;i+=2){num=parseInt(a.substr(i,2),16);if(!isNaN(num)){b[i>>3]|=num<<(24-(4*(i%8)));}else{return "INVALID HEX STRING";}}return b;},_290=function(a){var b=(_28a)?"0123456789ABCDEF":"0123456789abcdef",str="",_291=a.length*4,i,_292;for(i=0;i<_291;i+=1){_292=a[i>>2]>>((3-(i%4))*8);str+=b.charAt((_292>>4)&15)+b.charAt(_292&15);}return str;},_293=function(a){var b="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz"+"0123456789+/",str="",_294=a.length*4,i,j,_295;for(i=0;i<_294;i+=3){_295=(((a[i>>2]>>8*(3-i%4))&255)<<16)|(((a[i+1>>2]>>8*(3-(i+1)%4))&255)<<8)|((a[i+2>>2]>>8*(3-(i+2)%4))&255);for(j=0;j<4;j+=1){if(i*8+j*6<=a.length*32){str+=b.charAt((_295>>6*(3-j))&63);}else{str+=_289;}}}return str;},_296=function(x,n){return (x<<n)|(x>>>(32-n));},_297=function(x,n){return (x>>>n)|(x<<(32-n));},_298=function(x,n){if(n<=32){return new _28b((x.highOrder>>>n)|(x.lowOrder<<(32-n)),(x.lowOrder>>>n)|(x.highOrder<<(32-n)));}else{return new _28b((x.lowOrder>>>n)|(x.highOrder<<(32-n)),(x.highOrder>>>n)|(x.lowOrder<<(32-n)));}},_299=function(x,n){return x>>>n;},_29a=function(x,n){if(n<=32){return new _28b(x.highOrder>>>n,x.lowOrder>>>n|(x.highOrder<<(32-n)));}else{return new _28b(0,x.highOrder<<(32-n));}},_29b=function(x,y,z){return x^y^z;},_29c=function(x,y,z){return (x&y)^(~x&z);},_29d=function(x,y,z){return new _28b((x.highOrder&y.highOrder)^(~x.highOrder&z.highOrder),(x.lowOrder&y.lowOrder)^(~x.lowOrder&z.lowOrder));},_29e=function(x,y,z){return (x&y)^(x&z)^(y&z);},_29f=function(x,y,z){return new _28b((x.highOrder&y.highOrder)^(x.highOrder&z.highOrder)^(y.highOrder&z.highOrder),(x.lowOrder&y.lowOrder)^(x.lowOrder&z.lowOrder)^(y.lowOrder&z.lowOrder));},_2a0=function(x){return _297(x,2)^_297(x,13)^_297(x,22);},_2a1=function(x){var a=_298(x,28),_2a2=_298(x,34),_2a3=_298(x,39);return new _28b(a.highOrder^_2a2.highOrder^_2a3.highOrder,a.lowOrder^_2a2.lowOrder^_2a3.lowOrder);},_2a4=function(x){return _297(x,6)^_297(x,11)^_297(x,25);},_2a5=function(x){var a=_298(x,14),_2a6=_298(x,18),_2a7=_298(x,41);return new _28b(a.highOrder^_2a6.highOrder^_2a7.highOrder,a.lowOrder^_2a6.lowOrder^_2a7.lowOrder);},_2a8=function(x){return _297(x,7)^_297(x,18)^_299(x,3);},_2a9=function(x){var a=_298(x,1),_2aa=_298(x,8),shr7=_29a(x,7);return new _28b(a.highOrder^_2aa.highOrder^shr7.highOrder,a.lowOrder^_2aa.lowOrder^shr7.lowOrder);},_2ab=function(x){return _297(x,17)^_297(x,19)^_299(x,10);},_2ac=function(x){var a=_298(x,19),_2ad=_298(x,61),shr6=_29a(x,6);return new _28b(a.highOrder^_2ad.highOrder^shr6.highOrder,a.lowOrder^_2ad.lowOrder^shr6.lowOrder);},_2ae=function(x,y){var a=(x&65535)+(y&65535),msw=(x>>>16)+(y>>>16)+(a>>>16);return ((msw&65535)<<16)|(a&65535);},_2af=function(a,b,c,d){var e=(a&65535)+(b&65535)+(c&65535)+(d&65535),msw=(a>>>16)+(b>>>16)+(c>>>16)+(d>>>16)+(e>>>16);return ((msw&65535)<<16)|(e&65535);},_2b0=function(a,b,c,d,e){var f=(a&65535)+(b&65535)+(c&65535)+(d&65535)+(e&65535),msw=(a>>>16)+(b>>>16)+(c>>>16)+(d>>>16)+(e>>>16)+(f>>>16);return ((msw&65535)<<16)|(f&65535);},_2b1=function(x,y){var a,msw,_2b2,_2b3;a=(x.lowOrder&65535)+(y.lowOrder&65535);msw=(x.lowOrder>>>16)+(y.lowOrder>>>16)+(a>>>16);_2b2=((msw&65535)<<16)|(a&65535);a=(x.highOrder&65535)+(y.highOrder&65535)+(msw>>>16);msw=(x.highOrder>>>16)+(y.highOrder>>>16)+(a>>>16);_2b3=((msw&65535)<<16)|(a&65535);return new _28b(_2b3,_2b2);},_2b4=function(a,b,c,d){var e,msw,_2b5,_2b6;e=(a.lowOrder&65535)+(b.lowOrder&65535)+(c.lowOrder&65535)+(d.lowOrder&65535);msw=(a.lowOrder>>>16)+(b.lowOrder>>>16)+(c.lowOrder>>>16)+(d.lowOrder>>>16)+(e>>>16);_2b5=((msw&65535)<<16)|(e&65535);e=(a.highOrder&65535)+(b.highOrder&65535)+(c.highOrder&65535)+(d.highOrder&65535)+(msw>>>16);msw=(a.highOrder>>>16)+(b.highOrder>>>16)+(c.highOrder>>>16)+(d.highOrder>>>16)+(e>>>16);_2b6=((msw&65535)<<16)|(e&65535);return new _28b(_2b6,_2b5);},_2b7=function(a,b,c,d,e){var f,msw,_2b8,_2b9;f=(a.lowOrder&65535)+(b.lowOrder&65535)+(c.lowOrder&65535)+(d.lowOrder&65535)+(e.lowOrder&65535);msw=(a.lowOrder>>>16)+(b.lowOrder>>>16)+(c.lowOrder>>>16)+(d.lowOrder>>>16)+(e.lowOrder>>>16)+(f>>>16);_2b8=((msw&65535)<<16)|(f&65535);f=(a.highOrder&65535)+(b.highOrder&65535)+(c.highOrder&65535)+(d.highOrder&65535)+(e.highOrder&65535)+(msw>>>16);msw=(a.highOrder>>>16)+(b.highOrder>>>16)+(c.highOrder>>>16)+(d.highOrder>>>16)+(e.highOrder>>>16)+(f>>>16);_2b9=((msw&65535)<<16)|(f&65535);return new _28b(_2b9,_2b8);},_2ba=function(f,g){var W=[],a,b,c,d,e,T,ch=_29c,_2bb=_29b,maj=_29e,rotl=_296,_2bc=_2ae,i,t,_2bd=_2b0,_2be,H=[1732584193,4023233417,2562383102,271733878,3285377520],K=[1518500249,1518500249,1518500249,1518500249,1518500249,1518500249,1518500249,1518500249,1518500249,1518500249,1518500249,1518500249,1518500249,1518500249,1518500249,1518500249,1518500249,1518500249,1518500249,1518500249,1859775393,1859775393,1859775393,1859775393,1859775393,1859775393,1859775393,1859775393,1859775393,1859775393,1859775393,1859775393,1859775393,1859775393,1859775393,1859775393,1859775393,1859775393,1859775393,1859775393,2400959708,2400959708,2400959708,2400959708,2400959708,2400959708,2400959708,2400959708,2400959708,2400959708,2400959708,2400959708,2400959708,2400959708,2400959708,2400959708,2400959708,2400959708,2400959708,2400959708,3395469782,3395469782,3395469782,3395469782,3395469782,3395469782,3395469782,3395469782,3395469782,3395469782,3395469782,3395469782,3395469782,3395469782,3395469782,3395469782,3395469782,3395469782,3395469782,3395469782];f[g>>5]|=128<<(24-(g%32));f[(((g+65)>>9)<<4)+15]=g;_2be=f.length;for(i=0;i<_2be;i+=16){a=H[0];b=H[1];c=H[2];d=H[3];e=H[4];for(t=0;t<80;t+=1){if(t<16){W[t]=f[t+i];}else{W[t]=rotl(W[t-3]^W[t-8]^W[t-14]^W[t-16],1);}if(t<20){T=_2bd(rotl(a,5),ch(b,c,d),e,K[t],W[t]);}else{if(t<40){T=_2bd(rotl(a,5),_2bb(b,c,d),e,K[t],W[t]);}else{if(t<60){T=_2bd(rotl(a,5),maj(b,c,d),e,K[t],W[t]);}else{T=_2bd(rotl(a,5),_2bb(b,c,d),e,K[t],W[t]);}}}e=d;d=c;c=rotl(b,30);b=a;a=T;}H[0]=_2bc(a,H[0]);H[1]=_2bc(b,H[1]);H[2]=_2bc(c,H[2]);H[3]=_2bc(d,H[3]);H[4]=_2bc(e,H[4]);}return H;},_2bf=function(j,k,l){var a,b,c,d,e,f,g,h,T1,T2,H,_2c0,_2c1,i,t,_2c2,_2c3,_2c4,_2c5,_2c6,_2c7,_2c8,_2c9,_2ca,ch,maj,Int,K,W=[],_2cb;if(l==="SHA-224"||l==="SHA-256"){_2c0=64;_2c1=(((k+65)>>9)<<4)+15;_2c2=16;_2c3=1;Int=Number;_2c4=_2ae;_2c5=_2af;_2c6=_2b0;_2c7=_2a8;_2c8=_2ab;_2c9=_2a0;_2ca=_2a4;maj=_29e;ch=_29c;K=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298];if(l==="SHA-224"){H=[3238371032,914150663,812702999,4144912697,4290775857,1750603025,1694076839,3204075428];}else{H=[1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225];}}else{if(l==="SHA-384"||l==="SHA-512"){_2c0=80;_2c1=(((k+128)>>10)<<5)+31;_2c2=32;_2c3=2;Int=_28b;_2c4=_2b1;_2c5=_2b4;_2c6=_2b7;_2c7=_2a9;_2c8=_2ac;_2c9=_2a1;_2ca=_2a5;maj=_29f;ch=_29d;K=[new Int(1116352408,3609767458),new Int(1899447441,602891725),new Int(3049323471,3964484399),new Int(3921009573,2173295548),new Int(961987163,4081628472),new Int(1508970993,3053834265),new Int(2453635748,2937671579),new Int(2870763221,3664609560),new Int(3624381080,2734883394),new Int(310598401,1164996542),new Int(607225278,1323610764),new Int(1426881987,3590304994),new Int(1925078388,4068182383),new Int(2162078206,991336113),new Int(2614888103,633803317),new Int(3248222580,3479774868),new Int(3835390401,2666613458),new Int(4022224774,944711139),new Int(264347078,2341262773),new Int(604807628,2007800933),new Int(770255983,1495990901),new Int(1249150122,1856431235),new Int(1555081692,3175218132),new Int(1996064986,2198950837),new Int(2554220882,3999719339),new Int(2821834349,766784016),new Int(2952996808,2566594879),new Int(3210313671,3203337956),new Int(3336571891,1034457026),new Int(3584528711,2466948901),new Int(113926993,3758326383),new Int(338241895,168717936),new Int(666307205,1188179964),new Int(773529912,1546045734),new Int(1294757372,1522805485),new Int(1396182291,2643833823),new Int(1695183700,2343527390),new Int(1986661051,1014477480),new Int(2177026350,1206759142),new Int(2456956037,344077627),new Int(2730485921,1290863460),new Int(2820302411,3158454273),new Int(3259730800,3505952657),new Int(3345764771,106217008),new Int(3516065817,3606008344),new Int(3600352804,1432725776),new Int(4094571909,1467031594),new Int(275423344,851169720),new Int(430227734,3100823752),new Int(506948616,1363258195),new Int(659060556,3750685593),new Int(883997877,3785050280),new Int(958139571,3318307427),new Int(1322822218,3812723403),new Int(1537002063,2003034995),new Int(1747873779,3602036899),new Int(1955562222,1575990012),new Int(2024104815,1125592928),new Int(2227730452,2716904306),new Int(2361852424,442776044),new Int(2428436474,593698344),new Int(2756734187,3733110249),new Int(3204031479,2999351573),new Int(3329325298,3815920427),new Int(3391569614,3928383900),new Int(3515267271,566280711),new Int(3940187606,3454069534),new Int(4118630271,4000239992),new Int(116418474,1914138554),new Int(174292421,2731055270),new Int(289380356,3203993006),new Int(460393269,320620315),new Int(685471733,587496836),new Int(852142971,1086792851),new Int(1017036298,365543100),new Int(1126000580,2618297676),new Int(1288033470,3409855158),new Int(1501505948,4234509866),new Int(1607167915,987167468),new Int(1816402316,1246189591)];if(l==="SHA-384"){H=[new Int(3418070365,3238371032),new Int(1654270250,914150663),new Int(2438529370,812702999),new Int(355462360,4144912697),new Int(1731405415,4290775857),new Int(41048885895,1750603025),new Int(3675008525,1694076839),new Int(1203062813,3204075428)];}else{H=[new Int(1779033703,4089235720),new Int(3144134277,2227873595),new Int(1013904242,4271175723),new Int(2773480762,1595750129),new Int(1359893119,2917565137),new Int(2600822924,725511199),new Int(528734635,4215389547),new Int(1541459225,327033209)];}}}j[k>>5]|=128<<(24-k%32);j[_2c1]=k;_2cb=j.length;for(i=0;i<_2cb;i+=_2c2){a=H[0];b=H[1];c=H[2];d=H[3];e=H[4];f=H[5];g=H[6];h=H[7];for(t=0;t<_2c0;t+=1){if(t<16){W[t]=new Int(j[t*_2c3+i],j[t*_2c3+i+1]);}else{W[t]=_2c5(_2c8(W[t-2]),W[t-7],_2c7(W[t-15]),W[t-16]);}T1=_2c6(h,_2ca(e),ch(e,f,g),K[t],W[t]);T2=_2c4(_2c9(a),maj(a,b,c));h=g;g=f;f=e;e=_2c4(d,T1);d=c;c=b;b=a;a=_2c4(T1,T2);}H[0]=_2c4(a,H[0]);H[1]=_2c4(b,H[1]);H[2]=_2c4(c,H[2]);H[3]=_2c4(d,H[3]);H[4]=_2c4(e,H[4]);H[5]=_2c4(f,H[5]);H[6]=_2c4(g,H[6]);H[7]=_2c4(h,H[7]);}switch(l){case "SHA-224":return [H[0],H[1],H[2],H[3],H[4],H[5],H[6]];case "SHA-256":return H;case "SHA-384":return [H[0].highOrder,H[0].lowOrder,H[1].highOrder,H[1].lowOrder,H[2].highOrder,H[2].lowOrder,H[3].highOrder,H[3].lowOrder,H[4].highOrder,H[4].lowOrder,H[5].highOrder,H[5].lowOrder];case "SHA-512":return [H[0].highOrder,H[0].lowOrder,H[1].highOrder,H[1].lowOrder,H[2].highOrder,H[2].lowOrder,H[3].highOrder,H[3].lowOrder,H[4].highOrder,H[4].lowOrder,H[5].highOrder,H[5].lowOrder,H[6].highOrder,H[6].lowOrder,H[7].highOrder,H[7].lowOrder];default:return [];}},_2cc=function(a,b){this.sha1=null;this.sha224=null;this.sha256=null;this.sha384=null;this.sha512=null;this.strBinLen=null;this.strToHash=null;if("HEX"===b){if(0!==(a.length%2)){return "TEXT MUST BE IN BYTE INCREMENTS";}this.strBinLen=a.length*4;this.strToHash=_28e(a);}else{if(("ASCII"===b)||("undefined"===typeof (b))){this.strBinLen=a.length*_288;this.strToHash=_28c(a);}else{return "UNKNOWN TEXT INPUT TYPE";}}};_2cc.prototype={getHash:function(a,b){var c=null,_2cd=this.strToHash.slice();switch(b){case "HEX":c=_290;break;case "B64":c=_293;break;default:return "FORMAT NOT RECOGNIZED";}switch(a){case "SHA-1":if(null===this.sha1){this.sha1=_2ba(_2cd,this.strBinLen);}return c(this.sha1);case "SHA-224":if(null===this.sha224){this.sha224=_2bf(_2cd,this.strBinLen,a);}return c(this.sha224);case "SHA-256":if(null===this.sha256){this.sha256=_2bf(_2cd,this.strBinLen,a);}return c(this.sha256);case "SHA-384":if(null===this.sha384){this.sha384=_2bf(_2cd,this.strBinLen,a);}return c(this.sha384);case "SHA-512":if(null===this.sha512){this.sha512=_2bf(_2cd,this.strBinLen,a);}return c(this.sha512);default:return "HASH NOT RECOGNIZED";}},getHMAC:function(a,b,c,d){var e,_2ce,_2cf,_2d0,i,_2d1,_2d2,_2d3,_2d4,_2d5=[],_2d6=[];switch(d){case "HEX":e=_290;break;case "B64":e=_293;break;default:return "FORMAT NOT RECOGNIZED";}switch(c){case "SHA-1":_2cf=64;_2d4=160;break;case "SHA-224":_2cf=64;_2d4=224;break;case "SHA-256":_2cf=64;_2d4=256;break;case "SHA-384":_2cf=128;_2d4=384;break;case "SHA-512":_2cf=128;_2d4=512;break;default:return "HASH NOT RECOGNIZED";}if("HEX"===b){if(0!==(a.length%2)){return "KEY MUST BE IN BYTE INCREMENTS";}_2ce=_28e(a);_2d3=a.length*4;}else{if("ASCII"===b){_2ce=_28c(a);_2d3=a.length*_288;}else{return "UNKNOWN KEY INPUT TYPE";}}_2d0=_2cf*8;_2d2=(_2cf/4)-1;if(_2cf<(_2d3/8)){if("SHA-1"===c){_2ce=_2ba(_2ce,_2d3);}else{_2ce=_2bf(_2ce,_2d3,c);}_2ce[_2d2]&=4294967040;}else{if(_2cf>(_2d3/8)){_2ce[_2d2]&=4294967040;}}for(i=0;i<=_2d2;i+=1){_2d5[i]=_2ce[i]^909522486;_2d6[i]=_2ce[i]^1549556828;}if("SHA-1"===c){_2d1=_2ba(_2d5.concat(this.strToHash),_2d0+this.strBinLen);_2d1=_2ba(_2d6.concat(_2d1),_2d0+_2d4);}else{_2d1=_2bf(_2d5.concat(this.strToHash),_2d0+this.strBinLen,c);_2d1=_2bf(_2d6.concat(_2d1),_2d0+_2d4,c);}return (e(_2d1));}};window.jsSHA=_2cc;}());}if(!dojo._hasResource["toura.user.Twitter"]){dojo._hasResource["toura.user.Twitter"]=true;dojo.provide("toura.user.Twitter");(function(){var user;dojo.declare("toura.user.Twitter",null,{constructor:function(){var _2d7={customerKey:mulberry.app.Config.get("app").twitterCustomerKey,customerSecret:mulberry.app.Config.get("app").twitterCustomerSecret};if(_2d7.customerKey&&_2d7.customerSecret){this.twitterConfig=_2d7;if(mulberry.app.PhoneGap.present){this.childBrowser=mulberry.app.PhoneGap.browser.getBrowser();}}else{this.disabled=true;}},setUserInfo:function(u){console.log("toura.user.Twitter::setUserInfo()");if(u.username&&u.password){user=u;return true;}return false;},isAuthenticated:function(){console.log("toura.user.Twitter::isAuthenticated()");if(mulberry.app.PhoneGap.present){return !!(this.oauth_token&&this.oauth_token_secret);}return false;},postMessage:function(msg){console.log("toura.user.Twitter::postMessage()");if(!msg){return;}if(mulberry.silenceSharing){console.log("sharing silenced; twitter message would have been",msg);}var dfd=new dojo.Deferred();dojo.when(this._getAuth(),dojo.hitch(this,function(t){this._postMessage(msg,t).then(dfd.resolve,dfd.reject);}));return dfd.promise;},_postMessage:function(msg,t){console.log("toura.user.Twitter::_postMessage()");var _2d8=new toura.user._TwitterAPI({customerKey:this.twitterConfig.customerKey,consumerSecret:this.twitterConfig.customerSecret}),auth=this._getAuthTokenFields(),dfd=new dojo.Deferred();_2d8.setAuth(auth);if(!_2d8.setupUpdate(msg)){dfd.reject();}else{dojo.xhrPost({url:_2d8.getPostTarget(),headers:_2d8.getAuthHeader(),load:dfd.resolve});}return dfd.promise;},_getAuthTokenFields:function(){console.log("toura.user.Twitter::_getAuthTokenFields()");return {oauth_token:this.oauth_token,oauth_token_secret:this.oauth_token_secret};},_getAuth:function(){console.log("toura.user.Twitter::_getAuth()");var dfd=new dojo.Deferred(),_2d9;if(!mulberry.app.PhoneGap.present){dfd.resolve(true);return dfd.promise;}if(this.isAuthenticated()){return this._getAuthTokenFields();}if(!user){console.error("user not found");return;}_2d9=new toura.user._TwitterAPI({customerKey:this.twitterConfig.customerKey,consumerSecret:this.twitterConfig.customerSecret});_2d9.setupAuthPost(user.username,user.password);dojo.xhrPost({url:_2d9.getPostTarget(),headers:_2d9.getAuthHeader()}).then(dojo.hitch(this,function(_2da){var _2db=dojo.queryToObject(_2da);dojo.mixin(this,_2db);dfd.resolve({oauth_token:this.oauth_token,oauth_token_secret:this.oauth_token_secret});}),dfd.reject);return dfd.promise;}});}());dojo.declare("toura.user._TwitterAPI",null,{sigBaseTemplate:"POST&"+"{{ path }}&"+"oauth_consumer_key%3D"+"{{ customer_key }}"+"%26"+"oauth_nonce%3D"+"{{ nonce }}"+"%26"+"oauth_signature_method%3DHMAC-SHA1%26oauth_timestamp%3D"+"{{ time }}"+"%26"+"{{ optional_token }}"+"oauth_version%3D1.0%26"+"{{ post_body }}",authTemplate:"OAuth "+"oauth_nonce=\""+"{{ nonce }}"+"\", "+"oauth_signature_method=\"HMAC-SHA1\", "+"oauth_timestamp=\""+"{{ time }}"+"\", "+"oauth_consumer_key=\""+"{{ customer_key }}"+"\", "+"{{ optional_token }}"+"oauth_signature=\""+"{{ signature }}"+"\", "+"oauth_version=\"1.0\"",constructor:function(_2dc){this.config=_2dc;this.consumerSecret=this.config.consumerSecret+"&";this.nonce=this._createNonce();this.timestamp=(new Date((new Date()).toUTCString())).getTime()/1000;},_encode:function(str){return encodeURIComponent(str).replace(/!/g,"%21").replace(/'/g,"%27").replace(/\(/g,"%28").replace(/\)/g,"%29").replace(/\*/g,"%2A");},_createNonce:function(){var _2dd=[],_2de=5;while(_2de--){_2dd.push((((1+Math.random())*65536)).toString(16).substring(1));}return _2dd.join("");},getPostTarget:function(){return [this.path,this.postBody].join("?");},setSignature:function(_2df){var _2e0=new jsSHA(this.signatureBaseString,"ASCII");this.signature=_2e0.getHMAC(_2df,"ASCII","SHA-1","B64")+"%3D";},setupBaseString:function(_2e1){var _2e2=_2e1?"oauth_token%3D"+_2e1+"%26":"";this.signatureBaseString=this.sigBaseTemplate.split("{{ path }}").join(encodeURIComponent(this.path)).split("{{ customer_key }}").join(this.config.customerKey).split("{{ optional_token }}").join(_2e2).split("{{ nonce }}").join(this.nonce).split("{{ time }}").join(this.timestamp).split("{{ post_body }}").join(encodeURIComponent(this.postBody));},setupAuthHeader:function(_2e3){var _2e4=_2e3?"oauth_token=\""+_2e3+"\", ":"";this.authHeader=this.authTemplate.split("{{ nonce }}").join(this.nonce).split("{{ customer_key }}").join(this.config.customerKey).split("{{ optional_token }}").join(_2e4).split("{{ time }}").join(this.timestamp).split("{{ signature }}").join(this.signature);},getAuthHeader:function(){return {"Authorization":this.authHeader};},setupAuthPost:function(user,pw){this.path="https://api.twitter.com/oauth/access_token";this.postBody="x_auth_mode=client_auth&"+"x_auth_password="+this._encode(pw)+"&"+"x_auth_username="+this._encode(user);this.setupBaseString();this.setSignature(this.consumerSecret);this.setupAuthHeader();return true;},setupUpdate:function(_2e5){this.path="https://api.twitter.com/1/statuses/update.json";this.postBody="status="+this._encode(_2e5);if(!this.token||!this.tokenSecret){return false;}this.setupBaseString(this.token);this.setSignature(this.consumerSecret+this.tokenSecret);this.setupAuthHeader(this.token);return true;},setAuth:function(auth){this.token=auth.oauth_token;this.tokenSecret=auth.oauth_token_secret;}});(function(){if(window.device&&window.device.phonegap){return;}if(!toura.features.socialInBrowser){return;}var key=mulberry.app.Config.get("app").twitter_anywhere_key;if(!key){return;}var s=document.createElement("script");var _2e6="//platform.twitter.com/anywhere.js?"+dojo.objectToQuery({id:key,v:1});s.src=document.location.protocol+_2e6;s.async=true;document.body.appendChild(s);}());}if(!dojo._hasResource["toura.Sharing"]){dojo._hasResource["toura.Sharing"]=true;dojo.provide("toura.Sharing");toura.Sharing={lastPost:{},getMessage:function(svc,obj){console.log("toura.Sharing::getMessage",arguments);var app=mulberry.app.Config.get("app"),_2e7=app.sharingText||mulberry.sharingText||"${sharingURL}",_2e8=0,ret;obj=obj||{"name":app.name};console.log("app sharing URL is "+app.sharingUrl);obj.sharingURL=obj.sharingURL||app.sharingUrl||mulberry.sharingURL;if(!obj.sharingURL){console.error("No sharing URL defined for object or app. This will end badly.");}if(!_2e7){console.error("No sharing text template defined. This will end badly.");}if(svc==="twitter"){_2e8+=obj.sharingURL.length;ret=dojo.string.substitute(_2e7,obj).split(obj.sharingURL);if(ret[1]){_2e8+=ret[1].length;}ret=[dojo.trim(ret[0].substr(0,140-_2e8)),obj.sharingURL,ret[1]||""].join(" ");}else{ret=dojo.string.substitute(_2e7,obj)+" "+obj.sharingURL;}return ret;},share:function(_2e9,_2ea,node){console.log("toura.Sharing::share()");var dfd=new dojo.Deferred(),svc=_2e9.name,doit=true,_2eb=_2e9.beforePost?!!_2e9.beforePost(_2ea):true;if(_2eb!==true){console.log("beforePost was not true");dfd.reject(_2e9.beforePostError);doit=false;}if(this.lastPost[svc]&&(this.lastPost[svc]===_2ea.msg)){dfd.reject("The message is a duplicate.");doit=false;}if(doit){console.log("doing it");_2e9.api.postMessage(_2ea.msg).then(dojo.hitch(this,function(){this.lastPost[svc]=_2ea.msg;dojo.publish("/share",[[svc,node.id,_2ea.msg].join(": ")]);dfd.resolve();}));}return dfd.promise;},getServices:function(){var i18n=dojo.i18n.getLocalization("mulberry","mulberry",mulberry.app.Config.get("locale")),_2ec=[];if(!toura.user.Twitter.disabled){_2ec.push({name:"twitter",api:toura.user.Twitter,requireAuth:!toura.user.Twitter.isAuthenticated(),maxLength:140,beforePost:function(_2ed){return !!toura.user.Twitter.setUserInfo(_2ed);},beforePostError:i18n.TWITTER_AUTHENTICATION_ERROR});}if(!toura.user.Facebook.disabled){_2ec.push({name:"facebook",api:toura.user.Facebook});}return _2ec;}};dojo.subscribe("/app/ready",function(){toura.user.Facebook=new toura.user.Facebook.base();toura.user.Twitter=new toura.user.Twitter();});}if(!dojo._hasResource["mulberry._Capability"]){dojo._hasResource["mulberry._Capability"]=true;dojo.provide("mulberry._Capability");dojo.declare("mulberry._Capability",null,{requirements:{},connects:[],constructor:function(_2ee){dojo.mixin(this,_2ee);this.domNode=this.page.domNode;this.node=this.page.node;this.involved=this._loadInvolvedComponents();if(!this._checkRequirements()){console.error("Did not find required components for capability",this.declaredClass);console.error("These are the components I know about",this.involved);throw ("Did not find required components for capability "+this.declaredClass);}this._doLookups();this._doConnects();this.init();},init:function(){},_loadInvolvedComponents:function(){var _2ef={};dojo.forEach(this.components||[],function(c){var tmp=c.split(":"),_2f0=tmp[0],_2f1=tmp[1],_2f2=this.page.getScreen(_2f0),_2f3=_2f2.getComponent(_2f1);if(!_2f3){console.error("Capability",this.declaredClass,"did not find component for",_2f1,"on the",_2f0,"screen");}_2ef[_2f1]=_2f3;},this);return _2ef;},_checkRequirements:function(){var _2f4=true;dojo.forIn(this.requirements,function(_2f5,_2f6){var _2f7=!!this.involved[_2f6]||this.page.getComponent(_2f6);_2f4=_2f4&&_2f7;if(!_2f7){console.warn("did not find",_2f6);}},this);return _2f4;},_doLookups:function(){dojo.forIn(this.requirements,function(_2f8,_2f9){this[_2f8]=this.involved[_2f9]||this.page.getComponent(_2f9);},this);},_doConnects:function(){dojo.forEach(this.connects,function(c){this.connect.apply(this,c);},this);},connect:function(obj,_2fa,fn){if(dojo.isString(obj)){obj=this[obj];}this.page.connect(obj,_2fa,dojo.hitch(this,fn));}});mulberry.capability=function(name,_2fb){dojo.declare("mulberry.capabilities."+name,mulberry._Capability,_2fb);};}if(!dojo._hasResource["toura.capabilities.Page_Images"]){dojo._hasResource["toura.capabilities.Page_Images"]=true;dojo.provide("toura.capabilities.Page_Images");dojo.declare("toura.capabilities.Page_Images",mulberry._Capability,{requirements:{imageGallery:"ImageGallery",imageCaption:"ImageCaption"},connects:[["page","init","_setup"]],_setup:function(_2fc){if(!_2fc){return;}var _2fd=_2fc.assetId,_2fe,_2ff;if(!_2fd){return;}_2ff=dojo.filter(this.baseObj.images,function(_300,idx){if(_300.id===_2fd){_2fe=idx;return _300;}})[0];if(!_2ff){return;}if(this.imageGallery){this.connect(this.imageGallery,"startup",function(){this.imageGallery.scrollToIndex(_2fe);});}if(this.imageCaption){this.imageCaption.set("content",_2ff.caption||"");}}});}if(!dojo._hasResource["toura.capabilities.Page_GoogleMapTablet"]){dojo._hasResource["toura.capabilities.Page_GoogleMapTablet"]=true;dojo.provide("toura.capabilities.Page_GoogleMapTablet");dojo.declare("toura.capabilities.Page_GoogleMapTablet",mulberry._Capability,{requirements:{googleMap:"GoogleMap",pinInfo:"PinInfo"},connects:[["googleMap","onShowInfo","_showPin"]],init:function(){this.pinInfo.region.hide();this.googleMap.set("pinInfo",this.pinInfo);},_showPin:function(pin){this.pinInfo.set("pin",pin);}});}if(!dojo._hasResource["toura.capabilities.Page_GoogleMapPhone"]){dojo._hasResource["toura.capabilities.Page_GoogleMapPhone"]=true;dojo.provide("toura.capabilities.Page_GoogleMapPhone");dojo.declare("toura.capabilities.Page_GoogleMapPhone",mulberry._Capability,{requirements:{googleMap:"GoogleMap",pinInfo:"PinInfo",detailTitle:"DetailTitle"},connects:[["googleMap","onShowInfo","_showPin"],["detailTitle","onClose","_hidePin"]],init:function(){this.googleMap.set("pinInfo",this.pinInfo);},_showPin:function(pin){this.page.showScreen("detail");this.pinInfo.set("pin",pin);this.detailTitle.set("screenTitle",pin.name);},_hidePin:function(){this.page.showScreen("index");}});}if(!dojo._hasResource["toura.capabilities.Page_FullScreenImages"]){dojo._hasResource["toura.capabilities.Page_FullScreenImages"]=true;dojo.provide("toura.capabilities.Page_FullScreenImages");dojo.declare("toura.capabilities.Page_FullScreenImages",mulberry._Capability,{requirements:{imageGallery:"ZoomableImageGallery",pageNav:"PageNav"},connects:[["page","init","_setup"],["imageGallery","onHideChrome","_hideNav"],["imageGallery","onShowChrome","_showNav"]],_setup:function(_301){var _302=0;if(_301.assetId){dojo.forEach(this.baseObj.images,function(_303,idx){if(_303.id===_301.assetId){_302=idx;}});}this.imageGallery.set("currentImageIndex",_302);},_hideNav:function(){this.pageNav.hide();},_showNav:function(){this.pageNav.show();}});}if(!dojo._hasResource["toura.capabilities.ImageGallery_ImageCaption"]){dojo._hasResource["toura.capabilities.ImageGallery_ImageCaption"]=true;dojo.provide("toura.capabilities.ImageGallery_ImageCaption");dojo.declare("toura.capabilities.ImageGallery_ImageCaption",mulberry._Capability,{requirements:{imageGallery:"ImageGallery",imageCaption:"ImageCaption"},connects:[["imageGallery","onScrollEnd","_setCaption"]],_setCaption:function(_304){var _305=this.baseObj.images[_304];this.imageCaption.set("content",_305&&_305.caption||"");}});}if(!dojo._hasResource["mulberry.containers.Viewport"]){dojo._hasResource["mulberry.containers.Viewport"]=true;dojo.provide("mulberry.containers.Viewport");dojo.declare("mulberry.containers.Viewport",mulberry._View,{templateString:dojo.cache("mulberry.containers","Viewport/Viewport.haml","%ol.viewport\n"),direction:"next",postCreate:function(){this.connect(this.domNode,"webkitAnimationEnd","_onAnimationEnd");},_setNavDirectionAttr:function(dir){this.direction=dir==="back"?"prev":"next";},_setContentAttr:function(_306){if(mulberry.animating){return;}var n=this.domNode,next=this.direction==="next";this.direction="next";this.currentPage=_306;if(n.children.length){mulberry.animating=true;this.addClass("pre-slide");_306.placeAt(n,next?"last":"first");this.addClass(next?"slide-left":"slide-right");}else{_306.placeAt(n,"last");this._onAnimationEnd();}setTimeout(function(){if(this.animating){this._onAnimationEnd();}},600);},_cleanupOldPage:function(){var _307=document.querySelectorAll("ol.viewport > li");dojo.forEach(_307,function(page){if(this.currentPage.domNode!==page){dojo.destroy(page);var _308=dijit.byNode(page);if(_308){_308.destroy();}}},this);this.removeClass(["slide-left","slide-right","pre-slide"]);},_onAnimationEnd:function(){this._cleanupOldPage();mulberry.animating=false;dojo.publish("/page/transition/end");}});}if(!dojo._hasResource["mulberry.containers.Persistent"]){dojo._hasResource["mulberry.containers.Persistent"]=true;dojo.provide("mulberry.containers.Persistent");dojo.declare("mulberry.containers.Persistent",mulberry._View,{templateString:dojo.cache("mulberry.containers","Persistent/Persistent.haml",".container.persistent\n")});}if(!dojo._hasResource["mulberry.app.UI"]){dojo._hasResource["mulberry.app.UI"]=true;dojo.provide("mulberry.app.UI");dojo.declare("mulberry.app.UI",dojo.Stateful,{containers:{},currentPage:null,constructor:function(_309){this.device=_309;this.body=dojo.body();this.hasTouch="ontouchstart" in window;this.touchMoveDebounce=_309.os==="android"?200:0;this._containersSetup();this._watchers();this._updateViewport();this._uiSetup();this._eventSetup();},addPersistentComponent:function(_30a,opts){var pc=this.containers.persistent;return pc.adopt(_30a,opts||{}).placeAt(pc.domNode,"last");},_watchers:function(){var _30b={fontSize:function(k,_30c,_30d){var b=this.body;if(_30c){dojo.removeClass(b,_30c);}dojo.addClass(b,_30d);mulberry.app.DeviceStorage.set("fontSize",_30d);dojo.publish("/fontsize");},navDirection:function(k,old,dir){this.containers.viewport.set("navDirection",dir);}};dojo.forIn(_30b,this.watch,this);},_updateViewport:function(){this.viewport={width:this.body.offsetWidth,height:this.body.offsetHeight};},_uiSetup:function(){var b=this.body,_30e=this.device,_30f;dojo.addClass(b,_30e.type);dojo.addClass(b,_30e.os);dojo.addClass(b,"version-"+mulberry.app.PhoneGap.device.version);this.set("fontSize",mulberry.app.DeviceStorage.get("fontSize"));if(mulberry.isMAP){dojo.addClass(b,"layout-MAP");}},_containersSetup:function(){this.containers.viewport=new mulberry.containers.Viewport().placeAt(this.body,"first");this.containers.persistent=new mulberry.containers.Persistent().placeAt(this.body,"last");},_eventSetup:function(){dojo.connect(document,"touchmove",function(e){e.preventDefault();});dojo.connect(window,"resize",this,function(){this._updateViewport();dojo.publish("/window/resize");});dojo.connect(document,"menubutton",this,function(e){e.preventDefault();dojo.publish("/button/menu");});dojo.connect(document,"backbutton",this,function(e){e.preventDefault();mulberry.app.Router.back();});dojo.connect(document,"searchbutton",this,function(e){mulberry.app.Router.go("/search");e.preventDefault();});if(this.siblingNav){dojo.connect(this.siblingNav,"show",this,function(){dojo.addClass(this.body,"sibling-nav-visible");dojo.publish("/window/resize");});dojo.connect(this.siblingNav,"hide",this,function(){dojo.removeClass(this.body,"sibling-nav-visible");dojo.publish("/window/resize");});}},showPage:function(page,node){if(!page){throw new Error("mulberry.app.UI::showPage called without a page to show");}if(page.startup){var s=dojo.subscribe("/page/transition/end",function(){page.startup();dojo.unsubscribe(s);});}this.containers.viewport.set("content",page);this.currentPage=page;},hideSplash:function(){var _310=dojo.byId("splash");if(_310){dojo.destroy(_310);}}});dojo.subscribe("/app/ready",function(){mulberry.app.UI=new mulberry.app.UI(mulberry.Device);dojo.publish("/ui/ready");mulberry.showPage=dojo.hitch(mulberry.app.UI,"showPage");});}if(!dojo._hasResource["toura.capabilities.ImageGalleryDetail"]){dojo._hasResource["toura.capabilities.ImageGalleryDetail"]=true;dojo.provide("toura.capabilities.ImageGalleryDetail");dojo.declare("toura.capabilities.ImageGalleryDetail",mulberry._Capability,{requirements:{imageGallery:"ImageGallery",imageDetail:"ZoomableImageGallery",detailTitle:"DetailTitle"},connects:[["imageGallery","onShowDetail","_showDetail"],["detailTitle","onClose","_hideDetail"],["imageDetail","onImageChange","_setTitle"],["imageDetail","onShowChrome","_showDetailTitle"],["imageDetail","onHideChrome","_hideDetailTitle"]],_showDetail:function(_311){mulberry.app.UI.set("siblingNavVisible",false);this.detailTitle.hide();this.page.showScreen("detail");this.imageDetail.set("currentImageIndex",_311);this.imageDetail.set("chromeVisible",false);},_hideDetail:function(_312){this.page.showScreen("index");mulberry.app.UI.set("siblingNavVisible",true);this.imageGallery.scrollToIndex(this.imageDetail.currentImageIndex);},_setTitle:function(_313){this.detailTitle.set("screenTitle",_313.name);},_showDetailTitle:function(){this.detailTitle.show();},_hideDetailTitle:function(){this.detailTitle.hide();}});}if(!dojo._hasResource["toura.capabilities.FeedItemList_FeedItemPage"]){dojo._hasResource["toura.capabilities.FeedItemList_FeedItemPage"]=true;dojo.provide("toura.capabilities.FeedItemList_FeedItemPage");dojo.declare("toura.capabilities.FeedItemList_FeedItemPage",mulberry._Capability,{requirements:{feedItemList:"FeedItemList"},connects:[["feedItemList","onSelect","_navigateToFeedItemPage"]],_navigateToFeedItemPage:function(_314,_315){var url=toura.URL.feedItem(_314,_315);mulberry.app.Router.go(url);}});}if(!dojo._hasResource["toura.capabilities.FeedItemList_FeedItemDetail"]){dojo._hasResource["toura.capabilities.FeedItemList_FeedItemDetail"]=true;dojo.provide("toura.capabilities.FeedItemList_FeedItemDetail");dojo.declare("toura.capabilities.FeedItemList_FeedItemDetail",mulberry._Capability,{requirements:{feedItemList:"FeedItemList",feedItemDetail:"FeedItemDetail"},connects:[["feedItemList","onSelect","_showFeedItem"],["feedItemList","onPopulate","_showFirstItem"]],_showFeedItem:function(_316,_317){this.feedItemDetail.set("item",this.feedItemList.feed.getItem(_317));},_showFirstItem:function(){this.feedItemDetail.set("item",this.feedItemList.feed.getItem(0));}});}if(!dojo._hasResource["toura.capabilities.PageNav_FeedTitle"]){dojo._hasResource["toura.capabilities.PageNav_FeedTitle"]=true;dojo.provide("toura.capabilities.PageNav_FeedTitle");dojo.declare("toura.capabilities.PageNav_FeedTitle",mulberry._Capability,{requirements:{feedItemDetail:"FeedItemDetail",pageNav:"PageNav"},init:function(){this.pageNav.set("screenTitle",this.page.baseObj.feedName);}});}if(!dojo._hasResource["toura.capabilities.Page_Audios"]){dojo._hasResource["toura.capabilities.Page_Audios"]=true;dojo.provide("toura.capabilities.Page_Audios");dojo.declare("toura.capabilities.Page_Audios",mulberry._Capability,{requirements:{audioPlayer:"AudioPlayer",audioList:"AudioList"},connects:[["page","init","_setup"]],_setup:function(_318){if(this.baseObj.audios.length<2){dojo.destroy(this.audioList.domNode);}this._loadAudio(_318);},_loadAudio:function(_319){if(!_319.assetId||_319.assetType!=="audios"){return;}var _31a=_319.assetId,_31b=this._audioById(_31a);if(this.audioList){this.audioList.set("currentAsset",_31a);}if(this.audioCaption){this.audioCaption.set("content",_31b.caption||"");}this.audioPlayer.set("mediaId",_31a);}});}if(!dojo._hasResource["toura.capabilities.AudioList_AudioPlayer"]){dojo._hasResource["toura.capabilities.AudioList_AudioPlayer"]=true;dojo.provide("toura.capabilities.AudioList_AudioPlayer");dojo.declare("toura.capabilities.AudioList_AudioPlayer",mulberry._Capability,{requirements:{audioList:"AudioList",audioPlayer:"AudioPlayer"},connects:[["audioList","onSelect","_playAudio"]],_playAudio:function(_31c){this.audioPlayer.play(_31c);}});}if(!dojo._hasResource["toura.capabilities.AudioList_AudioCaption"]){dojo._hasResource["toura.capabilities.AudioList_AudioCaption"]=true;dojo.provide("toura.capabilities.AudioList_AudioCaption");dojo.declare("toura.capabilities.AudioList_AudioCaption",mulberry._Capability,{requirements:{audioList:"AudioList",audioCaption:"AudioCaption"},connects:[["audioList","onSelect","_setCaption"]],_setCaption:function(_31d){var _31e=this.baseObj.getAssetById("audio",_31d);if(!_31e){return;}this.audioCaption.set("content",_31e.caption||"");}});}if(!dojo._hasResource["toura.capabilities.Page_Videos"]){dojo._hasResource["toura.capabilities.Page_Videos"]=true;dojo.provide("toura.capabilities.Page_Videos");dojo.declare("toura.capabilities.Page_Videos",mulberry._Capability,{requirements:{videoPlayer:"VideoPlayer",videoList:"VideoList"},connects:[["page","init","_setup"]],_setup:function(_31f){this._loadVideo(_31f);},_loadVideo:function(_320){if(!_320.assetId||_320.assetType!=="videos"){return;}var _321=_320.assetId,_322=this._videoById(_321);if(this.videoList){this.videoList.set("currentAsset",_321);}if(this.videoCaption){this.videoCaption.set("content",_322.caption||"");}this.videoPlayer.set("mediaId",_321);}});}if(!dojo._hasResource["toura.capabilities.VideoList_VideoPlayer"]){dojo._hasResource["toura.capabilities.VideoList_VideoPlayer"]=true;dojo.provide("toura.capabilities.VideoList_VideoPlayer");dojo.declare("toura.capabilities.VideoList_VideoPlayer",mulberry._Capability,{requirements:{videoList:"VideoList",videoPlayer:"VideoPlayer"},connects:[["videoList","onSelect","_playVideo"]],_playVideo:function(_323){this.videoPlayer.play(_323);}});}if(!dojo._hasResource["toura.capabilities.VideoList_VideoCaption"]){dojo._hasResource["toura.capabilities.VideoList_VideoCaption"]=true;dojo.provide("toura.capabilities.VideoList_VideoCaption");dojo.declare("toura.capabilities.VideoList_VideoCaption",mulberry._Capability,{requirements:{videoList:"VideoList",videoCaption:"VideoCaption"},connects:[["videoList","onSelect","_setCaption"]],_setCaption:function(_324){var _325=this.baseObj.getAssetById("video",_324);if(!_325){return;}this.videoCaption.set("content",_325.caption||"");}});}if(!dojo._hasResource["toura.capabilities.Page_Search"]){dojo._hasResource["toura.capabilities.Page_Search"]=true;dojo.provide("toura.capabilities.Page_Search");dojo.declare("toura.capabilities.Page_Search",mulberry._Capability,{requirements:{searchInput:"SearchInput",searchResults:"SearchResults"},connects:[["searchInput","search","_handleSearch"]],init:function(){var term=this.baseObj.term||toura.lastSearchTerm;this.getResults=this.baseObj.getResults;if(term){this._handleSearch(term);}},_handleSearch:function(term){if(term===this.lastSearchTerm){return;}this.searchInput.set("searchTerm",term);this.searchResults.set("results",this.getResults(term));this.lastSearchTerm=toura.lastSearchTerm=term;}});}if(!dojo._hasResource["toura.capabilities.Text_ChildNodes"]){dojo._hasResource["toura.capabilities.Text_ChildNodes"]=true;dojo.provide("toura.capabilities.Text_ChildNodes");dojo.declare("toura.capabilities.Text_ChildNodes",mulberry._Capability,{requirements:{text:"BodyText",childNodes:"ChildNodes"},init:function(){if(this.childNodes.children.length===0){dojo.addClass(this.childNodes.region.domNode,"empty");}}});}if(!dojo._hasResource["toura.capabilities.Text_ChildNodes_VideoList"]){dojo._hasResource["toura.capabilities.Text_ChildNodes_VideoList"]=true;dojo.provide("toura.capabilities.Text_ChildNodes_VideoList");dojo.declare("toura.capabilities.Text_ChildNodes_VideoList",mulberry._Capability,{requirements:{text:"BodyText",childNodes:"ChildNodes",videoList:"VideoList"},init:function(){if(this.childNodes.children.length===0&&this.videoList.assets.length<=1){dojo.addClass(this.childNodes.region.domNode,"empty");}}});}if(!dojo._hasResource["toura.capabilities._base"]){dojo._hasResource["toura.capabilities._base"]=true;dojo.provide("toura.capabilities._base");}if(!dojo._hasResource["toura.components.buttons._Button"]){dojo._hasResource["toura.components.buttons._Button"]=true;dojo.provide("toura.components.buttons._Button");dojo.declare("toura.components.buttons._Button",mulberry._Component,{templateString:dojo.cache("toura.components.buttons","_Button/_Button.haml","%a.button{ title: i18n_text }\n"),url:"#",i18n_text:"",preventWhenAnimating:false,setupConnections:function(){this._setupTouch(this.domNode,"_handleClick");},_handleClick:function(e){if(e){e.preventDefault();}if(this.preventWhenAnimating&&mulberry.animating){return;}this.onClick(e);},onClick:function(e){if(this.url&&this.url!=="#"){mulberry.app.Router.go(this.url);}}});}if(!dojo._hasResource["toura.components.buttons.SearchButton"]){dojo._hasResource["toura.components.buttons.SearchButton"]=true;dojo.provide("toura.components.buttons.SearchButton");dojo.declare("toura.components.buttons.SearchButton",toura.components.buttons._Button,{"class":"search",url:toura.URL.search(),preventWhenAnimating:true});}if(!dojo._hasResource["toura.components.buttons.AboutButton"]){dojo._hasResource["toura.components.buttons.AboutButton"]=true;dojo.provide("toura.components.buttons.AboutButton");dojo.declare("toura.components.buttons.AboutButton",toura.components.buttons._Button,{"class":"about",prepareData:function(){this.url=toura.URL.about();},initializeStrings:function(){this.i18n_text=this.getString("ABOUT");}});dojo.mixin(toura.components.buttons.AboutButton,{isAvailable:function(){var _326=mulberry.app.Config.get("app");return _326.aboutEnabled&&!!_326.aboutNodeId;}});}if(!dojo._hasResource["toura.components.buttons.MapsButton"]){dojo._hasResource["toura.components.buttons.MapsButton"]=true;dojo.provide("toura.components.buttons.MapsButton");dojo.declare("toura.components.buttons.MapsButton",toura.components.buttons._Button,{"class":"maps",prepareData:function(){this.url=toura.URL.maps();},initializeStrings:function(){this.i18n_text=this.getString("MAPS");}});dojo.mixin(toura.components.buttons.MapsButton,{isAvailable:function(){var _327=mulberry.app.Config.get("app");return _327.mapsEnabled&&!!_327.mapNodeId;}});}if(!dojo._hasResource["toura.components.buttons.FavoritesButton"]){dojo._hasResource["toura.components.buttons.FavoritesButton"]=true;dojo.provide("toura.components.buttons.FavoritesButton");dojo.declare("toura.components.buttons.FavoritesButton",toura.components.buttons._Button,{"class":"favorites",prepareData:function(){this.url=toura.URL.favorites();},initializeStrings:function(){this.i18n_text=this.getString("FAVORITES");}});dojo.mixin(toura.components.buttons.FavoritesButton,{isAvailable:function(){return toura.features.favorites;}});}if(!dojo._hasResource["toura.components.AppNav"]){dojo._hasResource["toura.components.AppNav"]=true;dojo.provide("toura.components.AppNav");dojo.declare("toura.components.AppNav",mulberry._Component,{templateString:dojo.cache("toura.components","AppNav/AppNav.haml","%nav.component.app-nav\n  %ol{ dojoAttachPoint : 'buttonList' }\n"),widgetsInTemplate:true,handleClicks:true,setupChildComponents:function(){var _328=[toura.components.buttons.SearchButton,toura.components.buttons.AboutButton,toura.components.buttons.MapsButton,toura.components.buttons.FavoritesButton];dojo.forEach(_328,function(btn){if((btn.isAvailable&&btn.isAvailable())||!btn.isAvailable){var li=dojo.create("li");this.adopt(btn).placeAt(li);dojo.place(li,this.buttonList,"last");}},this);}});}if(!dojo._hasResource["toura.components.AssetList"]){dojo._hasResource["toura.components.AssetList"]=true;dojo.provide("toura.components.AssetList");dojo.declare("toura.components.AssetList",mulberry._Component,{templateString:dojo.cache("toura.components","AssetList/AssetList.haml",".component.asset-list\n  %ul{ dojoAttachPoint : 'list' }\n    :each a in assets\n      %li{ id : 'asset-' + a.id, data-id : a.id }\n        %a{ href : '#' }= a.name\n\n"),"class":"assets",prepareData:function(){this.assets=this.assets||(this.type&&this.node[this.type])||[];this.assets=dojo.map(this.assets,function(a){return dojo.mixin(a,{assetUrl:this.baseUrl+"/"+a.id});},this);this.baseUrl=this.node.assetTypeUrl(this.type);},setupConnections:function(){this.connect(this.domNode,"touchmove",function(){this.handle=null;});this.connect(this.domNode,"touchend",function(){if(this.handle&&dojo.isFunction(this.handle)){this.handle();}});dojo.forEach(this.list.children,function(n){var _329=dojo.attr(n,"data-id");if(mulberry.app.UI.hasTouch){this.connect(n,"touchstart",function(){this.handle=dojo.hitch(this,"_onSelect",_329);});this.connect(n,"click",function(e){e.preventDefault();});}else{this.connect(n,"click",function(e){e.preventDefault();this._onSelect(_329);});}},this);},_onSelect:function(_32a){this.set("currentAsset",_32a);this.onSelect(_32a);},onSelect:function(_32b){},_setCurrentAssetAttr:function(_32c){var item=this.query("#asset-"+_32c)[0];this.query(".asset-list li").removeClass("current");dojo.addClass(item,"current");this.currentAsset=_32c;}});}if(!dojo._hasResource["toura.components.BodyText"]){dojo._hasResource["toura.components.BodyText"]=true;dojo.provide("toura.components.BodyText");dojo.declare("toura.components.BodyText",mulberry._Component,{templateString:dojo.cache("toura.components","BodyText/BodyText.haml",".component.body-text\n  %div{ dojoAttachPoint : 'bodyTextContainer' }= bodyText\n"),prepareData:function(){this.bodyText=this.bodyText||this._getBodyText();},adjustMarkup:function(){if(!dojo.trim(this.bodyText)){this.addClass("empty");}},_getBodyText:function(){if(!this.node){return "";}return this.node.bodyText?this.node.bodyText.body:"";},setupConnections:function(){this.query("a[rel=\"external\"]").attr("target","_blank");this.connect(this.domNode,"click","_handleClick");},_handleClick:function(e){var t=e.target,href,rel;if(t.nodeName.toLowerCase()!=="a"){return;}rel=dojo.attr(t,"rel");if(rel&&rel==="external"){return;}href=dojo.attr(t,"href");if(/^http/.test(href)){e.preventDefault();mulberry.app.PhoneGap.browser.url(href);return;}},_setContentAttr:function(val){this.bodyTextContainer.innerHTML=val;dojo[val?"removeClass":"addClass"](this.domNode,"empty");dojo.publish("/content/update");}});}if(!dojo._hasResource["toura.components.AudioCaption"]){dojo._hasResource["toura.components.AudioCaption"]=true;dojo.provide("toura.components.AudioCaption");dojo.declare("toura.components.AudioCaption",toura.components.BodyText,{"class":"audio-caption",_getBodyText:function(){if(!this.node||!this.node.audios){return "";}return this.node.audios[0]?(this.node.audios[0].caption||""):"";}});}if(!dojo._hasResource["toura.components.AudioList"]){dojo._hasResource["toura.components.AudioList"]=true;dojo.provide("toura.components.AudioList");dojo.declare("toura.components.AudioList",toura.components.AssetList,{"class":"audio-list",postMixInProperties:function(){this.assets=this.node.audios||[];this.inherited(arguments);}});}if(!dojo._hasResource["toura.components._MediaPlayer"]){dojo._hasResource["toura.components._MediaPlayer"]=true;dojo.provide("toura.components._MediaPlayer");(function(){var pg=mulberry.app.PhoneGap;dojo.declare("toura.components._MediaPlayer",mulberry._Component,{useHtml5Player:true,prepareData:function(){this.inherited(arguments);this.mediasCache={};this.medias=dojo.map(this.medias||[],function(_32d){this.mediasCache[_32d.id]=_32d=dojo.mixin(_32d,{assetUrl:[this.baseUrl,_32d.id].join("/")});return _32d;},this);this.media=this.medias[0]||null;this.useHtml5Player=mulberry.app.Has.html5Player();},setupSubscriptions:function(){this.inherited(arguments);if(!this.useHtml5Player){return;}this.subscribe("/page/transition/end","_setupPlayer");},adjustMarkup:function(){if(!this.useHtml5Player){this.addClass("has-html5-player");}},play:function(_32e){this.set("mediaId",_32e);this._play(this.media);},_play:function(_32f){if(this.useHtml5Player){this.player.play();}dojo.publish("/"+this.playerType+"/play",[this.media.id]);},_pause:function(){if(this.useHtml5Player&&this.player){this.player.pause();}},_setMediaIdAttr:function(_330){var _331=this.media=this.mediasCache[_330];if(this.useHtml5Player&&!this.player){this._queuedMedia=_331;return;}this._queuedMedia=null;if(this.player){this.player.src=_331.url;}},_setupPlayer:function(){if(!this.useHtml5Player){return;}if(!this.media){return;}var _332=this.media,_333=this.domNode,_334=this.player=dojo.create(this.playerType,dojo.mixin({src:_332.url},this.playerSettings)),doIt=dojo.partial(dojo.place,_334,_333);var c=dojo.connect(_334,"loadstart",this,function(){dojo.disconnect(c);c=false;if(!_333){return;}doIt();});setTimeout(function(){if(!c){return;}dojo.disconnect(c);doIt();},100);}});}());}if(!dojo._hasResource["toura.components.AudioPlayer"]){dojo._hasResource["toura.components.AudioPlayer"]=true;dojo.provide("toura.components.AudioPlayer");dojo.declare("toura.components.AudioPlayer",toura.components._MediaPlayer,{templateString:dojo.cache("toura.components","AudioPlayer/AudioPlayer.haml",".component.audio-player\n  :if !useHtml5Player\n    %form\n      %input{ type : 'button', class : 'play', dojoAttachPoint : 'controller' }\n"),playerType:"audio",isPlaying:false,playerSettings:{preload:"auto",controls:true,autobuffer:true},prepareData:function(){this.medias=this.node.audios||[];this.inherited(arguments);},setupConnections:function(){this.inherited(arguments);if(!this.useHtml5Player){this.connect(this.controller,"click","_handleControllerClick");}},_handleControllerClick:function(){if(this.useHtml5Player){return;}if(this.isPlaying){this._pause();this.isPlaying=false;this.removeClass("playing");}else{this._play();this.isPlaying=true;this.addClass("playing");}},_play:function(_335){this.inherited(arguments);if(this.useHtml5Player){return;}var pg=mulberry.app.PhoneGap;pg.audio.destroy();pg.audio.play(this.media.url);},_pause:function(){this.inherited(arguments);if(!this.useHtml5Player){mulberry.app.PhoneGap.audio.stop();}},teardown:function(){if(!this.useHtml5Player){mulberry.app.PhoneGap.audio.destroy();}}});}if(!dojo._hasResource["mulberry.ui.BackgroundImage"]){dojo._hasResource["mulberry.ui.BackgroundImage"]=true;dojo.provide("mulberry.ui.BackgroundImage");dojo.declare("mulberry.ui.BackgroundImage",dijit._Widget,{imageUrl:"",isLoaded:false,loadOnInit:false,postCreate:function(){this.inherited(arguments);if(this.loadOnInit){this.loadImage();}},loadImage:function(){if(this.isLoaded){return;}dojo.style(this.domNode,{"backgroundImage":"url("+this.imageUrl+")","backgroundRepeat":"no-repeat"});this.isLoaded=true;},unloadImage:function(){dojo.style(this.domNode,"backgroundImage",null);this.isLoaded=false;},_setBackgroundImageAttr:function(_336){if(!_336){return;}this.imageUrl=_336.url;}});}if(!dojo._hasResource["toura.components.ChildNodeGrid"]){dojo._hasResource["toura.components.ChildNodeGrid"]=true;dojo.provide("toura.components.ChildNodeGrid");dojo.declare("toura.components.ChildNodeGrid",mulberry._Component,{templateString:dojo.cache("toura.components","ChildNodeGrid/ChildNodeGrid.haml","%ul.component.child-node-grid\n  :each c in children\n    %li\n      %a{ href : c.url }\n        :if tablet\n          .image{ dojoType : 'mulberry.ui.BackgroundImage', imageUrl : c.featuredImage.large.url, loadOnInit: true }\n        :if phone\n          .image{ dojoType : 'mulberry.ui.BackgroundImage', imageUrl : c.featuredImage.small.url, loadOnInit: true }\n        %h3= c.name\n"),widgetsInTemplate:true,prepareData:function(){this.node.populateChildren();this.children=dojo.filter(this.node.children||[],function(_337){return _337.featuredImage!==undefined;});if(this.tablet){var num=this.children.length,size=num>11?"medium":"large";this["class"]="size-"+size;}if(this.device.os==="ios"){return;}if(toura.components.ChildNodeGrid.placedCSS){return;}var tpl=dojo.cache("toura.components.ChildNodeGrid","child-node-grid.css.tpl","<style id=\"component-css-child-node-grid\">\n\n  .android.phone .child-node-grid li {\n    height: ${height}px;\n    width: ${width}px;\n  }\n\n  .android.phone .child-node-grid li h3 {\n    height: 2.5em;\n    overflow: hidden;\n  }\n\n  .android.phone .child-node-grid li .image {\n    width: ${width}px;\n    height: ${imageHeight}px;\n  }\n\n</style>\n"),_338=3/4,_339=Math.floor(mulberry.app.UI.viewport.width/2-18),_33a=Math.floor(_339*_338*1.4),_33b=_339*_338,css=dojo.string.substitute(tpl,{width:_339,height:_33a,imageHeight:_33b});dojo.place(css,document.querySelector("head"));toura.components.ChildNodeGrid.placedCSS=true;}});}if(!dojo._hasResource["toura.components.ChildNodes"]){dojo._hasResource["toura.components.ChildNodes"]=true;dojo.provide("toura.components.ChildNodes");dojo.declare("toura.components.ChildNodes",mulberry._Component,{templateString:dojo.cache("toura.components","ChildNodes/ChildNodes.haml","%ul.component.child-nodes\n  :each c in children\n    %li\n      %a{ href : '#/node/' + c.id }= c.name\n"),handleClicks:true,prepareData:function(){this.children=this.node.children||[];},adjustMarkup:function(){if(!this.children.length){this.addClass("empty");}},_clickHandler:function(t,e){dojo.addClass(t,"tapped");}});}if(!dojo._hasResource["toura.components.HeaderImage"]){dojo._hasResource["toura.components.HeaderImage"]=true;dojo.provide("toura.components.HeaderImage");dojo.declare("toura.components.HeaderImage",mulberry._Component,{templateString:dojo.cache("toura.components","HeaderImage/HeaderImage.haml",".component.header-image\n  :if viewImage\n    %img{ src : viewImage.url, width : viewImage.width, height : viewImage.height, dojoAttachPoint : 'imageNode' }\n"),prepareData:function(){this.inherited(arguments);var _33c=this.device.type,_33d=this.phone?"gallery":"original";if(this.node.headerImage&&this.node.headerImage[_33c]){this.image=this.node.headerImage[_33c][_33d];this.viewImage=dojo.mixin({},this.image);}else{this.viewImage=false;}},setupConnections:function(){if(!this.image){return;}var _33e=this.node.headerImage[this.device.type];if(_33e.destination){this.connect(this.domNode,"click",function(){mulberry.app.PhoneGap.browser.url(_33e.destination);});}},setupSubscriptions:function(){this.subscribe("/window/resize","_resizeImage");},teardown:function(){dojo.destroy(this.domNode);},resizeElements:function(){if(!this.viewImage){this.destroy();return;}this._resizeImage();},_resizeImage:function(){if(!this.imageNode){return;}dojo.attr(this.imageNode,this._calculateDimensions());},_calculateDimensions:function(){var w=this._getWidth(),img=this.image;return {width:img?w:0,height:img?Math.ceil(img.height*(w/img.width)):0};},_getWidth:function(){return this.getDimensions().width;}});}if(!dojo._hasResource["toura.components.ColumnHeaderImage"]){dojo._hasResource["toura.components.ColumnHeaderImage"]=true;dojo.provide("toura.components.ColumnHeaderImage");dojo.declare("toura.components.ColumnHeaderImage",toura.components.HeaderImage,{"class":"column-header-image"});}if(!dojo._hasResource["toura.components.DetailTitle"]){dojo._hasResource["toura.components.DetailTitle"]=true;dojo.provide("toura.components.DetailTitle");dojo.declare("toura.components.DetailTitle",mulberry._Component,{templateString:dojo.cache("toura.components","DetailTitle/DetailTitle.haml",".component.detail-title\n  %a.close{ href : '#', dojoAttachPoint : 'closeButton' }= i18n_close\n  %h1{ dojoAttachPoint : 'titleElement' }= title\n"),setupConnections:function(){this.connect(this.closeButton,"click","_close");},_close:function(e){e.preventDefault();this.onClose();},onClose:function(){},initializeStrings:function(){this.i18n_close=this.getString("CLOSE");},attributeMap:{screenTitle:{node:"titleElement",type:"innerHTML"}}});}if(!dojo._hasResource["toura.components.DropDownText"]){dojo._hasResource["toura.components.DropDownText"]=true;dojo.provide("toura.components.DropDownText");dojo.declare("toura.components.DropDownText",toura.components.BodyText,{templateString:dojo.cache("toura.components","DropDownText/DropDownText.haml",".component.drop-down-text\n  .open-wrapper{ dojoAttachPoint : 'openButton' }\n    .button.open\n      %span=i18n_instructions\n\n  .text-wrapper{ dojoAttachPoint : 'textWrapper' }\n    .body-text-container{ dojoAttachPoint : 'bodyTextContainer' }= bodyText\n    .button.close{ dojoAttachPoint : 'closeButton' }\n      %span=i18n_close\n\n"),adjustMarkup:function(){this.hide(this.textWrapper);},initializeStrings:function(){this.i18n_close=this.getString("CLOSE");this.i18n_instructions=this.getString("INSTRUCTIONS");},setupConnections:function(){this.connect(this.openButton,"click",function(){this.hide(this.openButton);this.show(this.textWrapper);});this.connect(this.textWrapper,"click",function(){this.hide(this.textWrapper);this.show(this.openButton);});}});}if(!dojo._hasResource["toura.components.buttons.DeleteButton"]){dojo._hasResource["toura.components.buttons.DeleteButton"]=true;dojo.provide("toura.components.buttons.DeleteButton");dojo.declare("toura.components.buttons.DeleteButton",toura.components.buttons._Button,{templateString:dojo.cache("toura.components.buttons","DeleteButton/DeleteButton.haml","%div.button{ title: i18n_text }\n"),objId:"",deleting:false,onClick:function(e){if(this.deleting){this.onDelete(this.objId,this.domNode);return;}dojo.addClass(this.domNode,"deleting");this.deleting=true;},initializeStrings:function(){this.i18n_text=this.getString("DELETE");},onDelete:function(id,_33f){}});}if(!dojo._hasResource["toura.components.Favorites"]){dojo._hasResource["toura.components.Favorites"]=true;dojo.provide("toura.components.Favorites");dojo.declare("toura.components.Favorites",mulberry._Component,{templateString:dojo.cache("toura.components","Favorites/Favorites.haml",".component.favorites\n  %ul{ dojoAttachPoint : 'favoritesList' }\n    :if favorites.length\n\n      :each fav in favorites\n        %li{ class : fav.type }\n\n          %a{ href : fav.model.url }\n            :if fav.img\n              .img{ dojoType : 'mulberry.ui.BackgroundImage', imageUrl : fav.img, loadOnInit : true }\n\n            :if !fav.img\n              .img.default\n\n            .text\n              %h2= fav.name\n\n              :if fav.displayText\n                %p= fav.displayText\n\n          .delete{ dojoType : 'toura.components.buttons.DeleteButton', objId : fav.id, dojoAttachEvent : 'onDelete: _deleteFavorite' }\n\n    :if !favorites.length\n      %li= i18n_noFavorites\n"),handleClicks:true,widgetsInTemplate:true,prepareData:function(){this.favorites=dojo.filter(this.node.favorites||[],function(fav){return !fav.deleted;});this.favorites=dojo.map(this.favorites,function(fav){fav.img=fav.model.featuredImage&&fav.model.featuredImage.small.url;fav.displayText=fav.model.bodyText&&fav.model.bodyText.body?mulberry.util.truncate(fav.model.bodyText.body,200):false;return fav;},this);},initializeStrings:function(){this.i18n_noFavorites=this.getString("FAVORITES_NO_FAVORITES");},_deleteFavorite:function(id,_340){dojo.publish("/favorite/remove",[id]);dojo.destroy(_340.parentNode);}});}if(!dojo._hasResource["dojo.date"]){dojo._hasResource["dojo.date"]=true;dojo.provide("dojo.date");dojo.getObject("date",true,dojo);dojo.date.getDaysInMonth=function(_341){var _342=_341.getMonth();var days=[31,28,31,30,31,30,31,31,30,31,30,31];if(_342==1&&dojo.date.isLeapYear(_341)){return 29;}return days[_342];};dojo.date.isLeapYear=function(_343){var year=_343.getFullYear();return !(year%400)||(!(year%4)&&!!(year%100));};dojo.date.getTimezoneName=function(_344){var str=_344.toString();var tz="";var _345;var pos=str.indexOf("(");if(pos>-1){tz=str.substring(++pos,str.indexOf(")"));}else{var pat=/([A-Z\/]+) \d{4}$/;if((_345=str.match(pat))){tz=_345[1];}else{str=_344.toLocaleString();pat=/ ([A-Z\/]+)$/;if((_345=str.match(pat))){tz=_345[1];}}}return (tz=="AM"||tz=="PM")?"":tz;};dojo.date.compare=function(_346,_347,_348){_346=new Date(+_346);_347=new Date(+(_347||new Date()));if(_348=="date"){_346.setHours(0,0,0,0);_347.setHours(0,0,0,0);}else{if(_348=="time"){_346.setFullYear(0,0,0);_347.setFullYear(0,0,0);}}if(_346>_347){return 1;}if(_346<_347){return -1;}return 0;};dojo.date.add=function(date,_349,_34a){var sum=new Date(+date);var _34b=false;var _34c="Date";switch(_349){case "day":break;case "weekday":var days,_34d;var mod=_34a%5;if(!mod){days=(_34a>0)?5:-5;_34d=(_34a>0)?((_34a-5)/5):((_34a+5)/5);}else{days=mod;_34d=parseInt(_34a/5);}var strt=date.getDay();var adj=0;if(strt==6&&_34a>0){adj=1;}else{if(strt==0&&_34a<0){adj=-1;}}var trgt=strt+days;if(trgt==0||trgt==6){adj=(_34a>0)?2:-2;}_34a=(7*_34d)+days+adj;break;case "year":_34c="FullYear";_34b=true;break;case "week":_34a*=7;break;case "quarter":_34a*=3;case "month":_34b=true;_34c="Month";break;default:_34c="UTC"+_349.charAt(0).toUpperCase()+_349.substring(1)+"s";}if(_34c){sum["set"+_34c](sum["get"+_34c]()+_34a);}if(_34b&&(sum.getDate()<date.getDate())){sum.setDate(0);}return sum;};dojo.date.difference=function(_34e,_34f,_350){_34f=_34f||new Date();_350=_350||"day";var _351=_34f.getFullYear()-_34e.getFullYear();var _352=1;switch(_350){case "quarter":var m1=_34e.getMonth();var m2=_34f.getMonth();var q1=Math.floor(m1/3)+1;var q2=Math.floor(m2/3)+1;q2+=(_351*4);_352=q2-q1;break;case "weekday":var days=Math.round(dojo.date.difference(_34e,_34f,"day"));var _353=parseInt(dojo.date.difference(_34e,_34f,"week"));var mod=days%7;if(mod==0){days=_353*5;}else{var adj=0;var aDay=_34e.getDay();var bDay=_34f.getDay();_353=parseInt(days/7);mod=days%7;var _354=new Date(_34e);_354.setDate(_354.getDate()+(_353*7));var _355=_354.getDay();if(days>0){switch(true){case aDay==6:adj=-1;break;case aDay==0:adj=0;break;case bDay==6:adj=-1;break;case bDay==0:adj=-2;break;case (_355+mod)>5:adj=-2;}}else{if(days<0){switch(true){case aDay==6:adj=0;break;case aDay==0:adj=1;break;case bDay==6:adj=2;break;case bDay==0:adj=1;break;case (_355+mod)<0:adj=2;}}}days+=adj;days-=(_353*2);}_352=days;break;case "year":_352=_351;break;case "month":_352=(_34f.getMonth()-_34e.getMonth())+(_351*12);break;case "week":_352=parseInt(dojo.date.difference(_34e,_34f,"day")/7);break;case "day":_352/=24;case "hour":_352/=60;case "minute":_352/=60;case "second":_352/=1000;case "millisecond":_352*=_34f.getTime()-_34e.getTime();}return Math.round(_352);};}if(!dojo._hasResource["dojo.cldr.supplemental"]){dojo._hasResource["dojo.cldr.supplemental"]=true;dojo.provide("dojo.cldr.supplemental");dojo.getObject("cldr.supplemental",true,dojo);dojo.cldr.supplemental.getFirstDayOfWeek=function(_356){var _357={mv:5,ae:6,af:6,bh:6,dj:6,dz:6,eg:6,er:6,et:6,iq:6,ir:6,jo:6,ke:6,kw:6,ly:6,ma:6,om:6,qa:6,sa:6,sd:6,so:6,sy:6,tn:6,ye:6,ar:0,as:0,az:0,bw:0,ca:0,cn:0,fo:0,ge:0,gl:0,gu:0,hk:0,il:0,"in":0,jm:0,jp:0,kg:0,kr:0,la:0,mh:0,mn:0,mo:0,mp:0,mt:0,nz:0,ph:0,pk:0,sg:0,th:0,tt:0,tw:0,um:0,us:0,uz:0,vi:0,zw:0};var _358=dojo.cldr.supplemental._region(_356);var dow=_357[_358];return (dow===undefined)?1:dow;};dojo.cldr.supplemental._region=function(_359){_359=dojo.i18n.normalizeLocale(_359);var tags=_359.split("-");var _35a=tags[1];if(!_35a){_35a={de:"de",en:"us",es:"es",fi:"fi",fr:"fr",he:"il",hu:"hu",it:"it",ja:"jp",ko:"kr",nl:"nl",pt:"br",sv:"se",zh:"cn"}[tags[0]];}else{if(_35a.length==4){_35a=tags[2];}}return _35a;};dojo.cldr.supplemental.getWeekend=function(_35b){var _35c={"in":0,af:4,dz:4,ir:4,om:4,sa:4,ye:4,ae:5,bh:5,eg:5,il:5,iq:5,jo:5,kw:5,ly:5,ma:5,qa:5,sd:5,sy:5,tn:5};var _35d={af:5,dz:5,ir:5,om:5,sa:5,ye:5,ae:6,bh:5,eg:6,il:6,iq:6,jo:6,kw:6,ly:6,ma:6,qa:6,sd:6,sy:6,tn:6};var _35e=dojo.cldr.supplemental._region(_35b);var _35f=_35c[_35e];var end=_35d[_35e];if(_35f===undefined){_35f=6;}if(end===undefined){end=0;}return {start:_35f,end:end};};}if(!dojo._hasResource["dojo.regexp"]){dojo._hasResource["dojo.regexp"]=true;dojo.provide("dojo.regexp");dojo.getObject("regexp",true,dojo);dojo.regexp.escapeString=function(str,_360){return str.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g,function(ch){if(_360&&_360.indexOf(ch)!=-1){return ch;}return "\\"+ch;});};dojo.regexp.buildGroupRE=function(arr,re,_361){if(!(arr instanceof Array)){return re(arr);}var b=[];for(var i=0;i<arr.length;i++){b.push(re(arr[i]));}return dojo.regexp.group(b.join("|"),_361);};dojo.regexp.group=function(_362,_363){return "("+(_363?"?:":"")+_362+")";};}if(!dojo._hasResource["dojo.date.locale"]){dojo._hasResource["dojo.date.locale"]=true;dojo.provide("dojo.date.locale");dojo.getObject("date.locale",true,dojo);(function(){function _364(_365,_366,_367,_368){return _368.replace(/([a-z])\1*/ig,function(_369){var s,pad,c=_369.charAt(0),l=_369.length,_36a=["abbr","wide","narrow"];switch(c){case "G":s=_366[(l<4)?"eraAbbr":"eraNames"][_365.getFullYear()<0?0:1];break;case "y":s=_365.getFullYear();switch(l){case 1:break;case 2:if(!_367.fullYear){s=String(s);s=s.substr(s.length-2);break;}default:pad=true;}break;case "Q":case "q":s=Math.ceil((_365.getMonth()+1)/3);pad=true;break;case "M":var m=_365.getMonth();if(l<3){s=m+1;pad=true;}else{var _36b=["months","format",_36a[l-3]].join("-");s=_366[_36b][m];}break;case "w":var _36c=0;s=dojo.date.locale._getWeekOfYear(_365,_36c);pad=true;break;case "d":s=_365.getDate();pad=true;break;case "D":s=dojo.date.locale._getDayOfYear(_365);pad=true;break;case "E":var d=_365.getDay();if(l<3){s=d+1;pad=true;}else{var _36d=["days","format",_36a[l-3]].join("-");s=_366[_36d][d];}break;case "a":var _36e=(_365.getHours()<12)?"am":"pm";s=_367[_36e]||_366["dayPeriods-format-wide-"+_36e];break;case "h":case "H":case "K":case "k":var h=_365.getHours();switch(c){case "h":s=(h%12)||12;break;case "H":s=h;break;case "K":s=(h%12);break;case "k":s=h||24;break;}pad=true;break;case "m":s=_365.getMinutes();pad=true;break;case "s":s=_365.getSeconds();pad=true;break;case "S":s=Math.round(_365.getMilliseconds()*Math.pow(10,l-3));pad=true;break;case "v":case "z":s=dojo.date.locale._getZone(_365,true,_367);if(s){break;}l=4;case "Z":var _36f=dojo.date.locale._getZone(_365,false,_367);var tz=[(_36f<=0?"+":"-"),dojo.string.pad(Math.floor(Math.abs(_36f)/60),2),dojo.string.pad(Math.abs(_36f)%60,2)];if(l==4){tz.splice(0,0,"GMT");tz.splice(3,0,":");}s=tz.join("");break;default:throw new Error("dojo.date.locale.format: invalid pattern char: "+_368);}if(pad){s=dojo.string.pad(s,l);}return s;});};dojo.date.locale._getZone=function(_370,_371,_372){if(_371){return dojo.date.getTimezoneName(_370);}else{return _370.getTimezoneOffset();}};dojo.date.locale.format=function(_373,_374){_374=_374||{};var _375=dojo.i18n.normalizeLocale(_374.locale),_376=_374.formatLength||"short",_377=dojo.date.locale._getGregorianBundle(_375),str=[],_378=dojo.hitch(this,_364,_373,_377,_374);if(_374.selector=="year"){return _379(_377["dateFormatItem-yyyy"]||"yyyy",_378);}var _37a;if(_374.selector!="date"){_37a=_374.timePattern||_377["timeFormat-"+_376];if(_37a){str.push(_379(_37a,_378));}}if(_374.selector!="time"){_37a=_374.datePattern||_377["dateFormat-"+_376];if(_37a){str.push(_379(_37a,_378));}}return str.length==1?str[0]:_377["dateTimeFormat-"+_376].replace(/\{(\d+)\}/g,function(_37b,key){return str[key];});};dojo.date.locale.regexp=function(_37c){return dojo.date.locale._parseInfo(_37c).regexp;};dojo.date.locale._parseInfo=function(_37d){_37d=_37d||{};var _37e=dojo.i18n.normalizeLocale(_37d.locale),_37f=dojo.date.locale._getGregorianBundle(_37e),_380=_37d.formatLength||"short",_381=_37d.datePattern||_37f["dateFormat-"+_380],_382=_37d.timePattern||_37f["timeFormat-"+_380],_383;if(_37d.selector=="date"){_383=_381;}else{if(_37d.selector=="time"){_383=_382;}else{_383=_37f["dateTimeFormat-"+_380].replace(/\{(\d+)\}/g,function(_384,key){return [_382,_381][key];});}}var _385=[],re=_379(_383,dojo.hitch(this,_386,_385,_37f,_37d));return {regexp:re,tokens:_385,bundle:_37f};};dojo.date.locale.parse=function(_387,_388){var _389=/[\u200E\u200F\u202A\u202E]/g,info=dojo.date.locale._parseInfo(_388),_38a=info.tokens,_38b=info.bundle,re=new RegExp("^"+info.regexp.replace(_389,"")+"$",info.strict?"":"i"),_38c=re.exec(_387&&_387.replace(_389,""));if(!_38c){return null;}var _38d=["abbr","wide","narrow"],_38e=[1970,0,1,0,0,0,0],amPm="",_38f=dojo.every(_38c,function(v,i){if(!i){return true;}var _390=_38a[i-1];var l=_390.length;switch(_390.charAt(0)){case "y":if(l!=2&&_388.strict){_38e[0]=v;}else{if(v<100){v=Number(v);var year=""+new Date().getFullYear(),_391=year.substring(0,2)*100,_392=Math.min(Number(year.substring(2,4))+20,99),num=(v<_392)?_391+v:_391-100+v;_38e[0]=num;}else{if(_388.strict){return false;}_38e[0]=v;}}break;case "M":if(l>2){var _393=_38b["months-format-"+_38d[l-3]].concat();if(!_388.strict){v=v.replace(".","").toLowerCase();_393=dojo.map(_393,function(s){return s.replace(".","").toLowerCase();});}v=dojo.indexOf(_393,v);if(v==-1){return false;}}else{v--;}_38e[1]=v;break;case "E":case "e":var days=_38b["days-format-"+_38d[l-3]].concat();if(!_388.strict){v=v.toLowerCase();days=dojo.map(days,function(d){return d.toLowerCase();});}v=dojo.indexOf(days,v);if(v==-1){return false;}break;case "D":_38e[1]=0;case "d":_38e[2]=v;break;case "a":var am=_388.am||_38b["dayPeriods-format-wide-am"],pm=_388.pm||_38b["dayPeriods-format-wide-pm"];if(!_388.strict){var _394=/\./g;v=v.replace(_394,"").toLowerCase();am=am.replace(_394,"").toLowerCase();pm=pm.replace(_394,"").toLowerCase();}if(_388.strict&&v!=am&&v!=pm){return false;}amPm=(v==pm)?"p":(v==am)?"a":"";break;case "K":if(v==24){v=0;}case "h":case "H":case "k":if(v>23){return false;}_38e[3]=v;break;case "m":_38e[4]=v;break;case "s":_38e[5]=v;break;case "S":_38e[6]=v;}return true;});var _395=+_38e[3];if(amPm==="p"&&_395<12){_38e[3]=_395+12;}else{if(amPm==="a"&&_395==12){_38e[3]=0;}}var _396=new Date(_38e[0],_38e[1],_38e[2],_38e[3],_38e[4],_38e[5],_38e[6]);if(_388.strict){_396.setFullYear(_38e[0]);}var _397=_38a.join(""),_398=_397.indexOf("d")!=-1,_399=_397.indexOf("M")!=-1;if(!_38f||(_399&&_396.getMonth()>_38e[1])||(_398&&_396.getDate()>_38e[2])){return null;}if((_399&&_396.getMonth()<_38e[1])||(_398&&_396.getDate()<_38e[2])){_396=dojo.date.add(_396,"hour",1);}return _396;};function _379(_39a,_39b,_39c,_39d){var _39e=function(x){return x;};_39b=_39b||_39e;_39c=_39c||_39e;_39d=_39d||_39e;var _39f=_39a.match(/(''|[^'])+/g),_3a0=_39a.charAt(0)=="'";dojo.forEach(_39f,function(_3a1,i){if(!_3a1){_39f[i]="";}else{_39f[i]=(_3a0?_39c:_39b)(_3a1.replace(/''/g,"'"));_3a0=!_3a0;}});return _39d(_39f.join(""));};function _386(_3a2,_3a3,_3a4,_3a5){_3a5=dojo.regexp.escapeString(_3a5);if(!_3a4.strict){_3a5=_3a5.replace(" a"," ?a");}return _3a5.replace(/([a-z])\1*/ig,function(_3a6){var s,c=_3a6.charAt(0),l=_3a6.length,p2="",p3="";if(_3a4.strict){if(l>1){p2="0"+"{"+(l-1)+"}";}if(l>2){p3="0"+"{"+(l-2)+"}";}}else{p2="0?";p3="0{0,2}";}switch(c){case "y":s="\\d{2,4}";break;case "M":s=(l>2)?"\\S+?":p2+"[1-9]|1[0-2]";break;case "D":s=p2+"[1-9]|"+p3+"[1-9][0-9]|[12][0-9][0-9]|3[0-5][0-9]|36[0-6]";break;case "d":s="3[01]|[12]\\d|"+p2+"[1-9]";break;case "w":s=p2+"[1-9]|[1-4][0-9]|5[0-3]";break;case "E":s="\\S+";break;case "h":s=p2+"[1-9]|1[0-2]";break;case "k":s=p2+"\\d|1[01]";break;case "H":s=p2+"\\d|1\\d|2[0-3]";break;case "K":s=p2+"[1-9]|1\\d|2[0-4]";break;case "m":case "s":s="[0-5]\\d";break;case "S":s="\\d{"+l+"}";break;case "a":var am=_3a4.am||_3a3["dayPeriods-format-wide-am"],pm=_3a4.pm||_3a3["dayPeriods-format-wide-pm"];if(_3a4.strict){s=am+"|"+pm;}else{s=am+"|"+pm;if(am!=am.toLowerCase()){s+="|"+am.toLowerCase();}if(pm!=pm.toLowerCase()){s+="|"+pm.toLowerCase();}if(s.indexOf(".")!=-1){s+="|"+s.replace(/\./g,"");}}s=s.replace(/\./g,"\\.");break;default:s=".*";}if(_3a2){_3a2.push(_3a6);}return "("+s+")";}).replace(/[\xa0 ]/g,"[\\s\\xa0]");};})();(function(){var _3a7=[];dojo.date.locale.addCustomFormats=function(_3a8,_3a9){_3a7.push({pkg:_3a8,name:_3a9});};dojo.date.locale._getGregorianBundle=function(_3aa){var _3ab={};dojo.forEach(_3a7,function(desc){var _3ac=dojo.i18n.getLocalization(desc.pkg,desc.name,_3aa);_3ab=dojo.mixin(_3ab,_3ac);},this);return _3ab;};})();dojo.date.locale.addCustomFormats("dojo.cldr","gregorian");dojo.date.locale.getNames=function(item,type,_3ad,_3ae){var _3af,_3b0=dojo.date.locale._getGregorianBundle(_3ae),_3b1=[item,_3ad,type];if(_3ad=="standAlone"){var key=_3b1.join("-");_3af=_3b0[key];if(_3af[0]==1){_3af=undefined;}}_3b1[1]="format";return (_3af||_3b0[_3b1.join("-")]).concat();};dojo.date.locale.isWeekend=function(_3b2,_3b3){var _3b4=dojo.cldr.supplemental.getWeekend(_3b3),day=(_3b2||new Date()).getDay();if(_3b4.end<_3b4.start){_3b4.end+=7;if(day<_3b4.start){day+=7;}}return day>=_3b4.start&&day<=_3b4.end;};dojo.date.locale._getDayOfYear=function(_3b5){return dojo.date.difference(new Date(_3b5.getFullYear(),0,1,_3b5.getHours()),_3b5)+1;};dojo.date.locale._getWeekOfYear=function(_3b6,_3b7){if(arguments.length==1){_3b7=0;}var _3b8=new Date(_3b6.getFullYear(),0,1).getDay(),adj=(_3b8-_3b7+7)%7,week=Math.floor((dojo.date.locale._getDayOfYear(_3b6)+adj-1)/7);if(_3b8==_3b7){week++;}return week;};}if(!dojo._hasResource["toura.components.FeedItemDetail"]){dojo._hasResource["toura.components.FeedItemDetail"]=true;dojo.provide("toura.components.FeedItemDetail");dojo.declare("toura.components.FeedItemDetail",mulberry._Component,{templateString:dojo.cache("toura.components","FeedItemDetail/FeedItemDetail.haml",".component.feed-item-detail\n  %article{ dojoAttachPoint : 'content' }\n  %a.full{ dojoAttachPoint : 'externalLink' }= i18n_viewOriginal\n"),itemTemplate:Haml(dojo.cache("toura.components","FeedItemDetail/Item.haml",":if image\n  .image{ style: 'background-image: url(' + image.url + ')' }\n\n.date= pubDate\n\n%h2= title\n.item-body{ dojoAttachPoint : 'itemBody' }= body\n")),prepareData:function(){this.item=this.node;},setupConnections:function(){this.connect(this.externalLink,"click",function(e){e.preventDefault();mulberry.app.PhoneGap.browser.url(this.item.link);});},initializeStrings:function(){this.i18n_viewOriginal=this.getString("FEED_VIEW_ORIGINAL");},_setItemAttr:function(_3b9){if(_3b9.type!=="feedItem"){return;}this.item=_3b9;dojo.empty(this.content);dojo.place(this.itemTemplate(dojo.delegate(this.item,{pubDate:dojo.date.locale.format(this.item.pubDate),i18n_viewOriginal:this.i18n_viewOriginal})),this.content);dojo.attr(this.externalLink,"href",this.item.link);this._setupLinks();if(this.region){this.region.refreshScroller();}},_setupLinks:function(){dojo.forEach(this.domNode.querySelectorAll(".content a"),function(link){dojo.attr(link,"target","_blank");},this);}});}if(!dojo._hasResource["toura.components.FeedItemList"]){dojo._hasResource["toura.components.FeedItemList"]=true;dojo.provide("toura.components.FeedItemList");dojo.declare("toura.components.FeedItemList",mulberry._Component,{templateString:dojo.cache("toura.components","FeedItemList/FeedItemList.haml",".component.feed-item-list\n  %header\n    .updated\n      %span Last Updated:\n      %span{ dojoAttachPoint : 'lastUpdated' }\n    .refresh{ dojoAttachPoint : 'refreshButton' }= i18n_feedRefresh\n    .spinner\n\n  %ol{ dojoAttachPoint : 'feedItemList' }\n\n"),itemTemplate:Haml(dojo.cache("toura.components","FeedItemList/FeedItem.haml","%li{ data-index : index }\n  %div\n    :if image\n      .image{ style: 'background: url(' + image.url + ')' }\n\n    %h2= title\n    %p.summary= displayText\n    %p.date= pubDate\n\n")),prepareData:function(){this.feed=this.node.feeds&&this.node.feeds[0];},setupConnections:function(){this.inherited(arguments);if(this.feed){this.connect(this.refreshButton,"click","_loadFeed");}},startup:function(){this.inherited(arguments);this._loadFeed();},_loadFeed:function(){this.addClass("loading");this.feed.load().then(dojo.hitch(this,"_populate"),dojo.hitch(this,"_handleNoNetwork"));this.connect(this.feedItemList,"click","_onSelect");},_populate:function(_3ba){this.removeClass("loading");if(!_3ba.length){var li=dojo.create("li",{innerHTML:this.i18n_noItems});dojo.place(li,this.feedItemList,"only");return;}this.populateElement(this.feedItemList,dojo.hitch(this,function(item,idx){item.displayText=mulberry.util.truncate(item.body,200);item.index=idx;item.pubDate=dojo.date.locale.format(item.pubDate);return this.itemTemplate(item);}),_3ba);this.lastUpdated.innerHTML=" "+dojo.date.locale.format(new Date());this.region.refreshScroller();this.onPopulate();},onPopulate:function(){},_handleNoNetwork:function(){this.removeClass("loading");var li=dojo.create("li",{innerHTML:this.i18n_noNetwork});dojo.place(li,this.feedItemList,"only");},_onSelect:function(e){e.preventDefault();var t=e.target,_3bb;while(t.nodeName.toLowerCase()!=="li"){t=t.parentNode;}_3bb=dojo.attr(t,"data-index");dojo.forEach(t.parentNode.childNodes,function(el){dojo.removeClass(el,"active");});dojo.addClass(t,"active");if(_3bb){this.onSelect(this.feed.id,_3bb);}},onSelect:function(_3bc,_3bd){console.log("onSelect",_3bc,_3bd);},initializeStrings:function(){this.i18n_noNetwork=this.getString("NO_NETWORK");this.i18n_noItems=this.getString("FEED_NO_ITEMS");this.i18n_feedRefresh=this.getString("FEED_REFRESH");}});}if(!dojo._hasResource["toura.components.GoogleMap"]){dojo._hasResource["toura.components.GoogleMap"]=true;dojo.provide("toura.components.GoogleMap");(function(dojo){var _3be=0;dojo.declare("toura.components.GoogleMap",mulberry._Component,{templateString:dojo.cache("toura.components","GoogleMap/GoogleMap.haml",".component.google-map\n  .map{ dojoAttachPoint : 'mapNode' }\n"),mapType:"roadmap",apiURL:mulberry.app.URL.protocol()+"://maps.google.com/maps/api/js?v=3.4&sensor=false&callback=",prepareData:function(){this.queue=[];this.googleTries=0;this.pinCache={};this.markerCache={};this.isBuilt=false;this.pins=this.node.googleMapPins;dojo.forEach(this.pins,function(pin){this.pinCache[pin.id]=pin;},this);},postCreate:function(){this.inherited(arguments);this.callbackName="GoogleMapCallback"+(++_3be);window[this.callbackName]=dojo.hitch(this,"_buildMap");dojo.io.script.get({url:this.apiURL+this.callbackName});},_buildMap:function(){delete window[this.callbackName];this.map=new google.maps.Map(this.mapNode,{mapTypeId:this.mapType,streetViewControl:false,mapTypeControl:false,zoom:0,zoomControl:true,zoomControlOptions:{position:google.maps.ControlPosition.TOP_RIGHT}});var _3bf=new google.maps.LatLngBounds();this.markers=dojo.map(this.pins||[],function(pin){var _3c0=new google.maps.LatLng(pin.lat,pin.lon),_3c1=new google.maps.Marker({map:this.map,position:_3c0,title:pin.name});google.maps.event.addListener(_3c1,"click",dojo.hitch(this,"_showInfo",_3c1,pin));_3bf.extend(_3c0);this.markerCache[pin.id]=_3c1;return _3c1;},this);if(this.pins.length>1){this.map.fitBounds(_3bf);}else{if(this.pins[0]){this.map.setCenter(new google.maps.LatLng(this.pins[0].lat,this.pins[0].lon));this.map.setZoom(15);}}this.isBuilt=true;this._doQueue();this.onMapBuilt();},_showInfo:function(_3c2,pin){var _3c3;if(this.tablet){_3c3=new google.maps.InfoWindow({content:this.pinInfo.domNode});_3c3.open(this.map,_3c2);}this.onShowInfo(pin);},onShowInfo:function(pin){},onMapBuilt:function(){},_setCenterAttr:function(_3c4){_3c4=new google.maps.LatLng(_3c4.lat,_3c4.lng);this.map.setCenter(_3c4);this.map.setZoom(15);},_setPinAttr:function(_3c5){if(!_3c5){return;}if(!this.isBuilt){this._addToQueue(dojo.hitch(this,"set","pin",_3c5));return;}var _3c6=this.markerCache[_3c5],pin=this.pinCache[_3c5],_3c7=new google.maps.LatLng(pin.lat,pin.lon);this.map.panTo(_3c7);this._showInfo(_3c6,pin);this.pin=pin;},teardown:function(){if(window.google&&window.google.maps&&window.google.maps.event){dojo.forEach(this.markers,function(_3c8){google.maps.event.clearInstanceListeners(_3c8);_3c8.setMap(null);});google.maps.event.clearInstanceListeners(this.map);}},_addToQueue:function(fn){this.queue.push(fn);},_doQueue:function(){dojo.forEach(this.queue,function(fn){fn();},this);}});}(dojo));}if(!dojo._hasResource["toura.components.Hotspots"]){dojo._hasResource["toura.components.Hotspots"]=true;dojo.provide("toura.components.Hotspots");dojo.declare("toura.components.Hotspots",mulberry._Component,{templateString:dojo.cache("toura.components","Hotspots/Hotspots.haml",".component.hotspots\n  .image-wrapper{ dojoAttachPoint : 'imageWrapper', style : 'text-align: center' }\n    %img{ src : image.url, dojoAttachPoint : 'imageNode' }\n"),widgetsInTemplate:true,prepareData:function(){var data=this.node.data[0].json;this.hotspots=data.hotspots;this.image=this.node.images[0].original;},setupConnections:function(){this.connect(this.imageNode,"click","_handleImageClick");},postCreate:function(){this.inherited(arguments);this.scroller=new iScroll(this.domNode,{zoom:false,bounce:false});dojo.style(this.imageWrapper,{"width":this.image.width+"px","height":this.image.height+"px"});},_handleImageClick:function(e){e.preventDefault();var x=e.offsetX,y=e.offsetY,_3c9;dojo.forEach(this.hotspots,function(spot){if(_3c9){return;}var _3ca;if(spot.shape==="rectangle"){if(x>spot.left&&y>spot.top&&x<(spot.left+spot.width)&&y<(spot.top+spot.height)){_3c9=spot;}}if(spot.shape==="circle"){var _3cb=spot.width/2,_3cc=spot.left+_3cb,_3cd=spot.top+_3cb,hyp=Math.sqrt(Math.pow(_3cd-y,2)+Math.pow(_3cc-x,2));if(hyp<_3cb){_3c9=spot;}}},this);if(_3c9){mulberry.app.UI.click={x:x,y:y};mulberry.app.Router.go(toura.URL.node(_3c9.node_id));}},startup:function(){this.inherited(arguments);var _3ce=this.domNode.clientHeight,_3cf=this.domNode.clientWidth,newX=0,newY=0,_3d0={},_3d1;if(mulberry.app.UI.click){_3d1=mulberry.app.UI.click;_3d0.x=+_3d1.x;_3d0.y=+_3d1.y;}else{_3d0.x=this.image.width/2;_3d0.y=this.image.height/2;}mulberry.app.UI.click=false;if(_3d0.x>_3cf/2){_3d0.x=_3d0.x-(_3cf/2);}else{_3d0.x=0;}if(_3d0.y>_3ce/2){_3d0.y=_3d0.y-(_3ce/2);}else{_3d0.y=0;}this.scroller.refresh();this.scroller.scrollTo(_3d0.x*-1,_3d0.y*-1,"0ms");}});}if(!dojo._hasResource["toura.components._ImageGallery"]){dojo._hasResource["toura.components._ImageGallery"]=true;dojo.provide("toura.components._ImageGallery");dojo.declare("toura.components._ImageGallery",null,{widgetsInTemplate:true,postCreate:function(){this.inherited(arguments);},startup:function(){this._setWidth();this._setupClick();this.subscribe("/window/resize","_setWidth");},_setWidth:function(){this.widthItems=this.widthItems||this.query(".image");this.widthItems.style("width",mulberry.app.UI.viewport.width+"px");},_setCurrentImageIndexAttr:function(_3d2){this.bgImgs=this.bgImgs||dojo.filter(dijit.findWidgets(this.domNode),function(w){return w.isInstanceOf(mulberry.ui.BackgroundImage);});dojo.forEach(this.bgImgs,function(_3d3,i){if(_3d2!==null&&i>=_3d2-1&&i<=_3d2+1){_3d3.loadImage();}else{_3d3.unloadImage();}},this);this.currentImageIndex=_3d2;},_setupClick:function(){if(!this._handleClick){return;}if(!this.clickNode){return;}var _3d4=mulberry.app.UI.hasTouch?{start:"touchstart",move:"touchmove",end:"touchend"}:{start:"mousedown",move:"mousemove",end:"mouseup"};this.connect(this.clickNode,_3d4.start,function(){var c=[],_3d5,_3d6=dojo.hitch(this,"_handleClick"),_3d7=new Date().getTime();c.push(dojo.connect(this.imageList,_3d4.move,function(){_3d5=true;}));c.push(dojo.connect(this.imageList,_3d4.end,function(e){dojo.forEach(c,dojo.disconnect);if((new Date().getTime()-_3d7>mulberry.app.UI.touchMoveDebounce)&&_3d5){return;}_3d6(e);}));});}});}if(!dojo._hasResource["toura.components._ImageScroller"]){dojo._hasResource["toura.components._ImageScroller"]=true;dojo.provide("toura.components._ImageScroller");dojo.declare("toura.components._ImageScroller",toura.components._ImageGallery,{templateString:dojo.cache("toura.components","_ImageScroller/ImageScroller.haml",".component.image-scroller\n  .wrapper\n    %ol.images{ dojoAttachPoint : 'imageList' }\n      :each img in images\n        %li{ class : 'image ' + img.id }\n          .image{ dojoType : 'mulberry.ui.BackgroundImage', imageUrl : img.url }\n  %ol.indicator{ dojoAttachPoint : 'indicator' }\n    :each img in images\n      %li &#183;\n"),postMixInProperties:function(){this.inherited(arguments);this.useScroller=this.images.length>1;},startup:function(){this.inherited(arguments);this._setupImageScroller();},_setupImageScroller:function(){if(this.useScroller&&this.scrollerNode){var self=this,node=this.scrollerNode.parentNode,_3d8;_3d8=this.scrollerHandle=new iScroll(node,{snap:true,momentum:false,hScrollbar:false,onScrollEnd:function(){self.set("currentImageIndex",this.currPageX);self.onScrollEnd(this.currPageX);}});_3d8.refresh();this.onScrollerSetupComplete();}this.set("currentImageIndex",0);},onScrollerSetupComplete:function(){console.log("toura.components._ImageScroller::onScrollerSetupComplete()");},onScrollEnd:function(_3d9){},_setWidth:function(){var _3da=mulberry.app.UI.viewport.width,_3db=this.images.length*_3da;this.scrollerNode.style.width=_3db+"px";this.query(".image").style("width",_3da+"px");if(!this.scrollerHandle){return;}this.scrollerHandle.refresh();this.scrollToIndex(this.currentImageIndex);},_setCurrentImageIndexAttr:function(_3dc){this.inherited(arguments);dojo.forEach(this.indicator.childNodes,function(_3dd){dojo.removeClass(_3dd,"active");});dojo.addClass(this.indicator.childNodes[_3dc],"active");},postCreate:function(){this.inherited(arguments);if(this.images.length<=1){this.hide(this.indicator);}},_updateIndicator:function(){},scrollToIndex:function(_3de){if(!this.scrollerHandle){return;}if(_3de===this.currentImageIndex){return;}this.scrollerHandle.scrollToPage(_3de,0,"0ms");this.set("currentImageIndex",_3de);},refresh:function(){if(!this.scrollerHandle){return;}this.scrollerHandle.refresh();},destroy:function(){if(this.scrollerHandle){this.scrollerHandle.destroy();}this.inherited(arguments);}});}if(!dojo._hasResource["toura.components.ImageGallery"]){dojo._hasResource["toura.components.ImageGallery"]=true;dojo.provide("toura.components.ImageGallery");dojo.declare("toura.components.ImageGallery",[mulberry._Component,toura.components._ImageScroller],{"class":"image-gallery",prepareData:function(){this.images=dojo.map(this.node.images||[],function(img){return dojo.mixin(img,{url:img.gallery.url,height:img.gallery.height,width:img.gallery.width});},this);},postCreate:function(){this.scrollerNode=this.clickNode=this.imageList;this.inherited(arguments);},_handleClick:function(){this.onShowDetail(this.currentImageIndex);},onShowDetail:function(_3df){}});}if(!dojo._hasResource["mulberry.app.URL"]){dojo._hasResource["mulberry.app.URL"]=true;dojo.provide("mulberry.app.URL");mulberry.app.URL={protocol:function(){return (/^https/).test(document.location.protocol)?"https":"http";},tel:function(tel){return "tel:"+tel.replace(/\W/g,"");},googleMapAddress:function(_3e0){var url="http://maps.google.com/maps?",_3e1={q:_3e0};return url+dojo.objectToQuery(_3e1);}};}if(!dojo._hasResource["toura.components.LocationList"]){dojo._hasResource["toura.components.LocationList"]=true;dojo.provide("toura.components.LocationList");dojo.declare("toura.components.LocationList",mulberry._Component,{templateString:dojo.cache("toura.components","LocationList/LocationList.haml","%ul.component.location-list\n  :each location in locations\n    %li\n      .address\n        %p= location.name\n\n        :if location.address\n          %p= location.address\n\n      %a.directions{ target : '_blank', href : location.directionsUrl }= i18n_directions\n\n      :if location.phoneNumber\n        %a.phone-number{ href : location.phoneUrl }\n          %span.label= i18n_phone\n          %span= location.phoneNumber\n\n      :if location.website\n          %a.website{ href : location.website }= i18n_website\n"),prepareData:function(){this.locations=dojo.map(this.node.googleMapPins,function(pin){var loc=dojo.mixin({},pin);loc.directionsUrl=pin.address&&mulberry.app.URL.googleMapAddress(pin.address);loc.phoneUrl=pin.phoneNumber&&mulberry.app.URL.tel(pin.phoneNumber);return loc;});},setupConnections:function(){dojo.forEach(this.query("a.website"),function(n){this.connect(n,"click",function(e){e.preventDefault();mulberry.app.PhoneGap.browser.url(dojo.attr(n,"href"));});},this);},initializeStrings:function(){this.i18n_phone=this.getString("PHONE");this.i18n_website=this.getString("WEBSITE");this.i18n_directions=this.getString("DIRECTIONS");}});}if(!dojo._hasResource["dojo.store.util.QueryResults"]){dojo._hasResource["dojo.store.util.QueryResults"]=true;dojo.provide("dojo.store.util.QueryResults");dojo.getObject("store.util",true,dojo);dojo.store.util.QueryResults=function(_3e2){if(!_3e2){return _3e2;}if(_3e2.then){_3e2=dojo.delegate(_3e2);}function _3e3(_3e4){if(!_3e2[_3e4]){_3e2[_3e4]=function(){var args=arguments;return dojo.when(_3e2,function(_3e5){Array.prototype.unshift.call(args,_3e5);return dojo.store.util.QueryResults(dojo[_3e4].apply(dojo,args));});};}};_3e3("forEach");_3e3("filter");_3e3("map");if(!_3e2.total){_3e2.total=dojo.when(_3e2,function(_3e6){return _3e6.length;});}return _3e2;};}if(!dojo._hasResource["dojo.store.util.SimpleQueryEngine"]){dojo._hasResource["dojo.store.util.SimpleQueryEngine"]=true;dojo.provide("dojo.store.util.SimpleQueryEngine");dojo.getObject("store.util",true,dojo);dojo.store.util.SimpleQueryEngine=function(_3e7,_3e8){switch(typeof _3e7){default:throw new Error("Can not query with a "+typeof _3e7);case "object":case "undefined":var _3e9=_3e7;_3e7=function(_3ea){for(var key in _3e9){var _3eb=_3e9[key];if(_3eb&&_3eb.test){if(!_3eb.test(_3ea[key])){return false;}}else{if(_3eb!=_3ea[key]){return false;}}}return true;};break;case "string":if(!this[_3e7]){throw new Error("No filter function "+_3e7+" was found in store");}_3e7=this[_3e7];case "function":}function _3ec(_3ed){var _3ee=dojo.filter(_3ed,_3e7);if(_3e8&&_3e8.sort){_3ee.sort(function(a,b){for(var sort,i=0;sort=_3e8.sort[i];i++){var _3ef=a[sort.attribute];var _3f0=b[sort.attribute];if(_3ef!=_3f0){return !!sort.descending==_3ef>_3f0?-1:1;}}return 0;});}if(_3e8&&(_3e8.start||_3e8.count)){var _3f1=_3ee.length;_3ee=_3ee.slice(_3e8.start||0,(_3e8.start||0)+(_3e8.count||Infinity));_3ee.total=_3f1;}return _3ee;};_3ec.matches=_3e7;return _3ec;};}if(!dojo._hasResource["dojo.store.Memory"]){dojo._hasResource["dojo.store.Memory"]=true;dojo.provide("dojo.store.Memory");dojo.declare("dojo.store.Memory",null,{constructor:function(_3f2){this.index={};dojo.mixin(this,_3f2);this.setData(this.data||[]);},data:null,idProperty:"id",index:null,queryEngine:dojo.store.util.SimpleQueryEngine,get:function(id){return this.index[id];},getIdentity:function(_3f3){return _3f3[this.idProperty];},put:function(_3f4,_3f5){var id=_3f5&&_3f5.id||_3f4[this.idProperty]||Math.random();this.index[id]=_3f4;var data=this.data,_3f6=this.idProperty;for(var i=0,l=data.length;i<l;i++){if(data[i][_3f6]==id){data[i]=_3f4;return id;}}this.data.push(_3f4);return id;},add:function(_3f7,_3f8){if(this.index[_3f8&&_3f8.id||_3f7[this.idProperty]]){throw new Error("Object already exists");}return this.put(_3f7,_3f8);},remove:function(id){delete this.index[id];var data=this.data,_3f9=this.idProperty;for(var i=0,l=data.length;i<l;i++){if(data[i][_3f9]==id){data.splice(i,1);return;}}},query:function(_3fa,_3fb){return dojo.store.util.QueryResults(this.queryEngine(_3fa,_3fb)(this.data));},setData:function(data){if(data.items){this.idProperty=data.identifier;data=this.data=data.items;}else{this.data=data;}for(var i=0,l=data.length;i<l;i++){var _3fc=data[i];this.index[_3fc[this.idProperty]]=_3fc;}}});}if(!dojo._hasResource["toura.models.Favorite"]){dojo._hasResource["toura.models.Favorite"]=true;dojo.provide("toura.models.Favorite");dojo.declare("toura.models.Favorite",null,{constructor:function(obj){var _3fd=new Date(),_3fe={id:obj.id,type:"node",name:obj.name,added:_3fd.getTime(),displayDate:dojo.date.locale.format(_3fd,{datePattern:"d MMMM yyy",timePattern:"H:m"})};dojo.mixin(this,_3fe);}});}if(!dojo._hasResource["toura.user.Favorites"]){dojo._hasResource["toura.user.Favorites"]=true;dojo.provide("toura.user.Favorites");(function(){var ds=mulberry.app.DeviceStorage;dojo.declare("toura.user.Favorites",null,{constructor:function(){this._init();this.subscriptions=[dojo.subscribe("/favorite/add",this,"_addFavorite"),dojo.subscribe("/favorite/remove",this,"_removeFavorite"),dojo.subscribe("/favorites/clear",this,"_empty"),dojo.subscribe("/data/loaded",this,"_refresh")];},hasFavorites:function(){return !!this.store.data.length;},_init:function(){var favs=ds.get("favorites");this.store=new dojo.store.Memory({data:favs||[]});this._refresh();},_refresh:function(){dojo.forEach(this.store.data,function(item){if(!toura.Data.getById(item.id)){item.deleted=true;this.store.put(item);}},this);this.onRefresh(this.store.data);},onRefresh:function(data){},load:function(_3ff,_400){if(!_3ff){_3ff="added";_400=true;}return this._sort(_3ff||"added",_400);},isFavorite:function(obj){return !!obj&&!!obj.id&&!!this.store.get(obj.id);},_removeFavorite:function(obj){console.log("toura.user.Favorites::_removeFavorite()",obj);var id=dojo.isString(obj)?obj:obj.id;this.store.remove(id);this._save();},_empty:function(){this._save([]);this._init();},_save:function(_401){console.log("will try to save",this.store.data);ds.set("favorites",_401||this.store.data);},_addFavorite:function(obj){console.log("toura.user.Favorites::_addFavorite()",obj);if(this.isFavorite(obj)){return;}this.store.add(new toura.models.Favorite(obj));this._save();},_sort:function(prop,_402){if(!prop){throw new Error("toura.user.Favorites::_sort requires a property for sorting");}var data=[].concat(this.store.data),_403=this._makeModels(data[0]&&data[0][prop]?data.sort(function(a,b){a=a[prop];b=b[prop];if(a<b){return _402?1:-1;}if(a>b){return _402?-1:1;}return 0;}):data);return _403;},_makeModels:function(data){return dojo.map(data,function(item){return dojo.mixin({model:toura.Data.getModel(item.id)},item);},this);},destroy:function(){dojo.forEach(this.subscriptions,dojo.unsubscribe);}});}());dojo.subscribe("/app/ready",function(){toura.user.Favorites=new toura.user.Favorites();});}if(!dojo._hasResource["toura.components.buttons.HomeButton"]){dojo._hasResource["toura.components.buttons.HomeButton"]=true;dojo.provide("toura.components.buttons.HomeButton");dojo.declare("toura.components.buttons.HomeButton",toura.components.buttons._Button,{preventWhenAnimating:true,onClick:function(e){e.preventDefault();mulberry.app.Router.home();}});}if(!dojo._hasResource["toura.components.buttons.FontSize"]){dojo._hasResource["toura.components.buttons.FontSize"]=true;dojo.provide("toura.components.buttons.FontSize");dojo.declare("toura.components.buttons.FontSize",toura.components.buttons._Button,{sizes:["small","medium","large"],"class":"font-size",defaultSize:"medium",sizePrefix:"font-size-",onClick:function(e){e.preventDefault();var b=dojo.body(),_404=mulberry.app.UI.fontSize||(this.sizePrefix+this.defaultSize),_405=dojo.indexOf(this.sizes,_404.replace(this.sizePrefix,"")),_406=this.sizePrefix+(this.sizes[_405+1]||this.sizes[0]);mulberry.app.UI.set("fontSize",_406);},initializeStrings:function(){this.i18n_font=this.getString("FONT");}});}if(!dojo._hasResource["toura.components.SocialMessage"]){dojo._hasResource["toura.components.SocialMessage"]=true;dojo.provide("toura.components.SocialMessage");dojo.declare("toura.components.SocialMessage",mulberry._Component,{templateString:dojo.cache("toura.components","SocialMessage/SocialMessage.haml","%form.component.social-message\n  :if requireAuth\n    %fieldset.auth\n      %input{ type : 'text', name : 'username', placeholder : 'username', dojoAttachPoint : 'username', autocapitalize : 'off', autocorrect : 'off' }\n      %input{ type : 'password', name : 'password', placeholder : 'password', dojoAttachPoint : 'password' }\n\n\n  %textarea{ dojoAttachPoint : 'message', name : 'msg', autocorrect : 'off' }= messageText\n\n  :if maxLength\n    .count{ dojoAttachPoint : 'count' }= availLength\n\n  %fieldset.buttons\n    %input.highlight{ type : 'submit', dojoAttachPoint : 'submitBtn', value : i18n_submitLabel }\n    %input{ type : 'reset', dojoAttachPoint : 'cancelBtn', value : i18n_cancelLabel }\n"),requireAuth:false,maxLength:false,errorClass:"error",warningClass:"warning",prepareData:function(){this.messageText=this.messageText||"";this.availLength=this.maxLength-this.messageText.length;},setupConnections:function(){this.connect(this.submitBtn,"click","_onSubmit");this.connect(this.cancelBtn,"click","_onCancel");dojo.forEach([this.message,this.username,this.password],dojo.hitch(this,function(node){this.connect(node,"blur","_onSocialBlur");}));dojo.forEach(["keyup","change"],dojo.hitch(this,function(e){this.connect(this.message,e,"_resize");}));if(this.maxLength){this.connect(this.message,"keyup","_updateCharCount");}},_updateCharCount:function(e){var len=this.message.value.length,warn=this.maxLength-len<11,_407=this.maxLength-len<=0;this.count.innerHTML=this.maxLength-len;dojo[_407?"addClass":"removeClass"](this.count,this.errorClass);dojo[warn&&!_407?"addClass":"removeClass"](this.count,this.warningClass);},_onSubmit:function(e){e.preventDefault();var _408={msg:this.message.value,username:this.username&&this.username.value,password:this.password&&this.password.value},_409;_408.msg=dojo.trim(_408.msg);_409=this._validate(_408);if(!_409.length){this.onSubmit(_408);return;}this._handleErrors(_409);},_validate:function(_40a){var _40b=[];if(this.requireAuth){if(!_40a.username){_40b.push(this.i18n_usernameRequired);}if(!_40a.password){_40b.push(this.i18n_passwordRequired);}if(_40b.length){_40b.push(this.i18n_privacy);}}if(!_40a.msg){_40b.push(this.i18n_messageRequired);}if(this.maxLength&&_40a.msg.length>this.maxLength){_40b.push(this.i18n_messageLength);}return _40b;},_resize:function(){var msg=this.message;msg.style.height="auto";msg.style.height=msg.scrollHeight+"px";},_handleErrors:function(_40c){mulberry.app.PhoneGap.notification.alert(_40c.join("\n"));},onSubmit:function(_40d){console.log(_40d);},_onCancel:function(){this.onCancel();},onCancel:function(){console.log("toura.components.SocialMessage::onCancel()");},_onSocialBlur:function(){window.scrollTo(0,0);},initializeStrings:function(){this.i18n_submitLabel=this.getString("SEND");this.i18n_cancelLabel=this.getString("CANCEL");this.i18n_usernameRequired=this.getString("SOCIAL_USERNAME_REQUIRED");this.i18n_passwordRequired=this.getString("SOCIAL_PASSWORD_REQUIRED");this.i18n_privacy=this.getString("SOCIAL_PRIVACY");this.i18n_messageRequired=this.getString("SOCIAL_MESSAGE_REQUIRED");this.i18n_messageLength=this.getString("SOCIAL_MESSAGE_LENGTH");}});}if(!dojo._hasResource["toura.components.MoreDrawer"]){dojo._hasResource["toura.components.MoreDrawer"]=true;dojo.provide("toura.components.MoreDrawer");dojo.declare("toura.components.MoreDrawer",mulberry._Component,{templateString:dojo.cache("toura.components","MoreDrawer/MoreDrawer.haml",".component.more-drawer\n  :if phone\n    %section\n      %menu\n        =helpers.homeButton\n        =helpers.fontSizeButton\n        =helpers.searchButton\n\n    %section\n      %menu\n        =helpers.favoriteButton\n        =helpers.sharingButtons\n\n  :if tablet\n    %section\n      %menu\n        =helpers.fontSizeButton\n        =helpers.favoriteButton\n        =helpers.sharingButtons\n\n  %section{ dojoAttachPoint : 'shareSection' }\n"),helpers:{sharingButtons:dojo.cache("toura.components","MoreDrawer/_SharingButtons.haml","%li.facebook\n  %a{ dojoAttachPoint : 'facebook' }\n\n%li.twitter\n  %a{ dojoAttachPoint : 'twitter' }\n\n%li.email\n  %a{ dojoAttachPoint : 'email', href : '#' }\n"),favoriteButton:dojo.cache("toura.components","MoreDrawer/_FavoriteButton.haml","%li.favorite\n  %input{ type : 'checkbox', dojoAttachPoint : 'favorite' }\n"),homeButton:dojo.cache("toura.components","MoreDrawer/_HomeButton.haml","%li.home\n  %a{ dojoType : 'toura.components.buttons.HomeButton', dojoAttachPoint : 'homeButton' }\n"),fontSizeButton:dojo.cache("toura.components","MoreDrawer/_FontSizeButton.haml","%li.font-size\n  %a{ dojoType : 'toura.components.buttons.FontSize' }\n"),searchButton:dojo.cache("toura.components","MoreDrawer/_SearchButton.haml","%li.search\n  %a{ dojoType : 'toura.components.buttons.SearchButton', dojoAttachPoint : 'searchButton' }\n")},widgetsInTemplate:true,isHidden:true,prepareData:function(){this.sharingDisabled=!toura.features.sharing;this.favoritesDisabled=!toura.features.favorites;this.fontSizeDisabled=!toura.features.fontSize;if(!this.sharingDisabled){this.socialMediaServices=toura.Sharing.getServices();if(!this.socialMediaServices.length){this.sharingDisabled=true;}}this.helpers.sharingButtons=this.sharingDisabled?"":this.helpers.sharingButtons;this.helpers.favoriteButton=this.favoritesDisabled?"":this.helpers.favoriteButton;this.helpers.fontSizeButton=this.fontSizeDisabled?"":this.helpers.fontSizeButton;this.inherited(arguments);},setupConnections:function(){var _40e=mulberry.app.UI.hasTouch,evt=_40e?"touchstart":"click",_40f=function(e){e.preventDefault();};if(!this.sharingDisabled){dojo.forEach(this.socialMediaServices,function(_410){var _411=this[_410.name];if(!_411){return;}this.connect(_411,evt,dojo.hitch(this,"_handleSocialMessageClick",_410));if(_40e){this.connect(_411,"click",_40f);}},this);this._createMailLink();this.hide(this.shareSection);}if(!this.favoritesDisabled){this.connect(this.favorite,evt,"_handleFavorite");if(_40e){this.connect(this.favorite,"click",_40f);}}},adjustMarkup:function(){if(this.sharingDisabled){return;}dojo.forEach(["facebook","twitter"],function(_412){var _413=dojo.filter(this.socialMediaServices,function(svc){return svc.name===_412;});if(!_413.length){dojo.destroy(this.query("."+_412)[0]);}},this);},_createMailLink:function(){if(!this.email){return;}dojo.attr(this.email,"href","mailto:?"+dojo.objectToQuery({subject:mulberry.app.Config.get("app").name,body:toura.Sharing.getMessage("email",this.node)}));this.connect(this.email,"click",function(){dojo.publish("/share",[["email",this.node.id].join(": ")]);});},_handleSocialMessageClick:function(_414){console.log("toura.components.MoreDrawer::_handleSocialMessageClick()");mulberry.app.PhoneGap.network.isReachable().then(dojo.hitch(this,function(_415){if(!_415){mulberry.app.PhoneGap.notification.alert(this.i18n_noNetwork);return;}if(this.socialMessage){var same=this.socialMessage.name===_414.name;this.orphan(this.socialMessage,true);delete this.socialMessage;if(same){dojo.removeClass(this[_414.name],"active");return;}}dojo.addClass(this[_414.name],"active");var _416=dojo.mixin({messageText:toura.Sharing.getMessage(_414.name,this.node)},_414),_417=this.socialMessage=this.adopt(toura.components.SocialMessage,_416);_417.placeAt(this.shareSection);this.show(this.shareSection);this.connect(_417,"onSubmit",function(_418){toura.Sharing.share(_414,_418,this.node).then(dojo.hitch(this,function(){this.hide(this.shareSection);}),function(msg){if(msg){mulberry.app.PhoneGap.notification.alert(msg);}});});this.connect(_417,"onCancel",function(){this.hide(this.shareSection);this.orphan(_417,true);delete this.socialMessage;});}),function(){mulberry.app.PhoneGap.notification.alert(this.i18n_noNetwork);});},_handleFavorite:function(e){console.log("toura.components.MoreDrawer::_handleFavorite");if(!this.node){return;}var n=this.node,_419=toura.user.Favorites.isFavorite(n),_41a="/favorite/"+(_419?"remove":"add");dojo.publish(_41a,[n]);this.favorite.checked=!_419;},_setNodeAttr:function(node){this.node=node;if(this.favorite){this.favorite.checked=toura.user.Favorites.isFavorite(node);}},toggle:function(){if(!this.isHidden){dojo.publish("/MoreDrawer/hide");this.hide(this.shareSection);}else{dojo.publish("/MoreDrawer/show");}this.inherited(arguments);},initializeStrings:function(){this.i18n_noNetwork=this.getString("NO_NETWORK");}});}if(!dojo._hasResource["toura.components.NodeGallery"]){dojo._hasResource["toura.components.NodeGallery"]=true;dojo.provide("toura.components.NodeGallery");dojo.declare("toura.components.NodeGallery",[mulberry._Component,toura.components._ImageScroller],{"class":"node-gallery",prepareData:function(){this.node.populateChildren();this.children=this.node.children;this.images=dojo.map(this.children||[],function(_41b){var img=_41b.images[0];return dojo.mixin(img,this.phone?{url:img.gallery.url,height:img.gallery.height,width:img.gallery.width}:{url:img.original.url,height:img.original.height,width:img.original.width});},this);},postCreate:function(){this.scrollerNode=this.clickNode=this.imageList;this.inherited(arguments);},setupConnections:function(){this.connect(this.clickNode,"click","_handle");},_handle:function(e){var _41c=this.children[this.currentImageIndex],_41d={x:e.offsetX,y:e.offsetY},img=this.images[this.currentImageIndex],_41e,_41f=this.domNode.clientHeight,_420=this.domNode.clientWidth,_421=_420/img.width;if((img.height*_421)>_41f){_41d.y+=((img.height*_421)-_41f)/2;}_41e=img.original.width/_420;_41d.x=Math.floor(_41d.x*_41e);_41d.y=Math.floor(_41d.y*_41e);mulberry.app.UI.click=_41d;mulberry.app.Router.go(_41c.url);},onScrollEnd:function(_422){}});}if(!dojo._hasResource["toura.components.NodeTitleBanner"]){dojo._hasResource["toura.components.NodeTitleBanner"]=true;dojo.provide("toura.components.NodeTitleBanner");dojo.declare("toura.components.NodeTitleBanner",mulberry._Component,{templateString:dojo.cache("toura.components","NodeTitleBanner/NodeTitleBanner.haml",".component.node-title-banner\n  :if image\n    .image{ dojoType : 'mulberry.ui.BackgroundImage', imageUrl : image.url, loadOnInit: true }\n\n  %header\n    :if parentTitle\n      %h3= parentTitle\n\n    %h2= nodeTitle\n"),widgetsInTemplate:true,prepareData:function(){if(this.node.featuredImage){this.image=this.node.featuredImage[this.phone?"small":"large"];}else{this.image=false;}this.parentTitle=this.node.parent&&this.node.parent.name;this.nodeTitle=this.node.name;}});}if(!dojo._hasResource["toura.components.PageHeaderImage"]){dojo._hasResource["toura.components.PageHeaderImage"]=true;dojo.provide("toura.components.PageHeaderImage");dojo.declare("toura.components.PageHeaderImage",toura.components.HeaderImage,{"class":"page-header-image",prepareData:function(){this.inherited(arguments);if(this.viewImage){dojo.mixin(this.viewImage,this._calculateDimensions());}},_getWidth:function(){return mulberry.app.UI.viewport.width;}});}if(!dojo._hasResource["toura.components.buttons.MoreDrawerButton"]){dojo._hasResource["toura.components.buttons.MoreDrawerButton"]=true;dojo.provide("toura.components.buttons.MoreDrawerButton");dojo.declare("toura.components.buttons.MoreDrawerButton",toura.components.buttons._Button,{initializeStrings:function(){this.i18n_text=this.getString("MORE");}});}if(!dojo._hasResource["toura.components.buttons.BackButton"]){dojo._hasResource["toura.components.buttons.BackButton"]=true;dojo.provide("toura.components.buttons.BackButton");dojo.declare("toura.components.buttons.BackButton",toura.components.buttons._Button,{preventWhenAnimating:true,onClick:function(e){e.preventDefault();if(toura.features.disableBackButton){return;}mulberry.app.Router.back();},initializeStrings:function(){this.i18n_text=this.getString("BACK");}});}if(!dojo._hasResource["toura.components.PageNav"]){dojo._hasResource["toura.components.PageNav"]=true;dojo.provide("toura.components.PageNav");dojo.declare("toura.components.PageNav",mulberry._Component,{templateString:dojo.cache("toura.components","PageNav/PageNav.haml","%nav.component.page-nav\n  .top\n    :if tablet\n      %ul\n        %li.back\n          %a{ dojoType : 'toura.components.buttons.BackButton', dojoAttachPoint : 'backButton' }\n        %li.home\n          %a{ dojoType : 'toura.components.buttons.HomeButton', dojoAttachPoint : 'homeButton' }\n\n      %h1\n        %span{ dojoAttachPoint : 'titleElement' }= title\n\n      %ul\n        :if shareable\n          %li.more\n            %a{ dojoType : 'toura.components.buttons.MoreDrawerButton', dojoAttachPoint : 'moreDrawerButton' }\n\n        %li.search\n          %a{ href : searchUrl }\n\n    :if phone\n      .back\n        %a{ dojoType : 'toura.components.buttons.BackButton', dojoAttachPoint : 'backButton' }\n\n      %h1\n        %span{ dojoAttachPoint : 'titleElement' }= title\n\n      :if shareable\n        .more\n          %a{ dojoType : 'toura.components.buttons.MoreDrawerButton', dojoAttachPoint : 'moreDrawerButton' }\n\n      :if !shareable\n        .home\n          %a{ dojoType : 'toura.components.buttons.BackButton', dojoAttachPoint : 'backButton' }\n\n  :if shareable\n    %div{ dojoType : 'toura.components.MoreDrawer', dojoAttachPoint : 'moreDrawer' }\n"),widgetsInTemplate:true,shareable:true,prepareData:function(){this.searchUrl=toura.URL.search();this.homeUrl=toura.URL.home();this.title=this.node?this.node.name:this.title;this.shareable=this.node&&this.node.shareable;},setupConnections:function(){if(this.moreDrawerButton){this.connect(this.moreDrawerButton,"onClick","_showMoreDrawer");}},setupSubscriptions:function(){this.subscribe("/button/menu","_showMoreDrawer");},setupChildComponents:function(){if(this.shareable){this.moreDrawer.set("node",this.node);}},initializeStrings:function(){this.i18n_more=this.getString("MORE");},_showMoreDrawer:function(e){if(e){e.preventDefault();}this.moreDrawer.toggle();},attributeMap:{screenTitle:{node:"titleElement",type:"innerHTML"}}});}if(!dojo._hasResource["toura.components.PinCaption"]){dojo._hasResource["toura.components.PinCaption"]=true;dojo.provide("toura.components.PinCaption");dojo.declare("toura.components.PinCaption",toura.components.BodyText,{"class":"pin-caption",_getBodyText:function(){return this.caption||this.inherited(arguments);}});}if(!dojo._hasResource["toura.components.PinInfo"]){dojo._hasResource["toura.components.PinInfo"]=true;dojo.provide("toura.components.PinInfo");dojo.declare("toura.components.PinInfo",mulberry._Component,{templateString:dojo.cache("toura.components","PinInfo/PinInfo.haml",".component.pin-info\n\n  %a.directions{ dojoAttachPoint : 'directionsNode', target : '_blank' }= i18n_directions\n  %a.phone-number{ dojoAttachPoint : 'phoneNumberContainerNode' }\n    %span.label= i18n_phone\n    %span{ dojoAttachPoint : 'phoneNumberNode' }\n  %a.website{ dojoAttachPoint : 'websiteContainerNode' }= i18n_website\n\n  .bottom\n    %section\n      %header\n        %h2{ dojoAttachPoint : 'nameNode' }\n        %p{ dojoAttachPoint : 'addressNode' }\n      %div{ dojoAttachPoint : 'captionNode' }\n\n"),widgetsInTemplate:true,setupChildComponents:function(){if(this.scroller){this.scroller.makeScroller();}this.captionNode=this.adopt(toura.components.PinCaption).placeAt(this.captionNode,"replace");},setupConnections:function(){this.connect(this.websiteContainerNode,"click",function(e){e.preventDefault();mulberry.app.PhoneGap.browser.url(dojo.attr(this.websiteContainerNode,"data-url"));});},_onClose:function(){this.onClose();},onClose:function(){},_setPinAttr:function(pin){if(!pin){return;}this.set("pinName",pin.name);this.set("address",pin.address);this.set("directionsUrl",mulberry.app.URL.googleMapAddress(pin.address));this.set("phoneNumber",pin.phoneNumber);this.set("website",pin.website);this.captionNode.set("content",pin.caption||"");},_setPhoneNumberAttr:function(_423){if(!_423){this.hide(this.phoneNumberContainerNode);return;}this.show(this.phoneNumberContainerNode);this.phoneNumberNode.innerHTML=_423;dojo.attr(this.phoneNumberContainerNode,"href",mulberry.app.URL.tel(_423));},_setWebsiteAttr:function(_424){if(!_424){this.hide(this.websiteContainerNode);return;}this.show(this.websiteContainerNode);dojo.attr(this.websiteContainerNode,"data-url",_424);},attributeMap:{pinName:{node:"nameNode",type:"innerHTML"},address:{node:"addressNode",type:"innerHTML"},directionsUrl:{node:"directionsNode",type:"attribute",attribute:"href"}},initializeStrings:function(){this.i18n_directions=this.getString("DIRECTIONS");this.i18n_phone=this.getString("PHONE");this.i18n_website=this.getString("WEBSITE");}});}if(!dojo._hasResource["toura.components.SearchInput"]){dojo._hasResource["toura.components.SearchInput"]=true;dojo.provide("toura.components.SearchInput");dojo.declare("toura.components.SearchInput",mulberry._Component,{templateString:dojo.cache("toura.components","SearchInput/SearchInput.haml",".component.search-input\n  %a.back{ dojoType : 'toura.components.buttons.BackButton' }\n  %form.search{ dojoAttachPoint : 'searchForm' }\n    %input{ type : 'search', name : 'query', placeholder : i18n_placeholderText, autocorrect : 'off', dojoAttachPoint : 'queryInput' }\n    %input{ type : 'submit', value : 'Search', dojoAttachPoint : 'searchButton' }\n"),_oldValue:null,keybuffer:3,debounceTime:300,timeout:null,widgetsInTemplate:true,setupConnections:function(){this.connect(this.queryInput,"focus",function(){window.scrollTo(0,0);this.queryInput.value="";});this.connect(this.queryInput,"keyup","_handleInput");if(mulberry.app.UI.hasTouch){this.connect(this.searchButton,"touchstart","_handleSubmit");}this.connect(this.searchForm,"submit","_handleSubmit");},_setSearchTermAttr:function(term){this.queryInput.value=term||"";},_handleInput:function(){if(dojo.trim(this.queryInput.value).length<this.keybuffer){return;}clearTimeout(this.timeout);this.timeout=setTimeout(dojo.hitch(this,function(){this._search(this.queryInput.value);}),this.debounceTime);},_handleSubmit:function(e){e.preventDefault();e.stopPropagation();var q=this.queryInput.value;if(/^mulberry:./.test(q)){console.log("found mulberry:");dojo.publish("/debug/user",[q]);return;}this._search(q);},_search:function(q){q=dojo.trim(q);if(!q){return;}if(q===this._oldValue){return;}this.search(q);},search:function(q){},initializeStrings:function(){this.i18n_placeholderText=this.getString("SEARCH_PLACEHOLDER_TEXT");}});}if(!dojo._hasResource["toura.components.SearchResults"]){dojo._hasResource["toura.components.SearchResults"]=true;dojo.provide("toura.components.SearchResults");dojo.declare("toura.components.SearchResults",mulberry._Component,{templateString:dojo.cache("toura.components","SearchResults/SearchResults.haml",".component.search-results\n  %ul{ dojoAttachPoint : 'resultsContainer' }\n"),resultTemplate:Haml(dojo.cache("toura.components","SearchResults/Result.haml","%li{ class : type }\n  %a.text{ href : url }\n    %h2= nodeTitle\n    %p= displayText\n")),handleClicks:true,resultsToShow:25,postCreate:function(){this.clickableNode=this.resultsContainer;this.inherited(arguments);},_setResultsAttr:function(_425){if(_425&&!dojo.isArray(_425)){throw new Error("toura.components.SearchResults::_setResultsAttr: results argument must be an array");}dojo.empty(this.resultsContainer);if(!_425){this._handleEmptySearch();return;}if(!_425.length){this._handleNoResults();return;}var _426=_425.length>this.resultsToShow;this.results=_425=_425.slice(0,this.resultsToShow);this.populateElement(this.resultsContainer,dojo.hitch(this,function(r){var _427=dojo.mixin({},r),a=_427.asset;_427.thumbnailURL=a&&a.featured&&a.featured.url;_427.displayText=this._truncate(_427.displayText);return this.resultTemplate(_427);}),_425);if(_426){_426=dojo.create("li",{innerHTML:this.i18n_moreResults,className:"more-results"});dojo.place(_426,this.resultsContainer,"last");}dojo.publish("/content/update");},_handleNoResults:function(){this.resultsContainer.innerHTML="<li>"+this.i18n_noResults+"</li>";},_handleEmptySearch:function(){this.resultsContainer.innerHTML="<li>"+this.i18n_instructions+"</li>";},initializeStrings:function(){this.i18n_instructions=this.getString("SEARCH_INSTRUCTIONS");this.i18n_noResults=this.getString("SEARCH_NO_RESULTS");this.i18n_moreResults=this.getString("SEARCH_MORE_RESULTS");},_truncate:function(text){return mulberry.util.truncate(text,200);}});}if(!dojo._hasResource["toura.components.VideoList"]){dojo._hasResource["toura.components.VideoList"]=true;dojo.provide("toura.components.VideoList");dojo.declare("toura.components.VideoList",toura.components.AssetList,{"class":"video-list",postMixInProperties:function(){this.assets=this.node.videos||[];this.inherited(arguments);},adjustMarkup:function(){if(this.assets.length<=1){this.hide();}}});}if(!dojo._hasResource["toura.components.VideoPlayer"]){dojo._hasResource["toura.components.VideoPlayer"]=true;dojo.provide("toura.components.VideoPlayer");dojo.declare("toura.components.VideoPlayer",toura.components._MediaPlayer,{templateString:dojo.cache("toura.components","VideoPlayer/VideoPlayer.haml",".component.video-player\n  .fake-video{ dojoAttachPoint : \"videoPlaceholder\", dojoType : 'mulberry.ui.BackgroundImage', imageUrl : media.poster }\n    .play-button{ dojoAttachPoint : 'playButton' }\n\n"),widgetsInTemplate:true,playerType:"video",playerSettings:{controls:true},prepareData:function(){this.medias=this.node.videos||[];this.inherited(arguments);if(this.useHtml5Player&&this.media.poster){this.playerSettings=dojo.mixin(this.playerSettings,{poster:this.media.poster});}},startup:function(){this.inherited(arguments);if(this.media.poster){this.videoPlaceholder.loadImage();}},setupConnections:function(){this.inherited(arguments);if(this.useHtml5Player){this.subscribe("/MoreDrawer/show",dojo.hitch(this,"disable"));this.subscribe("/MoreDrawer/hide",dojo.hitch(this,"enable"));return;}this.connect(this.videoPlaceholder,"click","_play");this.connect(this.playButton,"click","_play");},_play:function(_428){this.inherited(arguments);if(this.useHtml5Player){return;}mulberry.app.PhoneGap.browser.url(this.media.url);},_setMediaIdAttr:function(_429){this.inherited(arguments);this.set("poster",this.media.poster);},_setPosterAttr:function(_42a){if(!this.useHtml5Player){this.videoPlaceholder.set("imageUrl",_42a);return;}if(this.player){this.player.poster=_42a||"";}}});}if(!dojo._hasResource["toura.components._MediaCaption"]){dojo._hasResource["toura.components._MediaCaption"]=true;dojo.provide("toura.components._MediaCaption");dojo.declare("toura.components._MediaCaption",toura.components.BodyText,{_fixCaptionAlignment:function(){var _42b=dojo.position(this.domNode).w,_42c;dojo.style(this.domNode,{"float":"left"});_42c=dojo.position(this.domNode).w;if(_42b>_42c){this.addClass("short-caption");}else{this.removeClass("short-caption");}dojo.style(this.domNode,{"float":""});},resizeElements:function(){this.inherited(arguments);this._fixCaptionAlignment();},setupSubscriptions:function(){this.subscribe("/content/update","_fixCaptionAlignment");this.subscribe("/window/resize","_fixCaptionAlignment");}});}if(!dojo._hasResource["toura.components.VideoCaption"]){dojo._hasResource["toura.components.VideoCaption"]=true;dojo.provide("toura.components.VideoCaption");dojo.declare("toura.components.VideoCaption",toura.components._MediaCaption,{"class":"video-caption",_getBodyText:function(){if(!this.node||!this.node.videos){return "";}return this.node.videos[0]?(this.node.videos[0].caption||""):"";}});}if(!dojo._hasResource["toura.components.ImageCaption"]){dojo._hasResource["toura.components.ImageCaption"]=true;dojo.provide("toura.components.ImageCaption");dojo.declare("toura.components.ImageCaption",toura.components._MediaCaption,{"class":"image-caption",_getBodyText:function(){if(!this.node||!this.node.images){return "";}return this.node.images[0]?(this.node.images[0].caption||""):"";}});}if(!dojo._hasResource["mulberry.ui.PinchZoom"]){dojo._hasResource["mulberry.ui.PinchZoom"]=true;dojo.provide("mulberry.ui.PinchZoom");dojo.declare("mulberry.ui.PinchZoom",null,{zoomMax:3,_makeScroller:function(_42d){var self=this,_42e=dijit.byNode(_42d.firstChild);if(this.scroller){this.scroller.destroy();}this.scroller=new iScroll(_42d,{zoom:mulberry.app.Has.iScrollZoom(),onZoomEnd:function(){self.onZoomEnd(_42e,this);},zoomMin:0.33,zoomMax:this.zoomMax});},onZoomEnd:function(_42f,_430){if(this.zoomTimeout){return;}this.zoomTimeout=setTimeout(dojo.hitch(this,function(){var _431=_430.scale,_432=dojo.style(_42f.domNode,"width"),_433=dojo.style(_42f.domNode,"height"),_434=_432*_431,_435=_433*_431,newX=_430.x,newY=_430.y;if(_42f.imageWidth>_42f.imageHeight){if(_434<mulberry.app.UI.viewport.width){_434=mulberry.app.UI.viewport.width;_435=_434/ratio;}}else{if(_435<mulberry.app.UI.viewport.height){_435=mulberry.app.UI.viewport.height;_434=_435*ratio;}}if(_434>mulberry.app.UI.viewport.width*this.zoomMax){_434=_432;_435=_433;newX=newY=0;}dojo.style(_42f.domNode,"width",_434+"px");dojo.style(_42f.domNode,"height",_435+"px");_430.zoom(newX,newY,1,0);clearTimeout(this.zoomTimeout);this.zoomTimeout=null;}),0);}});}if(!dojo._hasResource["toura.components.ZoomableImageGallery"]){dojo._hasResource["toura.components.ZoomableImageGallery"]=true;dojo.provide("toura.components.ZoomableImageGallery");dojo.declare("toura.components.ZoomableImageGallery",[mulberry._Component,toura.components._ImageGallery,mulberry.ui.PinchZoom],{templateString:dojo.cache("toura.components","ZoomableImageGallery/ZoomableImageGallery.haml",".component.zoomable-image-gallery\n  .content\n    .image-nav.prev{ dojoAttachPoint : 'prevButton' }\n\n    %ol{ dojoAttachPoint : 'imageList' }\n      :each img in images\n        %li.image\n          .wrapper{ dojoType : 'mulberry.ui.BackgroundImage', imageUrl : img.url }\n\n    .image-nav.next{ dojoAttachPoint : 'nextButton' }\n\n    .caption{ dojoType : 'toura.components.ImageCaption', dojoAttachPoint : 'caption' }\n"),widgetsInTemplate:true,chromeVisible:false,prepareData:function(){this.inherited(arguments);this.images=dojo.map(this.node.images||[],function(img){var _436={tablet:"original",phone:"gallery"}[this.device.type];dojo.forEach(["url","height","width"],function(prop){img[prop]=img[_436][prop];});return img;},this);},setupConnections:function(){this.clickNode=this.imageList;this.connect(this.nextButton,"click",this._go(1));this.connect(this.prevButton,"click",this._go(-1));},_go:function(_437){return dojo.hitch(this,function(){this.set("currentImageIndex",this.currentImageIndex+_437);});},_setCurrentImageIndexAttr:function(_438){this.inherited(arguments);var img=this.images[_438];this.set("caption",img.caption||"");this._updateImages(_438);this._updateButtons(_438);this.onImageChange(img);},_handleClick:function(){this.set("chromeVisible",!this.chromeVisible);},_setChromeVisibleAttr:function(_439){this[_439?"removeClass":"addClass"]("chrome-hidden");this.chromeVisible=_439;this[_439?"onShowChrome":"onHideChrome"]();},onShowChrome:function(){},onHideChrome:function(){},onImageChange:function(_43a){},_updateImages:function(_43b){dojo.forEach(this.bgImgs,function(_43c,_43d){var n=_43c.domNode.parentNode,_43e=_43d===_43b;this[_43e?"show":"hide"](n);if(!_43e){return;}this._makeScroller(n);},this);},_updateButtons:function(_43f){var _440=_43f===0,_441=_43f===(this.images.length-1);this[_440?"hide":"show"](this.prevButton);this[_441?"hide":"show"](this.nextButton);},_setCaptionAttr:function(_442){this.caption.set("content",_442);this.caption[_442?"show":"hide"]();}});}if(!dojo._hasResource["toura.components._base"]){dojo._hasResource["toura.components._base"]=true;dojo.provide("toura.components._base");}if(!dojo._hasResource["toura.base"]){dojo._hasResource["toura.base"]=true;dojo.provide("toura.base");toura.data=toura.data||{};mulberry.registerComponentNamespace(toura.components);mulberry.registerCapabilityNamespace(toura.capabilities);mulberry.components.Debug.registerFeaturesObject(toura.features);}if(!dojo._hasResource["client.routes"]){dojo._hasResource["client.routes"]=true;dojo.provide("client.routes");}if(!dojo._hasResource["client.components.ATestComponent"]){dojo._hasResource["client.components.ATestComponent"]=true;dojo.provide("client.components.ATestComponent");mulberry.component("ATestComponent",{componentTemplate:dojo.cache("client.components","ATestComponent/ATestComponent.haml",".component.a-test-component It works!\n"),prep:function(){},init:function(){}});}dojo.i18n._preloadLocalizations("client.nls.base",["ROOT","en","en-us","xx"]);
